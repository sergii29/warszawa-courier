<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warsaw Courier</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #f9f9e8; --grid: #e2e2ca; --lime: #c8ff00; --dark: #1a1a1a; --danger: #ff4444;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: 'Arial', sans-serif; }

        /* –ú–ï–ù–Æ */
        #hamburger-btn {
            position: fixed; top: 15px; left: 15px;
            width: 50px; height: 50px; background: white; border: 2px solid var(--dark); border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;
            cursor: pointer; z-index: 9999; box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        .line { width: 26px; height: 3px; background: var(--dark); border-radius: 2px; }

        #sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 9998; display: none;
        }
        #sidebar {
            position: fixed; top: 0; left: -320px; width: 85%; max-width: 320px; height: 100%;
            background: #fff; z-index: 10000; transition: left 0.2s ease-in-out;
            display: flex; flex-direction: column; border-right: 2px solid var(--dark);
        }
        #sidebar.open { left: 0; }

        .sidebar-header { padding: 20px; background: var(--dark); color: white; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .sidebar-tabs { display: flex; background: #eee; padding: 10px; gap: 5px; overflow-x: auto; }
        .tab { padding: 8px 15px; background: white; border-radius: 6px; font-size: 12px; font-weight: bold; border: 1px solid #ccc; cursor: pointer; white-space: nowrap; }
        .tab.active { background: var(--lime); border-color: black; }
        .sidebar-content { flex-grow: 1; overflow-y: auto; padding: 15px; }

        .shop-item {
            background: #fff; border: 1px solid #ddd; padding: 12px; margin-bottom: 8px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center; font-size: 13px;
        }
        .buy-btn { background: var(--dark); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; }

        /* –ò–ù–¢–ï–†–§–ï–ô–° */
        #top-info {
            height: 140px; background: var(--bg); border-bottom: 2px solid var(--grid);
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding-top: 10px;
        }
        .balance-pill { 
            background: white; padding: 8px 30px; border-radius: 50px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); font-size: 24px; font-weight: 800; color: var(--dark);
            border: 1px solid #eee; margin-bottom: 5px;
        }
        /* –¢–∞–π–º–µ—Ä */
        #timer-pill {
            font-size: 14px; font-weight: 900; color: var(--danger); 
            background: #ffe6e6; padding: 4px 12px; border-radius: 10px; margin-bottom: 5px; display: none;
        }
        .stats-row { width: 90%; display: flex; justify-content: space-between; margin-bottom: 5px; }
        .stat-box { width: 48%; display: flex; align-items: center; gap: 5px; font-size: 10px; font-weight: bold; }
        .bar-bg { flex-grow: 1; height: 8px; background: #ddd; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        
        #game-container {
            position: relative; width: 100%; height: calc(100vh - 410px);
            background-image: radial-gradient(#ccc 1px, transparent 1px); background-size: 20px 20px;
            overflow: hidden;
        }
        .entity { position: absolute; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: all 0.1s linear; z-index: 10; }
        #player { background: var(--lime); border: 2px solid var(--dark); border-radius: 50%; font-size: 16px; z-index: 20; }
        .obs { z-index: 5; opacity: 0.8; }
        .police { z-index: 15; transition: all 0.5s ease; }

        #ui-bottom { 
            height: 270px; background: white; border-top: 2px solid #ccc;
            display: flex; flex-direction: column; align-items: center; padding-top: 15px; position: relative; z-index: 50;
        }
        #btn-online { width: 85%; padding: 20px; background: var(--lime); border: 2px solid var(--dark); border-radius: 12px; font-size: 18px; font-weight: 900; cursor: pointer; }
        #btn-offline { width: 140px; padding: 10px; background: #ff4444; color: white; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; display: none; cursor: pointer;}
        
        .joy-grid { display: none; grid-template-columns: repeat(3, 70px); grid-template-rows: repeat(2, 65px); gap: 5px; margin-top: 10px; }
        .btn-move { background: #eee; border: 1px solid #bbb; border-radius: 10px; font-size: 24px; cursor: pointer; }
        .btn-move:active { background: #ccc; }
        .up { grid-column: 2; } .left { grid-column: 1; grid-row: 2; } .down { grid-column: 2; grid-row: 2; } .right { grid-column: 3; grid-row: 2; }

        .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: white; padding: 15px 25px; border-radius: 20px; display: none; z-index: 10001; text-align: center;}
    </style>
</head>
<body>

<div id="hamburger-btn" onclick="toggleMenu()">
    <div class="line"></div><div class="line"></div><div class="line"></div>
</div>

<div id="sidebar-overlay" onclick="toggleMenu()"></div>
<div id="sidebar">
    <div class="sidebar-header">
        <span>–ú–ï–ù–Æ</span> <span onclick="toggleMenu()" style="cursor:pointer; font-size:24px;">‚úï</span>
    </div>
    <div class="sidebar-tabs">
        <div class="tab active" onclick="renderShop()">–ú–∞–≥–∞–∑–∏–Ω</div>
        <div class="tab" onclick="renderGarage()">–ì–∞—Ä–∞–∂</div>
        <div class="tab" onclick="alert('–ë–∞–Ω–∫ –∑–∞–∫—Ä—ã—Ç –Ω–∞ —Ä–µ–º–æ–Ω—Ç')">–ë–∞–Ω–∫</div>
    </div>
    <div id="menu-content" class="sidebar-content"></div>
    <div style="font-size:10px; text-align:center; padding:10px; color:#aaa;">ID: <span id="uid-disp">...</span></div>
</div>

<div id="toast" class="toast">Alert</div>

<div id="top-info">
    <div style="font-size:10px; font-weight:900; color:#999; letter-spacing:2px; margin-bottom:5px;">WARSZAWA COURIER</div>
    <div class="balance-pill"><span id="cash">0.00</span> PLN</div>
    <div id="timer-pill">‚è∞ <span id="timer-val">00:00</span></div>
    
    <div class="stats-row">
        <div class="stat-box">‚ö° <div class="bar-bg"><div id="en-bar" class="bar-fill" style="width:100%; background:orange"></div></div></div>
        <div class="stat-box">üíß <div class="bar-bg"><div id="wat-bar" class="bar-fill" style="width:100%; background:#00aaff"></div></div></div>
    </div>
    <div class="stats-row">
        <div class="stat-box" style="width:100%">üö≤ <div class="bar-bg"><div id="hp-bar" class="bar-fill" style="width:100%; background:#555"></div></div></div>
    </div>
</div>

<div id="game-container">
    <div id="player" class="entity">üö≤</div>
    <div id="target" class="entity" style="display:none"></div>
</div>

<div id="ui-bottom">
    <div id="status-text" style="margin-bottom:5px; font-weight:bold; color:#555;">–°–º–µ–Ω–∞ –Ω–µ –Ω–∞—á–∞—Ç–∞</div>
    <button id="btn-online" onclick="goOnline()">–í–´–ô–¢–ò –í –û–ù–õ–ê–ô–ù</button>
    
    <div class="joy-grid" id="controls">
        <button class="btn-move up" onclick="move(0, -30)">‚Üë</button>
        <button class="btn-move left" onclick="move(-30, 0)">‚Üê</button>
        <button class="btn-move down" onclick="move(0, 30)">‚Üì</button>
        <button class="btn-move right" onclick="move(30, 0)">‚Üí</button>
    </div>
    <button id="btn-offline" onclick="goOffline()">–ó–ê–ö–û–ù–ß–ò–¢–¨ –°–ú–ï–ù–£</button>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
        authDomain: "warszawa-courier.firebaseapp.com",
        databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "warszawa-courier",
        storageBucket: "warszawa-courier.firebasestorage.app",
        messagingSenderId: "295860613508",
        appId: "1:295860613508:web:86fe8364377d6875612dd1",
        measurementId: "G-TGSCHBVLX2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const tg = window.Telegram.WebApp;
    tg.expand();
    
    let userId = tg.initDataUnsafe?.user?.id || 'browser_static_user';
    document.getElementById('uid-disp').innerText = userId;

    // –í–ï–†–°–ò–Ø –î–ê–ù–ù–´–• –î–õ–Ø –°–ë–†–û–°–ê
    const DB_VERSION = 2; 

    let state = {
        bal: 0.00, en: 100, wat: 100, hp: 100,
        x: 30, y: 30,
        bike: 'default', bikes: ['default']
    };
    
    let isOnline = false;
    let policeUnits = [];
    let occupied = [];
    let policeTimer = null;
    let jobTimer = null;
    let currentJobPrice = 0;
    let target = {x:0, y:0, active:false, type:0};

    function loadData() {
        db.ref('users/' + userId).once('value', (s) => {
            const d = s.val();
            // –ï—Å–ª–∏ –≤–µ—Ä—Å–∏–∏ –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∞ —Å—Ç–∞—Ä–∞—è - –°–ë–†–ê–°–´–í–ê–ï–ú
            if (d && d.version === DB_VERSION) {
                state.bal = parseFloat(d.balance) || 0;
                state.en = d.energy ?? 100;
                state.wat = d.water ?? 100;
                state.hp = d.hp ?? 100;
                state.bikes = d.bikes || ['default'];
                state.bike = d.bike || 'default';
            } else {
                // –ü–û–õ–ù–´–ô –°–ë–†–û–°
                state.bal = 0.00; 
                state.en = 100; state.wat = 100; state.hp = 100;
                state.bikes = ['default']; state.bike = 'default';
                state.x = 30; state.y = 30;
                saveData(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —É–∂–µ —Å –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π
                showToast("–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ v2");
            }
            updateUI();
        });
    }
    loadData();

    function saveData() {
        db.ref('users/' + userId).update({
            version: DB_VERSION,
            balance: state.bal, energy: state.en, water: state.wat, hp: state.hp,
            bikes: state.bikes, bike: state.bike, lastLogin: Date.now()
        });
    }

    function toggleMenu() {
        const sb = document.getElementById('sidebar');
        const ov = document.getElementById('sidebar-overlay');
        if (sb.classList.contains('open')) {
            sb.classList.remove('open'); ov.style.display = 'none';
        } else {
            sb.classList.add('open'); ov.style.display = 'block';
            renderShop();
        }
    }

    function renderShop() {
        document.getElementById('menu-content').innerHTML = `
            <div class="shop-item"><div>üå≠ –•–æ—Ç-–¥–æ–≥ (+20 –≠–Ω)</div><button class="buy-btn" onclick="buy('food', 5, 20, 0)">5 PLN</button></div>
            <div class="shop-item"><div>ü•§ –í–æ–¥–∞ (+30 –í–æ–¥—ã)</div><button class="buy-btn" onclick="buy('water', 3, 0, 30)">3 PLN</button></div>
            <div class="shop-item"><div>‚ö° Red Bull (+50 –≠–Ω)</div><button class="buy-btn" onclick="buy('bull', 12, 50, 5)">12 PLN</button></div>
            <div class="shop-item"><div>üö≤ E-Bike (–≠–∫–æ–Ω–æ–º —Å–∏–ª)</div><button class="buy-btn" onclick="buyBike('ebike', 500)">500 PLN</button></div>
        `;
    }

    function renderGarage() {
        document.getElementById('menu-content').innerHTML = `
            <div style="text-align:center; padding:10px;">
                <h3>–ë–∞–π–∫: ${state.bike}</h3>
                <p>–ó–¥–æ—Ä–æ–≤—å–µ: ${state.hp.toFixed(0)}%</p>
                <button class="buy-btn" style="width:100%" onclick="repair()">–ü–æ—á–∏–Ω–∏—Ç—å (15 PLN)</button>
                <hr>
                ${state.bikes.map(b => `<div class="shop-item">${b} <button class="buy-btn" onclick="equip('${b}')">–í–∑—è—Ç—å</button></div>`).join('')}
            </div>
        `;
    }

    function buy(type, price, e, w) {
        if(state.bal >= price) {
            state.bal -= price; state.en = Math.min(100, state.en+e); state.wat = Math.min(100, state.wat+w);
            showToast("–ö—É–ø–ª–µ–Ω–æ!"); saveData(); updateUI(); renderShop();
        } else showToast("–ù–µ—Ç –¥–µ–Ω–µ–≥!");
    }
    function buyBike(id, price) {
        if(state.bikes.includes(id)) return showToast("–£–∂–µ –µ—Å—Ç—å!");
        if(state.bal >= price) {
            state.bal -= price; state.bikes.push(id); showToast("–ö—É–ø–ª–µ–Ω–æ!"); saveData(); updateUI(); renderShop();
        } else showToast("–ù–µ—Ç –¥–µ–Ω–µ–≥!");
    }
    function repair() {
        if(state.bal >= 15) {
            state.bal -= 15; state.hp = 100; showToast("–ü–æ—á–∏–Ω–∏–ª!"); saveData(); updateUI(); renderGarage();
        } else showToast("–ù–µ—Ç –¥–µ–Ω–µ–≥!");
    }
    function equip(id) { state.bike = id; showToast("–í—ã–±—Ä–∞–Ω: " + id); saveData(); renderGarage(); }

    // --- GAME LOGIC ---
    const STEP = 30;

    function goOnline() {
        if(state.en < 5) return showToast("–£—Å—Ç–∞–ª. –°—ä–µ—à—å —á—Ç–æ-–Ω–∏–±—É–¥—å.");
        if(state.hp <= 0) return showToast("–ë–∞–π–∫ —Å–ª–æ–º–∞–Ω.");
        
        isOnline = true;
        document.getElementById('btn-online').style.display = 'none';
        document.getElementById('controls').style.display = 'grid';
        document.getElementById('btn-offline').style.display = 'block';
        document.getElementById('status-text').innerText = "–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞...";
        
        spawnObstacles();
        spawnPolice();
        startJob();
        
        if (policeTimer) clearInterval(policeTimer);
        policeTimer = setInterval(movePolice, 1000); // –ë—ã—Å—Ç—Ä–∞—è –ø–æ–ª–∏—Ü–∏—è (1 —Å–µ–∫)
    }

    function goOffline() {
        isOnline = false;
        document.getElementById('btn-online').style.display = 'block';
        document.getElementById('controls').style.display = 'none';
        document.getElementById('btn-offline').style.display = 'none';
        document.getElementById('status-text').innerText = "–°–º–µ–Ω–∞ –æ–∫–æ–Ω—á–µ–Ω–∞";
        document.querySelectorAll('.obs, .police').forEach(e => e.remove());
        document.getElementById('target').style.display = 'none';
        
        clearInterval(policeTimer);
        stopTimer();
    }

    function startTimer(seconds) {
        stopTimer();
        let timeLeft = seconds;
        const timerPill = document.getElementById('timer-pill');
        timerPill.style.display = 'block';
        updateTimerDisplay(timeLeft);

        jobTimer = setInterval(() => {
            timeLeft--;
            updateTimerDisplay(timeLeft);
            if (timeLeft <= 0) {
                stopTimer();
                failJob();
            }
        }, 1000);
    }

    function stopTimer() {
        if (jobTimer) clearInterval(jobTimer);
        document.getElementById('timer-pill').style.display = 'none';
    }

    function updateTimerDisplay(sec) {
        let m = Math.floor(sec / 60);
        let s = sec % 60;
        document.getElementById('timer-val').innerText = `${m}:${s < 10 ? '0'+s : s}`;
    }

    function failJob() {
        showToast("–í–†–ï–ú–Ø –í–´–®–õ–û! -5 PLN");
        state.bal = state.bal - 5; // –£—Ö–æ–¥–∏–º –≤ –º–∏–Ω—É—Å –µ—Å–ª–∏ –Ω–∞–¥–æ
        saveData(); updateUI();
        startJob(); // –ò—â–µ–º –Ω–æ–≤—ã–π
    }

    function spawnObstacles() {
        occupied = [];
        document.querySelectorAll('.obs').forEach(e => e.remove());
        const box = document.getElementById('game-container');
        const cols = Math.floor(box.offsetWidth/STEP);
        const rows = Math.floor(box.offsetHeight/STEP);
        
        for(let i=0; i<15; i++) {
            let ox = Math.floor(Math.random()*cols)*STEP;
            let oy = Math.floor(Math.random()*rows)*STEP;
            if(Math.abs(ox-state.x)+Math.abs(oy-state.y) > 90) {
                occupied.push({x:ox, y:oy});
                let d = document.createElement('div');
                d.className = 'entity obs'; d.innerText = 'üöß';
                d.style.left = ox+'px'; d.style.top = oy+'px';
                box.appendChild(d);
            }
        }
    }

    function spawnPolice() {
        policeUnits = [];
        document.querySelectorAll('.police').forEach(e => e.remove());
        const box = document.getElementById('game-container');
        const cols = Math.floor(box.offsetWidth/STEP);
        const rows = Math.floor(box.offsetHeight/STEP);
        
        // 6 –ü–û–õ–ò–¶–ï–ô–°–ö–ò–•
        for(let i=0; i<6; i++) {
            let px = Math.floor(Math.random()*cols)*STEP;
            let py = Math.floor(Math.random()*rows)*STEP;
            if(!occupied.some(o=>o.x===px && o.y===py) && Math.abs(px-state.x)>120) {
                let d = document.createElement('div');
                d.className = 'entity police'; d.innerText = 'üöì';
                d.style.left = px+'px'; d.style.top = py+'px';
                box.appendChild(d);
                policeUnits.push({x:px, y:py, el:d});
            }
        }
    }

    function movePolice() {
        if(!isOnline) return;
        const box = document.getElementById('game-container');
        const cols = Math.floor(box.offsetWidth/STEP);
        const rows = Math.floor(box.offsetHeight/STEP);

        policeUnits.forEach(p => {
            let dirs = [{dx:0, dy:-30}, {dx:0, dy:30}, {dx:-30, dy:0}, {dx:30, dy:0}];
            let m = dirs[Math.floor(Math.random()*4)];
            let nx = p.x + m.dx; let ny = p.y + m.dy;
            
            if(nx>=0 && ny>=0 && nx<cols*STEP && ny<rows*STEP && !occupied.some(o=>o.x===nx && o.y===ny)) {
                p.x = nx; p.y = ny;
                p.el.style.left = nx+'px'; p.el.style.top = ny+'px';
            }
            if(Math.abs(p.x-state.x)<10 && Math.abs(p.y-state.y)<10) {
                showToast("–ü–û–õ–ò–¶–ò–Ø! –®–¢–†–ê–§ 50 PLN!");
                state.bal = state.bal - 50;
                state.x = 30; state.y = 30;
                saveData(); updateUI();
            }
        });
    }

    function move(dx, dy) {
        if(!isOnline) return;
        if(state.en <= 0) { showToast("–ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏!"); toggleMenu(); return; }
        if(state.hp <= 0) { showToast("–ë–∞–π–∫ —Å–ª–æ–º–∞–Ω!"); toggleMenu(); return; }

        let nx = state.x + dx; let ny = state.y + dy;
        const box = document.getElementById('game-container');
        const cols = Math.floor(box.offsetWidth/STEP);
        const rows = Math.floor(box.offsetHeight/STEP);

        if(nx<0 || ny<0 || nx>=cols*STEP || ny>=rows*STEP) return;
        if(occupied.some(o=>o.x===nx && o.y===ny)) { showToast("–¢—É–ø–∏–∫"); return; }
        if(policeUnits.some(p=>p.x===nx && p.y===ny)) { 
            showToast("–®–¢–†–ê–§ 50 PLN!"); state.bal= state.bal-50; 
            state.x=30; state.y=30; updateUI(); return; 
        }

        state.x = nx; state.y = ny;
        let drain = (state.bike === 'ebike') ? 0.3 : 1.0;
        state.en -= drain; state.wat -= 0.5; state.hp -= 0.2;
        
        checkJob();
        updateUI(); saveData();
    }

    function startJob() {
        target.type = 1; 
        let jd = spawnTarget('üçï'); 
        // –í—Ä–µ–º—è: –¥–∏—Å—Ç–∞–Ω—Ü–∏—è + –∑–∞–ø–∞—Å 10—Å
        let time = Math.ceil(jd.steps * 1.0) + 10;
        startTimer(time);
        document.getElementById('status-text').innerText = "–ó–∞–∫–∞–∑: –ó–∞–±–µ—Ä–∏ –ø–∏—Ü—Ü—É";
    }

    function spawnTarget(icon) {
        const box = document.getElementById('game-container');
        const cols = Math.floor(box.offsetWidth/STEP);
        const rows = Math.floor(box.offsetHeight/STEP);
        
        let tx, ty, ok=false, dist=0;
        while(!ok) {
            tx = Math.floor(Math.random()*cols)*STEP;
            ty = Math.floor(Math.random()*rows)*STEP;
            ok = !occupied.some(o=>o.x===tx && o.y===ty) && Math.abs(tx-state.x)>60;
            if(ok) dist = (Math.abs(tx-state.x)+Math.abs(ty-state.y))/STEP;
        }
        target.x = tx; target.y = ty; target.active = true;
        const el = document.getElementById('target');
        el.style.display = 'flex'; el.innerText = icon;
        el.style.left = tx+'px'; el.style.top = ty+'px';
        return {steps: dist};
    }

    function checkJob() {
        if(target.active && state.x === target.x && state.y === target.y) {
            stopTimer();

            if(target.type === 1) {
                target.type = 2; 
                showToast("–ü–∏—Ü—Ü–∞ —É —Ç–µ–±—è!");
                let jd = spawnTarget('üìç');
                
                // –û–ü–õ–ê–¢–ê = –®–ê–ì–ò * 1.5
                currentJobPrice = Math.ceil(jd.steps * 1.5);
                
                // –í–†–ï–ú–Ø = –®–ê–ì–ò * 1.2—Å + 5—Å (–∂–µ—Å—Ç—á–µ)
                let time = Math.ceil(jd.steps * 1.2) + 5;
                startTimer(time);

                document.getElementById('status-text').innerText = `–í–µ–∑–∏ –∫–ª–∏–µ–Ω—Ç—É! –ù–∞–≥—Ä–∞–¥–∞: ${currentJobPrice} PLN`;
            } else if(target.type === 2) {
                state.bal += currentJobPrice; 
                showToast(`+${currentJobPrice} PLN`);
                startJob();
            }
        }
    }

    function updateUI() {
        document.getElementById('cash').innerText = state.bal.toFixed(2);
        document.getElementById('en-bar').style.width = Math.max(0, state.en) + '%';
        document.getElementById('wat-bar').style.width = Math.max(0, state.wat) + '%';
        document.getElementById('hp-bar').style.width = Math.max(0, state.hp) + '%';
        const p = document.getElementById('player');
        p.style.left = state.x + 'px'; p.style.top = state.y + 'px';
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 1500);
    }
</script>
</body>
</html>
