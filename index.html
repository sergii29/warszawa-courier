<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warsaw Courier: Survival</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #f4f4dc; --grid: #dcdcc0; --lime: #ccff00; --dark: #121212; --danger: #ff3b3b; --blue: #007bff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; font-family: 'Courier New', Courier, monospace; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); }

        /* –ò–ù–¢–ï–†–§–ï–ô–° */
        #top-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 140px;
            background: rgba(255,255,255,0.95); border-bottom: 2px solid var(--dark);
            z-index: 100; padding: 10px; display: flex; flex-direction: column; align-items: center;
        }

        /* –ú–ï–ù–Æ */
        #burger {
            position: absolute; top: 15px; left: 15px; width: 45px; height: 45px;
            background: var(--dark); border-radius: 8px; cursor: pointer; z-index: 101;
            display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 5px;
        }
        .b-line { width: 25px; height: 3px; background: var(--lime); }

        /* STATS */
        .wallet-box { font-size: 20px; font-weight: bold; margin-bottom: 5px; color: var(--dark); border-bottom: 1px dashed #aaa; width: 100%; text-align: center; padding-bottom: 5px;}
        .level-badge { font-size: 10px; background: var(--dark); color: var(--lime); padding: 2px 6px; border-radius: 4px; position: absolute; top: 15px; right: 15px; }
        
        .bars { width: 100%; max-width: 300px; display: flex; flex-direction: column; gap: 4px; font-size: 10px; font-weight: bold; }
        .bar-row { display: flex; align-items: center; justify-content: space-between; }
        .bar-track { flex-grow: 1; height: 8px; background: #ddd; margin-left: 5px; border: 1px solid #999; border-radius: 4px; overflow: hidden; }
        .bar-val { height: 100%; transition: width 0.3s; }

        /* –ò–ì–†–û–í–û–ï –ü–û–õ–ï */
        #game-area {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(var(--grid) 1px, transparent 1px), linear-gradient(90deg, var(--grid) 1px, transparent 1px);
            background-size: 30px 30px; z-index: 1;
        }
        .entity { position: absolute; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: all 0.1s linear; }
        #player { z-index: 10; font-size: 22px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }
        .police { z-index: 5; transition: top 1s linear, left 1s linear; } /* –ü–ª–∞–≤–Ω–∞—è –ø–æ–ª–∏—Ü–∏—è */
        
        /* –ù–ò–ñ–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ */
        #bot-ui {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 260px;
            background: rgba(255,255,255,0.95); border-top: 2px solid var(--dark);
            z-index: 100; display: flex; flex-direction: column; align-items: center; padding-top: 10px;
        }
        
        #status-msg { font-weight: bold; margin-bottom: 10px; font-size: 14px; text-align: center; color: #555; height: 20px;}
        .timer-box { color: var(--danger); font-weight: 900; font-size: 18px; display: none; margin-bottom: 5px;}

        /* –î–ñ–û–ô–°–¢–ò–ö */
        .joy-pad { display: grid; grid-template-columns: 70px 70px 70px; grid-template-rows: 60px 60px; gap: 5px; }
        .j-btn { width: 100%; height: 100%; background: #eee; border: 1px solid #999; border-radius: 12px; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; -webkit-user-select: none; }
        .j-btn:active { background: #ccc; transform: scale(0.95); }
        .u { grid-column: 2; grid-row: 1; }
        .l { grid-column: 1; grid-row: 2; }
        .d { grid-column: 2; grid-row: 2; }
        .r { grid-column: 3; grid-row: 2; }

        /* –ö–ù–û–ü–ö–ò */
        .big-btn { background: var(--lime); color: var(--dark); border: 2px solid var(--dark); padding: 15px 40px; font-weight: bold; font-size: 16px; border-radius: 8px; cursor: pointer; margin-top: 40px;}
        .off-btn { background: var(--danger); color: white; border: none; padding: 5px 15px; border-radius: 4px; position: absolute; top: 10px; right: 10px; font-weight: bold;}

        /* –ú–û–î–ê–õ–ö–ò (–ú–ï–ù–Æ, –ó–ê–ö–ê–ó) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: none; align-items: center; justify-content: center; }
        
        /* SIDEBAR */
        #sidebar { 
            position: fixed; top: 0; left: -320px; width: 85%; height: 100%; background: white; 
            z-index: 2001; transition: 0.2s; border-right: 3px solid var(--dark); display: flex; flex-direction: column;
        }
        #sidebar.open { left: 0; }
        .sb-head { padding: 20px; background: var(--dark); color: var(--lime); display: flex; justify-content: space-between; font-weight: bold; align-items: center; }
        .tabs { display: flex; background: #eee; padding: 5px; }
        .tab { flex: 1; text-align: center; padding: 10px; font-size: 12px; border: 1px solid #ccc; background: white; cursor: pointer; }
        .tab.active { background: var(--lime); border-color: black; font-weight: bold; }
        .sb-body { flex: 1; overflow-y: auto; padding: 10px; }
        
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .price-tag { font-weight: bold; color: var(--danger); }
        
        /* ORDER POPUP */
        .popup { background: white; border: 3px solid var(--dark); padding: 20px; width: 90%; max-width: 350px; text-align: center; border-radius: 10px; box-shadow: 10px 10px 0 rgba(0,0,0,0.2); }
        .rest-name { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: var(--dark); border-bottom: 2px solid var(--lime); display: inline-block;}
        .order-info { margin: 15px 0; font-size: 14px; text-align: left; background: #f9f9f9; padding: 10px; border-radius: 5px;}
        .p-actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .btn-acc { background: var(--lime); border: 2px solid black; padding: 10px 20px; font-weight: bold; flex: 1; }
        .btn-dec { background: #eee; border: 2px solid #999; padding: 10px 20px; font-weight: bold; flex: 1; }

        /* TOAST */
        #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.85); color: white; padding: 15px 20px; border-radius: 20px; display: none; z-index: 5000; text-align: center; max-width: 80%; }
    </style>
</head>
<body>

<div id="top-ui">
    <div class="wallet-box">
        üíµ <span id="cash-disp">0.00</span> | üè¶ <span id="bank-disp">0.00</span>
    </div>
    <div class="level-badge">LVL <span id="lvl-disp">1</span></div>
    
    <div class="bars">
        <div class="bar-row">‚ö° <div class="bar-track"><div id="bar-en" class="bar-val" style="width:100%; background:orange"></div></div></div>
        <div class="bar-row">üíß <div class="bar-track"><div id="bar-wat" class="bar-val" style="width:100%; background:#00aaff"></div></div></div>
        <div class="bar-row">üö≤ <div class="bar-track"><div id="bar-hp" class="bar-val" style="width:100%; background:#555"></div></div></div>
    </div>
</div>

<div id="burger" onclick="openMenu()">
    <div class="b-line"></div><div class="b-line"></div><div class="b-line"></div>
</div>

<div id="game-area">
    <div id="player" class="entity">üö≤</div>
    <div id="target" class="entity" style="display:none"></div>
</div>

<div id="bot-ui">
    <div id="status-msg">–°–º–µ–Ω–∞ –Ω–µ –Ω–∞—á–∞—Ç–∞</div>
    <div id="timer-box" class="timer-box">‚è∞ <span id="timer-val">00:00</span></div>

    <button id="btn-start" class="big-btn" onclick="startShift()">–ù–ê–ß–ê–¢–¨ –°–ú–ï–ù–£</button>
    <button id="btn-stop" class="off-btn" style="display:none" onclick="endShift()">X</button>

    <div id="controls" class="joy-pad" style="display:none">
        <div class="j-btn u" ontouchstart="move(0,-1); event.preventDefault()" onmousedown="move(0,-1)">‚Üë</div>
        <div class="j-btn l" ontouchstart="move(-1,0); event.preventDefault()" onmousedown="move(-1,0)">‚Üê</div>
        <div class="j-btn d" ontouchstart="move(0,1); event.preventDefault()" onmousedown="move(0,1)">‚Üì</div>
        <div class="j-btn r" ontouchstart="move(1,0); event.preventDefault()" onmousedown="move(1,0)">‚Üí</div>
    </div>
</div>

<div id="menu-overlay" class="modal-overlay" onclick="closeMenu()"></div>
<div id="sidebar">
    <div class="sb-head">
        <span>WARSZAWA MENU</span> <span onclick="closeMenu()" style="font-size:20px">‚úï</span>
    </div>
    <div class="tabs">
        <div class="tab active" onclick="tab('shop')">–ú–∞–≥–∞–∑–∏–Ω</div>
        <div class="tab" onclick="tab('garage')">–ì–∞—Ä–∞–∂</div>
        <div class="tab" onclick="tab('bank')">–ë–∞–Ω–∫</div>
    </div>
    <div id="menu-content" class="sb-body"></div>
    <div style="font-size:10px; text-align:center; padding:5px; color:#aaa">ID: <span id="uid">...</span> v3.0</div>
</div>

<div id="job-modal" class="modal-overlay">
    <div class="popup">
        <div class="rest-name" id="job-rest">Pizzeria Mario</div>
        <div class="order-info">
            <div>üìè –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: <b id="job-dist">0</b> –∫–º</div>
            <div>üí∞ –û–ø–ª–∞—Ç–∞: <b id="job-pay" style="color:green; font-size:16px">0.00</b> PLN</div>
            <hr>
            <div style="font-size:11px; color:#555">–¶–µ–Ω—ã –∏ –æ–ø–ª–∞—Ç–∞ –∏–Ω–¥–µ–∫—Å–∏—Ä—É—é—Ç—Å—è —É—Ä–æ–≤–Ω–µ–º –∏–Ω—Ñ–ª—è—Ü–∏–∏.</div>
        </div>
        <div class="p-actions">
            <button class="btn-dec" onclick="rejectJob()">–û—Ç–∫–∞–∑–∞—Ç—å—Å—è</button>
            <button class="btn-acc" onclick="acceptJob()">–í–ó–Ø–¢–¨ –ó–ê–ö–ê–ó</button>
        </div>
    </div>
</div>

<div id="toast">Message</div>

<script>
    // --- FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
        authDomain: "warszawa-courier.firebaseapp.com",
        databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "warszawa-courier",
        storageBucket: "warszawa-courier.firebasestorage.app",
        messagingSenderId: "295860613508",
        appId: "1:295860613508:web:86fe8364377d6875612dd1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- USER & DATA ---
    const tg = window.Telegram.WebApp; 
    tg.expand();
    const userId = tg.initDataUnsafe?.user?.id || 'browser_dev_user_3';
    document.getElementById('uid').innerText = userId;

    const DB_VER = 3; // –°–ë–†–û–° –î–ê–ù–ù–´–• –î–õ–Ø –ù–û–í–û–ô –≠–ö–û–ù–û–ú–ò–ö–ò
    const STEP = 30; // px
    
    // –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    let st = {
        bal: 0.00, bank: 0.00, lvl: 1,
        en: 100, wat: 100, hp: 100,
        x: 30, y: 30,
        bike: 'default', bikes: ['default']
    };

    let isShift = false;
    let police = [];
    let obs = [];
    let loops = {};
    let target = { active: false, x:0, y:0, type:0, offer:null };
    
    // –†–µ—Å—Ç–æ—Ä–∞–Ω—ã –¥–ª—è –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã
    const RESTAURANTS = ["Pizzeria Mario", "Kebab King", "Pan Kanapka", "Pierogi World", "Burger Wwa", "Sushi Master", "Zapiekanki Center"];

    // --- LOAD/SAVE ---
    function init() {
        db.ref('users/' + userId).once('value', s => {
            const d = s.val();
            if(d && d.ver === DB_VER) {
                st = {...st, ...d}; // Merge saved data
            } else {
                save(); // Create new profile
                showToast("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –í–∞—Ä—à–∞–≤—É (v3.0)");
            }
            renderTop();
        });
    }

    function save() {
        db.ref('users/' + userId).set({
            ver: DB_VER, ...st, last: Date.now()
        });
    }

    // --- GAME LOOP & LOGIC ---
    function startShift() {
        if(st.en < 10) return showToast("–°–ª–∏—à–∫–æ–º –≥–æ–ª–æ–¥–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã!");
        if(st.hp <= 0) return showToast("–í–µ–ª–∏–∫ —Å–ª–æ–º–∞–Ω. –í —Ä–µ–º–æ–Ω—Ç!");

        isShift = true;
        document.getElementById('btn-start').style.display = 'none';
        document.getElementById('controls').style.display = 'grid';
        document.getElementById('btn-stop').style.display = 'block';
        document.getElementById('status-msg').innerText = "–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤...";
        
        spawnWorld();
        newJobPhase(1); // Find pizza

        // Police loop
        if(loops.pol) clearInterval(loops.pol);
        loops.pol = setInterval(movePolice, 1000);
    }

    function endShift() {
        isShift = false;
        clearInterval(loops.timer);
        clearInterval(loops.pol);
        document.getElementById('btn-start').style.display = 'block';
        document.getElementById('controls').style.display = 'none';
        document.getElementById('btn-stop').style.display = 'none';
        document.getElementById('timer-box').style.display = 'none';
        document.getElementById('target').style.display = 'none';
        document.getElementById('status-msg').innerText = "–°–º–µ–Ω–∞ –æ–∫–æ–Ω—á–µ–Ω–∞";
        
        // Clear entities
        document.querySelectorAll('.obs, .police').forEach(e => e.remove());
        obs = []; police = [];
    }

    function move(dx, dy) {
        if(!isShift) return;
        // Check Menu Block
        if(document.getElementById('sidebar').classList.contains('open')) return;

        if(st.en <= 0 || st.hp <= 0) {
            showToast("–ù–µ—Ç —Å–∏–ª –∏–ª–∏ –±–∞–π–∫ —Å–ª–æ–º–∞–Ω!");
            endShift(); openMenu(); return;
        }

        const box = document.getElementById('game-area');
        const cols = Math.floor(box.offsetWidth/STEP);
        const rows = Math.floor(box.offsetHeight/STEP);
        
        let nx = st.x + (dx * STEP);
        let ny = st.y + (dy * STEP);

        // Bounds
        if(nx < 0 || ny < 0 || nx >= cols*STEP || ny >= rows*STEP) return;
        
        // Obstacles
        if(obs.some(o => o.x === nx && o.y === ny)) {
            showToast("–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ!"); return;
        }

        // Police Collision (Instant Fine)
        if(police.some(p => p.x === nx && p.y === ny)) {
            finePlayer(); return;
        }

        // Apply Move
        st.x = nx; st.y = ny;
        const drain = st.bike === 'ebike' ? 0.2 : 0.8;
        st.en -= drain; st.wat -= 0.4; st.hp -= 0.15; // Iznos
        
        renderPlayer();
        renderTop();
        checkTarget();
        save();
    }

    // --- JOBS & ECONOMY ---
    
    // –ò–Ω—Ñ–ª—è—Ü–∏—è: 10% –∑–∞ –∫–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å
    function getInflation() { return 1 + (st.lvl - 1) * 0.10; }

    function newJobPhase(phase) {
        // Phase 1: Spawn Pizza, Phase 2: Spawn Client
        target.type = phase;
        let t = spawnRandomPoint();
        target.x = t.x; target.y = t.y; target.active = true;
        
        const el = document.getElementById('target');
        el.style.display = 'flex';
        el.style.left = t.x + 'px'; el.style.top = t.y + 'px';
        
        if(phase === 1) {
            el.innerText = 'üçï';
            document.getElementById('status-msg').innerText = "–ï–¥—å –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω";
            // Timer logic for pickup? Let's keep it simple for pickup, strict for delivery
            setTimer(30 + t.dist); 
        } else {
            el.innerText = 'üë§';
            document.getElementById('status-msg').innerText = "–í–µ–∑–∏ –∫–ª–∏–µ–Ω—Ç—É!";
             // Strict timer for delivery
            setTimer(15 + Math.ceil(t.dist * 1.2));
        }
    }

    function checkTarget() {
        if(!target.active) return;
        if(st.x === target.x && st.y === target.y) {
            if(target.type === 1) {
                // Arrived at restaurant -> Show Offer
                target.active = false; // Stop checking
                clearInterval(loops.timer); // Pause timer
                
                // Calculate realistic Offer
                let distToClient = Math.floor(Math.random() * 20) + 5; // Simulating next leg
                let basePay = distToClient * 1.5; 
                let finalPay = (basePay * getInflation()).toFixed(2);
                let rName = RESTAURANTS[Math.floor(Math.random() * RESTAURANTS.length)];

                // Store offer data
                target.offer = { dist: distToClient, pay: parseFloat(finalPay) };
                
                // Show UI
                document.getElementById('job-rest').innerText = rName;
                document.getElementById('job-dist').innerText = distToClient;
                document.getElementById('job-pay').innerText = finalPay;
                document.getElementById('job-modal').style.display = 'flex';

            } else if (target.type === 2) {
                // Delivered
                finishJob(true);
            }
        }
    }

    function acceptJob() {
        document.getElementById('job-modal').style.display = 'none';
        showToast("–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!");
        newJobPhase(2); // Spawn client
    }

    function rejectJob() {
        document.getElementById('job-modal').style.display = 'none';
        showToast("–û—Ç–∫–∞–∑. –®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ—Å—Ç–æ–π -2 PLN");
        st.bal -= 2; // Small penalty
        renderTop();
        newJobPhase(1); // Find new pizza
    }

    function finishJob(success) {
        clearInterval(loops.timer);
        target.active = false;
        document.getElementById('target').style.display = 'none';
        document.getElementById('timer-box').style.display = 'none';

        if(success) {
            let pay = target.offer.pay;
            st.bal += pay;
            showToast(`–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ! +${pay} PLN`);
        } else {
            showToast("–ù–µ —É—Å–ø–µ–ª! –®—Ç—Ä–∞—Ñ -5 PLN");
            st.bal -= 5;
        }
        save();
        renderTop();
        
        // Next job after delay
        setTimeout(() => { if(isShift) newJobPhase(1); }, 2000);
    }

    // --- TIMERS & POLICE ---
    function setTimer(sec) {
        clearInterval(loops.timer);
        let t = sec;
        const box = document.getElementById('timer-box');
        const val = document.getElementById('timer-val');
        box.style.display = 'block';
        
        loops.timer = setInterval(() => {
            t--;
            let m = Math.floor(t/60);
            let s = t%60;
            val.innerText = `${m}:${s<10?'0'+s:s}`;
            if(t <= 0) {
                finishJob(false);
            }
        }, 1000);
    }

    function spawnWorld() {
        const box = document.getElementById('game-area');
        const cols = Math.floor(box.offsetWidth/STEP);
        const rows = Math.floor(box.offsetHeight/STEP);
        
        // Obs
        for(let i=0; i<12; i++) {
            let p = getEmptyPos(cols, rows);
            obs.push(p);
            let el = document.createElement('div');
            el.className = 'entity obs'; el.innerText = 'üöß';
            el.style.left = p.x+'px'; el.style.top = p.y+'px';
            box.appendChild(el);
        }
        // Police (More vigilance)
        for(let i=0; i<6; i++) {
            let p = getEmptyPos(cols, rows);
            let el = document.createElement('div');
            el.className = 'entity police'; el.innerText = 'üöì';
            el.style.left = p.x+'px'; el.style.top = p.y+'px';
            box.appendChild(el);
            police.push({x:p.x, y:p.y, el:el});
        }
    }

    function movePolice() {
        if(!isShift) return;
        const box = document.getElementById('game-area');
        const cols = Math.floor(box.offsetWidth/STEP);
        const rows = Math.floor(box.offsetHeight/STEP);

        police.forEach(p => {
            let moves = [{x:0,y:-STEP}, {x:0,y:STEP}, {x:-STEP,y:0}, {x:STEP,y:0}];
            let m = moves[Math.floor(Math.random()*4)];
            let nx = p.x + m.x; let ny = p.y + m.y;
            
            // Basic bounds check
            if(nx>=0 && ny>=0 && nx<cols*STEP && ny<rows*STEP) {
                p.x = nx; p.y = ny;
                p.el.style.left = nx+'px'; p.el.style.top = ny+'px';
            }
            // Check catch
            if(Math.abs(p.x - st.x) < 10 && Math.abs(p.y - st.y) < 10) {
                finePlayer();
            }
        });
    }

    function finePlayer() {
        showToast("–ü–û–õ–ò–¶–ò–Ø! –®–¢–†–ê–§ 50 PLN!");
        st.bal -= 50; // Bank money is safe, cash is taken
        st.x = 30; st.y = 30; // Respawn home
        renderPlayer(); renderTop(); save();
    }

    function getEmptyPos(cols, rows) {
        while(true) {
            let x = Math.floor(Math.random()*cols)*STEP;
            let y = Math.floor(Math.random()*rows)*STEP;
            // Simple check away from player
            if(Math.abs(x-st.x) > 60 && !obs.some(o=>o.x===x && o.y===y)) {
                return {x,y};
            }
        }
    }
    
    function spawnRandomPoint() {
        const box = document.getElementById('game-area');
        const cols = Math.floor(box.offsetWidth/STEP);
        const rows = Math.floor(box.offsetHeight/STEP);
        let p = getEmptyPos(cols, rows);
        let dist = (Math.abs(p.x-st.x) + Math.abs(p.y-st.y))/STEP;
        return {...p, dist};
    }

    // --- MENU & SYSTEM ---
    function openMenu() { 
        document.getElementById('sidebar').classList.add('open'); 
        document.getElementById('menu-overlay').style.display = 'flex';
        tab('shop'); // Default tab
    }
    function closeMenu() { 
        document.getElementById('sidebar').classList.remove('open'); 
        document.getElementById('menu-overlay').style.display = 'none';
    }

    // Helper to calculate price based on inflation
    function p(base) { return Math.ceil(base * getInflation()); }

    function tab(name) {
        const c = document.getElementById('menu-content');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active'); // Highlight tab logic simplified for brevity

        if(name === 'shop') {
            c.innerHTML = `
                <div class="item-row"><div>üå≠ –•–æ—Ç-–¥–æ–≥ (+20 En)</div> <div class="price-tag" onclick="buy('en', 20, ${p(8)})">${p(8)} PLN</div></div>
                <div class="item-row"><div>ü•§ –í–æ–¥–∞ (+30 Wat)</div> <div class="price-tag" onclick="buy('wat', 30, ${p(5)})">${p(5)} PLN</div></div>
                <div class="item-row"><div>‚ö° Red Bull (+50 En)</div> <div class="price-tag" onclick="buy('bull', 50, ${p(15)})">${p(15)} PLN</div></div>
                <div class="item-row" style="margin-top:20px; font-size:11px; color:#777">–ò–Ω—Ñ–ª—è—Ü–∏—è: +${((getInflation()-1)*100).toFixed(0)}%</div>
            `;
        } else if(name === 'garage') {
            c.innerHTML = `
                <div style="text-align:center; padding:10px; border:1px solid #ddd; border-radius:8px;">
                    <h3>üîß –°–µ—Ä–≤–∏—Å</h3>
                    <p>–°–æ—Å—Ç–æ—è–Ω–∏–µ: ${st.hp.toFixed(0)}%</p>
                    <button class="big-btn" style="width:100%; margin-top:5px; background:#eee; font-size:14px" onclick="repairBike()">–ü–æ—á–∏–Ω–∏—Ç—å (${p(20)} PLN)</button>
                    <p style="font-size:10px; margin-top:5px">–†–µ–º–æ–Ω—Ç –ø–æ–≤—ã—à–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å –∏ —Ü–µ–Ω—ã (–ò–Ω—Ñ–ª—è—Ü–∏—è)</p>
                </div>
            `;
        } else if(name === 'bank') {
            c.innerHTML = `
                <div style="text-align:center; padding:10px;">
                    <h3>PKO Bank Polski</h3>
                    <div style="font-size:30px; margin:10px">üè¶ ${st.bank.toFixed(2)}</div>
                    <p style="font-size:12px; color:#555">–î–µ–Ω—å–≥–∏ –≤ –±–∞–Ω–∫–µ –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç —à—Ç—Ä–∞—Ñ–æ–≤.</p>
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button class="btn-acc" onclick="bankOp('dep')">–í–∫–ª–∞–¥</button>
                        <button class="btn-dec" onclick="bankOp('wit')">–°–Ω—è—Ç—å</button>
                    </div>
                </div>
            `;
        }
    }

    function buy(type, val, cost) {
        if(st.bal >= cost) {
            st.bal -= cost;
            if(type === 'en' || type === 'bull') st.en = Math.min(100, st.en + val);
            if(type === 'wat') st.wat = Math.min(100, st.wat + val);
            showToast("–ö—É–ø–ª–µ–Ω–æ!"); save(); renderTop(); tab('shop');
        } else showToast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥!");
    }

    function repairBike() {
        let cost = p(20);
        if(st.bal >= cost) {
            st.bal -= cost;
            st.hp = 100;
            st.lvl++; // LEVEL UP
            showToast(`–ë–∞–π–∫ –∫–∞–∫ –Ω–æ–≤—ã–π! –£—Ä–æ–≤–µ–Ω—å ${st.lvl}. –¶–µ–Ω—ã –≤—ã—Ä–æ—Å–ª–∏!`);
            save(); renderTop(); tab('garage');
        } else showToast("–ù–µ—Ç –¥–µ–Ω–µ–≥ –Ω–∞ —Ä–µ–º–æ–Ω—Ç.");
    }

    function bankOp(op) {
        if(op === 'dep') {
            if(st.bal > 0) {
                st.bank += st.bal; st.bal = 0;
                showToast("–í—Å–µ –¥–µ–Ω—å–≥–∏ –ø–æ–ª–æ–∂–µ–Ω—ã –≤ –±–∞–Ω–∫");
            }
        } else {
            if(st.bank > 0) {
                st.bal += st.bank; st.bank = 0;
                showToast("–î–µ–Ω—å–≥–∏ —Å–Ω—è—Ç—ã");
            }
        }
        save(); renderTop(); tab('bank');
    }

    function renderPlayer() {
        const p = document.getElementById('player');
        p.style.left = st.x + 'px'; p.style.top = st.y + 'px';
    }

    function renderTop() {
        document.getElementById('cash-disp').innerText = st.bal.toFixed(2);
        document.getElementById('bank-disp').innerText = st.bank.toFixed(2);
        document.getElementById('lvl-disp').innerText = st.lvl;
        
        document.getElementById('bar-en').style.width = Math.max(0, st.en)+'%';
        document.getElementById('bar-wat').style.width = Math.max(0, st.wat)+'%';
        document.getElementById('bar-hp').style.width = Math.max(0, st.hp)+'%';
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = 'block';
        setTimeout(()=>t.style.display='none', 2000);
    }

    // Init
    init();

</script>
</body>
</html>
