<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warsaw Courier Tycoon: Realism Update</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* –û–°–ù–û–í–ù–û–ô –°–¢–ò–õ–¨ */
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; background: #121212; color: #fff; overflow: hidden; user-select: none; }
        
        #map { height: 100vh; width: 100vw; z-index: 1; background: #1a1a1a; }

        /* –ò–ö–û–ù–ö–ò –ù–ê –ö–ê–†–¢–ï */
        .emoji-icon {
            font-size: 24px;
            text-align: center;
            line-height: 24px;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
            transition: all 0.5s linear; /* –ü–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ */
        }
        .office-icon-div { font-size: 30px; filter: drop-shadow(0 0 5px #00e676); }
        .rest-icon-div { font-size: 24px; filter: drop-shadow(0 0 3px #ff9800); cursor: pointer; }
        
        /* UI –°–õ–û–ò */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1000; display: flex; flex-direction: column; justify-content: space-between;
        }

        /* –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ */
        .top-bar {
            background: rgba(20, 20, 20, 0.95);
            padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            pointer-events: auto; border-bottom: 2px solid #00e676; backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
        }
        .balance-display { font-size: 1.2rem; font-weight: bold; color: #00e676; }
        .office-timer { font-family: monospace; color: #ff5252; font-weight: bold; }

        /* –õ–û–ì–ò */
        .log-container {
            position: absolute; top: 70px; right: 10px; width: 250px;
            background: linear-gradient(to left, rgba(0,0,0,0.9), rgba(0,0,0,0));
            padding: 10px; border-radius: 8px; pointer-events: none;
            font-size: 0.7rem; color: #ddd; max-height: 200px; overflow: hidden;
            text-shadow: 1px 1px 2px black; text-align: right;
        }
        .log-entry { margin-bottom: 4px; opacity: 0.9; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ */
        .bottom-bar {
            background: rgba(20, 20, 20, 0.98); padding: 15px; pointer-events: auto;
            border-top: 1px solid #333; display: flex; gap: 10px; overflow-x: auto;
            padding-bottom: 25px; /* –î–ª—è iOS Safe Area */
        }
        .btn-menu {
            flex: 1; padding: 14px; border: 1px solid #444; background: #222; color: #fff;
            border-radius: 10px; font-weight: 600; cursor: pointer; white-space: nowrap;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s;
        }
        .btn-menu:active { transform: scale(0.96); }
        .btn-rent { background: #b71c1c; border-color: #d32f2f; }
        
        /* –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000; display: none;
            justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.open { opacity: 1; }
        
        .modal-content {
            background: #1e1e1e; width: 90%; max-width: 500px;
            border-radius: 15px; padding: 25px; max-height: 85vh; overflow-y: auto;
            border: 1px solid #444; position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        .close-btn {
            position: absolute; top: 15px; right: 20px; font-size: 24px; color: #888; cursor: pointer;
        }
        
        h2, h3 { color: #fff; margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        /* Dashboard Stats Grid */
        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .dash-card { background: #2a2a2a; padding: 15px; border-radius: 10px; }
        .dash-card h4 { margin: 0; color: #aaa; font-size: 0.8rem; }
        .dash-card .val { font-size: 1.2rem; font-weight: bold; margin-top: 5px; }
        .text-green { color: #00e676; }
        .text-red { color: #ff5252; }
        
        /* START SCREEN */
        #setup-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #121212; z-index: 3000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center; padding: 30px;
        }
        .welcome-box {
            border: 2px solid #00e676; padding: 30px; border-radius: 20px;
            background: #1a1a1a; max-width: 400px; width: 100%;
        }

    </style>
</head>
<body>

    <div id="setup-screen">
        <div class="welcome-box">
            <h1 style="color: #00e676; margin-bottom: 10px;">üì¶ Warsaw Courier CEO</h1>
            <p style="color: #ccc; margin-bottom: 30px;">–°–∏–º—É–ª—è—Ç–æ—Ä –∫—É—Ä—å–µ—Ä—Å–∫–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞</p>
            
            <div id="setup-loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
            
            <div id="setup-actions" style="display:none;">
                <p>–í–∞—à–∞ —Ñ–∏—Ä–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ.</p>
                <button onclick="startGame()" class="btn-menu" style="background: #00e676; color: #000; width: 100%;">
                    –û—Ç–∫—Ä—ã—Ç—å –û—Ñ–∏—Å
                </button>
            </div>

            <div id="setup-new" style="display:none;">
                <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ë–æ—Å—Å.</p>
                <p style="font-size: 0.9rem; color: #888;">–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –Ω–∞–º –Ω—É–∂–Ω–æ –∞—Ä–µ–Ω–¥–æ–≤–∞—Ç—å –ø–æ–º–µ—â–µ–Ω–∏–µ.</p>
                <div style="background: #333; padding: 10px; border-radius: 8px; margin: 20px 0; font-size: 0.8rem;">
                    1. –ù–∞–∂–º–∏—Ç–µ "–í—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–æ"<br>
                    2. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –í–∞—Ä—à–∞–≤—ã<br>
                    3. –ü–æ–¥–ø–∏—à–∏—Ç–µ –¥–æ–≥–æ–≤–æ—Ä –∞—Ä–µ–Ω–¥—ã
                </div>
                <button onclick="startMapSelection()" class="btn-menu" style="background: #2979ff; width: 100%;">
                    üó∫Ô∏è –í—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ
                </button>
            </div>
        </div>
    </div>

    <div class="ui-layer" id="game-ui" style="display: none;">
        <div class="top-bar">
            <div class="balance-display" id="balance">0 PLN</div>
            <div style="text-align: right;">
                <div style="font-size: 0.7rem; color: #aaa;">–ê—Ä–µ–Ω–¥–∞ —á–µ—Ä–µ–∑</div>
                <div class="office-timer" id="rent-timer">5:00</div>
            </div>
        </div>

        <div class="log-container" id="log-area">
            </div>

        <div class="bottom-bar">
            <button class="btn-menu" onclick="openModal('office-modal')">üè¢ –û—Ñ–∏—Å</button>
            <button class="btn-menu" onclick="openModal('shop-modal')">üö≤ –ú–∞–≥–∞–∑–∏–Ω</button>
            <button class="btn-menu" onclick="openModal('mgmt-modal')">üíº –ë–∏–∑–Ω–µ—Å</button>
        </div>
    </div>

    <div id="office-modal" class="modal-overlay" onclick="closeModal(event, 'office-modal')">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('office-modal').classList.remove('open')">&times;</span>
            <h2>üìä –ö–∞–±–∏–Ω–µ—Ç –î–∏—Ä–µ–∫—Ç–æ—Ä–∞</h2>
            
            <div class="dash-grid">
                <div class="dash-card">
                    <h4>–ë–∞–ª–∞–Ω—Å</h4>
                    <div class="val text-green" id="dash-balance">0 PLN</div>
                </div>
                <div class="dash-card">
                    <h4>–ß–∏—Å—Ç–∞—è –ü—Ä–∏–±—ã–ª—å</h4>
                    <div class="val" id="dash-net">0 PLN</div>
                </div>
                <div class="dash-card">
                    <h4>–î–æ—Ö–æ–¥ (–í—Å–µ–≥–æ)</h4>
                    <div class="val text-green" id="dash-income">0 PLN</div>
                </div>
                <div class="dash-card">
                    <h4>–†–∞—Å—Ö–æ–¥—ã (–í—Å–µ–≥–æ)</h4>
                    <div class="val text-red" id="dash-expense">0 PLN</div>
                </div>
            </div>

            <h3>–ü–µ—Ä—Å–æ–Ω–∞–ª</h3>
            <div style="background: #2a2a2a; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>–ö—É—Ä—å–µ—Ä—ã –Ω–∞ –ª–∏–Ω–∏–∏:</span>
                    <span id="dash-couriers" style="font-weight: bold;">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥:</span>
                    <span style="color: gold;">4.9 ‚òÖ</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ:</span>
                    <span id="dash-happy" style="color: #2979ff;">100%</span>
                </div>
            </div>

            <button class="btn-menu btn-rent" onclick="payRent()" style="width: 100%;">
                üí≥ –û–ø–ª–∞—Ç–∏—Ç—å –∞—Ä–µ–Ω–¥—É (-500 PLN)
            </button>
        </div>
    </div>

    <div id="shop-modal" class="modal-overlay" onclick="closeModal(event, 'shop-modal')">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('shop-modal').classList.remove('open')">&times;</span>
            <h2>üö≤ –°–Ω–∞–±–∂–µ–Ω–∏–µ</h2>
            <p style="color:#aaa; font-size:0.9rem;">–ß—Ç–æ–±—ã –Ω–∞–Ω—è—Ç—å –∫—É—Ä—å–µ—Ä–∞, –Ω—É–∂–µ–Ω –ø–æ–ª–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Ç (–í–µ–ª–∏–∫ + –°—É–º–∫–∞ + –ö—É—Ä—Ç–∫–∞).</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                <div style="background:#2a2a2a; padding:10px; border-radius:8px;">
                    <div>City Bike</div>
                    <div style="color:#00e676">1500 PLN</div>
                    <div style="font-size:0.8rem; color:#888;">–ù–∞ —Å–∫–ª–∞–¥–µ: <span id="inv-bike250">0</span></div>
                    <button onclick="buyItem('bike_250', 1500)" style="width:100%; margin-top:5px; background:#444; color:white; border:none; padding:5px;">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div style="background:#2a2a2a; padding:10px; border-radius:8px;">
                    <div>E-Bike Pro</div>
                    <div style="color:#00e676">3700 PLN</div>
                    <div style="font-size:0.8rem; color:#888;">–ù–∞ —Å–∫–ª–∞–¥–µ: <span id="inv-bike350">0</span></div>
                    <button onclick="buyItem('bike_350', 3700)" style="width:100%; margin-top:5px; background:#444; color:white; border:none; padding:5px;">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div style="background:#2a2a2a; padding:10px; border-radius:8px;">
                    <div>–¢–µ—Ä–º–æ—Å—É–º–∫–∞</div>
                    <div style="color:#00e676">150 PLN</div>
                    <div style="font-size:0.8rem; color:#888;">–ù–∞ —Å–∫–ª–∞–¥–µ: <span id="inv-bag">0</span></div>
                    <button onclick="buyItem('bag', 150)" style="width:100%; margin-top:5px; background:#444; color:white; border:none; padding:5px;">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div style="background:#2a2a2a; padding:10px; border-radius:8px;">
                    <div>–£–Ω–∏—Ñ–æ—Ä–º–∞</div>
                    <div style="color:#00e676">200 PLN</div>
                    <div style="font-size:0.8rem; color:#888;">–ù–∞ —Å–∫–ª–∞–¥–µ: <span id="inv-jacket">0</span></div>
                    <button onclick="buyItem('jacket', 200)" style="width:100%; margin-top:5px; background:#444; color:white; border:none; padding:5px;">–ö—É–ø–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <div id="mgmt-modal" class="modal-overlay" onclick="closeModal(event, 'mgmt-modal')">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('mgmt-modal').classList.remove('open')">&times;</span>
            <h2>ü§ù –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã</h2>
            <div style="margin-bottom: 20px;">
                <label>–ó–∞—Ä–ø–ª–∞—Ç–∞ –∫—É—Ä—å–µ—Ä–∞: <span id="salary-val" style="color:#00e676">50%</span></label>
                <input type="range" min="10" max="90" value="50" oninput="updateSalary(this.value)" style="width:100%; accent-color:#00e676;">
                <div style="font-size:0.7rem; color:#888;">–ú–µ–Ω—å—à–µ –∑–∞—Ä–ø–ª–∞—Ç–∞ = –º–µ–Ω—å—à–µ —Å—á–∞—Å—Ç—å—è = –º–µ–¥–ª–µ–Ω–Ω–µ–µ –¥–æ—Å—Ç–∞–≤–∫–∞.</div>
            </div>
            
            <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã</h3>
            <div id="rest-list">
                </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
            authDomain: "warszawa-courier.firebaseapp.com",
            databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "warszawa-courier",
            storageBucket: "warszawa-courier.firebasestorage.app",
            messagingSenderId: "295860613508",
            appId: "1:295860613508:web:86fe8364377d6875612dd1"
        };

        const RESTAURANTS_DB = [
            { id: 'r1', name: 'MCD ≈öwiƒôtokrzyska', lat: 52.235, lng: 21.008, cost: 2000, type: 'üçî' },
            { id: 'r2', name: 'Kebab King', lat: 52.230, lng: 21.015, cost: 3500, type: 'üåØ' },
            { id: 'r3', name: 'Zapiecek Old Town', lat: 52.249, lng: 21.013, cost: 5000, type: 'ü•ü' },
            { id: 'r4', name: 'Sushi Master', lat: 52.225, lng: 21.020, cost: 8000, type: 'üç£' },
            { id: 'r5', name: 'Pizza Hut', lat: 52.228, lng: 21.010, cost: 12000, type: 'üçï' }
        ];

        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        let map;
        let db;
        let userId = "boss_prod_004"; // ID –∏–≥—Ä–æ–∫–∞
        let officeMarker;
        let couriers = []; // –û–±—ä–µ–∫—Ç—ã { marker, data }
        let restMarkers = {};

        let state = {
            balance: 7500,
            financials: { totalIncome: 0, totalExpenses: 0 },
            office: { lat: null, lng: null, rentPaidAt: Date.now() },
            inventory: { bikes_250: 0, bikes_350: 0, bags: 0, jackets: 0 },
            licenses: [],
            settings: { salaryShare: 50 },
            stats: { happiness: 100 }
        };

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        window.onload = function() {
            firebase.initializeApp(FIREBASE_CONFIG);
            db = firebase.database();
            initMap();
            loadData();
        };

        function initMap() {
            // –¢–µ–º–Ω–∞—è –∫–∞—Ä—Ç–∞
            map = L.map('map', {zoomControl: false}).setView([52.2297, 21.0122], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            map.on('click', (e) => {
                if(document.getElementById('setup-new').style.display === 'block') {
                    setOfficeLocation(e.latlng.lat, e.latlng.lng);
                }
            });
        }

        function loadData() {
            db.ref('players/' + userId).on('value', snap => {
                const data = snap.val();
                document.getElementById('setup-loading').style.display = 'none';
                
                if (data && data.office && data.office.lat) {
                    state = { ...state, ...data };
                    // –§–∏–∫—Å —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–µ—Ä—Å–∏–π
                    if(!state.financials) state.financials = { totalIncome: 0, totalExpenses: 0 };
                    
                    document.getElementById('setup-actions').style.display = 'block';
                } else {
                    document.getElementById('setup-new').style.display = 'block';
                }
                
                updateUI();
                refreshMapObjects();
            });
        }

        // --- –°–¢–ê–†–¢ –ò–ì–†–´ ---
        function startMapSelection() {
            document.getElementById('setup-screen').style.display = 'none';
            showLog("üó∫Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ –¥–ª—è –æ—Ñ–∏—Å–∞...", "#00e676");
        }

        function setOfficeLocation(lat, lng) {
            state.office.lat = lat;
            state.office.lng = lng;
            state.office.rentPaidAt = Date.now();
            saveState();
            location.reload();
        }

        function startGame() {
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = 'flex';
            
            // –°—Ç–∞–≤–∏–º –æ—Ñ–∏—Å
            const officeIcon = L.divIcon({
                className: 'office-icon-div',
                html: 'üè¢',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            if(officeMarker) map.removeLayer(officeMarker);
            officeMarker = L.marker([state.office.lat, state.office.lng], {icon: officeIcon})
                .addTo(map)
                .on('click', () => openModal('office-modal')); // –ö–ª–∏–∫ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

            // –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞
            setInterval(gameLoop, 100); // 10 FPS –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
        }

        // --- –ò–ì–†–û–í–û–ô –¶–ò–ö–õ (LOGIC) ---
        function gameLoop() {
            // 1. –ê—Ä–µ–Ω–¥–∞
            updateRentTimer();
            
            // 2. –°–ø–∞–≤–Ω –∫—É—Ä—å–µ—Ä–æ–≤
            manageFleet();

            // 3. –î–≤–∏–∂–µ–Ω–∏–µ
            moveCouriers();
        }

        function manageFleet() {
            // –†–∞—Å—á–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤
            const bikes = (state.inventory.bikes_250 || 0) + (state.inventory.bikes_350 || 0);
            const sets = Math.min(state.inventory.bags || 0, state.inventory.jackets || 0);
            const maxCouriers = Math.min(bikes, sets);

            // –î–æ–±–∞–≤–ª—è–µ–º –µ—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç
            while(couriers.length < maxCouriers) {
                spawnCourier();
            }
        }

        function spawnCourier() {
            const icon = L.divIcon({
                className: 'emoji-icon',
                html: 'üö¥', // –ò–∫–æ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
            
            const marker = L.marker([state.office.lat, state.office.lng], {icon: icon}).addTo(map);
            
            couriers.push({
                marker: marker,
                data: {
                    status: 'IDLE', 
                    pos: { lat: state.office.lat, lng: state.office.lng },
                    target: null,
                    waitTimer: 0,
                    order: null
                }
            });
        }

        function moveCouriers() {
            // –û–ß–ï–ù–¨ –ú–ï–î–õ–ï–ù–ù–ê–Ø –°–ö–û–†–û–°–¢–¨
            // 0.000005 –≥—Ä–∞–¥—É—Å–∞ –∑–∞ 100–º—Å ~ 20 –∫–º/—á –≤ –º–∞—Å—à—Ç–∞–±–µ
            const BASE_SPEED = 0.000008; 
            const happinessFactor = state.stats.happiness / 100;
            
            couriers.forEach(c => {
                const d = c.data;
                const m = c.marker;
                let currentIcon = 'üö¥';

                // --- –õ–û–ì–ò–ö–ê ---
                
                // 1. –ò—â–µ–º —Ä–∞–±–æ—Ç—É
                if (d.status === 'IDLE') {
                    if (state.licenses.length > 0) {
                        const rId = state.licenses[Math.floor(Math.random() * state.licenses.length)];
                        const rest = RESTAURANTS_DB.find(x => x.id === rId);
                        d.target = { lat: rest.lat, lng: rest.lng, type: 'REST', name: rest.name };
                        d.status = 'MOVING';
                    }
                }

                // 2. –î–≤–∏–∂–µ–Ω–∏–µ
                if (d.status === 'MOVING') {
                    if (!d.target) { d.status = 'IDLE'; return; }
                    
                    const dist = Math.sqrt(Math.pow(d.target.lat - d.pos.lat, 2) + Math.pow(d.target.lng - d.pos.lng, 2));
                    
                    if (dist < 0.0001) {
                        // –ü—Ä–∏–±—ã–ª
                        d.pos = d.target;
                        if (d.target.type === 'REST') {
                            d.status = 'WAITING_FOOD';
                            d.waitTimer = 30; // 3 —Å–µ–∫ –∂–¥–µ–º –µ–¥—É
                        } else if (d.target.type === 'CLIENT') {
                            d.status = 'DELIVERING_HANDOVER';
                            d.waitTimer = 20; // 2 —Å–µ–∫ –æ—Ç–¥–∞–µ–º
                        }
                    } else {
                        // –ï–¥–µ–º
                        const angle = Math.atan2(d.target.lat - d.pos.lat, d.target.lng - d.pos.lng);
                        d.pos.lat += Math.sin(angle) * BASE_SPEED * happinessFactor;
                        d.pos.lng += Math.cos(angle) * BASE_SPEED * happinessFactor;
                    }
                }

                // 3. –û–∂–∏–¥–∞–Ω–∏–µ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ
                if (d.status === 'WAITING_FOOD') {
                    currentIcon = '‚è≥';
                    d.waitTimer--;
                    if (d.waitTimer <= 0) {
                        // –ï–¥—É –∑–∞–±—Ä–∞–ª–∏, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç–∞
                        const offset = 0.015; // ~1.5 –∫–º —Ä–∞–¥–∏—É—Å
                        d.target = {
                            lat: d.pos.lat + (Math.random() * offset * 2 - offset),
                            lng: d.pos.lng + (Math.random() * offset * 2 - offset),
                            type: 'CLIENT'
                        };
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞ (–≤—Ä–µ–º–µ–Ω–Ω—ã–π)
                        if (d.clientMarker) map.removeLayer(d.clientMarker);
                        const cIcon = L.divIcon({ className: 'emoji-icon', html: 'üë§', iconSize:[20,20] });
                        d.clientMarker = L.marker([d.target.lat, d.target.lng], {icon: cIcon}).addTo(map);

                        d.status = 'MOVING';
                        d.order = { val: Math.floor(Math.random()*15 + 20), rest: d.target.name }; // 20-35 PLN
                    }
                }

                // 4. –í–µ–∑–µ–º –µ–¥—É (–∏–∫–æ–Ω–∫–∞ –∫–æ—Ä–æ–±–∫–∏)
                if (d.status === 'MOVING' && d.target && d.target.type === 'CLIENT') {
                    currentIcon = 'üéí';
                }

                // 5. –û—Ç–¥–∞—á–∞ –∫–ª–∏–µ–Ω—Ç—É
                if (d.status === 'DELIVERING_HANDOVER') {
                    currentIcon = 'ü§ù';
                    d.waitTimer--;
                    if (d.waitTimer <= 0) {
                        completeOrder(c);
                    }
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª
                m.setLatLng([d.pos.lat, d.pos.lng]);
                
                // –ú–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
                const newHtml = currentIcon;
                if (m.getElement() && m.getElement().innerHTML !== newHtml) {
                    m.setIcon(L.divIcon({ className: 'emoji-icon', html: newHtml, iconSize: [24,24] }));
                }
            });
        }

        function completeOrder(c) {
            const d = c.data;
            if (d.clientMarker) { map.removeLayer(d.clientMarker); d.clientMarker = null; }
            
            // –§–∏–Ω–∞–Ω—Å—ã
            const total = d.order.val;
            const courierShare = total * (state.settings.salaryShare / 100); // –ó–ü –∫—É—Ä—å–µ—Ä–∞
            const profit = total - courierShare; // –ù–∞—à–∞ –ø—Ä–∏–±—ã–ª—å

            // –†–∞—Å—Ö–æ–¥—ã (–ó–ü) + –î–æ—Ö–æ–¥—ã
            state.financials.totalIncome += profit;
            state.financials.totalExpenses += courierShare; // –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ —ç—Ç–æ —Ä–∞—Å—Ö–æ–¥, –Ω–æ –º—ã —Å—á–∏—Ç–∞–µ–º Net
            state.balance += profit;

            // –°—á–∞—Å—Ç—å–µ
            adjustHappiness();

            showLog(`‚úÖ –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ! +${profit.toFixed(1)} PLN`, "#00e676");
            
            // –†–µ—Å–µ—Ç
            d.status = 'IDLE';
            d.target = null;
            saveState();
            updateUI();
        }

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï ---
        function buyItem(item, cost) {
            if (state.balance >= cost) {
                state.balance -= cost;
                state.financials.totalExpenses += cost;
                
                if (item === 'bike_250') state.inventory.bikes_250++;
                if (item === 'bike_350') state.inventory.bikes_350++;
                if (item === 'bag') state.inventory.bags++;
                if (item === 'jacket') state.inventory.jackets++;
                
                saveState();
                updateUI();
                showLog(`–ö—É–ø–ª–µ–Ω–æ: ${item}`, "#fff");
            } else {
                showLog("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤", "#ff5252");
            }
        }

        function buyLicense(id) {
            const r = RESTAURANTS_DB.find(x => x.id === id);
            if (state.balance >= r.cost) {
                state.balance -= r.cost;
                state.financials.totalExpenses += r.cost;
                state.licenses.push(id);
                refreshMapObjects();
                saveState();
                updateUI();
                showLog(`–õ–∏—Ü–µ–Ω–∑–∏—è ${r.name} –∫—É–ø–ª–µ–Ω–∞!`, "#00e676");
            }
        }

        function payRent() {
            if (state.balance >= 500) {
                state.balance -= 500;
                state.financials.totalExpenses += 500;
                state.office.rentPaidAt = Date.now();
                saveState();
                updateUI();
                showLog("–ê—Ä–µ–Ω–¥–∞ –æ–ø–ª–∞—á–µ–Ω–∞", "#2979ff");
            } else {
                showLog("–ù–µ—Ç –¥–µ–Ω–µ–≥ –Ω–∞ –∞—Ä–µ–Ω–¥—É!", "#ff5252");
            }
        }

        function updateSalary(val) {
            state.settings.salaryShare = val;
            document.getElementById('salary-val').innerText = val + "%";
            adjustHappiness();
        }

        function adjustHappiness() {
            const share = state.settings.salaryShare;
            // 50% = 100 happiness. 30% = low.
            let target = 100;
            if (share < 40) target = 50;
            if (share < 30) target = 20;
            if (share > 60) target = 110;

            // –ü–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
            state.stats.happiness = (state.stats.happiness * 0.9) + (target * 0.1);
        }

        // --- UI UTILS ---
        function refreshMapObjects() {
            // –†–µ—Å—Ç–æ—Ä–∞–Ω—ã
            RESTAURANTS_DB.forEach(r => {
                if (state.licenses.includes(r.id)) {
                    if (!restMarkers[r.id]) {
                        const icon = L.divIcon({ className: 'rest-icon-div', html: r.type, iconSize:[24,24] });
                        const m = L.marker([r.lat, r.lng], {icon: icon}).addTo(map).bindPopup(r.name);
                        restMarkers[r.id] = m;
                    }
                }
            });

            // –°–ø–∏—Å–æ–∫ –≤ –º–µ–Ω—é
            const list = document.getElementById('rest-list');
            list.innerHTML = '';
            RESTAURANTS_DB.forEach(r => {
                const owned = state.licenses.includes(r.id);
                list.innerHTML += `
                    <div style="display:flex; justify-content:space-between; align-items:center; background:#222; padding:10px; margin-bottom:5px; border-radius:5px;">
                        <div>${r.type} ${r.name}</div>
                        ${owned ? '<span class="text-green">‚úî</span>' : `<button onclick="buyLicense('${r.id}')" style="background:#444; color:#fff; border:none; padding:5px 10px;">${r.cost}</button>`}
                    </div>
                `;
            });
        }

        function updateUI() {
            // Top Bar
            document.getElementById('balance').innerText = Math.floor(state.balance) + " PLN";
            
            // Dashboard
            document.getElementById('dash-balance').innerText = Math.floor(state.balance) + " PLN";
            document.getElementById('dash-net').innerText = Math.floor(state.financials.totalIncome - state.financials.totalExpenses) + " PLN";
            document.getElementById('dash-income').innerText = Math.floor(state.financials.totalIncome);
            document.getElementById('dash-expense').innerText = Math.floor(state.financials.totalExpenses);
            document.getElementById('dash-couriers').innerText = couriers.length;
            document.getElementById('dash-happy').innerText = Math.floor(state.stats.happiness) + "%";
            
            // Inventory
            document.getElementById('inv-bike250').innerText = state.inventory.bikes_250;
            document.getElementById('inv-bike350').innerText = state.inventory.bikes_350;
            document.getElementById('inv-bag').innerText = state.inventory.bags;
            document.getElementById('inv-jacket').innerText = state.inventory.jackets;
        }

        function updateRentTimer() {
            const diff = Date.now() - state.office.rentPaidAt;
            const left = (5 * 60 * 1000) - diff;
            if (left <= 0) {
                document.getElementById('rent-timer').innerText = "–ü–†–û–°–†–û–ß–ï–ù–û";
            } else {
                const m = Math.floor(left / 60000);
                const s = Math.floor((left % 60000) / 1000);
                document.getElementById('rent-timer').innerText = `${m}:${s<10?'0':''}${s}`;
            }
        }

        function showLog(msg, color) {
            const area = document.getElementById('log-area');
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.style.color = color || "#fff";
            div.innerText = msg;
            area.prepend(div);
            if(area.children.length > 6) area.lastChild.remove();
        }

        function saveState() {
            if(userId) db.ref('players/' + userId).set(state);
        }

        function openModal(id) {
            document.getElementById(id).classList.add('open');
            document.getElementById(id).style.display = 'flex';
        }
        function closeModal(e, id) {
            if(e.target.id === id) {
                document.getElementById(id).classList.remove('open');
                setTimeout(() => document.getElementById(id).style.display = 'none', 300);
            }
        }
    </script>
</body>
</html>
