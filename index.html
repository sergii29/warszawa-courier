<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warsaw Courier: Full</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #f9f9e8;
            --grid: #e2e2ca;
            --lime: #c8ff00;
            --dark: #1a1a1a;
            --red: #ff3333;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: 'Arial', sans-serif; }

        /* --- –ö–ù–û–ü–ö–ê –ú–ï–ù–Æ (–ë–£–†–ì–ï–†) --- */
        #hamburger-btn {
            position: fixed; top: 15px; left: 15px;
            width: 45px; height: 45px; background: white; border: 2px solid #eee; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
            cursor: pointer; z-index: 5000; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .line { width: 24px; height: 3px; background: var(--dark); border-radius: 2px; }

        /* --- –ë–û–ö–û–í–û–ï –ú–ï–ù–Æ --- */
        #sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 5001; display: none;
        }
        #sidebar {
            position: fixed; top: 0; left: -320px; width: 85%; max-width: 300px; height: 100%;
            background: #fff; z-index: 5002; transition: left 0.3s ease;
            display: flex; flex-direction: column; border-right: 1px solid #ddd;
        }
        #sidebar.open { left: 0; }

        .sidebar-header { padding: 20px; background: var(--dark); color: white; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-tabs { display: flex; background: #f4f4f4; padding: 10px; gap: 5px; overflow-x: auto; }
        .tab { padding: 8px 12px; background: white; border-radius: 6px; font-size: 12px; font-weight: bold; border: 1px solid #ccc; cursor: pointer; white-space: nowrap; }
        .tab.active { background: var(--lime); border-color: #999; }
        .sidebar-content { flex-grow: 1; overflow-y: auto; padding: 15px; }

        .shop-item { background: #fafafa; border: 1px solid #eee; padding: 12px; margin-bottom: 10px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; }
        .buy-btn { background: var(--dark); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; }

        /* --- –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ --- */
        #top-info {
            height: 140px; background: var(--bg); border-bottom: 2px solid var(--grid);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; z-index: 100; padding-top: 10px;
        }
        .balance-pill { 
            background: white; padding: 6px 25px; border-radius: 50px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); font-size: 1.6rem; font-weight: 800; color: var(--dark);
            border: 1px solid #eee; margin-bottom: 5px;
        }
        .stats-container { width: 90%; display: flex; justify-content: space-between; margin-top: 5px; }
        .stat-box { display: flex; align-items: center; gap: 5px; font-size: 11px; font-weight: bold; width: 48%; }
        .bar-bg { flex-grow: 1; height: 6px; background: #ddd; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; width: 100%; transition: width 0.3s; }
        #energy-bar { background: orange; }
        #water-bar { background: #00aaff; }
        #hp-bar { background: #555; }

        /* --- –ò–ì–†–û–í–û–ï –ü–û–õ–ï --- */
        #game-container {
            position: relative; width: 100%; height: calc(100vh - 410px);
            background-image: linear-gradient(var(--grid) 1px, transparent 1px), linear-gradient(90deg, var(--grid) 1px, transparent 1px);
            background-size: 30px 30px; overflow: hidden;
        }
        .entity { position: absolute; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; z-index: 10; font-size: 18px; transition: all 0.2s linear; }
        #player { background: var(--lime); border: 2px solid var(--dark); border-radius: 50%; z-index: 20; font-size: 16px; }
        .obs { opacity: 0.6; z-index: 5; font-size: 16px; }
        .police { font-size: 20px; z-index: 15; transition: left 0.5s ease, top 0.5s ease; }

        /* --- –£–ü–†–ê–í–õ–ï–ù–ò–ï --- */
        #ui-bottom { 
            height: 270px; background: white; border-top: 2px solid #eee;
            display: flex; flex-direction: column; align-items: center; padding-top: 15px; 
            z-index: 90; position: relative;
        }
        #btn-online {
            width: 85%; padding: 20px; background: var(--lime); border: none; border-radius: 15px;
            font-size: 18px; font-weight: 900; cursor: pointer; box-shadow: 0 4px 0 #a2ce00; color: var(--dark);
        }
        #btn-offline {
            margin-top: 10px; width: 150px; padding: 8px; background: #ff4444; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; display: none;
        }
        .joy-grid { display: none; grid-template-columns: repeat(3, 70px); grid-template-rows: repeat(2, 65px); gap: 8px; margin-top: 10px; }
        .btn-move { background: #f4f4f4; border: 1px solid #ddd; border-radius: 12px; font-size: 24px; box-shadow: 0 4px 0 #eee; }
        .btn-move:active { background: var(--lime); transform: translateY(2px); box-shadow: none; }
        .up { grid-column: 2; }
        .left { grid-column: 1; grid-row: 2; }
        .down { grid-column: 2; grid-row: 2; }
        .right { grid-column: 3; grid-row: 2; }

        .toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85); color: white; padding: 15px 25px;
            border-radius: 30px; font-weight: bold; z-index: 6000; display: none; text-align: center;
        }
        .toast.red { background: rgba(220, 30, 30, 0.9); }
    </style>
</head>
<body>

<div id="hamburger-btn" onclick="toggleMenu()">
    <div class="line"></div><div class="line"></div><div class="line"></div>
</div>

<div id="sidebar-overlay" onclick="toggleMenu()"></div>
<div id="sidebar">
    <div class="sidebar-header">
        <span>Warsaw OS</span> <span onclick="toggleMenu()" style="cursor:pointer; font-size:20px">‚úï</span>
    </div>
    <div class="sidebar-tabs">
        <div class="tab active" onclick="renderShop()">–ú–∞–≥–∞–∑–∏–Ω</div>
        <div class="tab" onclick="renderGarage()">–ì–∞—Ä–∞–∂</div>
        <div class="tab" onclick="alert('–ë–∞–Ω–∫ —Å–∫–æ—Ä–æ')">–ë–∞–Ω–∫</div>
    </div>
    <div id="menu-content" class="sidebar-content"></div>
    <div style="text-align:center; font-size:10px; color:#ccc; padding:10px">ID: <span id="uid-disp">...</span></div>
</div>

<div id="toast" class="toast">Alert</div>

<div id="top-info">
    <div style="font-size:10px; color:#999; font-weight:900; letter-spacing:2px; margin-bottom:5px">WARSZAWA COURIER</div>
    <div class="balance-pill"><span id="cash">0.00</span> PLN</div>
    
    <div class="stats-container">
        <div class="stat-box">‚ö° <div class="bar-bg"><div id="energy-bar" class="bar-fill"></div></div></div>
        <div class="stat-box">üíß <div class="bar-bg"><div id="water-bar" class="bar-fill"></div></div></div>
    </div>
    <div class="stats-container" style="margin-top:5px;">
        <div class="stat-box" style="width:100%">üö≤ <div class="bar-bg"><div id="hp-bar" class="bar-fill"></div></div></div>
    </div>
</div>

<div id="game-container">
    <div id="player" class="entity">üö≤</div>
    <div id="target" class="entity" style="display:none"></div>
</div>

<div id="ui-bottom">
    <div id="status-text" style="margin-bottom:10px; font-weight:bold; color:#555; font-size:12px;">–°–º–µ–Ω–∞ –Ω–µ –Ω–∞—á–∞—Ç–∞</div>
    <button id="btn-online" onclick="goOnline()">–í–´–ô–¢–ò –í –û–ù–õ–ê–ô–ù</button>
    
    <div class="joy-grid" id="controls">
        <button class="btn-move up" onclick="move(0, -30)">‚Üë</button>
        <button class="btn-move left" onclick="move(-30, 0)">‚Üê</button>
        <button class="btn-move down" onclick="move(0, 30)">‚Üì</button>
        <button class="btn-move right" onclick="move(30, 0)">‚Üí</button>
    </div>
    <button id="btn-offline" onclick="goOffline()">–ó–ê–ö–û–ù–ß–ò–¢–¨ –°–ú–ï–ù–£</button>
</div>

<script>
    // --- 1. FIREBASE & USER ---
    const firebaseConfig = {
        apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
        authDomain: "warszawa-courier.firebaseapp.com",
        databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "warszawa-courier",
        storageBucket: "warszawa-courier.firebasestorage.app",
        messagingSenderId: "295860613508",
        appId: "1:295860613508:web:86fe8364377d6875612dd1",
        measurementId: "G-TGSCHBVLX2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const tg = window.Telegram.WebApp;
    tg.expand();
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞ –∏–ª–∏ –±–µ—Ä–µ–º –∏–∑ –¢–ì
    let userId = tg.initDataUnsafe?.user?.id || localStorage.getItem('wc_real_id');
    if(!userId) {
        userId = 'user_' + Date.now(); // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID, —á—Ç–æ–±—ã –±–∞–ª–∞–Ω—Å –±—ã–ª 0
        localStorage.setItem('wc_real_id', userId);
    }
    document.getElementById('uid-disp').innerText = userId;

    // --- 2. STATE ---
    let state = {
        bal: 0.00, en: 100, wat: 100, hp: 100,
        x: 30, y: 30,
        bike: 'default',
        bikes: ['default']
    };
    let isOnline = false;
    let policeInterval = null;
    let policeUnits = [];
    let occupied = [];
    let target = {x:0, y:0};
    let jobStep = 0; // 0=none, 1=rest, 2=client

    // --- 3. DB LOAD/SAVE ---
    function loadData() {
        db.ref('users/' + userId).once('value', s => {
            let d = s.val();
            if(d) {
                state.bal = parseFloat(d.balance) || 0;
                state.en = d.energy ?? 100;
                state.wat = d.water ?? 100;
                state.hp = d.hp ?? 100;
                state.bikes = d.bikes || ['default'];
                state.bike = d.bike || 'default';
            } else {
                saveData(); // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
            }
            updateUI();
        });
    }
    loadData();

    function saveData() {
        db.ref('users/' + userId).update({
            balance: state.bal, energy: state.en, water: state.wat, hp: state.hp,
            bike: state.bike, bikes: state.bikes, lastLogin: Date.now()
        });
    }

    // --- 4. MENU LOGIC ---
    function toggleMenu() {
        const sb = document.getElementById('sidebar');
        const ov = document.getElementById('sidebar-overlay');
        if(sb.classList.contains('open')) {
            sb.classList.remove('open'); ov.style.display = 'none';
        } else {
            sb.classList.add('open'); ov.style.display = 'block';
            renderShop();
        }
    }

    function renderShop() {
        document.getElementById('menu-content').innerHTML = `
            <div class="shop-item"><div>üå≠ –•–æ—Ç-–¥–æ–≥ (+20 –≠–Ω)</div><button class="buy-btn" onclick="buy('food', 5, 20, 0)">5 PLN</button></div>
            <div class="shop-item"><div>ü•§ –í–æ–¥–∞ (+30 –í–æ–¥—ã)</div><button class="buy-btn" onclick="buy('water', 3, 0, 30)">3 PLN</button></div>
            <div class="shop-item"><div>‚ö° Red Bull (+50 –≠–Ω)</div><button class="buy-btn" onclick="buy('bull', 12, 50, 5)">12 PLN</button></div>
            <div class="shop-item"><div>üö≤ E-Bike 250W</div><button class="buy-btn" onclick="buyBike('ebike250', 500)">500 PLN</button></div>
        `;
    }

    function renderGarage() {
        document.getElementById('menu-content').innerHTML = `
            <div style="padding:10px; text-align:center">
                <h3>–¢–≤–æ–π: ${state.bike}</h3>
                <p>–°–æ—Å—Ç–æ—è–Ω–∏–µ: ${state.hp.toFixed(0)}%</p>
                <button class="buy-btn" style="width:100%" onclick="repair()">–ü–æ—á–∏–Ω–∏—Ç—å (15 PLN)</button>
                <hr>
                ${state.bikes.map(b => `<div class="shop-item">${b} <button class="buy-btn" onclick="equip('${b}')">–í–∑—è—Ç—å</button></div>`).join('')}
            </div>
        `;
    }

    function buy(type, price, e, w) {
        if(state.bal >= price) {
            state.bal -= price; state.en = Math.min(100, state.en+e); state.wat = Math.min(100, state.wat+w);
            showToast("–ö—É–ø–ª–µ–Ω–æ!"); saveData(); updateUI(); renderShop();
        } else showToast("–ù–µ—Ç –¥–µ–Ω–µ–≥!", true);
    }
    function buyBike(id, price) {
        if(state.bikes.includes(id)) return showToast("–£–∂–µ –µ—Å—Ç—å!");
        if(state.bal >= price) {
            state.bal -= price; state.bikes.push(id); showToast("–ö—É–ø–ª–µ–Ω –±–∞–π–∫!");
            saveData(); updateUI(); renderShop();
        } else showToast("–ù–µ—Ç –¥–µ–Ω–µ–≥!", true);
    }
    function repair() {
        if(state.bal >= 15 && state.hp < 100) {
            state.bal -= 15; state.hp = 100; showToast("–ü–æ—á–∏–Ω–∏–ª!"); saveData(); renderGarage(); updateUI();
        } else showToast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥ / —Ü–µ–ª", true);
    }
    function equip(id) { state.bike = id; showToast("–í–∑—è—Ç: "+id); saveData(); renderGarage(); }

    // --- 5. GAME LOGIC ---
    const step = 30;

    function goOnline() {
        if(state.en < 10) return showToast("–ú–∞–ª–æ —ç–Ω–µ—Ä–≥–∏–∏!", true);
        isOnline = true;
        document.getElementById('btn-online').style.display = 'none';
        document.getElementById('controls').style.display = 'grid';
        document.getElementById('btn-offline').style.display = 'block';
        document.getElementById('status-text').innerText = "–ò—â–µ–º –∑–∞–∫–∞–∑...";
        
        spawnObstacles();
        spawnPolice();
        
        if(policeInterval) clearInterval(policeInterval);
        policeInterval = setInterval(movePolice, 1500);
        
        startJob();
        updateUI();
    }

    function goOffline() {
        isOnline = false;
        document.getElementById('btn-online').style.display = 'block';
        document.getElementById('controls').style.display = 'none';
        document.getElementById('btn-offline').style.display = 'none';
        document.getElementById('status-text').innerText = "–°–º–µ–Ω–∞ –æ–∫–æ–Ω—á–µ–Ω–∞";
        document.querySelectorAll('.obs, .police').forEach(e => e.remove());
        document.getElementById('target').style.display = 'none';
        clearInterval(policeInterval);
    }

    function spawnObstacles() {
        document.querySelectorAll('.obs').forEach(e => e.remove());
        occupied = [];
        const box = document.getElementById('game-container');
        const cols = Math.floor(box.offsetWidth/step);
        const rows = Math.floor(box.offsetHeight/step);
        
        for(let i=0; i<15; i++) {
            let ox = Math.floor(Math.random()*cols)*step;
            let oy = Math.floor(Math.random()*rows)*step;
            if(Math.abs(ox-state.x)+Math.abs(oy-state.y) > 90) {
                occupied.push({x:ox, y:oy});
                let d = document.createElement('div');
                d.className = 'entity obs'; d.innerText = 'üöß';
                d.style.left = ox+'px'; d.style.top = oy+'px';
                box.appendChild(d);
            }
        }
    }

    function spawnPolice() {
        document.querySelectorAll('.police').forEach(e => e.remove());
        policeUnits = [];
        const box = document.getElementById('game-container');
        const cols = Math.floor(box.offsetWidth/step);
        const rows = Math.floor(box.offsetHeight/step);
        
        for(let i=0; i<3; i++) {
            let px = Math.floor(Math.random()*cols)*step;
            let py = Math.floor(Math.random()*rows)*step;
            if(!occupied.some(o=>o.x===px && o.y===py) && Math.abs(px-state.x)>90) {
                let d = document.createElement('div');
                d.className = 'entity police'; d.innerText = 'üöì';
                d.style.left = px+'px'; d.style.top = py+'px';
                box.appendChild(d);
                policeUnits.push({x:px, y:py, el:d});
            }
        }
    }

    function movePolice() {
        if(!isOnline) return;
        const box = document.getElementById('game-container');
        const cols = Math.floor(box.offsetWidth/step);
        const rows = Math.floor(box.offsetHeight/step);

        policeUnits.forEach(p => {
            let dirs = [{dx:0, dy:-30}, {dx:0, dy:30}, {dx:-30, dy:0}, {dx:30, dy:0}];
            let m = dirs[Math.floor(Math.random()*4)];
            let nx = p.x + m.dx; let ny = p.y + m.dy;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü –∏ —Å—Ç–µ–Ω
            if(nx>=0 && ny>=0 && nx<cols*step && ny<rows*step && !occupied.some(o=>o.x===nx && o.y===ny)) {
                p.x = nx; p.y = ny;
                p.el.style.left = nx+'px'; p.el.style.top = ny+'px';
            }
            if(p.x === state.x && p.y === state.y) catchPlayer();
        });
    }

    function catchPlayer() {
        showToast("–ü–û–õ–ò–¶–ò–Ø! –®–¢–†–ê–§ 50 PLN!", true);
        state.bal -= 50; if(state.bal<0) state.bal=0;
        state.x = 30; state.y = 30; // Respawn
        updateUI(); saveData();
    }

    function move(dx, dy) {
        if(!isOnline) return;
        if(state.en <= 0) { showToast("–ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏!", true); toggleMenu(); return; }
        if(state.hp <= 0) { showToast("–í–µ–ª–∏–∫ —Å–ª–æ–º–∞–Ω!", true); toggleMenu(); return; }

        let nx = state.x + dx; let ny = state.y + dy;
        const box = document.getElementById('game-container');
        const cols = Math.floor(box.offsetWidth/step);
        const rows = Math.floor(box.offsetHeight/step);

        // –ì—Ä–∞–Ω–∏—Ü—ã
        if(nx<0 || ny<0 || nx>=cols*step || ny>=rows*step) return;
        // –°—Ç–µ–Ω—ã
        if(occupied.some(o=>o.x===nx && o.y===ny)) { showToast("–¢—É–ø–∏–∫"); return; }
        // –ü–æ–ª–∏—Ü–∏—è
        if(policeUnits.some(p=>p.x===nx && p.y===ny)) { catchPlayer(); return; }

        state.x = nx; state.y = ny;
        
        // –†–∞—Å—Ö–æ–¥
        let drain = state.bike === 'ebike250' ? 0.3 : 1.0;
        state.en -= drain; state.wat -= 0.5; state.hp -= 0.1;

        checkJob();
        updateUI(); saveData();
    }

    function startJob() {
        jobStep = 1; 
        spawnTarget('üçï');
        document.getElementById('status-text').innerText = "–ï–¥—å –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω (–ü–∏—Ü—Ü–∞)";
    }

    function spawnTarget(icon) {
        const box = document.getElementById('game-container');
        const cols = Math.floor(box.offsetWidth/step);
        const rows = Math.floor(box.offsetHeight/step);
        
        // –ò—â–µ–º —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ
        let tx, ty, ok=false;
        while(!ok) {
            tx = Math.floor(Math.random()*cols)*step;
            ty = Math.floor(Math.random()*rows)*step;
            ok = !occupied.some(o=>o.x===tx && o.y===ty) && !policeUnits.some(p=>p.x===tx && p.y===ty);
        }
        target = {x:tx, y:ty};
        const el = document.getElementById('target');
        el.style.display = 'flex'; el.innerText = icon || 'üìç';
        el.style.left = tx+'px'; el.style.top = ty+'px';
    }

    function checkJob() {
        if(state.x === target.x && state.y === target.y) {
            if(jobStep === 1) {
                jobStep = 2;
                showToast("–ü–∏—Ü—Ü–∞ –∑–∞–±—Ä–∞–Ω–∞!");
                spawnTarget('üë§');
                document.getElementById('status-text').innerText = "–í–µ–∑–∏ –∫–ª–∏–µ–Ω—Ç—É!";
            } else if(jobStep === 2) {
                state.bal += 15;
                showToast("+15 PLN");
                startJob(); // New loop
            }
        }
    }

    function updateUI() {
        document.getElementById('cash').innerText = state.bal.toFixed(2);
        document.getElementById('energy-bar').style.width = Math.max(0, state.en)+'%';
        document.getElementById('water-bar').style.width = Math.max(0, state.wat)+'%';
        document.getElementById('hp-bar').style.width = Math.max(0, state.hp)+'%';
        
        const p = document.getElementById('player');
        p.style.left = state.x+'px'; p.style.top = state.y+'px';
    }

    function showToast(msg, red=false) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.className = red ? 'toast red' : 'toast';
        t.style.display = 'block'; setTimeout(()=>t.style.display='none', 2000);
    }
</script>
</body>
</html>
