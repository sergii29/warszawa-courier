<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Warsaw Night Courier</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0a; color: #fff; overflow: hidden; height: 100vh; }
        
        #map { height: 100%; width: 100%; position: absolute; top: 0; left: 0; z-index: 1; }
        .leaflet-tile { filter: brightness(0.3) saturate(0.6) contrast(1.3) !important; }
        
        .ui-layer { position: absolute; z-index: 100; pointer-events: none; width: 100%; height: 100%; }
        .ui-layer > * { pointer-events: auto; }
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —Å —Ä–µ—Å—É—Ä—Å–∞–º–∏ */
        .top-panel { position: absolute; top: 0; left: 0; right: 0; padding: 15px; background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent); }
        
        .balance-box { background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 20px; border: 1px solid #00e676; display: inline-block; margin-bottom: 10px; }
        .balance-amount { font-size: 22px; font-weight: bold; color: #00e676; }
        
        .stats-grid { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .stat-card { background: rgba(20,20,20,0.9); padding: 10px 15px; border-radius: 15px; text-align: center; min-width: 80px; border: 2px solid; transition: all 0.3s; }
        .stat-card.energy { border-color: #ffcc00; }
        .stat-card.water { border-color: #00ccff; }
        .stat-card.mood { border-color: #d500f9; }
        .stat-card.critical { animation: pulse-red 1s infinite; border-color: #ff3d00 !important; }
        
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 5px #ff3d00; } 50% { box-shadow: 0 0 20px #ff3d00; } }
        
        .stat-icon { font-size: 20px; margin-bottom: 3px; }
        .stat-value { font-size: 16px; font-weight: bold; }
        .stat-bar { width: 100%; height: 4px; background: #333; border-radius: 2px; margin-top: 5px; overflow: hidden; }
        .stat-fill { height: 100%; transition: width 0.3s, background 0.3s; }
        .energy .stat-fill { background: #ffcc00; }
        .water .stat-fill { background: #00ccff; }
        .mood .stat-fill { background: #d500f9; }
        
        /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .bottom-panel { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.98), transparent); padding: 20px; max-height: 50%; overflow-y: auto; }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card { background: rgba(25,25,25,0.95); border-radius: 20px; padding: 20px; margin-bottom: 15px; border: 1px solid #333; display: none; }
        .card.active { display: block; animation: slideUp 0.4s ease; }
        
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .card-title { font-size: 20px; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .card-subtitle { color: #888; font-size: 13px; margin-bottom: 15px; }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { width: 100%; padding: 16px; border: none; border-radius: 15px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: linear-gradient(135deg, #00e676, #00c853); color: #000; }
        .btn-warning { background: linear-gradient(135deg, #ff9100, #ff6d00); color: #000; }
        .btn-danger { background: linear-gradient(135deg, #ff3d00, #dd2c00); color: #fff; }
        .btn-info { background: linear-gradient(135deg, #2979ff, #2962ff); color: #fff; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* –í—ã–±–æ—Ä –º–∞—Ä—à—Ä—É—Ç–∞ */
        .route-options { display: flex; flex-direction: column; gap: 10px; }
        .route-option { background: rgba(40,40,40,0.9); padding: 15px; border-radius: 15px; border: 2px solid #444; cursor: pointer; transition: all 0.2s; }
        .route-option:hover { border-color: #00e676; background: rgba(50,50,50,0.9); }
        .route-option.selected { border-color: #00e676; background: rgba(0,230,118,0.1); }
        .route-name { font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        .route-info { font-size: 12px; color: #aaa; display: flex; gap: 15px; }
        .route-tag { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px; margin-left: 5px; }
        .tag-fast { background: #ff3d00; color: #fff; }
        .tag-safe { background: #00e676; color: #000; }
        .tag-profit { background: #ffd600; color: #000; }
        
        /* –°–æ–±—ã—Ç–∏—è */
        .event-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 200; display: none; align-items: center; justify-content: center; padding: 20px; }
        .event-overlay.active { display: flex; animation: fadeIn 0.3s; }
        .event-card { background: #1a1a1a; border-radius: 25px; padding: 30px; max-width: 350px; width: 100%; border: 2px solid; text-align: center; }
        .event-icon { font-size: 60px; margin-bottom: 15px; }
        .event-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .event-text { color: #aaa; margin-bottom: 20px; line-height: 1.5; }
        .event-choices { display: flex; flex-direction: column; gap: 10px; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* –ú–∞—Ä–∫–µ—Ä—ã */
        .marker-courier { background: #00e676; width: 24px; height: 24px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 0 20px #00e676; animation: pulse-green 2s infinite; }
        .marker-dest { background: #ff3d00; width: 30px; height: 30px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 0 25px #ff3d00; }
        .marker-pitstop { background: #2979ff; width: 28px; height: 28px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 0 15px #2979ff; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        
        @keyframes pulse-green { 0%, 100% { box-shadow: 0 0 10px #00e676; } 50% { box-shadow: 0 0 25px #00e676; } }
        
        /* –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ—Å—Ç–∞–≤–∫–∏ */
        .delivery-progress { background: rgba(40,40,40,0.9); padding: 15px; border-radius: 15px; margin-bottom: 15px; }
        .progress-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 13px; color: #aaa; }
        .progress-bar { height: 8px; background: #333; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #00e676, #00c853); width: 0%; transition: width 0.5s; }
        .progress-stops { display: flex; justify-content: space-between; margin-top: 10px; font-size: 11px; }
        .stop { text-align: center; opacity: 0.4; transition: opacity 0.3s; }
        .stop.active { opacity: 1; }
        .stop.completed { opacity: 0.6; color: #00e676; }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.95); padding: 20px 30px; border-radius: 20px; border: 2px solid #00e676; color: #00e676; font-weight: bold; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 300; text-align: center; max-width: 300px; }
        .toast.show { opacity: 1; }
        .toast.error { border-color: #ff3d00; color: #ff3d00; }
        .toast.warning { border-color: #ff9100; color: #ff9100; }
        
        /* –ú–∏–Ω–∏-–∏–≥—Ä–∞ –≤–æ–∂–¥–µ–Ω–∏—è */
        .drive-game { display: none; background: #0f0f0f; border-radius: 20px; padding: 20px; text-align: center; }
        .drive-game.active { display: block; }
        .road { width: 100%; height: 150px; background: linear-gradient(to bottom, #1a1a1a, #0f0f0f); border-radius: 15px; position: relative; overflow: hidden; margin: 15px 0; border: 2px solid #333; }
        .lane { position: absolute; width: 100%; height: 33.33%; border-bottom: 2px dashed #444; }
        .player-bike { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); font-size: 30px; transition: top 0.2s; }
        .obstacle { position: absolute; right: -50px; font-size: 25px; animation: moveLeft 3s linear; }
        @keyframes moveLeft { from { right: -50px; } to { right: 110%; } }
        .game-controls { display: flex; justify-content: center; gap: 20px; margin-top: 10px; }
        .game-btn { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #444; background: #1a1a1a; color: #fff; font-size: 24px; cursor: pointer; transition: all 0.1s; }
        .game-btn:active { background: #333; transform: scale(0.95); }
        
        /* –ù–∞–≤—ã–∫–∏ */
        .skills-row { display: flex; gap: 10px; overflow-x: auto; padding: 5px 0; margin-bottom: 15px; }
        .skill-badge { background: rgba(50,50,50,0.9); padding: 8px 12px; border-radius: 20px; font-size: 12px; white-space: nowrap; border: 1px solid #555; }
        .skill-badge.active { border-color: #00e676; background: rgba(0,230,118,0.2); }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="ui-layer">
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
        <div class="top-panel">
            <div class="balance-box">
                <div class="balance-amount" id="balance">50 PLN</div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card energy" id="energy-card">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-value" id="energy-val">100</div>
                    <div class="stat-bar"><div class="stat-fill" id="energy-bar" style="width: 100%"></div></div>
                </div>
                <div class="stat-card water" id="water-card">
                    <div class="stat-icon">üíß</div>
                    <div class="stat-value" id="water-val">100</div>
                    <div class="stat-bar"><div class="stat-fill" id="water-bar" style="width: 100%"></div></div>
                </div>
                <div class="stat-card mood" id="mood-card">
                    <div class="stat-icon">üòé</div>
                    <div class="stat-value" id="mood-val">100</div>
                    <div class="stat-bar"><div class="stat-fill" id="mood-bar" style="width: 100%"></div></div>
                </div>
            </div>
        </div>
        
        <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å -->
        <div class="bottom-panel" id="bottom-panel">
            <!-- –ü–∞–Ω–µ–ª—å –æ–∂–∏–¥–∞–Ω–∏—è -->
            <div class="card active" id="wait-panel">
                <div class="card-title">üö¥ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
                <div class="card-subtitle">–í—ã–±–µ—Ä–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –¥–æ—Å—Ç–∞–≤–∫–∏. –£—á–∏—Ç—ã–≤–∞–π —Å–≤–æ–∏ —Ä–µ—Å—É—Ä—Å—ã!</div>
                <button class="btn btn-primary" onclick="findOrder()">üîç –ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑</button>
                <button class="btn btn-info" onclick="showStats()">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
            </div>
            
            <!-- –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ –º–∞—Ä—à—Ä—É—Ç–∞ -->
            <div class="card" id="route-panel">
                <div class="card-title">üó∫Ô∏è –í—ã–±–µ—Ä–∏ –º–∞—Ä—à—Ä—É—Ç</div>
                <div class="card-subtitle">–ö–∞–∂–¥—ã–π –ø—É—Ç—å –∏–º–µ–µ—Ç —Å–≤–æ–∏ —Ä–∏—Å–∫–∏ –∏ –Ω–∞–≥—Ä–∞–¥—ã</div>
                <div class="route-options" id="route-options"></div>
            </div>
            
            <!-- –ü–∞–Ω–µ–ª—å –¥–æ—Å—Ç–∞–≤–∫–∏ -->
            <div class="card" id="delivery-panel">
                <div class="card-title" id="delivery-title">üçî –î–æ—Å—Ç–∞–≤–∫–∞</div>
                <div class="delivery-progress">
                    <div class="progress-header">
                        <span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                        <span id="progress-percent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-stops" id="progress-stops"></div>
                </div>
                <div class="drive-game" id="drive-game">
                    <div class="card-subtitle">–£–∫–ª–æ–Ω—è–π—Å—è –æ—Ç –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π! ‚¨ÜÔ∏è ‚¨áÔ∏è</div>
                    <div class="road" id="game-road">
                        <div class="lane" style="top: 0;"></div>
                        <div class="lane" style="top: 33.33%;"></div>
                        <div class="lane" style="top: 66.66%;"></div>
                        <div class="player-bike" id="player">üö¥</div>
                    </div>
                    <div class="game-controls">
                        <button class="game-btn" onclick="moveBike(-1)">‚¨ÜÔ∏è</button>
                        <button class="game-btn" onclick="moveBike(1)">‚¨áÔ∏è</button>
                    </div>
                </div>
                <button class="btn btn-primary" id="action-btn" onclick="handleAction()">üö≤ –ü–æ–µ—Ö–∞–ª–∏!</button>
                <button class="btn btn-danger" id="cancel-btn" onclick="cancelDelivery()">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
            </div>
            
            <!-- –ü–∞–Ω–µ–ª—å –ø–∏—Ç-—Å—Ç–æ–ø–∞ -->
            <div class="card" id="pitstop-panel">
                <div class="card-title" id="pitstop-title">‚õΩ –ü–∏—Ç-—Å—Ç–æ–ø</div>
                <div class="card-subtitle" id="pitstop-desc">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏ —Å–∏–ª—ã –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º</div>
                <div id="pitstop-options"></div>
            </div>
        </div>
    </div>
    
    <!-- –û–≤–µ—Ä–ª–µ–π —Å–æ–±—ã—Ç–∏–π -->
    <div class="event-overlay" id="event-overlay">
        <div class="event-card" id="event-card">
            <div class="event-icon" id="event-icon">‚ö†Ô∏è</div>
            <div class="event-title" id="event-title">–°–æ–±—ã—Ç–∏–µ</div>
            <div class="event-text" id="event-text">–ß—Ç–æ-—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ...</div>
            <div class="event-choices" id="event-choices"></div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>






        <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase (—Ç–≤–æ—è)
        const firebaseConfig = {
            apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
            authDomain: "warszawa-courier.firebaseapp.com",
            databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "warszawa-courier",
            storageBucket: "warszawa-courier.firebasestorage.app",
            messagingSenderId: "295860613508",
            appId: "1:295860613508:web:86fe8364377d6875612dd1"
        };

        // –¶–µ–Ω—Ç—Ä –í–∞—Ä—à–∞–≤—ã
        const WARSAW_CENTER = [52.2297, 21.0122];
        
        // –¢–∏–ø—ã –ø–∏—Ç-—Å—Ç–æ–ø–æ–≤
        const PITSTOPS = {
            gas: { name: '–ê–ó–°', icon: '‚õΩ', color: '#ff9100', items: [
                { name: '–ö–æ—Ñ–µ', cost: 4, energy: 25, water: -5, mood: 10, icon: '‚òï' },
                { name: '–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫', cost: 7, energy: 50, water: -10, mood: 5, icon: '‚ö°' },
                { name: '–í–æ–¥–∞', cost: 3, energy: 5, water: 40, mood: 0, icon: 'üíß' }
            ]},
            cafe: { name: '–ö–∞—Ñ–µ', icon: '‚òï', color: '#795548', items: [
                { name: '–û–±–µ–¥', cost: 12, energy: 40, water: 20, mood: 30, icon: 'üçΩÔ∏è' },
                { name: '–î–µ—Å–µ—Ä—Ç', cost: 8, energy: 15, water: -5, mood: 40, icon: 'üç∞' },
                { name: '–õ–∞—Ç—Ç–µ', cost: 6, energy: 20, water: 10, mood: 15, icon: '‚òï' }
            ]},
            park: { name: '–ü–∞—Ä–∫', icon: 'üå≥', color: '#4caf50', items: [
                { name: '–û—Ç–¥—ã—Ö 10 –º–∏–Ω', cost: 0, energy: 15, water: 0, mood: 35, icon: 'üßò' },
                { name: '–í–æ–¥–∞ –∏–∑ —Ñ–æ–Ω—Ç–∞–Ω–∞', cost: 0, energy: -5, water: 25, mood: 10, icon: 'üíß' }
            ]}
        };
        
        // –†–µ—Å—Ç–æ—Ä–∞–Ω—ã
        const RESTAURANTS = [
            { name: "McDonald's", icon: "üçî", time: 5 },
            { name: "KFC", icon: "üçó", time: 7 },
            { name: "Pizza Hut", icon: "üçï", time: 10 },
            { name: "Sushi Master", icon: "üç£", time: 8 },
            { name: "Kebab King", icon: "üåØ", time: 4 },
            { name: "Burger King", icon: "üçî", time: 6 },
            { name: "Starbucks", icon: "‚òï", time: 3 }
        ];
        
        // –°–ª—É—á–∞–π–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ
        const ROAD_EVENTS = [
            { 
                id: 'rain', icon: 'üåßÔ∏è', title: '–õ–∏–≤–µ–Ω—å!', text: '–î–æ—Ä–æ–≥–∏ —Å–∫–æ–ª—å–∑–∫–∏–µ. –†–∏—Å–∫ –∞–≤–∞—Ä–∏–∏ –≤—ã—à–µ, –Ω–æ –∑–∞–∫–∞–∑—á–∏–∫–∏ –¥–∞—é—Ç —á–∞–µ–≤—ã–µ –∑–∞ —Å–∫–æ—Ä–æ—Å—Ç—å.',
                choices: [
                    { text: '–ï—Ö–∞—Ç—å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ (-–≤—Ä–µ–º—è, +–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)', effect: { time: 1.3, risk: -20, mood: -10 } },
                    { text: '–†–∏—Å–∫–Ω—É—Ç—å —Ä–∞–¥–∏ —á–∞–µ–≤—ã—Ö (+–¥–µ–Ω—å–≥–∏, +—Ä–∏—Å–∫)', effect: { time: 0.9, risk: 30, moneyBonus: 5 } }
                ]
            },
            { 
                id: 'police', icon: 'üöî', title: '–ü–æ–ª–∏—Ü–∏—è', text: '–ü–∞—Ç—Ä—É–ª—å –æ—Å—Ç–∞–Ω–æ–≤–∏–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.',
                choices: [
                    { text: '–ü–æ–∫–∞–∑–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã (-5 –º–∏–Ω)', effect: { time: 1.2, mood: -15 } },
                    { text: '–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å "–∫–æ—Ñ–µ" (-20 PLN)', effect: { money: -20, mood: -5 } }
                ]
            },
            { 
                id: 'shortcut', icon: 'üöß', title: '–ü—Ä–æ–±–∫–∞', text: '–ì–ª–∞–≤–Ω–∞—è –¥–æ—Ä–æ–≥–∞ –≤—Å—Ç–∞–ª–∞. –ï—Å—Ç—å –æ–±—ä–µ–∑–¥ —á–µ—Ä–µ–∑ –¥–≤–æ—Ä—ã.',
                choices: [
                    { text: '–ñ–¥–∞—Ç—å –≤ –ø—Ä–æ–±–∫–µ (+–≤—Ä–µ–º—è, -–Ω–µ—Ä–≤—ã)', effect: { time: 1.5, mood: -20, energy: -10 } },
                    { text: '–û–±—ä–µ–∑–¥ —á–µ—Ä–µ–∑ –¥–≤–æ—Ä—ã (+—Ä–∏—Å–∫)', effect: { time: 0.8, risk: 25, energy: -5 } }
                ]
            },
            { 
                id: 'client', icon: 'üì±', title: '–ó–≤–æ–Ω–æ–∫ –∫–ª–∏–µ–Ω—Ç–∞', text: '"–í—ã –≥–¥–µ? –£–∂–µ 5 –º–∏–Ω—É—Ç –∂–¥—É!"',
                choices: [
                    { text: '–ò–∑–≤–∏–Ω–∏—Ç—å—Å—è –∏ —É—Å–∫–æ—Ä–∏—Ç—å—Å—è (-—ç–Ω–µ—Ä–≥–∏—è)', effect: { energy: -15, mood: -10, time: 0.9 } },
                    { text: '–°–∫–∞–∑–∞—Ç—å —á—Ç–æ —Å–∫–æ—Ä–æ (–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å)', effect: { mood: -20, moneyBonus: -5 } }
                ]
            }
        ];
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let state = {
            balance: 50,
            energy: 100,
            water: 100,
            mood: 100,
            experience: 0,
            level: 1,
            stats: {
                totalDeliveries: 0,
                totalEarned: 0,
                accidents: 0,
                bestTip: 0
            },
            currentOrder: null,
            currentRoute: null,
            isDelivering: false,
            progress: 0,
            currentStop: 0,
            gameActive: false,
            bikeLane: 1 // 0, 1, 2 –¥–ª—è –º–∏–Ω–∏-–∏–≥—Ä—ã
        };
        
        // –ö–∞—Ä—Ç–∞ –∏ –º–∞—Ä–∫–µ—Ä—ã
        let map, courierMarker, destMarker, routeLine, pitstopMarkers = [];
        let gameInterval, obstacleInterval;



             // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            // –ö–∞—Ä—Ç–∞
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView(WARSAW_CENTER, 13);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            }).addTo(map);
            
            // –ú–∞—Ä–∫–µ—Ä –∫—É—Ä—å–µ—Ä–∞
            const courierIcon = L.divIcon({
                html: '<div class="marker-courier"></div>',
                className: 'custom-marker',
                iconSize: [24, 24]
            });
            courierMarker = L.marker(WARSAW_CENTER, { icon: courierIcon }).addTo(map);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª—ã
            updateUI();
            setInterval(gameTick, 1000);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
            showToast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ù–∞–π–¥–∏ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑.', 3000);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI —Ä–µ—Å—É—Ä—Å–æ–≤
        function updateUI() {
            document.getElementById('balance').textContent = Math.floor(state.balance) + ' PLN';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏ –±–∞—Ä—ã
            ['energy', 'water', 'mood'].forEach(stat => {
                const val = Math.floor(state[stat]);
                document.getElementById(stat + '-val').textContent = val;
                document.getElementById(stat + '-bar').style.width = val + '%';
                
                // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
                const card = document.getElementById(stat + '-card');
                if (val < 25) {
                    card.classList.add('critical');
                } else {
                    card.classList.remove('critical');
                }
            });
        }
        
        // –ò–≥—Ä–æ–≤–æ–π —Ç–∏–∫ (–∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É)
        function gameTick() {
            if (state.isDelivering && !state.gameActive) {
                // –ü–∞—Å—Å–∏–≤–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ —Ä–µ—Å—É—Ä—Å–æ–≤
                state.energy -= 0.3;
                state.water -= 0.2;
                state.mood -= 0.1;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏—Å—Ç–æ—â–µ–Ω–∏–µ
                if (state.energy <= 0 || state.water <= 0) {
                    failDelivery('–†–µ—Å—É—Ä—Å—ã –∏—Å—á–µ—Ä–ø–∞–Ω—ã! –¢—ã –Ω–µ –¥–æ–µ—Ö–∞–ª.');
                }
                
                updateUI();
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showToast(msg, duration = 2500) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), duration);
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–µ–π
        function showPanel(panelName) {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            document.getElementById(panelName + '-panel').classList.add('active');
        }










                    // –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞
        function findOrder() {
            if (state.energy < 30 || state.water < 30) {
                showToast('‚ö†Ô∏è –°–ª–∏—à–∫–æ–º —É—Å—Ç–∞–ª! –û—Ç–¥–æ—Ö–Ω–∏ —Å–Ω–∞—á–∞–ª–∞.', 3000);
                return;
            }
            
            const rest = RESTAURANTS[Math.floor(Math.random() * RESTAURANTS.length)];
            const dist = (1.5 + Math.random() * 4).toFixed(1);
            const basePrice = Math.floor(15 + parseFloat(dist) * 8);
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞
            const routes = generateRoutes(dist, basePrice);
            
            state.currentOrder = {
                restaurant: rest,
                distance: parseFloat(dist),
                basePrice: basePrice,
                routes: routes,
                destLat: WARSAW_CENTER[0] + (Math.random() - 0.5) * 0.06,
                destLng: WARSAW_CENTER[1] + (Math.random() - 0.5) * 0.08
            };
            
            renderRouteOptions(routes);
            showPanel('route');
        }
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤
        function generateRoutes(dist, basePrice) {
            const routes = [];
            
            // –ö–æ—Ä–æ—Ç–∫–∏–π —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω—ã–π
            routes.push({
                id: 'fast',
                name: 'üèéÔ∏è –ö–æ—Ä–æ—Ç–∫–∏–π –ø—É—Ç—å',
                tag: 'tag-fast',
                tagText: '–ë—ã—Å—Ç—Ä–æ',
                time: Math.floor(dist * 2.5),
                risk: 40,
                energyCost: 25,
                waterCost: 20,
                price: basePrice + 5,
                pitstops: 0,
                desc: `${dist} –∫–º ‚Ä¢ ${Math.floor(dist * 2.5)} –º–∏–Ω ‚Ä¢ –†–∏—Å–∫: –≤—ã—Å–æ–∫–∏–π`
            });
            
            // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å –ø–∏—Ç-—Å—Ç–æ–ø–æ–º
            routes.push({
                id: 'safe',
                name: 'üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π',
                tag: 'tag-safe',
                tagText: '–ù–∞–¥—ë–∂–Ω–æ',
                time: Math.floor(dist * 4),
                risk: 10,
                energyCost: 15,
                waterCost: 15,
                price: basePrice,
                pitstops: 1,
                desc: `${dist} –∫–º ‚Ä¢ ${Math.floor(dist * 4)} –º–∏–Ω ‚Ä¢ 1 –ø–∏—Ç-—Å—Ç–æ–ø`
            });
            
            // –ü—Ä–∏–±—ã–ª—å–Ω—ã–π –¥–ª–∏–Ω–Ω—ã–π
            routes.push({
                id: 'profit',
                name: 'üí∞ –ü—Ä–∏–±—ã–ª—å–Ω—ã–π',
                tag: 'tag-profit',
                tagText: '–î–æ—Ö–æ–¥',
                time: Math.floor(dist * 5),
                risk: 20,
                energyCost: 35,
                waterCost: 25,
                price: Math.floor(basePrice * 1.4),
                pitstops: 2,
                desc: `${dist} –∫–º ‚Ä¢ ${Math.floor(dist * 5)} –º–∏–Ω ‚Ä¢ 2 –ø–∏—Ç-—Å—Ç–æ–ø–∞ ‚Ä¢ –ß–∞–µ–≤—ã–µ`
            });
            
            return routes;
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –º–∞—Ä—à—Ä—É—Ç–∞
        function renderRouteOptions(routes) {
            const container = document.getElementById('route-options');
            container.innerHTML = '';
            
            routes.forEach((route, idx) => {
                const div = document.createElement('div');
                div.className = 'route-option';
                div.onclick = () => selectRoute(idx);
                div.innerHTML = `
                    <div class="route-name">
                        ${route.name}
                        <span class="route-tag ${route.tag}">${route.tagText}</span>
                    </div>
                    <div class="route-info">
                        <span>‚è±Ô∏è ${route.time} –º–∏–Ω</span>
                        <span>‚ö° -${route.energyCost}</span>
                        <span>üíß -${route.waterCost}</span>
                        <span style="color: #00e676; font-weight: bold;">${route.price} PLN</span>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">${route.desc}</div>
                `;
                container.appendChild(div);
            });
        }
        
        // –í—ã–±–æ—Ä –º–∞—Ä—à—Ä—É—Ç–∞
        function selectRoute(idx) {
            state.currentRoute = state.currentOrder.routes[idx];
            state.currentRoute.pitstopData = generatePitstops(state.currentRoute.pitstops);
            
            // –í–∏–∑—É–∞–ª—å–Ω–æ –≤—ã–¥–µ–ª—è–µ–º
            document.querySelectorAll('.route-option').forEach((el, i) => {
                el.classList.toggle('selected', i === idx);
            });
            
            setTimeout(() => startDelivery(), 500);
        }
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∏—Ç-—Å—Ç–æ–ø–æ–≤
        function generatePitstops(count) {
            const types = Object.keys(PITSTOPS);
            const stops = [];
            for (let i = 0; i < count; i++) {
                const type = types[Math.floor(Math.random() * types.length)];
                stops.push({
                    type: type,
                    ...PITSTOPS[type],
                    progress: Math.floor(((i + 1) / (count + 1)) * 100)
                });
            }
            return stops;
        }



                // –ù–∞—á–∞–ª–æ –¥–æ—Å—Ç–∞–≤–∫–∏
        function startDelivery() {
            state.isDelivering = true;
            state.progress = 0;
            state.currentStop = 0;
            
            // –°–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã
            state.energy -= state.currentRoute.energyCost * 0.3;
            state.water -= state.currentRoute.waterCost * 0.3;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞ –∫–∞—Ä—Ç–µ
            const dest = [state.currentOrder.destLat, state.currentOrder.destLng];
            
            const destIcon = L.divIcon({
                html: '<div class="marker-dest"></div>',
                className: 'custom-marker',
                iconSize: [30, 30]
            });
            destMarker = L.marker(dest, { icon: destIcon }).addTo(map);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∏—Ç-—Å—Ç–æ–ø—ã –Ω–∞ –∫–∞—Ä—Ç–µ
            state.currentRoute.pitstopData.forEach((stop, idx) => {
                const lat = WARSAW_CENTER[0] + (dest[0] - WARSAW_CENTER[0]) * (stop.progress / 100);
                const lng = WARSAW_CENTER[1] + (dest[1] - WARSAW_CENTER[1]) * (stop.progress / 100);
                
                const stopIcon = L.divIcon({
                    html: `<div class="marker-pitstop">${stop.icon}</div>`,
                    className: 'custom-marker',
                    iconSize: [28, 28]
                });
                const marker = L.marker([lat, lng], { icon: stopIcon }).addTo(map);
                marker.bindPopup(stop.name);
                pitstopMarkers.push(marker);
            });
            
            // –õ–∏–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
            routeLine = L.polyline([WARSAW_CENTER, dest], {
                color: '#00e676',
                weight: 4,
                opacity: 0.6,
                dashArray: '8, 8'
            }).addTo(map);
            
            map.fitBounds([WARSAW_CENTER, dest], { padding: [60, 60] });
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º UI –¥–æ—Å—Ç–∞–≤–∫–∏
            document.getElementById('delivery-title').innerHTML = 
                `${state.currentOrder.restaurant.icon} –î–æ—Å—Ç–∞–≤–∫–∞ –∏–∑ ${state.currentOrder.restaurant.name}`;
            updateProgressUI();
            
            showPanel('delivery');
            showToast('–ü–æ–µ—Ö–∞–ª–∏! –°–ª–µ–¥–∏ –∑–∞ —Ä–µ—Å—É—Ä—Å–∞–º–∏.', 2000);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function updateProgressUI() {
            document.getElementById('progress-percent').textContent = Math.floor(state.progress) + '%';
            document.getElementById('progress-fill').style.width = state.progress + '%';
            
            const stopsContainer = document.getElementById('progress-stops');
            stopsContainer.innerHTML = '';
            
            // –¢–æ—á–∫–∏ –ø–∏—Ç-—Å—Ç–æ–ø–æ–≤
            state.currentRoute.pitstopData.forEach((stop, idx) => {
                const div = document.createElement('div');
                div.className = 'stop';
                if (idx < state.currentStop) div.classList.add('completed');
                if (idx === state.currentStop && state.progress >= stop.progress) div.classList.add('active');
                div.innerHTML = `${stop.icon}<br><small>${stop.name}</small>`;
                stopsContainer.appendChild(div);
            });
            
            // –§–∏–Ω–∏—à
            const finishDiv = document.createElement('div');
            finishDiv.className = 'stop';
            if (state.progress >= 100) finishDiv.classList.add('active');
            finishDiv.innerHTML = `üèÅ<br><small>–§–∏–Ω–∏—à</small>`;
            stopsContainer.appendChild(finishDiv);
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è (–µ—Ö–∞—Ç—å/–ø–∏—Ç-—Å—Ç–æ–ø)
        function handleAction() {
            if (state.gameActive) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–æ—Ä–∞ –ª–∏ –Ω–∞ –ø–∏—Ç-—Å—Ç–æ–ø
            const nextStop = state.currentRoute.pitstopData[state.currentStop];
            if (nextStop && state.progress >= nextStop.progress && state.progress < 100) {
                showPitstop(nextStop);
                return;
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–Ω–∏-–∏–≥—Ä—É –≤–æ–∂–¥–µ–Ω–∏—è
            startDrivingGame();
        }
        
        // –ú–∏–Ω–∏-–∏–≥—Ä–∞ –≤–æ–∂–¥–µ–Ω–∏—è
        function startDrivingGame() {
            state.gameActive = true;
            document.getElementById('drive-game').classList.add('active');
            document.getElementById('action-btn').style.display = 'none';
            
            state.bikeLane = 1;
            updateBikePosition();
            
            // –°–ø–∞–≤–Ω–∏–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
            obstacleInterval = setInterval(spawnObstacle, 1500);
            
            // –¢–∞–π–º–µ—Ä –∏–≥—Ä—ã
            let gameTime = 0;
            gameInterval = setInterval(() => {
                gameTime += 100;
                if (gameTime >= 3000) { // 3 —Å–µ–∫—É–Ω–¥—ã = –æ–¥–∏–Ω "–ø—Ä–æ—Ö–æ–¥"
                    endDrivingGame(true);
                }
            }, 100);
        }
        
        function updateBikePosition() {
            const bike = document.getElementById('player');
            bike.style.top = (state.bikeLane * 33.33 + 16.66) + '%';
        }
        
        function moveBike(dir) {
            state.bikeLane += dir;
            if (state.bikeLane < 0) state.bikeLane = 0;
            if (state.bikeLane > 2) state.bikeLane = 2;
            updateBikePosition();
        }
        
        function spawnObstacle() {
            const road = document.getElementById('game-road');
            const obstacle = document.createElement('div');
            obstacle.className = 'obstacle';
            obstacle.textContent = ['üöó', 'üöß', 'üï≥Ô∏è', 'üêï', 'üö∂'][Math.floor(Math.random() * 5)];
            obstacle.style.top = (Math.floor(Math.random() * 3) * 33.33 + 8) + '%';
            road.appendChild(obstacle);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
            setTimeout(() => {
                const bikeRect = document.getElementById('player').getBoundingClientRect();
                const obsRect = obstacle.getBoundingClientRect();
                
                if (Math.abs(bikeRect.top - obsRect.top) < 30 && obsRect.left < bikeRect.right && obsRect.right > bikeRect.left) {
                    // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ!
                    clearInterval(obstacleInterval);
                    clearInterval(gameInterval);
                    endDrivingGame(false);
                }
                
                setTimeout(() => obstacle.remove(), 3000);
            }, 2800);
        }
        
        function endDrivingGame(success) {
            state.gameActive = false;
            clearInterval(obstacleInterval);
            clearInterval(gameInterval);
            document.getElementById('drive-game').classList.remove('active');
            document.getElementById('action-btn').style.display = 'block';
            
            // –£–±–∏—Ä–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
            document.querySelectorAll('.obstacle').forEach(o => o.remove());
            
            if (success) {
                // –£—Å–ø–µ—Ö - –¥–≤–∏–≥–∞–µ–º—Å—è –¥–∞–ª—å—à–µ
                state.progress += 25;
                
                // –†–∞—Å—Ö–æ–¥ —Ä–µ—Å—É—Ä—Å–æ–≤ –∑–∞ –ø–æ–µ–∑–¥–∫—É
                state.energy -= 8;
                state.water -= 5;
                state.mood -= 3;
                
                updateUI();
                updateProgressUI();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∏—Ç-—Å—Ç–æ–ø –∏–ª–∏ —Ñ–∏–Ω–∏—à
                const nextStop = state.currentRoute.pitstopData[state.currentStop];
                if (nextStop && state.progress >= nextStop.progress) {
                    showToast(` –û—Å—Ç–∞–Ω–æ–≤–∫–∞: ${nextStop.name}`, 2000);
                } else if (state.progress >= 100) {
                    completeDelivery();
                } else {
                    // –°–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ —Å —à–∞–Ω—Å–æ–º
                    if (Math.random() < state.currentRoute.risk / 100) {
                        triggerRandomEvent();
                    }
                }
            } else {
                // –ê–≤–∞—Ä–∏—è
                state.stats.accidents++;
                state.energy -= 20;
                state.mood -= 15;
                state.progress += 10; // –ú–µ–¥–ª–µ–Ω–Ω–æ –ø–æ–ª–∑—ë–º –¥–∞–ª—å—à–µ
                
                showToast('üí• –ê–≤–∞—Ä–∏—è! -20 —ç–Ω–µ—Ä–≥–∏–∏', 3000);
                updateUI();
                updateProgressUI();
            }
        }






                    // –ü–æ–∫–∞–∑–∞—Ç—å –ø–∏—Ç-—Å—Ç–æ–ø
        function showPitstop(stop) {
            showPanel('pitstop');
            document.getElementById('pitstop-title').innerHTML = `${stop.icon} ${stop.name}`;
            document.getElementById('pitstop-desc').textContent = '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏ —Å–∏–ª—ã –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º –ø—É—Ç–∏';
            
            const container = document.getElementById('pitstop-options');
            container.innerHTML = '';
            
            stop.items.forEach(item => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-primary';
                btn.style.marginBottom = '10px';
                btn.innerHTML = `${item.icon} ${item.name} ‚Äî ${item.cost} PLN<br>
                    <small style="opacity: 0.8;">‚ö°${item.energy > 0 ? '+' : ''}${item.energy} 
                    üíß${item.water > 0 ? '+' : ''}${item.water} 
                    üòé${item.mood > 0 ? '+' : ''}${item.mood}</small>`;
                
                btn.onclick = () => buyAtPitstop(item, stop);
                container.appendChild(btn);
            });
            
            // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –ø–æ–∫—É–ø–æ–∫"
            const skipBtn = document.createElement('button');
            skipBtn.className = 'btn btn-warning';
            skipBtn.textContent = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—É—Ç—å';
            skipBtn.onclick = () => {
                state.currentStop++;
                showPanel('delivery');
                updateProgressUI();
            };
            container.appendChild(skipBtn);
        }
        
        // –ü–æ–∫—É–ø–∫–∞ –Ω–∞ –ø–∏—Ç-—Å—Ç–æ–ø–µ
        function buyAtPitstop(item, stop) {
            if (state.balance < item.cost) {
                showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!', 2000);
                return;
            }
            
            state.balance -= item.cost;
            state.energy = Math.min(100, state.energy + item.energy);
            state.water = Math.min(100, state.water + item.water);
            state.mood = Math.min(100, state.mood + item.mood);
            
            state.currentStop++;
            updateUI();
            showPanel('delivery');
            updateProgressUI();
            showToast(`${item.icon} –û—Ç–ª–∏—á–Ω–æ! –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—É—Ç—å.`, 2000);
        }
        
        // –°–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
        function triggerRandomEvent() {
            const event = ROAD_EVENTS[Math.floor(Math.random() * ROAD_EVENTS.length)];
            
            document.getElementById('event-icon').textContent = event.icon;
            document.getElementById('event-title').textContent = event.title;
            document.getElementById('event-text').textContent = event.text;
            
            const choicesContainer = document.getElementById('event-choices');
            choicesContainer.innerHTML = '';
            
            event.choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-primary';
                btn.textContent = choice.text;
                btn.onclick = () => resolveEvent(choice.effect);
                choicesContainer.appendChild(btn);
            });
            
            document.getElementById('event-overlay').classList.add('active');
        }
        
        // –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
        function resolveEvent(effect) {
            document.getElementById('event-overlay').classList.remove('active');
            
            if (effect.time) {
                // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏/–ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                state.progress = Math.min(100, state.progress * effect.time);
            }
            if (effect.money) state.balance += effect.money;
            if (effect.energy) state.energy = Math.max(0, state.energy + effect.energy);
            if (effect.water) state.water = Math.max(0, state.water + effect.water);
            if (effect.mood) state.mood = Math.max(0, state.mood + effect.mood);
            if (effect.moneyBonus && state.currentOrder) state.currentOrder.bonus = effect.moneyBonus;
            
            updateUI();
            updateProgressUI();
            showToast('–°–æ–±—ã—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!', 2000);
        }
        
        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏
        function completeDelivery() {
            let earned = state.currentRoute.price;
            
            // –ë–æ–Ω—É—Å—ã
            if (state.mood > 80) earned += Math.floor(earned * 0.2);
            if (state.currentOrder.bonus) earned += state.currentOrder.bonus;
            
            // –ß–∞–µ–≤—ã–µ –∑–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
            const tip = Math.floor(Math.random() * (state.mood / 10));
            earned += tip;
            
            state.balance += earned;
            state.stats.totalDeliveries++;
            state.stats.totalEarned += earned;
            if (tip > state.stats.bestTip) state.stats.bestTip = tip;
            
            // –û–ø—ã—Ç
            state.experience += 10;
            if (state.experience >= state.level * 50) {
                state.level++;
                state.experience = 0;
                showToast(`üéâ –£—Ä–æ–≤–µ–Ω—å ${state.level}! –ù–æ–≤—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –æ—Ç–∫—Ä—ã—Ç—ã.`, 3000);
            }
            
            // –°–±—Ä–æ—Å
            resetDelivery();
            showPanel('wait');
            showToast(`üí∞ +${earned} PLN${tip > 0 ? ' (—á–∞–µ–≤—ã–µ: ' + tip + ')' : ''}!`, 3000);
            updateUI();
        }
        
        // –ü—Ä–æ–≤–∞–ª –¥–æ—Å—Ç–∞–≤–∫–∏
        function failDelivery(reason) {
            state.stats.accidents++;
            resetDelivery();
            showPanel('wait');
            showToast(reason, 4000);
            updateUI();
        }
        
        // –û—Ç–º–µ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
        function cancelDelivery() {
            if (confirm('–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑? –®—Ç—Ä–∞—Ñ 10 PLN')) {
                state.balance = Math.max(0, state.balance - 10);
                resetDelivery();
                showPanel('wait');
                showToast('–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω. –®—Ç—Ä–∞—Ñ: 10 PLN', 3000);
                updateUI();
            }
        }
        
        // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏
        function resetDelivery() {
            state.isDelivering = false;
            state.currentOrder = null;
            state.currentRoute = null;
            state.progress = 0;
            state.currentStop = 0;
            state.gameActive = false;
            
            if (destMarker) map.removeLayer(destMarker);
            if (routeLine) map.removeLayer(routeLine);
            pitstopMarkers.forEach(m => map.removeLayer(m));
            pitstopMarkers = [];
            
            courierMarker.setLatLng(WARSAW_CENTER);
            map.setView(WARSAW_CENTER, 13);
            
            clearInterval(gameInterval);
            clearInterval(obstacleInterval);
            document.querySelectorAll('.obstacle').forEach(o => o.remove());
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        function showStats() {
            const msg = `üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
–î–æ—Å—Ç–∞–≤–æ–∫: ${state.stats.totalDeliveries}
–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: ${state.stats.totalEarned} PLN
–ê–≤–∞—Ä–∏–π: ${state.stats.accidents}
–õ—É—á—à–∏–µ —á–∞–µ–≤—ã–µ: ${state.stats.bestTip} PLN
–£—Ä–æ–≤–µ–Ω—å: ${state.level}`;
            alert(msg);
        }
        
        // –°—Ç–∞—Ä—Ç
        init();
    </script>
</body>
</html>






