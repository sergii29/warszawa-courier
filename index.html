<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warsaw Courier: Syndicate</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #f0f2f5; --grid: #d1d9e6; --lime: #32CD32; --dark: #121212; --danger: #ff3b3b; --blue: #007bff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; font-family: 'Courier New', monospace; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); }

        /* –ò–ì–†–û–í–û–ï –ü–û–õ–ï */
        #game-area {
            position: absolute; top: 140px; left: 0; right: 0; bottom: 260px;
            background-image: linear-gradient(var(--grid) 1px, transparent 1px), linear-gradient(90deg, var(--grid) 1px, transparent 1px);
            background-size: 30px 30px; 
            z-index: 1; overflow: hidden; 
            border-top: 2px solid #ccc; border-bottom: 2px solid #ccc;
        }
        
        /* –°–ò–†–ï–ù–ê (–í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –±–ª–∏–∑–æ—Å—Ç–∏ –ø–æ–ª–∏—Ü–∏–∏) */
        @keyframes siren-flash { 0% {box-shadow: inset 0 0 0 0 transparent;} 50% {box-shadow: inset 0 0 30px 10px rgba(255,0,0,0.5);} 100% {box-shadow: inset 0 0 30px 10px rgba(0,0,255,0.5);} }
        .siren-active { animation: siren-flash 0.8s infinite; border: 2px solid red !important; }

        /* –°–£–©–ù–û–°–¢–ò */
        .entity { 
            position: absolute; width: 30px; height: 30px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 20px; transition: all 0.2s linear; /* –ü–ª–∞–≤–Ω–µ–µ –¥–≤–∏–∂–µ–Ω–∏–µ */
        }
        #player { 
            z-index: 100; font-size: 24px; 
            background: rgba(50, 205, 50, 0.4); 
            border-radius: 50%; border: 2px solid var(--dark);
        }
        .police { z-index: 50; transition: top 1s linear, left 1s linear; }
        .obs { z-index: 10; opacity: 0.7; }

        /* UI */
        #top-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 140px;
            background: white; z-index: 200; padding: 10px; display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .wallet-row { display: flex; width: 100%; justify-content: space-around; border-bottom: 2px dashed #ccc; padding-bottom: 5px; margin-bottom: 5px; }
        .stat-t { font-size: 14px; font-weight: bold; color: #555; }
        .stat-v { font-size: 18px; font-weight: 900; color: var(--dark); }
        
        .bars { width: 100%; max-width: 300px; display: flex; flex-direction: column; gap: 4px; font-size: 10px; font-weight: bold; }
        .bar-row { display: flex; align-items: center; justify-content: space-between; }
        .bar-track { flex-grow: 1; height: 8px; background: #eee; margin-left: 5px; border: 1px solid #999; border-radius: 4px; overflow: hidden; }
        .bar-val { height: 100%; transition: width 0.3s; }

        #bot-ui {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 260px;
            background: white; z-index: 200; border-top: 2px solid var(--dark);
            display: flex; flex-direction: column; align-items: center; padding-top: 10px;
        }

        .joy-pad { display: grid; grid-template-columns: 70px 70px 70px; grid-template-rows: 60px 60px; gap: 8px; margin-top: 10px;}
        .j-btn { background: #f0f0f0; border: 1px solid #bbb; border-radius: 12px; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 0 #ccc; }
        .j-btn:active { background: #e0e0e0; box-shadow: 0 2px 0 #ccc; transform: translateY(2px); }
        .u { grid-column: 2; grid-row: 1; } .l { grid-column: 1; grid-row: 2; } 
        .d { grid-column: 2; grid-row: 2; } .r { grid-column: 3; grid-row: 2; }

        .btn-main { background: var(--lime); color: black; border: 2px solid black; padding: 15px 40px; font-weight: bold; border-radius: 8px; margin-top: 40px; cursor: pointer; }

        /* SCENES */
        #arrest-screen {
            position: fixed; top:0; left:0; width:100%; height:100%; z-index: 9000;
            background: rgba(0,0,50,0.9); display: none; flex-direction: column;
            align-items: center; justify-content: center; color: white;
        }
        
        /* MENU & MODALS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .popup { background: white; padding: 20px; border-radius: 10px; text-align: center; width: 85%; max-width: 320px; border: 3px solid var(--lime); }
        
        #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: black; color: white; padding: 10px 20px; border-radius: 20px; z-index: 5000; display: none; text-align: center;}

        #menu-btn { position: absolute; top: 10px; left: 10px; width: 40px; height: 40px; background: #333; z-index: 201; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; gap:4px; border-radius:6px; }
        .ml { width: 24px; height: 2px; background: white; }
        
        #sidebar { position: fixed; top:0; left:-300px; width:290px; height:100%; background:white; z-index:2001; transition:0.3s; border-right:2px solid black; padding:20px; overflow-y:auto; }
        #sidebar.open { left:0; }
        
        .bank-card { background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .debt-text { color: var(--danger); font-weight: bold; margin-top: 5px; font-size: 12px;}
    </style>
</head>
<body>

<div id="top-ui">
    <div class="wallet-row">
        <div><div class="stat-t">–ù–∞–ª–∏—á–∫–∞</div><div class="stat-v" id="cash">0.00</div></div>
        <div><div class="stat-t">–ë–∞–Ω–∫</div><div class="stat-v" id="bank">0.00</div></div>
    </div>
    <div style="font-size: 10px; margin-bottom: 5px;">LVL: <span id="lvl">1</span> | –î–æ–ª–≥: <span id="debt" style="color:red">0</span></div>
    
    <div class="bars">
        <div class="bar-row">‚ö° <div class="bar-track"><div id="b-en" class="bar-val" style="width:100%; background:orange"></div></div></div>
        <div class="bar-row">üíß <div class="bar-track"><div id="b-wat" class="bar-val" style="width:100%; background:#00aaff"></div></div></div>
        <div class="bar-row">üö≤ <div class="bar-track"><div id="b-hp" class="bar-val" style="width:100%; background:#555"></div></div></div>
    </div>
</div>

<div id="menu-btn" onclick="toggleMenu()"><div class="ml"></div><div class="ml"></div><div class="ml"></div></div>

<div id="arrest-screen">
    <div style="font-size:50px; margin-bottom:20px">üöî</div>
    <h1 style="color:red; font-weight:900; letter-spacing:2px">–í–´ –ê–†–ï–°–¢–û–í–ê–ù–´</h1>
    <p>–ü–æ–ø—ã—Ç–∫–∞ —Å–∫—Ä—ã—Ç—å—Å—è –Ω–µ —É–¥–∞–ª–∞—Å—å.</p>
    <h2 style="color: yellow; margin-top:10px">-50 PLN –®—Ç—Ä–∞—Ñ</h2>
    <div style="margin-top:20px; font-size:12px; color:#ccc">–ü–µ—Ä–µ–≤–æ–∑–∫–∞ –≤ —É—á–∞—Å—Ç–æ–∫...</div>
</div>

<div id="game-area">
    <div id="player" class="entity">üö≤</div>
    <div id="target" class="entity" style="display:none">üçï</div>
    </div>

<div id="bot-ui">
    <div id="status" style="font-weight:bold; margin-bottom:5px; height:20px; color:#555">–°–º–µ–Ω–∞ –Ω–µ –Ω–∞—á–∞—Ç–∞</div>
    <div id="timer" style="color:red; font-weight:900; display:none; margin-bottom:5px">00:00</div>
    
    <button id="btn-start" class="btn-main" onclick="startShift()">–ù–ê–ß–ê–¢–¨ –†–ê–ë–û–¢–£</button>
    <button id="btn-stop" style="display:none; color:red; background:none; border:none; font-weight:bold; margin-top:5px;" onclick="endShift()">–ó–∞–∫–æ–Ω—á–∏—Ç—å —Å–º–µ–Ω—É</button>

    <div id="joy" class="joy-pad" style="display:none">
        <div class="j-btn u" onclick="move(0, -1)">‚Üë</div>
        <div class="j-btn l" onclick="move(-1, 0)">‚Üê</div>
        <div class="j-btn d" onclick="move(0, 1)">‚Üì</div>
        <div class="j-btn r" onclick="move(1, 0)">‚Üí</div>
    </div>
</div>

<div id="sidebar">
    <h3>–ú–ï–ù–Æ –ò–ì–†–û–ö–ê</h3>
    <hr>
    <h4>–ú–∞–≥–∞–∑–∏–Ω 24/7</h4>
    <div id="shop-list"></div>
    <hr>
    <h4>PKO Bank Polski</h4>
    <div id="bank-ui"></div>
    <hr>
    <h4>–ì–∞—Ä–∞–∂</h4>
    <div style="display:flex; justify-content:space-between; align-items:center">
        <span>–†–µ–º–æ–Ω—Ç –±–∞–π–∫–∞</span>
        <button class="buy-btn" onclick="repairBike()">FIX</button>
    </div>
    <div style="font-size:10px; color:gray; margin-top:20px">ID: <span id="uid">...</span> v6.0</div>
</div>
<div id="side-overlay" onclick="toggleMenu()" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; display:none"></div>

<div id="job-modal" class="modal">
    <div class="popup">
        <h2 id="j-name">–ó–∞–∫–∞–∑</h2>
        <div style="background:#eee; padding:10px; border-radius:5px; margin:10px 0; text-align:left">
            <div>üìè –î–∏—Å—Ç–∞–Ω—Ü–∏—è: <b id="j-dist">0</b> –∫–º</div>
            <div>üí∞ –û–ø–ª–∞—Ç–∞: <b id="j-pay" style="color:green">0.00</b> PLN</div>
        </div>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button style="flex:1; padding:10px; border-radius:5px; border:1px solid #999" onclick="ansJob(false)">–û—Ç–º–µ–Ω–∞</button>
            <button style="flex:1; padding:10px; border-radius:5px; background:var(--lime); border:2px solid black; font-weight:bold" onclick="ansJob(true)">–ü–†–ò–ù–Ø–¢–¨</button>
        </div>
    </div>
</div>

<div id="toast">Msg</div>

<script>
    // --- FIREBASE SETUP ---
    const firebaseConfig = {
        apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
        authDomain: "warszawa-courier.firebaseapp.com",
        databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "warszawa-courier",
        storageBucket: "warszawa-courier.firebasestorage.app",
        messagingSenderId: "295860613508",
        appId: "1:295860613508:web:86fe8364377d6875612dd1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    const tg = window.Telegram.WebApp; tg.expand();
    const userId = tg.initDataUnsafe?.user?.id || 'browser_patch_v6';
    document.getElementById('uid').innerText = userId;

    // --- STATE & CONFIG ---
    const DB_VER = 6; 
    const STEP = 30;
    
    let st = {
        bal: 0.00, bank: 0.00, debt: 0.00, lvl: 1,
        en: 100, wat: 100, hp: 100,
        x: 30, y: 30
    };

    let isShift = false;
    let isPaused = false;
    let police = [];
    let obs = [];
    let loops = {};
    let target = { active: false, x:0, y:0, type:0, offer:null };

    // --- CORE ---
    function init() {
        db.ref('users/' + userId).once('value', s => {
            const d = s.val();
            if(d && d.ver === DB_VER) {
                st = {...st, ...d};
            } else {
                if(d) { // Migration
                    st.bal = d.bal||0; st.bank = d.bank||0; st.lvl = d.lvl||1; st.debt = d.debt||0;
                }
                forceRescue();
            }
            render();
            setInterval(ensureBounds, 2000);
        });
    }

    function save() {
        db.ref('users/' + userId).set({ver: DB_VER, ...st, last: Date.now()});
    }

    function ensureBounds() {
        if(isPaused) return;
        const box = document.getElementById('game-area');
        const maxX = box.offsetWidth - 30;
        const maxY = box.offsetHeight - 30;
        let fix = false;
        if(st.x < 0){st.x=0; fix=true;} if(st.y < 0){st.y=0; fix=true;}
        if(st.x > maxX){st.x=maxX-(maxX%STEP); fix=true;} if(st.y > maxY){st.y=maxY-(maxY%STEP); fix=true;}
        if(fix) { renderPlayer(); save(); }
    }

    function forceRescue() {
        st.x = 30; st.y = 30; st.en = 100;
        renderPlayer(); save();
    }

    // --- GAMEPLAY ---
    function startShift() {
        if(st.en < 5) return showToast("–ù—É–∂–Ω–∞ –µ–¥–∞!");
        if(st.hp <= 0) return showToast("–ë–∞–π–∫ —Å–ª–æ–º–∞–Ω!");
        
        isShift = true; isPaused = false;
        document.getElementById('btn-start').style.display = 'none';
        document.getElementById('joy').style.display = 'grid';
        document.getElementById('btn-stop').style.display = 'block';
        document.getElementById('status').innerText = "–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤...";
        
        spawnWorld();
        newJobPhase(1);
        
        if(loops.pol) clearInterval(loops.pol);
        loops.pol = setInterval(policeAI, 1000); // 1 —Å–µ–∫ —Ç–∏–∫
    }

    function endShift() {
        isShift = false;
        clearInterval(loops.timer); clearInterval(loops.pol);
        document.getElementById('btn-start').style.display = 'block';
        document.getElementById('joy').style.display = 'none';
        document.getElementById('btn-stop').style.display = 'none';
        document.getElementById('target').style.display = 'none';
        document.getElementById('timer').style.display = 'none';
        document.getElementById('status').innerText = "–°–º–µ–Ω–∞ –æ–∫–æ–Ω—á–µ–Ω–∞";
        document.getElementById('game-area').classList.remove('siren-active'); // Off siren
        
        obs.forEach(o=>o.el.remove()); obs=[];
        police.forEach(p=>p.el.remove()); police=[];
    }

    function move(dx, dy) {
        if(!isShift || isPaused) return;
        
        const box = document.getElementById('game-area');
        let nx = st.x + (dx * STEP);
        let ny = st.y + (dy * STEP);
        
        if(nx < 0 || ny < 0 || nx > box.offsetWidth-30 || ny > box.offsetHeight-30) return showToast("–ö—Ä–∞–π –∫–∞—Ä—Ç—ã!");
        if(obs.some(o => dist(o.x, o.y, nx, ny) < 10)) return showToast("–°—Ç–µ–Ω–∞!");
        
        st.x = nx; st.y = ny;
        st.en -= 0.5; st.wat -= 0.2; st.hp -= 0.1;
        
        renderPlayer();
        checkPoliceProx(); // Check proximity instantly
        checkJob();
        save();
    }

    // --- POLICE 2.0 (SMART) ---
    function spawnWorld() {
        const box = document.getElementById('game-area');
        const cols = Math.floor(box.offsetWidth/STEP);
        const rows = Math.floor(box.offsetHeight/STEP);
        
        for(let i=0; i<8; i++) {
            let p = getPos(cols, rows);
            let el = mkEnt('obs', 'üöß', p.x, p.y);
            obs.push({...p, el});
        }
        for(let i=0; i<5; i++) { // 5 Cops
            let p = getPos(cols, rows);
            let el = mkEnt('police', 'üöì', p.x, p.y);
            police.push({...p, el});
        }
    }

    function policeAI() {
        if(!isShift || isPaused) return;
        const box = document.getElementById('game-area');

        police.forEach(p => {
            // Simple random patrol
            let dirs = [{x:0,y:-STEP}, {x:0,y:STEP}, {x:-STEP,y:0}, {x:STEP,y:0}];
            let m = dirs[Math.floor(Math.random()*4)];
            let nx = p.x + m.x; let ny = p.y + m.y;
            
            if(nx >= 0 && ny >= 0 && nx <= box.offsetWidth-30 && ny <= box.offsetHeight-30) {
                p.x = nx; p.y = ny;
                p.el.style.left = nx+'px'; p.el.style.top = ny+'px';
            }
        });
        checkPoliceProx();
    }

    function checkPoliceProx() {
        if(!isShift || isPaused) return;
        let caught = false;
        let near = false;

        police.forEach(p => {
            let d = dist(st.x, st.y, p.x, p.y);
            if(d < 10) caught = true; // Touch
            if(d < 70) near = true;   // Proximity (2 cells)
        });

        // Visual Siren
        const area = document.getElementById('game-area');
        if(near && !caught) {
            area.classList.add('siren-active');
            showToast("üö® –ö–û–ü–´ –†–Ø–î–û–ú! –ë–ï–ì–ò! üö®");
        } else {
            area.classList.remove('siren-active');
        }

        if(caught) arrestSequence();
    }

    function arrestSequence() {
        isPaused = true;
        st.bal -= 50; 
        document.getElementById('game-area').classList.remove('siren-active');
        document.getElementById('arrest-screen').style.display = 'flex';
        save(); render();

        setTimeout(() => {
            document.getElementById('arrest-screen').style.display = 'none';
            isPaused = false;
            forceRescue();
            showToast("–í–ø—Ä–µ–¥—å –±—É–¥—å –æ—Å—Ç–æ—Ä–æ–∂–Ω–µ–µ");
        }, 3000);
    }

    // --- JOBS & ECONOMY ---
    function newJobPhase(ph) {
        target.type = ph;
        let p = getPos(10,10); // Randomish
        const box = document.getElementById('game-area');
        // Better random pos
        p.x = Math.floor(Math.random() * (Math.floor(box.offsetWidth/STEP)-1)) * STEP;
        p.y = Math.floor(Math.random() * (Math.floor(box.offsetHeight/STEP)-1)) * STEP;

        target.x = p.x; target.y = p.y; target.active = true;
        
        const el = document.getElementById('target');
        el.style.display = 'flex'; el.style.left = p.x+'px'; el.style.top = p.y+'px';
        
        if(ph===1) {
            el.innerText = 'üçï'; document.getElementById('status').innerText = "–ó–∞–±–µ—Ä–∏ –∑–∞–∫–∞–∑";
            startTimer(45);
        } else {
            el.innerText = 'üë§'; document.getElementById('status').innerText = "–ö –∫–ª–∏–µ–Ω—Ç—É!";
            startTimer(25);
        }
    }

    function checkJob() {
        if(target.active && dist(st.x, st.y, target.x, target.y) < 15) {
            if(target.type === 1) {
                clearInterval(loops.timer); target.active = false;
                let inf = 1 + (st.lvl-1)*0.1;
                let distK = Math.floor(Math.random()*10)+2;
                let pay = (distK * 2.0 * inf).toFixed(2); // Higher pay formula
                
                target.offer = {dist: distK, pay: parseFloat(pay)};
                document.getElementById('j-dist').innerText = distK;
                document.getElementById('j-pay').innerText = pay;
                document.getElementById('job-modal').style.display = 'flex';
            } else {
                finish(true);
            }
        }
    }

    function ansJob(y) {
        document.getElementById('job-modal').style.display='none';
        if(y) { newJobPhase(2); } 
        else { st.bal-=2; render(); newJobPhase(1); }
    }

    function finish(ok) {
        clearInterval(loops.timer); target.active = false;
        document.getElementById('target').style.display = 'none';
        document.getElementById('timer').style.display = 'none';
        if(ok) { st.bal += target.offer.pay; showToast(`+${target.offer.pay}`); }
        else { st.bal -= 5; showToast("–®—Ç—Ä–∞—Ñ –≤—Ä–µ–º–µ–Ω–∏ -5"); }
        save(); render();
        setTimeout(()=>{ if(isShift) newJobPhase(1); }, 1500);
    }

    function startTimer(s) {
        clearInterval(loops.timer);
        document.getElementById('timer').style.display='block';
        loops.timer = setInterval(()=>{
            s--; document.getElementById('timer').innerText = s;
            if(s<=0) finish(false);
        }, 1000);
    }

    // --- BANKING SYSTEM ---
    function renderBank() {
        const div = document.getElementById('bank-ui');
        div.innerHTML = `
            <div class="bank-card">
                <div style="font-size:12px; opacity:0.8">–ë–∞–ª–∞–Ω—Å —Å—á–µ—Ç–∞</div>
                <div style="font-size:24px; font-weight:bold">${st.bank.toFixed(2)} PLN</div>
            </div>
            
            <div style="background:#fff; border:1px solid #eee; padding:10px; border-radius:8px; text-align:center">
                <div style="font-weight:bold; margin-bottom:5px">–ö–†–ï–î–ò–¢–ù–´–ô –û–¢–î–ï–õ</div>
                ${st.debt > 0 
                    ? `<div class="debt-text">–î–û–õ–ì: ${st.debt.toFixed(2)} PLN</div>
                       <button class="buy-btn" style="width:100%; margin-top:5px; background:var(--blue)" onclick="repayLoan()">–ü–æ–≥–∞—Å–∏—Ç—å (–í—Å–µ)</button>`
                    : `<div style="font-size:11px; color:green; margin-bottom:5px">–ö—Ä–µ–¥–∏—Ç –¥–æ—Å—Ç—É–ø–µ–Ω</div>
                       <button class="buy-btn" style="width:100%; background:orange; color:black" onclick="takeLoan()">–í–∑—è—Ç—å 200 PLN</button>
                       <div style="font-size:9px; color:#777; margin-top:2px">–í–µ—Ä–Ω—É—Ç—å –Ω—É–∂–Ω–æ 250 PLN</div>`
                }
            </div>

            <div style="display:flex; gap:5px; margin-top:10px">
                <button class="buy-btn" style="flex:1" onclick="bankOp(1)">–í–∫–ª–∞–¥</button>
                <button class="buy-btn" style="flex:1; background:red" onclick="bankOp(-1)">–°–Ω—è—Ç—å</button>
            </div>
        `;
    }

    function takeLoan() {
        if(st.debt > 0) return showToast("–°–Ω–∞—á–∞–ª–∞ –ø–æ–≥–∞—Å–∏ —Å—Ç–∞—Ä—ã–π!");
        st.bal += 200;
        st.debt = 250; // Interest
        showToast("–ö—Ä–µ–¥–∏—Ç –≤–∑—è—Ç. –ù–µ –∑–∞–±—É–¥—å –≤–µ—Ä–Ω—É—Ç—å.");
        save(); render();
    }

    function repayLoan() {
        if(st.bal >= st.debt) {
            st.bal -= st.debt;
            st.debt = 0;
            showToast("–î–æ–ª–≥ –ø–æ–≥–∞—à–µ–Ω! –°–≤–æ–±–æ–¥–∞!");
            save(); render();
        } else {
            showToast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –Ω–∞–ª–∏—á–∫–∏!");
        }
    }

    function bankOp(dir) {
        if(dir===1 && st.bal>0) { st.bank+=st.bal; st.bal=0; }
        if(dir===-1 && st.bank>0) { st.bal+=st.bank; st.bank=0; }
        save(); render();
    }

    // --- UTILS ---
    function mkEnt(c,i,x,y){
        let d=document.createElement('div'); d.className='entity '+c; d.innerText=i;
        d.style.left=x+'px'; d.style.top=y+'px';
        document.getElementById('game-area').appendChild(d); return d;
    }
    function getPos(c,r){ return {x:Math.floor(Math.random()*(c-1))*STEP, y:Math.floor(Math.random()*(r-1))*STEP}; }
    function dist(x1,y1,x2,y2){ return Math.abs(x1-x2)+Math.abs(y1-y2); }
    
    function render() {
        document.getElementById('cash').innerText = st.bal.toFixed(2);
        document.getElementById('bank').innerText = st.bank.toFixed(2);
        document.getElementById('debt').innerText = st.debt.toFixed(2);
        document.getElementById('lvl').innerText = st.lvl;
        
        document.getElementById('b-en').style.width = st.en+'%';
        document.getElementById('b-wat').style.width = st.wat+'%';
        document.getElementById('b-hp').style.width = st.hp+'%';
        
        // Shop render
        let inf = 1+(st.lvl-1)*0.1; const p=(v)=>Math.ceil(v*inf);
        document.getElementById('shop-list').innerHTML = `
            <div style="display:flex; justify-content:space-between; padding:5px 0"><span>üå≠ –ï–¥–∞</span> <button class="buy-btn" onclick="buy('en',20,${p(8)})">${p(8)}</button></div>
            <div style="display:flex; justify-content:space-between; padding:5px 0"><span>ü•§ –í–æ–¥–∞</span> <button class="buy-btn" onclick="buy('wat',30,${p(5)})">${p(5)}</button></div>
        `;
        renderBank();
    }

    function renderPlayer() {
        const p = document.getElementById('player');
        p.style.left = st.x+'px'; p.style.top = st.y+'px';
    }

    function buy(t,v,c){ if(st.bal>=c){st.bal-=c; if(t=='en')st.en+=v; if(t=='wat')st.wat+=v; render(); save();} }
    function repairBike(){ 
        let c=Math.ceil(20*(1+(st.lvl-1)*0.1)); 
        if(st.bal>=c){st.bal-=c; st.hp=100; st.lvl++; showToast("LVL UP!"); render(); save();} 
    }
    function showToast(m){const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',1500);}
    function toggleMenu(){const s=document.getElementById('sidebar'); const o=document.getElementById('side-overlay'); if(s.classList.contains('open')){s.classList.remove('open');o.style.display='none';}else{s.classList.add('open');o.style.display='block';render();}}

    init();
</script>
</body>
</html>
