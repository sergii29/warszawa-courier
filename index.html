<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warszawa Courier Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg: #f4f4dc;
            --grid: #dadab9;
            --lime: #c8ff00;
            --blue: #007bff;
            --red: #ff4500;
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: sans-serif; }
        
        /* –ö–∞—Ä—Ç–∞ */
        #game-board {
            position: relative; width: 100%; height: 60vh;
            background-image: linear-gradient(var(--grid) 1px, transparent 1px), linear-gradient(90deg, var(--grid) 1px, transparent 1px);
            background-size: 25px 25px; background-position: 0 0;
        }

        /* –û–±—ä–µ–∫—Ç—ã */
        .dot { position: absolute; width: 25px; height: 25px; transition: all 0.1s; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        #player { z-index: 10; background: var(--lime); border-radius: 4px; border: 1px solid #000; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        #target { z-index: 5; border-radius: 50%; color: white; font-weight: bold; }
        .obstacle { background: #bbb; z-index: 4; border-radius: 2px; }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #ui-layer { height: 40vh; background: #fff; padding: 15px; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; border-top: 3px solid #ccc; }
        .stats { display: flex; justify-content: space-between; width: 100%; font-weight: bold; margin-bottom: 10px; }
        
        /* –î–∂–æ–π—Å—Ç–∏–∫ */
        .joystick { display: grid; grid-template-columns: repeat(3, 60px); grid-template-rows: repeat(2, 60px); gap: 10px; }
        .j-btn { background: #333; color: white; border: none; border-radius: 10px; font-size: 24px; font-weight: bold; }
        .j-up { grid-column: 2; }
        .j-left { grid-column: 1; grid-row: 2; }
        .j-down { grid-column: 2; grid-row: 2; }
        .j-right { grid-column: 3; grid-row: 2; }

        #msg-log { font-size: 14px; color: #555; height: 40px; text-align: center; }
        .active-btn { background: var(--lime); color: #000; width: 100%; padding: 10px; border: none; border-radius: 8px; font-weight: bold; margin-top: 5px; }
        .offline-btn { background: #ffcccc; color: #900; margin-top: 5px; border: none; padding: 5px 15px; border-radius: 5px; }
    </style>
</head>
<body>

<div id="game-board">
    <div id="player" class="dot">üö≤</div>
    <div id="target" class="dot"></div>
</div>

<div id="ui-layer">
    <div class="stats">
        <div>–ë–∞–ª–∞–Ω—Å: <span id="cash">0.00</span> PLN</div>
        <div id="timer-box" style="color: red; display: none;">‚è≥ <span id="timer">30</span>—Å</div>
    </div>
    
    <div id="msg-log">–ù–∞–∂–º–∏ "–í—ã–π—Ç–∏ –≤ –æ–Ω–ª–∞–π–Ω", —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</div>
    
    <button id="main-action" class="active-btn" onclick="toggleOnline()">–í–´–ô–¢–ò –í –û–ù–õ–ê–ô–ù</button>
    
    <div class="joystick" id="controls" style="visibility: hidden;">
        <button class="j-btn j-up" onclick="move(0, -25)">‚Üë</button>
        <button class="j-btn j-left" onclick="move(-25, 0)">‚Üê</button>
        <button class="j-btn j-down" onclick="move(0, 25)">‚Üì</button>
        <button class="j-btn j-right" onclick="move(25, 0)">‚Üí</button>
    </div>

    <button id="off-btn" class="offline-btn" onclick="goOffline()" style="display:none">–£–π—Ç–∏ –≤ –æ—Ñ—Ñ–ª–∞–π–Ω</button>
</div>

<script>
    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase ---
    const firebaseConfig = {
        apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
        authDomain: "warszawa-courier.firebaseapp.com",
        databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "warszawa-courier"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–≥—Ä—ã ---
    let balance = 0.00;
    let pX = 150, pY = 150; // –ü–æ–∑–∏—Ü–∏—è –∏–≥—Ä–æ–∫–∞
    let tX, tY; // –ü–æ–∑–∏—Ü–∏—è —Ü–µ–ª–∏
    let gameState = "IDLE"; // IDLE, TO_RESTAURANT, WAITING, TO_CLIENT
    let timerInterval;
    const cellSize = 25;

    function updateUI() {
        document.getElementById('player').style.left = pX + 'px';
        document.getElementById('player').style.top = pY + 'px';
        document.getElementById('cash').innerText = balance.toFixed(2);
    }

    function toggleOnline() {
        if(gameState === "IDLE") {
            generateOrder();
            document.getElementById('controls').style.visibility = 'visible';
            document.getElementById('main-action').style.display = 'none';
            document.getElementById('off-btn').style.display = 'block';
        }
    }

    function generateOrder() {
        gameState = "TO_RESTAURANT";
        spawnTarget("RES");
        spawnObstacles();
        startTimer(45);
        document.getElementById('msg-log').innerText = "–ï–¥—å –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω (–°–∏–Ω–∏–π –º–∞—Ä–∫–µ—Ä)";
    }

    function spawnTarget(type) {
        tX = Math.floor(Math.random() * (window.innerWidth/cellSize - 2)) * cellSize;
        tY = Math.floor(Math.random() * (window.innerHeight*0.6/cellSize - 2)) * cellSize;
        const target = document.getElementById('target');
        target.style.display = 'flex';
        target.style.left = tX + 'px';
        target.style.top = tY + 'px';
        target.style.background = (type === "RES") ? "var(--blue)" : "var(--red)";
        target.innerText = (type === "RES") ? "üè†" : "üë§";
    }

    function spawnObstacles() {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–µ–≥—Ä–∞–¥—ã
        document.querySelectorAll('.obstacle').forEach(el => el.remove());
        for(let i=0; i<15; i++) {
            let ox = Math.floor(Math.random() * (window.innerWidth/cellSize - 2)) * cellSize;
            let oy = Math.floor(Math.random() * (window.innerHeight*0.6/cellSize - 2)) * cellSize;
            if(ox === pX && oy === pY) continue;
            let div = document.createElement('div');
            div.className = 'dot obstacle';
            div.style.left = ox + 'px';
            div.style.top = oy + 'px';
            div.innerText = "üöß";
            document.getElementById('game-board').appendChild(div);
        }
    }

    function move(dx, dy) {
        if(gameState === "IDLE" || gameState === "WAITING") return;
        
        let nextX = pX + dx;
        let nextY = pY + dy;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü –∏ –ø—Ä–µ–≥—Ä–∞–¥
        if(nextX < 0 || nextX > window.innerWidth - 25 || nextY < 0 || nextY > (window.innerHeight*0.6 - 25)) return;
        
        let collision = false;
        document.querySelectorAll('.obstacle').forEach(obs => {
            if(parseInt(obs.style.left) === nextX && parseInt(obs.style.top) === nextY) collision = true;
        });

        if(collision) {
            document.getElementById('msg-log').innerText = "–ü—Ä–µ–≥—Ä–∞–¥–∞! –ò—â–∏ –æ–±—ä–µ–∑–¥!";
            return;
        }

        pX = nextX; pY = nextY;
        updateUI();
        checkTarget();
    }

    function checkTarget() {
        if(pX === tX && pY === tY) {
            if(gameState === "TO_RESTAURANT") {
                processRestaurant();
            } else if(gameState === "TO_CLIENT") {
                finishOrder();
            }
        }
    }

    function processRestaurant() {
        gameState = "WAITING";
        clearInterval(timerInterval);
        document.getElementById('target').style.display = 'none';
        document.getElementById('msg-log').innerText = "–ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤–∏—Ç—Å—è... –ñ–¥–∏ 3 —Å–µ–∫.";
        setTimeout(() => {
            gameState = "TO_CLIENT";
            spawnTarget("CLIENT");
            startTimer(40);
            document.getElementById('msg-log').innerText = "–ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤! –í–µ–∑–∏ –∫–ª–∏–µ–Ω—Ç—É (–ö—Ä–∞—Å–Ω—ã–π)";
        }, 3000);
    }

    function finishOrder() {
        clearInterval(timerInterval);
        let reward = (Math.random() * 5 + 10).toFixed(2);
        balance += parseFloat(reward);
        gameState = "IDLE";
        document.getElementById('target').style.display = 'none';
        document.getElementById('msg-log').innerText = `–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ! +${reward} PLN.`;
        document.getElementById('main-action').style.display = 'block';
        document.getElementById('main-action').innerText = "–ò—Å–∫–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑";
        document.getElementById('timer-box').style.display = 'none';
        updateUI();
    }

    function startTimer(sec) {
        let left = sec;
        document.getElementById('timer-box').style.display = 'block';
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            left--;
            document.getElementById('timer').innerText = left;
            if(left <= 0) {
                clearInterval(timerInterval);
                alert("–í—Ä–µ–º—è –≤—ã—à–ª–æ! –ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω.");
                location.reload();
            }
        }, 1000);
    }

    function goOffline() {
        location.reload();
    }

    updateUI();
</script>
</body>
</html>
