<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Warsaw Courier Tycoon</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #121212; color: #fff; overflow: hidden; }
        
        /* –ö–ê–†–¢–ê –ù–ê –í–ï–°–¨ –≠–ö–†–ê–ù */
        #map { height: 100vh; width: 100vw; z-index: 1; }

        /* UI –ò–ù–¢–ï–†–§–ï–ô–° */
        .ui-layer {
            position: absolute;
            z-index: 1000;
            pointer-events: none; /* –ß—Ç–æ–±—ã –∫–ª–∏–∫–∏ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —Å–∫–≤–æ–∑—å –ø—É—Å—Ç—ã–µ –º–µ—Å—Ç–∞ */
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .top-bar {
            background: rgba(20, 20, 20, 0.9);
            padding: 10px;
            display: flex;
            justify-content: space-around;
            pointer-events: auto;
            border-bottom: 2px solid #00e676;
            backdrop-filter: blur(5px);
        }

        .stat-box { text-align: center; font-size: 0.9rem; }
        .stat-val { font-weight: bold; color: #00e676; font-size: 1.1rem; }
        .stat-warn { color: #ff5252; }

        .bottom-bar {
            background: rgba(20, 20, 20, 0.95);
            padding: 15px;
            pointer-events: auto;
            border-top: 1px solid #333;
            max-height: 40vh;
            overflow-y: auto;
        }

        .btn-main {
            width: 100%;
            padding: 12px;
            background: #00e676;
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .btn-main:disabled { background: #555; color: #888; }

        .shop-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .shop-item {
            background: #2c2c2c;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #444;
        }
        .shop-item h4 { margin: 0 0 5px 0; font-size: 0.9rem; }
        .shop-item p { margin: 0 0 5px 0; color: #aaa; font-size: 0.8rem; }
        .btn-buy {
            background: #333; color: white; border: 1px solid #555;
            padding: 5px 10px; border-radius: 4px; width: 100%; cursor: pointer;
        }
        .btn-buy:active { transform: scale(0.95); }

        /* –û–∫–Ω–æ —Å—Ç–∞—Ä—Ç–∞ */
        #setup-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            pointer-events: auto; text-align: center; padding: 20px; box-sizing: border-box;
        }

        .log-area {
            position: absolute; top: 70px; right: 10px; width: 200px;
            background: rgba(0,0,0,0.7); padding: 5px; font-size: 10px;
            pointer-events: none; border-radius: 5px; max-height: 100px; overflow: hidden;
        }
        .log-entry { margin-bottom: 2px; }

    </style>
</head>
<body>

    <div id="setup-modal">
        <h2 style="color: #00e676;">Warsaw Courier Tycoon</h2>
        <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ë–æ—Å—Å.</p>
        <p>–î–ª—è –Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –æ—Ñ–∏—Å–∞ –Ω–∞ –∫–∞—Ä—Ç–µ.</p>
        <button id="start-btn" class="btn-main" style="max-width: 200px;" disabled>–ó–∞–≥—Ä—É–∑–∫–∞...</button>
    </div>

    <div class="ui-layer" id="game-ui" style="display: none;">
        <div class="top-bar">
            <div class="stat-box">–ë–∞–ª–∞–Ω—Å<br><span id="balance" class="stat-val">0</span> PLN</div>
            <div class="stat-box">–ö—É—Ä—å–µ—Ä—ã<br><span id="couriers" class="stat-val">0</span></div>
            <div class="stat-box">–û—Ñ–∏—Å<br><span id="rent-timer" class="stat-val">5:00</span></div>
        </div>

        <div class="log-area" id="log-area"></div>

        <div class="bottom-bar">
            <h3 style="margin: 0 0 10px 0;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –§–ª–æ—Ç–æ–º</h3>
            
            <div style="display: flex; gap: 10px; margin-bottom: 10px; font-size: 0.8rem; color: #ccc;">
                <div>üö≤ –í–µ–ª–∏–∫–∏: <span id="inv-bikes">0</span></div>
                <div>üéí –°—É–º–∫–∏: <span id="inv-bags">0</span></div>
                <div>üß• –ö—É—Ä—Ç–∫–∏: <span id="inv-jackets">0</span></div>
            </div>

            <div class="shop-grid">
                <div class="shop-item">
                    <h4>City Bike 250w</h4>
                    <p>1500 PLN</p>
                    <button class="btn-buy" onclick="buyItem('bike_250', 1500)">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div class="shop-item">
                    <h4>E-Bike 350w</h4>
                    <p>3700 PLN</p>
                    <button class="btn-buy" onclick="buyItem('bike_350', 3700)">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div class="shop-item">
                    <h4>–¢–µ—Ä–º–æ—Å—É–º–∫–∞</h4>
                    <p>150 PLN</p>
                    <button class="btn-buy" onclick="buyItem('bag', 150)">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div class="shop-item">
                    <h4>–ö—É—Ä—Ç–∫–∞ —Ñ–∏—Ä–º—ã</h4>
                    <p>200 PLN</p>
                    <button class="btn-buy" onclick="buyItem('jacket', 200)">–ö—É–ø–∏—Ç—å</button>
                </div>
            </div>
            
            <button class="btn-main" style="margin-top: 15px; background: #ff5252; color: #fff;" onclick="payRentManual()">–û–ø–ª–∞—Ç–∏—Ç—å –ê—Ä–µ–Ω–¥—É (-500 PLN)</button>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
            authDomain: "warszawa-courier.firebaseapp.com",
            databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "warszawa-courier",
            storageBucket: "warszawa-courier.firebasestorage.app",
            messagingSenderId: "295860613508",
            appId: "1:295860613508:web:86fe8364377d6875612dd1",
            measurementId: "G-TGSCHBVLX2"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();
        const userId = "boss_user_001"; // –í —Ä–µ–∞–ª—å–Ω–æ–π –∏–≥—Ä–µ –∑–¥–µ—Å—å –±—É–¥–µ—Ç ID –∏–∑ –¢–µ–ª–µ–≥—Ä–∞–º–∞
        
        // --- 2. GAME VARIABLES ---
        let map;
        let officeMarker;
        let couriersMarkers = [];
        let rentInterval;
        
        // Default State
        let gameState = {
            balance: 5000, // –°—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–∞–ø–∏—Ç–∞–ª
            inventory: {
                bikes_250: 0,
                bikes_350: 0,
                bags: 0,
                jackets: 0
            },
            office: {
                lat: null,
                lng: null,
                rentCost: 500, // –¶–µ–Ω–∞ –∞—Ä–µ–Ω–¥—ã
                lastRentPaid: Date.now()
            },
            activeCouriers: 0
        };

        // --- 3. INIT MAP ---
        function initMap() {
            // –¶–µ–Ω—Ç—Ä –í–∞—Ä—à–∞–≤—ã
            map = L.map('map').setView([52.2297, 21.0122], 13);

            // –°–ª–æ–π –∫–∞—Ä—Ç—ã (OpenStreetMap CartoDB Dark –¥–ª—è —Å—Ç–∏–ª—è)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ—Ñ–∏—Å–∞
            map.on('click', function(e) {
                if (!gameState.office.lat) {
                    setOfficeLocation(e.latlng.lat, e.latlng.lng);
                }
            });
        }

        // --- 4. CORE LOGIC ---
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
        function loadProfile() {
            const ref = db.ref('players/' + userId);
            ref.on('value', (snapshot) => {
                const data = snapshot.val();
                const btn = document.getElementById('start-btn');
                
                if (data) {
                    gameState = data;
                    if (gameState.office.lat) {
                        startGame();
                    } else {
                        btn.innerText = "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ";
                        btn.disabled = false;
                        btn.onclick = () => { document.getElementById('setup-modal').style.display = 'none'; log("–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –æ—Ñ–∏—Å"); };
                    }
                } else {
                    // –ù–æ–≤—ã–π –∏–≥—Ä–æ–∫
                    btn.innerText = "–ù–∞—á–∞—Ç—å –±–∏–∑–Ω–µ—Å";
                    btn.disabled = false;
                    btn.onclick = () => { 
                        document.getElementById('setup-modal').style.display = 'none'; 
                        log("–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –æ—Ñ–∏—Å");
                    };
                }
                updateUI();
            });
        }

        function setOfficeLocation(lat, lng) {
            gameState.office.lat = lat;
            gameState.office.lng = lng;
            saveState();
            startGame();
        }

        function startGame() {
            document.getElementById('setup-modal').style.display = 'none';
            document.getElementById('game-ui').style.display = 'flex';
            
            // –°—Ç–∞–≤–∏–º –º–∞—Ä–∫–µ—Ä –æ—Ñ–∏—Å–∞
            const officeIcon = L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/1086/1086665.png', // –ò–∫–æ–Ω–∫–∞ –¥–æ–º–∞/–æ—Ñ–∏—Å–∞
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            });
            
            if (officeMarker) map.removeLayer(officeMarker);
            officeMarker = L.marker([gameState.office.lat, gameState.office.lng], {icon: officeIcon}).addTo(map);
            officeMarker.bindPopup("<b>–®—Ç–∞–±-–∫–≤–∞—Ä—Ç–∏—Ä–∞</b><br>–ê—Ä–µ–Ω–¥–∞: 500 PLN/5–º–∏–Ω").openPopup();

            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª –∏–≥—Ä—ã
            updateActiveCouriers();
            startRentTimer();
            simulateCouriers();
        }

        function saveState() {
            db.ref('players/' + userId).set(gameState);
        }

        // --- 5. ECONOMY & INVENTORY ---

        function buyItem(item, price) {
            if (gameState.balance >= price) {
                gameState.balance -= price;
                
                // Inventory Logic
                if (item === 'bike_250') gameState.inventory.bikes_250++;
                if (item === 'bike_350') gameState.inventory.bikes_350++;
                if (item === 'bag') gameState.inventory.bags++;
                if (item === 'jacket') gameState.inventory.jackets++;

                log(`–ö—É–ø–ª–µ–Ω–æ: ${item}. –ë–∞–ª–∞–Ω—Å: ${gameState.balance}`);
                saveState();
                updateActiveCouriers(); // –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∫—É—Ä—å–µ—Ä–æ–≤
            } else {
                log("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!", "red");
            }
        }

        function updateActiveCouriers() {
            // –õ–æ–≥–∏–∫–∞: 1 –≤–µ–ª–∏–∫ + 1 —Å—É–º–∫–∞ + 1 –∫—É—Ä—Ç–∫–∞ = 1 –∫—É—Ä—å–µ—Ä
            const totalBikes = gameState.inventory.bikes_250 + gameState.inventory.bikes_350;
            const possibleCouriers = Math.min(totalBikes, gameState.inventory.bags, gameState.inventory.jackets);
            
            gameState.activeCouriers = possibleCouriers;
            document.getElementById('couriers').innerText = gameState.activeCouriers;
            
            manageCourierMarkers();
        }

        // --- 6. COURIER SIMULATION (ON REAL MAP) ---

        function manageCourierMarkers() {
            // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏—Ö, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã—Ö
            while (couriersMarkers.length > gameState.activeCouriers) {
                const marker = couriersMarkers.pop();
                map.removeLayer(marker);
            }

            while (couriersMarkers.length < gameState.activeCouriers) {
                spawnCourier();
            }
        }

        function spawnCourier() {
            // –°–æ–∑–¥–∞–µ–º –∫—É—Ä—å–µ—Ä–∞ –≤ –æ—Ñ–∏—Å–µ
            const courierIcon = L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png', // –ò–∫–æ–Ω–∫–∞ –∫—É—Ä—å–µ—Ä–∞
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            const marker = L.marker([gameState.office.lat, gameState.office.lng], {icon: courierIcon}).addTo(map);
            
            // –î–∞–Ω–Ω—ã–µ –∫—É—Ä—å–µ—Ä–∞ (–∫—É–¥–∞ –µ–¥–µ—Ç)
            marker.courierData = {
                state: 'IDLE', // IDLE, TO_REST, TO_CLIENT
                target: null,
                lat: gameState.office.lat,
                lng: gameState.office.lng
            };

            couriersMarkers.push(marker);
        }

        function simulateCouriers() {
            setInterval(() => {
                couriersMarkers.forEach(marker => {
                    const data = marker.courierData;
                    const speed = 0.0005; // –°–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è (–≥—Ä–∞–¥—É—Å—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç)

                    if (data.state === 'IDLE') {
                        // –ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑ (—Ä–∞–Ω–¥–æ–º–Ω–∞—è —Ç–æ—á–∫–∞ –≤ —Ä–∞–¥–∏—É—Å–µ 2–∫–º –æ—Ç –æ—Ñ–∏—Å–∞)
                        const r = 0.02; // ~2km
                        const targetLat = gameState.office.lat + (Math.random() * r * 2 - r);
                        const targetLng = gameState.office.lng + (Math.random() * r * 2 - r);
                        data.target = { lat: targetLat, lng: targetLng };
                        data.state = 'TO_CLIENT';
                    }

                    if (data.state === 'TO_CLIENT') {
                        // –î–≤–∏–∂–µ–Ω–∏–µ –∫ —Ü–µ–ª–∏
                        const dLat = data.target.lat - data.lat;
                        const dLng = data.target.lng - data.lng;
                        const dist = Math.sqrt(dLat*dLat + dLng*dLng);

                        if (dist < speed) {
                            // –ü—Ä–∏–±—ã–ª
                            data.lat = data.target.lat;
                            data.lng = data.target.lng;
                            
                            // –ü—Ä–∏–±—ã–ª—å –∏ –∑–∞—Ä–ø–ª–∞—Ç–∞
                            const income = Math.floor(Math.random() * 15) + 10; // 10-25 PLN
                            const wage = 8; // –ó–ü –∫—É—Ä—å–µ—Ä–∞
                            const profit = income - wage;
                            
                            gameState.balance += profit;
                            log(`–ó–∞–∫–∞–∑ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω! +${profit} PLN (–ø—Ä–∏–±—ã–ª—å)`);
                            saveState(); // –í–∞–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–µ–Ω—å–≥–∏
                            updateUI();

                            // –ï—Ö–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ –∏–ª–∏ –Ω–∞ –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑?
                            data.state = 'IDLE'; 
                        } else {
                            // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –¥–≤–∏–∂–µ–Ω–∏—è
                            data.lat += (dLat / dist) * speed;
                            data.lng += (dLng / dist) * speed;
                            marker.setLatLng([data.lat, data.lng]);
                        }
                    }
                });
            }, 100); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 100–º—Å
        }


        // --- 7. RENT SYSTEM ---
        function startRentTimer() {
            clearInterval(rentInterval);
            rentInterval = setInterval(() => {
                const now = Date.now();
                const diff = now - gameState.office.lastRentPaid;
                const fiveMinutes = 5 * 60 * 1000;
                
                const timeLeft = Math.max(0, fiveMinutes - diff);
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                document.getElementById('rent-timer').innerText = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

                if (timeLeft <= 0) {
                    payRent();
                }
            }, 1000);
        }

        function payRent() {
            if (gameState.balance >= gameState.office.rentCost) {
                gameState.balance -= gameState.office.rentCost;
                gameState.office.lastRentPaid = Date.now();
                log(`–°–ø–∏—Å–∞–Ω–∞ –∞—Ä–µ–Ω–¥–∞ –æ—Ñ–∏—Å–∞: -${gameState.office.rentCost} PLN`);
                saveState();
            } else {
                log("–ü–†–û–°–†–û–ß–ö–ê –ê–†–ï–ù–î–´! –û—Ñ–∏—Å –∑–∞–º–æ—Ä–æ–∂–µ–Ω.", "red");
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —à—Ç—Ä–∞—Ñ—ã
                gameState.office.lastRentPaid = Date.now(); // –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞, –Ω–æ –¥–æ–ª–≥ —Ä–∞—Å—Ç–µ—Ç (–≤ –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏)
            }
        }
        
        function payRentManual() {
            gameState.office.lastRentPaid = Date.now() - (5 * 60 * 1000) + 1000; // Trigger auto pay immediately
        }

        // --- UI UTILS ---
        function updateUI() {
            document.getElementById('balance').innerText = Math.floor(gameState.balance);
            
            document.getElementById('inv-bikes').innerText = 
                (gameState.inventory.bikes_250 || 0) + (gameState.inventory.bikes_350 || 0);
            document.getElementById('inv-bags').innerText = gameState.inventory.bags || 0;
            document.getElementById('inv-jackets').innerText = gameState.inventory.jackets || 0;
        }

        function log(msg, color="white") {
            const area = document.getElementById('log-area');
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.style.color = color;
            div.innerText = `> ${msg}`;
            area.prepend(div);
        }

        // --- BOOTSTRAP ---
        initMap();
        loadProfile();

    </script>
</body>
</html>
