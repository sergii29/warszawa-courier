<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warsaw Courier Tycoon</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; overflow: hidden; }
        #map { height: 60vh; width: 100%; }
        #ui-panel { height: 40vh; padding: 15px; background: #222; display: flex; gap: 20px; overflow-y: auto; border-top: 3px solid #ff004c; }
        .stat-card { background: #333; padding: 10px; border-radius: 8px; min-width: 150px; text-align: center; }
        .menu-section { flex: 1; border-right: 1px solid #444; padding-right: 15px; }
        button { background: #ff004c; border: none; color: white; padding: 8px 12px; cursor: pointer; border-radius: 4px; margin-top: 5px; width: 100%; }
        button:disabled { background: #555; }
        .log { font-size: 12px; color: #aaa; height: 100px; overflow-y: scroll; background: #000; padding: 5px; margin-top: 10px; }
        .highlight { color: #00ff88; font-weight: bold; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="ui-panel">
    <div class="menu-section">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
        <div class="stat-card">–ë–∞–ª–∞–Ω—Å: <span id="balance" class="highlight">5000</span> PLN</div>
        <div class="stat-card">–ö—É—Ä—å–µ—Ä—ã: <span id="courier-count">0</span></div>
        <div id="office-status" style="margin-top:10px; color: #ffbc00;">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ –¥–ª—è –æ—Ñ–∏—Å–∞ –Ω–∞ –∫–∞—Ä—Ç–µ!</div>
        <div class="log" id="game-log">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –í–∞—Ä—à–∞–≤—É!</div>
    </div>

    <div class="menu-section">
        <h3>–ú–∞–≥–∞–∑–∏–Ω (–û–ø—Ç)</h3>
        <div>
            –í–µ–ª–æ—Å–∏–ø–µ–¥ 250W (1500 PLN)
            <button onclick="buyItem('bike250', 1500)">–ö—É–ø–∏—Ç—å</button>
        </div>
        <div>
            –í–µ–ª–æ—Å–∏–ø–µ–¥ 350W (3700 PLN)
            <button onclick="buyItem('bike350', 3700)">–ö—É–ø–∏—Ç—å</button>
        </div>
        <div style="margin-top:10px;">
            –°—É–º–∫–∞ + –ö—É—Ä—Ç–∫–∞ (500 PLN)
            <button onclick="buyItem('gear', 500)">–ö—É–ø–∏—Ç—å –Ω–∞–±–æ—Ä</button>
        </div>
    </div>

    <div class="menu-section">
        <h3>–°–∫–ª–∞–¥</h3>
        <p>–í–µ–ª–æ—Å–∏–ø–µ–¥—ã: <span id="inv-bikes">0</span></p>
        <p>–≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞: <span id="inv-gear">0</span></p>
        <small>* 1 –≤–µ–ª + 1 —Å—É–º–∫–∞ = 1 –∫—É—Ä—å–µ—Ä</small>
    </div>
</div>

<script>
    // --- –ö–û–ù–§–ò–ì –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    const firebaseConfig = {
        apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
        authDomain: "warszawa-courier.firebaseapp.com",
        databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "warszawa-courier",
        storageBucket: "warszawa-courier.firebasestorage.app",
        messagingSenderId: "295860613508",
        appId: "1:295860613508:web:86fe8364377d6875612dd1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ ---
    let state = {
        balance: 5000,
        bikes: 0,
        gear: 0,
        couriers: [],
        office: null, // {lat, lng}
        rentPrice: 200,
        lastRentPay: Date.now()
    };

    // --- –ö–ê–†–¢–ê ---
    const map = L.map('map').setView([52.2297, 21.0122], 13); // –¶–µ–Ω—Ç—Ä –í–∞—Ä—à–∞–≤—ã
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    let officeMarker = null;

    map.on('click', function(e) {
        if (!state.office) {
            state.office = e.latlng;
            officeMarker = L.marker(e.latlng, {icon: L.divIcon({className: 'office-icon', html: 'üè¢', iconSize: [30, 30]})}).addTo(map);
            addLog("–û—Ñ–∏—Å –æ—Ç–∫—Ä—ã—Ç! –ê—Ä–µ–Ω–¥–∞ 200 PLN / 5 –º–∏–Ω.");
            document.getElementById('office-status').innerText = "–û—Ñ–∏—Å –∞–∫—Ç–∏–≤–µ–Ω";
            saveGame();
        }
    });

    // --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ ---
    function buyItem(type, price) {
        if (state.balance >= price) {
            state.balance -= price;
            if (type.includes('bike')) state.bikes++;
            if (type === 'gear') state.gear++;
            updateUI();
            checkNewCouriers();
            addLog(`–ö—É–ø–ª–µ–Ω–æ: ${type} –∑–∞ ${price} PLN`);
        } else {
            addLog("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!");
        }
    }

    function checkNewCouriers() {
        const potential = Math.min(state.bikes, state.gear);
        while (state.couriers.length < potential && state.office) {
            spawnCourier();
        }
    }

    function spawnCourier() {
        const id = Date.now() + Math.random();
        const marker = L.marker([state.office.lat, state.office.lng], {
            icon: L.divIcon({html: 'üö¥', className: 'courier-icon'})
        }).addTo(map);

        const courier = { id, marker, status: 'idle', target: null };
        state.couriers.push(courier);
        startCourierLife(courier);
        updateUI();
    }

    async function startCourierLife(courier) {
        while (true) {
            // 1. –ï–¥–µ–º –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω (—Å–ª—É—á–∞–π–Ω–∞—è —Ç–æ—á–∫–∞ —Ä—è–¥–æ–º)
            const restaurant = [state.office.lat + (Math.random()-0.5)*0.02, state.office.lng + (Math.random()-0.5)*0.02];
            await moveTo(courier, restaurant, "–ó–∞–±–∏—Ä–∞–µ—Ç –∑–∞–∫–∞–∑...");
            
            // 2. –ï–¥–µ–º –∫ –∫–ª–∏–µ–Ω—Ç—É
            const client = [restaurant[0] + (Math.random()-0.5)*0.01, restaurant[1] + (Math.random()-0.5)*0.01];
            await moveTo(courier, client, "–î–æ—Å—Ç–∞–≤–∫–∞ –∫–ª–∏–µ–Ω—Ç—É...");

            // 3. –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏–±—ã–ª—å
            const profit = Math.floor(Math.random() * 20) + 15;
            const salary = 10;
            state.balance += (profit - salary);
            addLog(`–ö—É—Ä—Å –∑–∞–≤–µ—Ä—à–µ–Ω: +${profit - salary} PLN (–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å)`);
            updateUI();

            // 4. –í–æ–∑–≤—Ä–∞—Ç –≤ –æ—Ñ–∏—Å
            await moveTo(courier, [state.office.lat, state.office.lng], "–í–æ–∑–≤—Ä–∞—Ç –≤ –æ—Ñ–∏—Å...");
        }
    }

    function moveTo(courier, target, taskName) {
        return new Promise(resolve => {
            const start = courier.marker.getLatLng();
            let steps = 100;
            let currentStep = 0;

            const interval = setInterval(() => {
                currentStep++;
                const lat = start.lat + (target[0] - start.lat) * (currentStep / steps);
                const lng = start.lng + (target[1] - start.lng) * (currentStep / steps);
                courier.marker.setLatLng([lat, lng]);

                if (currentStep >= steps) {
                    clearInterval(interval);
                    resolve();
                }
            }, 50); // –°–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è
        });
    }

    // --- –°–ò–°–¢–ï–ú–ê –ê–†–ï–ù–î–´ ---
    setInterval(() => {
        if (state.office) {
            state.balance -= state.rentPrice;
            addLog(`<span style="color:red">–°–ø–∏—Å–∞–Ω–∞ –∞—Ä–µ–Ω–¥–∞: -${state.rentPrice} PLN</span>`);
            if (state.balance < 0) {
                addLog("–í–ù–ò–ú–ê–ù–ò–ï: –ë–∞–ª–∞–Ω—Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π! –í—ã –±–∞–Ω–∫—Ä–æ—Ç!");
            }
            updateUI();
            saveGame();
        }
    }, 300000); // 5 –º–∏–Ω—É—Ç = 300000 –º—Å

    // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï ---
    function updateUI() {
        document.getElementById('balance').innerText = state.balance.toFixed(2);
        document.getElementById('inv-bikes').innerText = state.bikes;
        document.getElementById('inv-gear').innerText = state.gear;
        document.getElementById('courier-count').innerText = state.couriers.length;
    }

    function addLog(msg) {
        const log = document.getElementById('game-log');
        log.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>` + log.innerHTML;
    }

    function saveGame() {
        db.ref('saves/WARSZAWA_FOREVER').set({
            balance: state.balance,
            bikes: state.bikes,
            gear: state.gear,
            office: state.office
        });
    }

    // –ê–≤—Ç–æ-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
    setInterval(saveGame, 30000);

</script>
</body>
</html>
