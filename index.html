<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Courier Pro: Warsaw</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- –î–ò–ó–ê–ô–ù: DARK GLASS --- */
        :root {
            --bg-glass: rgba(20, 20, 20, 0.85);
            --accent: #3b82f6; 
            --accent-repair: #f59e0b;
            --danger: #ef4444;
            --success: #10b981;
            --text-main: #ffffff;
            --radius: 16px;
        }

        body {
            margin: 0; padding: 0;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #map {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
            filter: grayscale(80%) invert(10%) contrast(110%);
        }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .top-bar {
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%);
            padding: 15px;
            pointer-events: auto;
            display: flex;
            justify-content: space-between;
        }

        .stats-card {
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            padding: 10px 15px;
            border-radius: var(--radius);
            border: 1px solid rgba(255,255,255,0.1);
            min-width: 100px;
        }

        .money-val { color: var(--success); font-size: 18px; font-weight: bold; }
        .res-bar-bg { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin-top:2px; }
        .res-bar-fill { height: 100%; transition: width 0.3s; }
        
        .bottom-dock {
            background: var(--bg-glass);
            backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 20px 20px 40px 20px;
            pointer-events: auto;
            border-radius: 24px 24px 0 0;
        }

        .nav-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }
        .nav-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.05);
            color: #9ca3af;
            padding: 10px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .action-btn {
            width: 100%;
            background: var(--accent);
            color: white;
            font-size: 18px;
            font-weight: 800;
            padding: 18px;
            border: none;
            border-radius: var(--radius);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }
        .btn-repair { background: var(--accent-repair) !important; }

        /* --- –ù–û–í–û–ï: –ú–û–î–ê–õ–ö–ê –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø –ó–ê–ö–ê–ó–ê --- */
        #offer-modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 500;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .offer-card {
            background: #1c1c1e;
            width: 85%;
            max-width: 320px;
            border-radius: 24px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .timer-ring {
            width: 60px; height: 60px;
            border: 4px solid #333;
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            margin: 0 auto 15px auto;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: bold;
            animation: spin 1s linear infinite; /* –ë—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è JS-–æ–º */
        }

        .offer-btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn-accept { background: var(--success); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .btn-decline { background: #333; color: var(--danger); border: 1px solid var(--danger); padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; }

        /* –ú–æ–¥–∞–ª–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; justify-content: center; align-items: flex-end; }
        .modal-content { background: #1c1c1e; width: 100%; padding: 20px; border-radius: 24px 24px 0 0; color: #fff; max-height: 80vh; overflow-y: auto; }
        
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: #fff; padding: 10px 20px;
            border-radius: 30px; font-size: 13px; z-index: 1000;
            display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="ui-layer">
        <div class="top-bar">
            <div class="stats-card">
                <div style="font-size:12px; color:#aaa;">–ë–ê–õ–ê–ù–°</div>
                <div class="money-val" id="cash-display">0 PLN</div>
                <div style="font-size:12px; color:#aaa; margin-top:5px;">–†–ï–ô–¢–ò–ù–ì</div>
                <div style="color:var(--accent); font-weight:bold;" id="lvl-display">LVL 1</div>
            </div>

            <div class="stats-card" style="text-align:right;">
                <div style="font-size:12px; color:#aaa;">–í–ï–õ–û–°–ò–ü–ï–î</div>
                <div class="res-bar-bg"><div id="bike-bar" class="res-bar-fill" style="background:orange; width:100%;"></div></div>
                <div style="font-size:12px; margin-top:5px;" id="bike-hp">100%</div>
            </div>
        </div>

        <div class="bottom-dock">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                <div>
                    <div style="font-size:12px; color:#aaa;">–≠–ù–ï–†–ì–ò–Ø <span id="energy-val">100%</span></div>
                    <div class="res-bar-bg"><div id="energy-bar" class="res-bar-fill" style="background:var(--accent);"></div></div>
                </div>
                <div>
                    <div style="font-size:12px; color:#aaa;">–í–û–î–ê <span id="water-val">100%</span></div>
                    <div class="res-bar-bg"><div id="water-bar" class="res-bar-fill" style="background:#0ea5e9;"></div></div>
                </div>
            </div>

            <div class="nav-grid">
                <button class="nav-btn" onclick="openShop()"><i class="fas fa-shopping-cart"></i> <span>–ú–ê–ì–ê–ó–ò–ù</span></button>
                <button class="nav-btn" onclick="drinkFreeWater()"><i class="fas fa-faucet" style="color:#0ea5e9;"></i> <span>–ü–û–ü–ò–¢–¨</span></button>
                <button class="nav-btn" onclick="showToast('–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')"><i class="fas fa-user"></i> <span>–ü–†–û–§–ò–õ–¨</span></button>
            </div>

            <button id="main-btn" class="action-btn" onclick="pedal()">
                <i class="fas fa-bicycle"></i> –ó–ê–ì–†–£–ó–ö–ê...
            </button>
            <div id="order-info" style="text-align:center; font-size:12px; color:#aaa; margin-top:10px; display:none;">
                –î–∏—Å—Ç–∞–Ω—Ü–∏—è: <span id="dist-display">0</span> –º
            </div>
        </div>
    </div>

    <div id="offer-modal">
        <div class="offer-card">
            <h2 style="margin:0 0 15px 0;">üì¶ –ù–û–í–´–ô –ó–ê–ö–ê–ó</h2>
            <div class="timer-ring" id="offer-timer-ui">10</div>
            <div style="font-size:14px; color:#aaa;">–û–ø–ª–∞—Ç–∞ –∑–∞ –¥–æ—Å—Ç–∞–≤–∫—É:</div>
            <div style="font-size:32px; color:var(--success); font-weight:bold; margin-bottom:20px;" id="offer-price">0 PLN</div>
            
            <div class="offer-btn-grid">
                <button class="btn-decline" onclick="rejectOrder()">
                    –û–¢–ö–ê–ó<br><span style="font-size:10px">-5 PLN</span>
                </button>
                <button class="btn-accept" onclick="acceptOrder()">
                    –ü–†–ò–ù–Ø–¢–¨<br><span style="font-size:10px">–í–ø–µ—Ä–µ–¥!</span>
                </button>
            </div>
        </div>
    </div>

    <div id="shop-modal" class="modal" onclick="if(event.target === this) this.style.display='none'">
        <div class="modal-content">
            <h2>üè™ 7-Eleven</h2>
            <div id="shop-list"></div>
            <button onclick="document.getElementById('shop-modal').style.display='none'" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:12px; margin-top:20px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const SAVE_KEY = 'PROJECT2_OFFER_V2'; 

        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([52.2297, 21.0122], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

        const courierIcon = L.divIcon({ html: '<div style="background:#3b82f6; width:15px; height:15px; border-radius:50%; border:2px solid white; box-shadow:0 0 10px #3b82f6;"></div>', className: 'cm' });
        const targetIcon = L.divIcon({ html: '<div style="background:#ef4444; width:15px; height:15px; border-radius:50%; border:2px solid white; animation: pulse 1s infinite;"></div>', className: 'tm' });

        let courierMarker = L.marker([52.2297, 21.0122], {icon: courierIcon}).addTo(map);
        let targetMarker = null;

        let state = {
            cash: 50,
            energy: 100, water: 100, mood: 100,
            bike: 100, gear: 100,
            exp: 0, lvl: 1,
            currentOrder: null
        };
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–µ—Ö–∞–Ω–∏–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
        let pendingOrder = null; // –ó–∞–∫–∞–∑, –∫–æ—Ç–æ—Ä—ã–π –≤–∏—Å–∏—Ç –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏
        let offerInterval = null; // –¢–∞–π–º–µ—Ä
        let offerTimeLeft = 10;
        let lastDrinkTime = 0;

        function init() {
            loadGame();
            updateUI();
            updateMainButtonState();
            setInterval(autoTick, 5000); 
            setInterval(saveGame, 10000);
        }

        function autoTick() {
            if(state.currentOrder) {
                state.water = Math.max(0, state.water - 0.2);
                state.mood = Math.max(0, state.mood - 0.2);
            } else {
                if(state.energy < 50) state.energy += 0.5;
            }
            updateUI();
        }

        function pedal() {
            // 1. –†–ï–ú–û–ù–¢
            if (state.bike <= 0) {
                if (state.energy >= 10) {
                    state.energy -= 10; state.bike += 15;
                    showToast("üîß –ì–∞–π–∫–∏ –ø–æ–¥–∫—Ä—É—á–µ–Ω—ã! (+15% HP)", "success");
                } else showToast("üò´ –ù–µ—Ç —Å–∏–ª —á–∏–Ω–∏—Ç—å! –ü–æ–µ—à—å.", "error");
                updateUI(); updateMainButtonState(); return;
            }

            // 2. –ü–û–ò–°–ö –ó–ê–ö–ê–ó–ê (–ò–ó–ú–ï–ù–ï–ù–û)
            if (!state.currentOrder) {
                findOrder(); // –¢–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ—Ç –æ–∫–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
                return;
            }

            // 3. –ï–ó–î–ê
            if (state.energy <= 0) { showToast("‚ö° –ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏!", "error"); return; }

            const dest = state.currentOrder.dest;
            const pos = courierMarker.getLatLng();
            const newLat = pos.lat + (dest[0] - pos.lat) * 0.1; 
            const newLng = pos.lng + (dest[1] - pos.lng) * 0.1;

            courierMarker.setLatLng([newLat, newLng]);
            map.setView([newLat, newLng]); 

            state.energy = Math.max(0, state.energy - 2);
            state.bike = Math.max(0, state.bike - 0.5); 
            state.gear = Math.max(0, state.gear - 0.2);

            const dist = map.distance([newLat, newLng], dest);
            document.getElementById('dist-display').innerText = Math.floor(dist);

            if (dist < 20) finishOrder();
            
            updateUI(); updateMainButtonState();
        }

        // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –ó–ê–ö–ê–ó–û–í ---

        function findOrder() {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º "–ü—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–π –∑–∞–∫–∞–∑"
            const center = [52.2297, 21.0122];
            const dest = [ center[0] + (Math.random() - 0.5) * 0.03, center[1] + (Math.random() - 0.5) * 0.03 ];
            
            pendingOrder = {
                dest: dest,
                pay: 15 + Math.floor(Math.random() * 25) // 15-40 PLN
            };

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
            document.getElementById('offer-price').innerText = pendingOrder.pay + " PLN";
            document.getElementById('offer-modal').style.display = 'flex';
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
            offerTimeLeft = 10;
            updateTimerUI();
            
            if (offerInterval) clearInterval(offerInterval);
            offerInterval = setInterval(() => {
                offerTimeLeft--;
                updateTimerUI();
                if (offerTimeLeft <= 0) {
                    rejectOrder(true); // true –∑–Ω–∞—á–∏—Ç "–ø–æ –≤—Ä–µ–º–µ–Ω–∏"
                }
            }, 1000);
        }

        function updateTimerUI() {
            const el = document.getElementById('offer-timer-ui');
            el.innerText = offerTimeLeft;
            // –ö—Ä–∞—Å–Ω–µ–µ—Ç –∫–æ–≥–¥–∞ –º–∞–ª–æ –≤—Ä–µ–º–µ–Ω–∏
            el.style.borderColor = offerTimeLeft < 4 ? '#ef4444' : '#3b82f6';
            el.style.color = offerTimeLeft < 4 ? '#ef4444' : '#fff';
        }

        function acceptOrder() {
            clearInterval(offerInterval);
            document.getElementById('offer-modal').style.display = 'none';
            
            state.currentOrder = pendingOrder;
            pendingOrder = null;
            
            // –°—Ç–∞–≤–∏–º –º–∞—Ä–∫–µ—Ä
            if (targetIcon) map.removeLayer(targetIcon); // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –µ—Å–ª–∏ –±—ã–ª
            targetMarker = L.marker(state.currentOrder.dest, {icon: targetIcon}).addTo(map);
            
            document.getElementById('order-info').style.display = 'block';
            showToast("‚úÖ –ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç! –í–ø–µ—Ä–µ–¥!", "success");
            updateMainButtonState();
            saveGame();
        }

        function rejectOrder(isTimeout = false) {
            clearInterval(offerInterval);
            document.getElementById('offer-modal').style.display = 'none';
            pendingOrder = null;

            // –®–¢–†–ê–§
            state.cash -= 5;
            
            if (isTimeout) {
                showToast("‚è∞ –í—Ä–µ–º—è –≤—ã—à–ª–æ! –®—Ç—Ä–∞—Ñ -5 PLN", "error");
            } else {
                showToast("‚ùå –û—Ç–∫–∞–∑ –æ—Ç –∑–∞–∫–∞–∑–∞. –®—Ç—Ä–∞—Ñ -5 PLN", "error");
            }
            updateUI();
            saveGame();
        }

        function finishOrder() {
            state.cash += state.currentOrder.pay;
            state.exp += 10;
            if (state.exp > 100 * state.lvl) { state.lvl++; state.exp = 0; showToast("üéâ LEVEL UP!"); }
            
            showToast(`üíµ –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ! +${state.currentOrder.pay} PLN`, "success");
            state.currentOrder = null;
            if (targetMarker) map.removeLayer(targetMarker);
            document.getElementById('order-info').style.display = 'none';
            saveGame();
            updateMainButtonState();
        }

        // --- –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
        function drinkFreeWater() {
            const now = Date.now();
            if (now - lastDrinkTime < 60000) { 
                showToast(`‚è≥ –ñ–¥–∏ –µ—â–µ ${Math.ceil((60000 - (now - lastDrinkTime))/1000)} —Å–µ–∫.`); return; 
            }
            state.water = Math.min(100, state.water + 25);
            lastDrinkTime = now;
            showToast("üíß –ì–ª–æ—Ç–æ–∫ –≤–æ–¥—ã (+25%)", "success"); updateUI();
        }

        const items = [
            { id: 'snickers', name: '–°–Ω–∏–∫–µ—Ä—Å', price: 10, effect: { energy: 30 }, icon: 'üç´' },
            { id: 'water', name: '–í–æ–¥–∞ 0.5', price: 5, effect: { water: 50 }, icon: 'üíß' },
            { id: 'repair', name: '–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è', price: 40, effect: { bike: 100 }, icon: 'üîß' }
        ];

        function openShop() {
            const list = document.getElementById('shop-list'); list.innerHTML = '';
            items.forEach(item => {
                const div = document.createElement('div');
                div.style.cssText = "display:flex; justify-content:space-between; padding:15px 0; border-bottom:1px solid rgba(255,255,255,0.1);";
                div.innerHTML = `<div><span style="font-size:20px">${item.icon}</span> <b>${item.name}</b> <div style="font-size:12px;color:#aaa">${item.price} PLN</div></div> <button onclick="buyItem('${item.id}')" style="background:#10b981; border:none; padding:5px 15px; border-radius:15px;">–ö—É–ø–∏—Ç—å</button>`;
                list.appendChild(div);
            });
            document.getElementById('shop-modal').style.display = 'flex';
        }

        function buyItem(id) {
            const item = items.find(i => i.id === id);
            if (state.cash >= item.price) {
                state.cash -= item.price;
                if (item.effect.energy) state.energy = Math.min(100, state.energy + item.effect.energy);
                if (item.effect.water) state.water = Math.min(100, state.water + item.effect.water);
                if (item.effect.bike) state.bike = Math.min(100, state.bike + item.effect.bike);
                showToast(`–ö—É–ø–ª–µ–Ω–æ: ${item.name}`, "success"); updateUI();
            } else showToast("‚ùå –ù–µ—Ç –¥–µ–Ω–µ–≥!", "error");
        }

        function updateUI() {
            document.getElementById('cash-display').innerText = state.cash + ' PLN';
            document.getElementById('lvl-display').innerText = 'LVL ' + state.lvl;
            document.getElementById('energy-bar').style.width = state.energy + '%';
            document.getElementById('water-bar').style.width = state.water + '%';
            document.getElementById('bike-bar').style.width = state.bike + '%';
            document.getElementById('bike-hp').innerText = Math.floor(state.bike) + '%';
        }

        function updateMainButtonState() {
            const btn = document.getElementById('main-btn');
            if (state.bike <= 0) {
                btn.innerHTML = '<i class="fas fa-wrench"></i> –ß–ò–ù–ò–¢–¨ (–†—É–∫–∞–º–∏)';
                btn.classList.add('btn-repair');
            } else {
                btn.classList.remove('btn-repair');
                if (state.currentOrder) btn.innerHTML = '<i class="fas fa-bicycle"></i> –ö–†–£–¢–ò–¢–¨ –ü–ï–î–ê–õ–ò';
                else btn.innerHTML = '<i class="fas fa-search"></i> –ù–ê–ô–¢–ò –ó–ê–ö–ê–ó';
            }
        }

        function showToast(msg, type="info") {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            t.style.border = type === 'error' ? '1px solid red' : '1px solid #333';
            setTimeout(() => t.style.display = 'none', 2000);
        }

        function saveGame() { localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }
        function loadGame() {
            const saved = localStorage.getItem(SAVE_KEY);
            if (saved) state = JSON.parse(saved);
        }

        init();
    </script>
    <style>
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { transform: scale(1.5); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</body>
</html>
