<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Warsaw Night Courier</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0a; color: #fff; overflow: hidden; height: 100vh; }
        
        #map { height: 100%; width: 100%; position: absolute; top: 0; left: 0; z-index: 1; }
        .leaflet-tile { filter: brightness(0.3) saturate(0.6) contrast(1.3) !important; }
        
        .ui-layer { position: absolute; z-index: 100; pointer-events: none; width: 100%; height: 100%; }
        .ui-layer > * { pointer-events: auto; }
        
        /* === –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ === */
        .top-hud {
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .resources-bar {
            display: flex;
            gap: 6px;
            background: rgba(0,0,0,0.7);
            padding: 6px 10px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .resource-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .resource-icon { font-size: 14px; }
        .resource-val.energy { color: #ffd700; }
        .resource-val.water { color: #00d4ff; }
        .resource-val.mood { color: #ff00ff; }
        
        .resource-bar-mini {
            width: 30px;
            height: 3px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .resource-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }
        
        .resource-fill.energy { background: #ffd700; }
        .resource-fill.water { background: #00d4ff; }
        .resource-fill.mood { background: #ff00ff; }
        
        .balance-chip {
            background: linear-gradient(135deg, #00e676, #00c853);
            color: #000;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
        }
        
        /* === –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ (–æ–¥–Ω–æ) === */
        .bottom-menu {
            position: absolute;
            bottom: 15px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: center;
            gap: 8px;
        }
        
        .menu-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 10px 12px;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 55px;
        }
        
        .menu-btn:active { transform: scale(0.92); }
        
        .menu-btn.primary {
            background: linear-gradient(135deg, #00e676, #00c853);
            color: #000;
            padding: 12px 18px;
        }
        
        .menu-btn.secondary {
            background: rgba(30,30,30,0.9);
            border: 1px solid rgba(255,255,255,0.15);
            color: #fff;
        }
        
        .menu-btn.secondary.water { border-color: #00d4ff; }
        .menu-btn.secondary.water .btn-icon { color: #00d4ff; }
        .menu-btn.secondary.energy { border-color: #ffd700; }
        .menu-btn.secondary.energy .btn-icon { color: #ffd700; }
        .menu-btn.secondary.shop { border-color: #ff4081; }
        .menu-btn.secondary.shop .btn-icon { color: #ff4081; }
        .menu-btn.secondary.stats { border-color: #9c27b0; }
        .menu-btn.secondary.stats .btn-icon { color: #9c27b0; }
        
        .btn-icon { font-size: 20px; }
        .btn-label { font-size: 10px; font-weight: 600; text-transform: uppercase; }
        .btn-cost { font-size: 9px; opacity: 0.8; }
        
        /* === –ü–ê–ù–ï–õ–ò === */
        .center-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 380px;
            background: rgba(15,15,15,0.98);
            border-radius: 24px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 150;
            display: none;
        }
        
        .center-panel.active { display: block; }
        
        .panel-title { font-size: 22px; font-weight: 700; margin-bottom: 6px; text-align: center; }
        .panel-subtitle { color: #888; font-size: 13px; margin-bottom: 20px; text-align: center; }
        
        /* === –î–û–°–¢–ê–í–ö–ê === */
        .delivery-panel {
            position: absolute;
            bottom: 100px;
            left: 15px;
            right: 15px;
            background: rgba(15,15,15,0.95);
            border-radius: 20px;
            padding: 16px;
            border: 1px solid rgba(0,230,118,0.3);
            display: none;
        }
        
        .delivery-panel.active { display: block; }
        
        .delivery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .delivery-title { font-size: 16px; font-weight: 600; }
        .delivery-status { font-size: 12px; color: #00e676; }
        
        .progress-track {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00e676, #00c853);
            width: 0%;
            transition: width 0.5s;
        }
        
        .delivery-buttons { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #00e676; color: #000; }
        .btn-danger { background: rgba(255,61,0,0.2); color: #ff3d00; border: 1px solid rgba(255,61,0,0.3); }
        
        /* === –ò–ì–†–ê === */
        .game-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .game-overlay.active { display: flex; }
        
        .game-box {
            background: #1a1a1a;
            border-radius: 24px;
            padding: 24px;
            width: 90%;
            max-width: 340px;
            border: 1px solid rgba(41,121,255,0.3);
            text-align: center;
        }
        
        .game-title { font-size: 20px; font-weight: 700; margin-bottom: 16px; color: #2979ff; }
        
        .game-road { 
            width: 100%; 
            height: 180px; 
            background: linear-gradient(to bottom, #0f0f0f, #1a1a1a); 
            border-radius: 16px; 
            position: relative; 
            overflow: hidden; 
            margin-bottom: 20px;
            border: 2px solid rgba(255,255,255,0.1);
        }
        
        .lane { position: absolute; width: 100%; height: 33.33%; border-bottom: 2px dashed rgba(255,255,255,0.1); }
        .player-bike { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 36px; transition: top 0.1s; z-index: 10; }
        .obstacle { position: absolute; right: -50px; font-size: 32px; animation: moveLeft 2s linear; z-index: 5; }
        
        @keyframes moveLeft { from { right: -50px; } to { right: 110%; } }
        
        .game-controls { display: flex; gap: 20px; justify-content: center; }
        .control-btn { 
            width: 80px; 
            height: 80px; 
            border-radius: 50%; 
            border: 2px solid; 
            background: transparent; 
            font-size: 32px; 
            cursor: pointer;
        }
        
        .control-btn.up { border-color: #2979ff; color: #2979ff; }
        .control-btn.down { border-color: #7c4dff; color: #7c4dff; }
        
        /* === –ü–ò–¢-–°–¢–û–ü === */
        .pitstop-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 220;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .pitstop-overlay.active { display: flex; }
        
        .pitstop-card {
            background: #1a1a1a;
            border-radius: 24px;
            padding: 24px;
            max-width: 340px;
            width: 100%;
            border: 1px solid rgba(0,230,118,0.3);
            text-align: center;
        }
        
        .pitstop-title { font-size: 22px; font-weight: 700; margin-bottom: 20px; }
        
        .pitstop-item {
            background: rgba(40,40,40,0.8);
            padding: 14px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            margin-bottom: 10px;
            text-align: left;
        }
        
        .pitstop-item-header { display: flex; align-items: center; gap: 10px; font-size: 16px; }
        .pitstop-item-price { margin-left: auto; color: #00e676; font-weight: 600; }
        
        .btn-close {
            width: 100%;
            padding: 14px;
            border: 1px solid rgba(255,255,255,0.2);
            background: transparent;
            color: #888;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        /* === –°–û–ë–´–¢–ò–ï === */
        .event-overlay { 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.95); 
            z-index: 250; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
        }
        
        .event-overlay.active { display: flex; }
        
        .event-card { 
            background: #1a1a1a; 
            border-radius: 24px; 
            padding: 28px; 
            max-width: 340px; 
            width: 100%; 
            border: 1px solid rgba(255,145,0,0.3); 
            text-align: center; 
        }
        
        .event-icon { font-size: 56px; margin-bottom: 12px; }
        .event-title { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
        .event-text { color: #aaa; margin-bottom: 20px; line-height: 1.5; font-size: 14px; }
        
        /* === –ú–ê–ì–ê–ó–ò–ù === */
        .shop-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 300;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .shop-overlay.active { display: flex; }
        
        .shop-card {
            background: #1a1a1a;
            border-radius: 24px;
            padding: 24px;
            max-width: 340px;
            width: 100%;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .shop-title { font-size: 20px; font-weight: 700; margin-bottom: 16px; text-align: center; }
        
        .shop-item {
            background: rgba(40,40,40,0.8);
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            border: 1px solid transparent;
        }
        
        .shop-item-price { color: #00e676; font-weight: 700; font-size: 14px; }
        
        /* === –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø === */
        .toast { 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background: rgba(0,0,0,0.95); 
            padding: 18px 28px; 
            border-radius: 16px; 
            border: 1px solid #00e676; 
            color: #00e676; 
            font-weight: 600; 
            opacity: 0; 
            pointer-events: none; 
            transition: opacity 0.3s; 
            z-index: 400; 
            text-align: center; 
        }
        
        .toast.show { opacity: 1; }
        
        /* === –ú–ê–†–ö–ï–†–´ === */
        .marker-courier { background: #00e676; width: 20px; height: 20px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 0 20px #00e676; }
        .marker-dest { background: #ff3d00; width: 26px; height: 26px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 0 25px #ff3d00; }
        .marker-pitstop { background: #2979ff; width: 24px; height: 24px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 0 15px #2979ff; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        
        .route-option {
            background: rgba(40,40,40,0.8);
            padding: 14px;
            border-radius: 14px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
        }
        
        .route-tag { padding: 3px 8px; border-radius: 8px; font-size: 10px; font-weight: 600; }
        .tag-fast { background: #ff3d00; color: #fff; }
        .tag-safe { background: #00e676; color: #000; }
        .tag-profit { background: #ffd600; color: #000; }
        .route-price { color: #00e676; font-weight: 700; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="ui-layer">
        <!-- –í–ï–†–•: —Ä–µ—Å—É—Ä—Å—ã + –±–∞–ª–∞–Ω—Å -->
        <div class="top-hud">
            <div class="resources-bar">
                <div class="resource-item">
                    <span class="resource-icon">‚ö°</span>
                    <span class="resource-val energy" id="energy-val">100</span>
                    <div class="resource-bar-mini"><div class="resource-fill energy" id="energy-bar" style="width: 100%"></div></div>
                </div>
                <div class="resource-item">
                    <span class="resource-icon">üíß</span>
                    <span class="resource-val water" id="water-val">100</span>
                    <div class="resource-bar-mini"><div class="resource-fill water" id="water-bar" style="width: 100%"></div></div>
                </div>
                <div class="resource-item">
                    <span class="resource-icon">üòé</span>
                    <span class="resource-val mood" id="mood-val">100</span>
                    <div class="resource-bar-mini"><div class="resource-fill mood" id="mood-bar" style="width: 100%"></div></div>
                </div>
            </div>
            <div class="balance-chip" id="balance">50 ‚ÇΩ</div>
        </div>
        
        <!-- –ù–ò–ó: –æ–¥–Ω–æ –º–µ–Ω—é -->
        <div class="bottom-menu">
            <button class="menu-btn secondary water" onclick="openShopType('water')">
                <span class="btn-icon">üíß</span>
                <span class="btn-label">–í–æ–¥–∞</span>
                <span class="btn-cost">3‚ÇΩ</span>
            </button>
            <button class="menu-btn secondary energy" onclick="openShopType('energy')">
                <span class="btn-icon">‚òï</span>
                <span class="btn-label">–ö–æ—Ñ–µ</span>
                <span class="btn-cost">5‚ÇΩ</span>
            </button>
            <button class="menu-btn primary" onclick="findOrder()">
                <span class="btn-icon">üîç</span>
                <span class="btn-label">–ó–∞–∫–∞–∑</span>
            </button>
            <button class="menu-btn secondary shop" onclick="openShop()">
                <span class="btn-icon">üõí</span>
                <span class="btn-label">–ú–∞–≥–∞–∑</span>
            </button>
            <button class="menu-btn secondary stats" onclick="showStats()">
                <span class="btn-icon">üìä</span>
                <span class="btn-label">–°—Ç–∞—Ç</span>
            </button>
        </div>
        
        <!-- –ü–ê–ù–ï–õ–¨ –í–´–ë–û–†–ê –ú–ê–†–®–†–£–¢–ê -->
        <div class="center-panel" id="route-panel">
            <div class="panel-title">üó∫Ô∏è –í—ã–±–µ—Ä–∏ –º–∞—Ä—à—Ä—É—Ç</div>
            <div class="panel-subtitle">–ö–∞–∂–¥—ã–π –ø—É—Ç—å ‚Äî —Å–≤–æ–π —Ä–∏—Å–∫ –∏ –Ω–∞–≥—Ä–∞–¥–∞</div>
            <div id="route-options"></div>
        </div>
        
        <!-- –ü–ê–ù–ï–õ–¨ –î–û–°–¢–ê–í–ö–ò -->
        <div class="delivery-panel" id="delivery-panel">
            <div class="delivery-header">
                <div class="delivery-title" id="delivery-title">üçî –î–æ—Å—Ç–∞–≤–∫–∞</div>
                <div class="delivery-status" id="delivery-status">–í –ø—É—Ç–∏...</div>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="delivery-buttons">
                <button class="btn btn-primary" id="drive-btn" onclick="startDriving()" style="display:none;">üö≤ –ï—Ö–∞—Ç—å</button>
                <button class="btn btn-danger" onclick="cancelDelivery()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
    
    <!-- –ò–ì–†–ê -->
    <div class="game-overlay" id="game-overlay">
        <div class="game-box">
            <div class="game-title">‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –¥–æ—Ä–æ–≥–µ!</div>
            <div class="game-road" id="game-road">
                <div class="lane" style="top: 0;"></div>
                <div class="lane" style="top: 33.33%;"></div>
                <div class="lane" style="top: 66.66%;"></div>
                <div class="player-bike" id="player">üö¥</div>
            </div>
            <div class="game-controls">
                <button class="control-btn up" onclick="moveBike(-1)">‚¨ÜÔ∏è</button>
                <button class="control-btn down" onclick="moveBike(1)">‚¨áÔ∏è</button>
            </div>
        </div>
    </div>
    
    <!-- –ü–ò–¢-–°–¢–û–ü -->
    <div class="pitstop-overlay" id="pitstop-overlay">
        <div class="pitstop-card">
            <div class="pitstop-title" id="pitstop-title">‚õΩ –ü–∏—Ç-—Å—Ç–æ–ø</div>
            <div id="pitstop-items"></div>
            <button class="btn-close" onclick="skipPitstop()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
    </div>
    
    <!-- –°–û–ë–´–¢–ò–ï -->
    <div class="event-overlay" id="event-overlay">
        <div class="event-card">
            <div class="event-icon" id="event-icon">‚ö†Ô∏è</div>
            <div class="event-title" id="event-title">–°–æ–±—ã—Ç–∏–µ</div>
            <div class="event-text" id="event-text">–ß—Ç–æ-—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ...</div>
            <div id="event-choices"></div>
        </div>
    </div>
    
    <!-- –ú–ê–ì–ê–ó–ò–ù -->
    <div class="shop-overlay" id="shop-overlay">
        <div class="shop-card">
            <div class="shop-title" id="shop-title">üõí –ú–∞–≥–∞–∑–∏–Ω</div>
            <div id="shop-items"></div>
            <button class="btn-close" onclick="closeShop()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    
    <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
    <div class="shop-overlay" id="stats-overlay">
        <div class="shop-card">
            <div class="shop-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
            <div id="stats-content"></div>
            <button class="btn-close" onclick="closeStats()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const WARSAW_CENTER = [52.2297, 21.0122];
        
        const SHOP_ITEMS = {
            water: [
                { name: '–í–æ–¥–∞ 0.5–ª', icon: 'üíß', cost: 3, energy: 0, water: 40, mood: 5 },
                { name: '–í–æ–¥–∞ 1.5–ª', icon: 'ü•§', cost: 5, energy: -5, water: 70, mood: 10 }
            ],
            energy: [
                { name: '–≠—Å–ø—Ä–µ—Å—Å–æ', icon: '‚òï', cost: 5, energy: 35, water: -5, mood: 10 },
                { name: 'Red Bull', icon: '‚ö°', cost: 8, energy: 60, water: -10, mood: 5 }
            ],
            all: [
                { name: '–ë—É—Ä–≥–µ—Ä', icon: 'üçî', cost: 15, energy: 50, water: 10, mood: 30 },
                { name: '–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫', icon: '‚ö°', cost: 8, energy: 60, water: -10, mood: 5 },
                { name: '–í–æ–¥–∞ 1.5–ª', icon: 'ü•§', cost: 5, energy: -5, water: 70, mood: 10 }
            ]
        };
        
        const PITSTOPS = {
            gas: { name: '–ê–ó–°', icon: '‚õΩ', items: [
                { name: '–ö–æ—Ñ–µ', cost: 4, energy: 25, water: -5, mood: 10, icon: '‚òï' },
                { name: '–í–æ–¥–∞', cost: 3, energy: 5, water: 40, mood: 0, icon: 'üíß' }
            ]},
            cafe: { name: '–ö–∞—Ñ–µ', icon: '‚òï', items: [
                { name: '–û–±–µ–¥', cost: 12, energy: 40, water: 20, mood: 30, icon: 'üçΩÔ∏è' },
                { name: '–õ–∞—Ç—Ç–µ', cost: 6, energy: 20, water: 10, mood: 15, icon: '‚òï' }
            ]}
        };
        
        const RESTAURANTS = [
            { name: "McDonald's", icon: "üçî" },
            { name: "KFC", icon: "üçó" },
            { name: "Pizza Hut", icon: "üçï" },
            { name: "Sushi Master", icon: "üç£" },
            { name: "Kebab King", icon: "üåØ" }
        ];
        
        const ROAD_EVENTS = [
            { icon: 'üåßÔ∏è', title: '–õ–∏–≤–µ–Ω—å!', text: '–î–æ—Ä–æ–≥–∏ —Å–∫–æ–ª—å–∑–∫–∏–µ.', choices: [
                { text: '–ï—Ö–∞—Ç—å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ', effect: { time: 10, mood: -5 } },
                { text: '–†–∏—Å–∫–Ω—É—Ç—å', effect: { time: -5, risk: 20 } }
            ]},
            { icon: 'üöî', title: '–ü–æ–ª–∏—Ü–∏—è', text: '–ü–∞—Ç—Ä—É–ª—å –æ—Å—Ç–∞–Ω–æ–≤–∏–ª.', choices: [
                { text: '–ü–æ–∫–∞–∑–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã', effect: { time: 5, mood: -10 } },
                { text: '–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∫–æ—Ñ–µ (-15‚ÇΩ)', effect: { money: -15 } }
            ]},
            { icon: 'üöß', title: '–ü—Ä–æ–±–∫–∞', text: '–ì–ª–∞–≤–Ω–∞—è –¥–æ—Ä–æ–≥–∞ –≤—Å—Ç–∞–ª–∞.', choices: [
                { text: '–ñ–¥–∞—Ç—å', effect: { time: 8, mood: -15 } },
                { text: '–û–±—ä–µ–∑–¥', effect: { time: -3, risk: 25 } }
            ]}
        ];
        
        let state = {
            balance: 50, energy: 100, water: 100, mood: 100,
            experience: 0, level: 1,
            stats: { totalDeliveries: 0, totalEarned: 0, accidents: 0, bestTip: 0 },
            currentOrder: null, currentRoute: null, isDelivering: false,
            progress: 0, currentStop: 0, gameActive: false, bikeLane: 1, gameHits: 0
        };
        
        let map, courierMarker, destMarker, routeLine, pitstopMarkers = [];
        let obstacleInterval;

        function saveGame() {
            localStorage.setItem('warsaw_courier_save', JSON.stringify({
                balance: state.balance, energy: state.energy, water: state.water, mood: state.mood,
                stats: state.stats, level: state.level, experience: state.experience
            }));
        }
        
        function loadGame() {
            const saved = localStorage.getItem('warsaw_courier_save');
            if (saved) {
                const data = JSON.parse(saved);
                state.balance = data.balance ?? 50;
                state.energy = data.energy ?? 100;
                state.water = data.water ?? 100;
                state.mood = data.mood ?? 100;
                state.stats = data.stats ?? { totalDeliveries: 0, totalEarned: 0, accidents: 0, bestTip: 0 };
                state.level = data.level ?? 1;
                state.experience = data.experience ?? 0;
            }
        }

        function init() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView(WARSAW_CENTER, 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
            
            const courierIcon = L.divIcon({ html: '<div class="marker-courier"></div>', className: 'custom-marker', iconSize: [20, 20] });
            courierMarker = L.marker(WARSAW_CENTER, { icon: courierIcon }).addTo(map);
            
            loadGame();
            updateUI();
            setInterval(gameTick, 1000);
            setInterval(saveGame, 5000);
            window.addEventListener('beforeunload', saveGame);
            
            showToast('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ! –ù–∞–∂–º–∏ –ó–ê–ö–ê–ó', 3000);
        }
        
        function updateUI() {
            document.getElementById('balance').textContent = Math.floor(state.balance) + ' ‚ÇΩ';
            ['energy', 'water', 'mood'].forEach(stat => {
                const val = Math.floor(state[stat]);
                document.getElementById(stat + '-val').textContent = val;
                document.getElementById(stat + '-bar').style.width = val + '%';
            });
        }
        
        function gameTick() {
            if (state.isDelivering && !state.gameActive) {
                state.energy -= 0.2;
                state.water -= 0.15;
                state.mood -= 0.1;
                if (state.energy <= 0 || state.water <= 0) failDelivery('–†–µ—Å—É—Ä—Å—ã –∫–æ–Ω—á–∏–ª–∏—Å—å!');
                updateUI();
            }
        }
        
        function showToast(msg, duration = 2500) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), duration);
        }

        function openShopType(type) {
            if (state.isDelivering) { showToast('‚ùå –í–æ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–µ–ª—å–∑—è!', 2000); return; }
            document.getElementById('shop-title').textContent = type === 'water' ? 'üíß –ù–∞–ø–∏—Ç–∫–∏' : '‚òï –≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∏';
            const container = document.getElementById('shop-items');
            container.innerHTML = '';
            SHOP_ITEMS[type].forEach(item => {
                const div = document.createElement('div');
                div.className = 'shop-item';
                div.onclick = () => buyItem(item);
                div.innerHTML = `<span>${item.icon} ${item.name}</span><span class="shop-item-price">${item.cost}‚ÇΩ</span>`;
                container.appendChild(div);
            });
            document.getElementById('shop-overlay').classList.add('active');
        }
        
        function openShop() {
            if (state.isDelivering) { showToast('‚ùå –í–æ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–µ–ª—å–∑—è!', 2000); return; }
            document.getElementById('shop-title').textContent = 'üõí –ú–∞–≥–∞–∑–∏–Ω';
            const container = document.getElementById('shop-items');
            container.innerHTML = '';
            SHOP_ITEMS.all.forEach(item => {
                const div = document.createElement('div');
                div.className = 'shop-item';
                div.onclick = () => buyItem(item);
                div.innerHTML = `<span>${item.icon} ${item.name}</span><span class="shop-item-price">${item.cost}‚ÇΩ</span>`;
                container.appendChild(div);
            });
            document.getElementById('shop-overlay').classList.add('active');
        }
        
        function buyItem(item) {
            if (state.balance < item.cost) { showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!', 2000); return; }
            state.balance -= item.cost;
            state.energy = Math.min(100, Math.max(0, state.energy + item.energy));
            state.water = Math.min(100, Math.max(0, state.water + item.water));
            state.mood = Math.min(100, Math.max(0, state.mood + item.mood));
            updateUI(); saveGame(); closeShop();
            showToast(`${item.icon} –ì–æ—Ç–æ–≤–æ!`, 2000);
        }
        
        function closeShop() { document.getElementById('shop-overlay').classList.remove('active'); }

        function showStats() {
            const container = document.getElementById('stats-content');
            container.innerHTML = `
                <div class="shop-item"><span>üì¶ –î–æ—Å—Ç–∞–≤–æ–∫</span><span class="shop-item-price">${state.stats.totalDeliveries}</span></div>
                <div class="shop-item"><span>üí∞ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</span><span class="shop-item-price">${state.stats.totalEarned}‚ÇΩ</span></div>
                <div class="shop-item"><span>üí• –ê–≤–∞—Ä–∏–π</span><span class="shop-item-price">${state.stats.accidents}</span></div>
                <div class="shop-item"><span>üéÅ –õ—É—á—à–∏–µ —á–∞–µ–≤—ã–µ</span><span class="shop-item-price">${state.stats.bestTip}‚ÇΩ</span></div>
            `;
            document.getElementById('stats-overlay').classList.add('active');
        }
        
        function closeStats() { document.getElementById('stats-overlay').classList.remove('active'); }

        function findOrder() {
            if (state.energy < 20 || state.water < 20) { showToast('‚ö†Ô∏è –ú–∞–ª–æ —Ä–µ—Å—É—Ä—Å–æ–≤!', 3000); return; }
            
            const rest = RESTAURANTS[Math.floor(Math.random() * RESTAURANTS.length)];
            const dist = (1.5 + Math.random() * 4).toFixed(1);
            const basePrice = Math.floor(15 + parseFloat(dist) * 8);
            
            const routes = [
                { id: 'fast', name: 'üèéÔ∏è –ö–æ—Ä–æ—Ç–∫–∏–π', tag: 'tag-fast', tagText: '–ë—ã—Å—Ç—Ä–æ', time: Math.floor(dist * 2), risk: 40, energyCost: 20, waterCost: 15, price: basePrice + 5, pitstops: 0, desc: `${dist} –∫–º ‚Ä¢ –†–∏—Å–∫: –≤—ã—Å–æ–∫–∏–π` },
                { id: 'safe', name: 'üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π', tag: 'tag-safe', tagText: '–ù–∞–¥—ë–∂–Ω–æ', time: Math.floor(dist * 4), risk: 10, energyCost: 12, waterCost: 10, price: basePrice, pitstops: 1, desc: `${dist} –∫–º ‚Ä¢ 1 –ø–∏—Ç-—Å—Ç–æ–ø` },
                { id: 'profit', name: 'üí∞ –ü—Ä–∏–±—ã–ª—å–Ω—ã–π', tag: 'tag-profit', tagText: '–î–æ—Ö–æ–¥', time: Math.floor(dist * 5), risk: 25, energyCost: 30, waterCost: 20, price: Math.floor(basePrice * 1.4), pitstops: 2, desc: `${dist} –∫–º ‚Ä¢ 2 –ø–∏—Ç-—Å—Ç–æ–ø–∞` }
            ];
            
            state.currentOrder = { restaurant: rest, distance: parseFloat(dist), basePrice: basePrice, routes: routes, destLat: WARSAW_CENTER[0] + (Math.random() - 0.5) * 0.06, destLng: WARSAW_CENTER[1] + (Math.random() - 0.5) * 0.08 };
            
            const container = document.getElementById('route-options');
            container.innerHTML = '';
            routes.forEach((route, idx) => {
                const div = document.createElement('div');
                div.className = 'route-option';
                div.onclick = () => selectRoute(idx);
                div.innerHTML = `
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">${route.name}<span class="route-tag ${route.tag}">${route.tagText}</span></div>
                    <div style="font-size:12px;color:#888;display:flex;gap:12px;flex-wrap:wrap;">
                        <span>‚è±Ô∏è ${route.time} –º–∏–Ω</span><span>‚ö° -${route.energyCost}</span><span>üíß -${route.waterCost}</span><span class="route-price">${route.price}‚ÇΩ</span>
                    </div>
                    <div style="margin-top:6px;font-size:11px;color:#666;">${route.desc}</div>
                `;
                container.appendChild(div);
            });
            
            document.getElementById('route-panel').classList.add('active');
        }
        
        function selectRoute(idx) {
            state.currentRoute = state.currentOrder.routes[idx];
            const types = Object.keys(PITSTOPS);
            state.currentRoute.pitstopData = [];
            for (let i = 0; i < state.currentRoute.pitstops; i++) {
                const type = types[Math.floor(Math.random() * types.length)];
                state.currentRoute.pitstopData.push({ type: type, ...PITSTOPS[type], progress: Math.floor(((i + 1) / (state.currentRoute.pitstops + 1)) * 100) });
            }
            document.getElementById('route-panel').classList.remove('active');
            startDelivery();
        }
        
        function startDelivery() {
            state.isDelivering = true; state.progress = 0; state.currentStop = 0; state.gameHits = 0;
            state.energy -= state.currentRoute.energyCost * 0.3;
            state.water -= state.currentRoute.waterCost * 0.3;
            
            const dest = [state.currentOrder.destLat, state.currentOrder.destLng];
            
            destMarker = L.marker(dest, { icon: L.divIcon({ html: '<div class="marker-dest"></div>', className: 'custom-marker', iconSize: [26, 26] }) }).addTo(map);
            
            state.currentRoute.pitstopData.forEach((stop, idx) => {
                const lat = WARSAW_CENTER[0] + (dest[0] - WARSAW_CENTER[0]) * (stop.progress / 100);
                const lng = WARSAW_CENTER[1] + (dest[1] - WARSAW_CENTER[1]) * (stop.progress / 100);
                const marker = L.marker([lat, lng], { icon: L.divIcon({ html: `<div class="marker-pitstop">${stop.icon}</div>`, className: 'custom-marker', iconSize: [24, 24] }) }).addTo(map);
                pitstopMarkers.push(marker);
            });
            
            routeLine = L.polyline([WARSAW_CENTER, dest], { color: '#00e676', weight: 4, opacity: 0.6, dashArray: '8, 8' }).addTo(map);
            map.fitBounds([WARSAW_CENTER, dest], { padding: [60, 60] });
            
            document.getElementById('delivery-title').innerHTML = `${state.currentOrder.restaurant.icon} –î–æ—Å—Ç–∞–≤–∫–∞`;
            document.getElementById('delivery-panel').classList.add('active');
            document.getElementById('drive-btn').style.display = 'block';
            updateProgress(); updateUI();
            showToast('–ù–∞–∂–º–∏ –ï–•–ê–¢–¨ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!', 3000);
        }
        
        function updateProgress() { document.getElementById('progress-fill').style.width = state.progress + '%'; }

        function startDriving() {
            document.getElementById('drive-btn').style.display = 'none';
            document.getElementById('delivery-status').textContent = '–ï–¥–µ–º...';
            autoDrive();
        }
        
        function autoDrive() {
            const nextStop = state.currentRoute.pitstopData[state.currentStop];
            if (nextStop && state.progress >= nextStop.progress) { showPitstop(nextStop); return; }
            if (state.progress >= 100) { finishDelivery(); return; }
            
            const rand = Math.random();
            if (rand < 0.3) { startMiniGame(); }
            else if (rand < 0.3 + (state.currentRoute.risk / 100)) { triggerEvent(); }
            else {
                state.progress += 15; state.energy -= 3; state.water -= 2;
                updateProgress(); updateUI();
                setTimeout(autoDrive, 1000);
            }
        }
        
        function startMiniGame() {
            state.gameActive = true; state.bikeLane = 1; state.gameHits = 0;
            document.getElementById('game-overlay').classList.add('active');
            document.getElementById('delivery-status').textContent = '–û–ø–∞—Å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫!';
            updateBikePosition();
            
            let spawnCount = 0;
            obstacleInterval = setInterval(() => {
                spawnObstacle();
                spawnCount++;
                if (spawnCount >= 5) { clearInterval(obstacleInterval); setTimeout(endMiniGame, 2500); }
            }, 800);
        }
        
        function updateBikePosition() { document.getElementById('player').style.top = (state.bikeLane * 33.33 + 16.66) + '%'; }
        
        function moveBike(dir) {
            if (!state.gameActive) return;
            state.bikeLane += dir;
            if (state.bikeLane < 0) state.bikeLane = 0;
            if (state.bikeLane > 2) state.bikeLane = 2;
            updateBikePosition();
        }
        
        function spawnObstacle() {
            const road = document.getElementById('game-road');
            const obstacle = document.createElement('div');
            obstacle.className = 'obstacle';
            obstacle.textContent = ['üöó', 'üöß', 'üï≥Ô∏è', 'üêï'][Math.floor(Math.random() * 4)];
            const lane = Math.floor(Math.random() * 3);
            obstacle.style.top = (lane * 33.33 + 8) + '%';
            obstacle.dataset.lane = lane;
            road.appendChild(obstacle);
            
            setTimeout(() => {
                if (!state.gameActive) return;
                const bike = document.getElementById('player');
                const bikeRect = bike.getBoundingClientRect();
                const obsRect = obstacle.getBoundingClientRect();
                if (parseInt(obstacle.dataset.lane) === state.bikeLane && Math.abs(bikeRect.left - obsRect.left) < 60) {
                    state.gameHits++; showToast('üí• –£–¥–∞—Ä!', 1000);
                }
                setTimeout(() => obstacle.remove(), 2000);
            }, 1800);
        }
        
        function endMiniGame() {
            state.gameActive = false;
            document.getElementById('game-overlay').classList.remove('active');
            document.querySelectorAll('.obstacle').forEach(o => o.remove());
            
            if (state.gameHits === 0) { showToast('üåü –ò–¥–µ–∞–ª—å–Ω–æ! –ë–æ–Ω—É—Å: +5‚ÇΩ', 2000); state.currentOrder.bonus = (state.currentOrder.bonus || 0) + 5; state.progress += 10; }
            else if (state.gameHits === 1) { showToast('‚úÖ –ù–µ–ø–ª–æ—Ö–æ', 1500); state.progress += 5; }
            else { showToast(`üí• ${state.gameHits} –∞–≤–∞—Ä–∏–π! -10 —ç–Ω–µ—Ä–≥–∏–∏`, 2000); state.energy -= 10; state.mood -= 10; state.accidents++; }
            
            updateProgress(); updateUI();
            setTimeout(autoDrive, 2000);
        }
        
        function showPitstop(stop) {
            document.getElementById('pitstop-title').innerHTML = `${stop.icon} ${stop.name}`;
            const container = document.getElementById('pitstop-items');
            container.innerHTML = '';
            stop.items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'pitstop-item';
                div.onclick = () => buyPitstopItem(item);
                div.innerHTML = `<div class="pitstop-item-header"><span>${item.icon}</span><span>${item.name}</span><span class="pitstop-item-price">${item.cost}‚ÇΩ</span></div>`;
                container.appendChild(div);
            });
            document.getElementById('pitstop-overlay').classList.add('active');
        }
        
        function buyPitstopItem(item) {
            if (state.balance < item.cost) { showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!', 2000); return; }
            state.balance -= item.cost;
            state.energy = Math.min(100, Math.max(0, state.energy + item.energy));
            state.water = Math.min(100, Math.max(0, state.water + item.water));
            state.mood = Math.min(100, Math.max(0, state.mood + item.mood));
            updateUI(); saveGame(); skipPitstop();
            showToast(`${item.icon} –ö—É–ø–ª–µ–Ω–æ!`, 2000);
        }
        
        function skipPitstop() { document.getElementById('pitstop-overlay').classList.remove('active'); state.currentStop++; setTimeout(autoDrive, 1000); }

        function triggerEvent() {
            const event = ROAD_EVENTS[Math.floor(Math.random() * ROAD_EVENTS.length)];
            document.getElementById('event-icon').textContent = event.icon;
            document.getElementById('event-title').textContent = event.title;
            document.getElementById('event-text').textContent = event.text;
            
            const container = document.getElementById('event-choices');
            container.innerHTML = '';
            event.choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-primary';
                btn.textContent = choice.text;
                btn.onclick = () => handleEventChoice(choice.effect);
                container.appendChild(btn);
            });
            document.getElementById('event-overlay').classList.add('active');
        }
        
        function handleEventChoice(effect) {
            document.getElementById('event-overlay').classList.remove('active');
            if (effect.money) { state.balance += effect.money; showToast(effect.money > 0 ? `+${effect.money}‚ÇΩ` : `${effect.money}‚ÇΩ`, 2000); }
            if (effect.mood) state.mood = Math.max(0, state.mood + effect.mood);
            updateUI(); saveGame();
            setTimeout(autoDrive, 1500);
        }

        function finishDelivery() {
            state.isDelivering = false;
            const bonus = state.currentOrder.bonus || 0;
            const total = state.currentRoute.price + bonus;
            
            state.balance += total;
            state.stats.totalDeliveries++;
            state.stats.totalEarned += total;
            if (bonus > state.stats.bestTip) state.stats.bestTip = bonus;
            
            document.getElementById('delivery-panel').classList.remove('active');
            if (destMarker) map.removeLayer(destMarker);
            pitstopMarkers.forEach(m => map.removeLayer(m));
            pitstopMarkers = [];
            if (routeLine) map.removeLayer(routeLine);
            map.setView(WARSAW_CENTER, 13);
            
            updateUI(); saveGame();
            showToast(`‚úÖ –î–æ—Å—Ç–∞–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! +${total}‚ÇΩ`, 3000);
        }
        
        function failDelivery(reason) {
            state.isDelivering = false;
            document.getElementById('delivery-panel').classList.remove('active');
            if (destMarker) map.removeLayer(destMarker);
            pitstopMarkers.forEach(m => map.removeLayer(m));
            pitstopMarkers = [];
            if (routeLine) map.removeLayer(routeLine);
            map.setView(WARSAW_CENTER, 13);
            showToast('‚ùå ' + reason, 3000);
        }
        
        function cancelDelivery() {
            state.isDelivering = false;
            document.getElementById('delivery-panel').classList.remove('active');
            if (destMarker) map.removeLayer(destMarker);
            pitstopMarkers.forEach(m => map.removeLayer(m));
            pitstopMarkers = [];
            if (routeLine) map.removeLayer(routeLine);
            map.setView(WARSAW_CENTER, 13);
            showToast('–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω—ë–Ω', 2000);
        }

        window.onload = init;
    </script>
</body>
</html>
