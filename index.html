<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warszawa 2077: Canvas Engine</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

        :root {
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-gold: #ffd700;
            --bg-color: #050510;
        }

        body { 
            margin: 0; overflow: hidden; background: var(--bg-color); 
            font-family: 'Orbitron', sans-serif; color: white;
            touch-action: none; /* Отключает зум и скролл */
        }

        /* ХОЛСТ (ГРАФИКА) */
        canvas { display: block; width: 100%; height: 100%; }

        /* ИНТЕРФЕЙС (ПОВЕРХ ХОЛСТА) */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Чтобы клики проходили сквозь UI на канвас (если нужно) */
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
            background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.8) 100%);
        }

        /* CRT ЭФФЕКТ (ПОЛОСКИ) */
        #scanlines {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px;
            pointer-events: none; z-index: 999;
            opacity: 0.6;
        }

        /* ЭЛЕМЕНТЫ UI */
        .hud-top { display: flex; justify-content: space-between; align-items: flex-start; pointer-events: auto; }
        .hud-stat { text-align: right; }
        .val { font-size: 24px; font-weight: 900; text-shadow: 0 0 10px var(--neon-blue); }
        .lbl { font-size: 10px; color: #aaa; letter-spacing: 2px; }

        .bars-container { width: 120px; }
        .bar-row { display: flex; align-items: center; margin-bottom: 4px; }
        .bar-label { font-size: 8px; width: 25px; }
        .bar-track { flex-grow: 1; height: 4px; background: #333; position: relative; }
        .bar-fill { height: 100%; width: 100%; box-shadow: 0 0 5px currentColor; transition: width 0.2s; }

        .hud-bot { pointer-events: auto; text-align: center; padding-bottom: 20px; }
        
        .btn {
            background: rgba(0, 243, 255, 0.1); border: 1px solid var(--neon-blue);
            color: var(--neon-blue); padding: 15px 40px; font-family: 'Orbitron';
            font-size: 16px; text-transform: uppercase; cursor: pointer;
            backdrop-filter: blur(5px); clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            transition: 0.2s; pointer-events: auto;
        }
        .btn:active { background: var(--neon-blue); color: black; transform: scale(0.95); }

        /* ДЖОЙСТИК */
        #controls { display: none; gap: 10px; justify-content: center; pointer-events: auto; }
        .d-btn {
            width: 60px; height: 60px; border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.05); font-size: 24px; backdrop-filter: blur(4px);
        }
        .d-btn:active { background: var(--neon-blue); color: black; border-color: var(--neon-blue); }

        /* МЕНЮ */
        #menu {
            position: fixed; top: 0; left: -100%; width: 80%; height: 100%;
            background: rgba(5, 5, 16, 0.95); z-index: 1000;
            border-right: 1px solid var(--neon-pink);
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 30px; box-shadow: 50px 0 100px rgba(0,0,0,0.8);
            pointer-events: auto;
        }
        #menu.open { left: 0; }
        
        .menu-item {
            padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .menu-btn-s {
            border: 1px solid var(--neon-gold); color: var(--neon-gold);
            background: transparent; padding: 5px 10px; font-family: 'Orbitron'; cursor: pointer;
        }

        #toast {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: var(--neon-gold); font-size: 20px; font-weight: bold;
            text-shadow: 0 0 20px var(--neon-gold); pointer-events: none;
            opacity: 0; transition: opacity 0.5s;
        }
    </style>
</head>
<body>

<div id="scanlines"></div>

<canvas id="gameCanvas"></canvas>

<div id="ui-layer">
    <div class="hud-top">
        <div class="bars-container" onclick="toggleMenu()">
            <div style="font-size:20px; margin-bottom:10px">☰ MENU</div>
            <div class="bar-row"><div class="bar-label" style="color:orange">EN</div><div class="bar-track"><div id="b-en" class="bar-fill" style="background:orange; width:100%"></div></div></div>
            <div class="bar-row"><div class="bar-label" style="color:cyan">H2O</div><div class="bar-track"><div id="b-wat" class="bar-fill" style="background:cyan; width:100%"></div></div></div>
            <div class="bar-row"><div class="bar-label" style="color:red">HP</div><div class="bar-track"><div id="b-hp" class="bar-fill" style="background:red; width:100%"></div></div></div>
        </div>
        <div class="hud-stat">
            <div class="lbl">CREDITS</div>
            <div class="val" id="ui-cash">0.00</div>
            <div class="lbl" style="margin-top:5px">BANK</div>
            <div class="val" style="color:var(--neon-gold); text-shadow:0 0 10px var(--neon-gold)" id="ui-bank">0.00</div>
        </div>
    </div>

    <div id="toast">MISSION COMPLETE</div>

    <div class="hud-bot">
        <div id="status-msg" style="margin-bottom:15px; color:#888; font-size:12px; letter-spacing:1px">SYSTEM READY</div>
        <button id="btn-start" class="btn" onclick="startGame()">INITIATE SEQUENCE</button>
        
        <div id="controls">
            <div style="display:flex; flex-direction:column; align-items:center; gap:5px">
                <div class="d-btn" onclick="input(0, -1)">▲</div>
                <div style="display:flex; gap:60px">
                    <div class="d-btn" onclick="input(-1, 0)">◀</div>
                    <div class="d-btn" onclick="input(1, 0)">▶</div>
                </div>
                <div class="d-btn" onclick="input(0, 1)">▼</div>
            </div>
        </div>
        
        <div id="btn-stop" style="display:none; margin-top:20px; color:red; text-decoration:underline; cursor:pointer; pointer-events:auto" onclick="stopGame()">ABORT MISSION</div>
    </div>
</div>

<div id="menu">
    <h2 style="color:var(--neon-blue)">CYBER SHOP</h2>
    <div style="font-size:10px; color:gray; margin-bottom:20px">ID: <span id="uid-disp">...</span></div>
    
    <div class="menu-item">
        <span>Synthetic Meat (+30 EN)</span>
        <button class="menu-btn-s" onclick="buy('en', 30, 25)">25 CR</button>
    </div>
    <div class="menu-item">
        <span>Pure Water (+40 H2O)</span>
        <button class="menu-btn-s" onclick="buy('wat', 40, 20)">20 CR</button>
    </div>
    <div class="menu-item" style="border-top:1px solid #333; margin-top:20px">
        <span>Repair Drone (100 HP)</span>
        <button class="menu-btn-s" style="border-color:red; color:red" onclick="repair()">50 CR</button>
    </div>
    <div class="menu-item">
        <span>Deposit ALL</span>
        <button class="menu-btn-s" style="border-color:var(--neon-gold); color:var(--neon-gold)" onclick="bankAll()">BANK</button>
    </div>
    <div style="margin-top:20px; font-size:10px; color:#444; text-align:center" onclick="toggleMenu()">CLOSE [X]</div>
</div>

<script>
    // === CONFIG ===
    const TILE_SIZE = 40; // Размер клетки в пикселях
    const GRID_W = 10;    // Ширина сетки (в клетках)
    const GRID_H = 12;    // Высота сетки
    
    // === STATE ===
    let st = { cash: 0, bank: 0, lvl: 1, en: 100, wat: 100, hp: 100 };
    let game = {
        active: false,
        p: {x: 4, y: 10}, // Позиция игрока (в клетках)
        target: null,     // Цель (пицца)
        obs: [],          // Стены
        pol: [],          // Полиция
        particles: [],    // Эффекты
        animId: null,
        lastTime: 0
    };
    
    let dbRef, uid;
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // === SYSTEM INIT ===
    async function init() {
        // Настройка Firebase
        const fbConfig = {
            apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
            authDomain: "warszawa-courier.firebaseapp.com",
            databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "warszawa-courier",
            appId: "1:295860613508:web:86fe8364377d6875612dd1"
        };
        try {
            firebase.initializeApp(fbConfig);
            // ID игрока
            const tg = window.Telegram?.WebApp;
            if (tg) tg.expand();
            uid = tg?.initDataUnsafe?.user?.id ? "tg_"+tg.initDataUnsafe.user.id : (localStorage.getItem('w_uid') || "dev_"+Date.now());
            if(!localStorage.getItem('w_uid')) localStorage.setItem('w_uid', uid);
            document.getElementById('uid-disp').innerText = uid;

            // Загрузка
            dbRef = firebase.database().ref('users/'+uid);
            dbRef.on('value', snap => {
                if(snap.exists()) { st = snap.val(); updateUI(); }
                else save(); 
            });
        } catch(e) { console.log("Offline mode"); st = JSON.parse(localStorage.getItem('w_loc_save')) || st; }

        resize();
        window.addEventListener('resize', resize);
        
        // Запуск рендер-лупа (даже если игра не идет, рисуем фон)
        requestAnimationFrame(renderLoop);
    }

    function save() {
        if(dbRef) dbRef.update(st);
        localStorage.setItem('w_loc_save', JSON.stringify(st));
        updateUI();
    }

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }

    // === GAME LOGIC ===
    function startGame() {
        if(st.en<5 || st.hp<5) return showToast("LOW ENERGY/HP");
        game.active = true;
        
        // Генерация уровня
        game.obs = [];
        for(let i=0; i<8; i++) game.obs.push(getFreePos());
        
        game.pol = [];
        for(let i=0; i<3; i++) game.pol.push({...getFreePos(), dir:1});
        
        spawnTarget();

        // UI
        document.getElementById('btn-start').style.display='none';
        document.getElementById('controls').style.display='flex';
        document.getElementById('btn-stop').style.display='block';
        document.getElementById('status-msg').innerText = "DELIVERY IN PROGRESS";
        
        // AI Timer
        if(game.aiInt) clearInterval(game.aiInt);
        game.aiInt = setInterval(updateAI, 800);
    }

    function stopGame() {
        game.active = false;
        clearInterval(game.aiInt);
        document.getElementById('btn-start').style.display='block';
        document.getElementById('controls').style.display='none';
        document.getElementById('btn-stop').style.display='none';
        document.getElementById('status-msg').innerText = "SYSTEM IDLE";
    }

    function getFreePos() {
        let p;
        do {
            p = {x: Math.floor(Math.random()*GRID_W), y: Math.floor(Math.random()*GRID_H)};
        } while ((p.x==game.p.x && p.y==game.p.y) || game.obs.some(o=>o.x==p.x && o.y==p.y));
        return p;
    }

    function spawnTarget() {
        game.target = getFreePos();
        // Эффект спавна
        for(let i=0; i<10; i++) addParticle(game.target.x, game.target.y, 'gold');
    }

    function input(dx, dy) {
        if(!game.active) return;
        let nx = game.p.x + dx;
        let ny = game.p.y + dy;

        if(nx<0 || ny<0 || nx>=GRID_W || ny>=GRID_H) return; // Границы
        if(game.obs.some(o=>o.x==nx && o.y==ny)) return; // Стены

        game.p.x = nx; game.p.y = ny;
        
        // Ресурсы
        st.en -= 0.5; st.wat -= 0.3; st.hp -= 0.1;
        if(st.en<=0) stopGame();

        // Проверка цели
        if(game.target && nx==game.target.x && ny==game.target.y) {
            let pay = Math.floor(10 + st.lvl*2);
            st.cash += pay;
            st.lvl += 0.1;
            showToast(`+${pay} CR`);
            spawnTarget();
        }

        // Проверка полиции
        checkPol();
        
        // Частицы движения
        addParticle(game.p.x, game.p.y, 'cyan');
        
        save();
    }

    function updateAI() {
        if(!game.active) return;
        game.pol.forEach(p => {
            // Простейший AI: Если игрок близко, идем к нему
            let dx = game.p.x - p.x;
            let dy = game.p.y - p.y;
            let dist = Math.abs(dx) + Math.abs(dy);
            
            let mx=0, my=0;
            if(dist < 4) { // Агро
                if(Math.abs(dx) > Math.abs(dy)) mx = dx>0?1:-1;
                else my = dy>0?1:-1;
            } else { // Патруль
                if(Math.random()>0.5) mx = Math.random()>0.5?1:-1;
                else my = Math.random()>0.5?1:-1;
            }

            let nx = p.x+mx, ny = p.y+my;
            if(nx>=0 && ny>=0 && nx<GRID_W && ny<GRID_H && !game.obs.some(o=>o.x==nx && o.y==ny)) {
                p.x = nx; p.y = ny;
            }
        });
        checkPol();
    }

    function checkPol() {
        game.pol.forEach(p => {
            if(p.x == game.p.x && p.y == game.p.y) {
                st.cash = Math.max(0, st.cash - 50);
                showToast("ARRESTED! -50 CR");
                game.p = {x:4, y:10}; // Респавн
                stopGame();
                save();
            }
        });
    }

    // === GRAPHICS ENGINE (CANVAS) ===
    function renderLoop(time) {
        // Очистка
        ctx.fillStyle = '#050510';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // 1. Рисуем "3D" Сетку на фоне (эффект полета)
        drawRetroGrid(time);

        // Центрируем игровое поле
        let boardW = GRID_W * TILE_SIZE;
        let boardH = GRID_H * TILE_SIZE;
        let offX = (canvas.width - boardW) / 2;
        let offY = (canvas.height - boardH) / 2 + 50; // Чуть ниже центра

        // Рисуем рамку поля
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
        ctx.lineWidth = 2;
        ctx.strokeRect(offX, offY, boardW, boardH);

        // 2. Рисуем игру
        if(game.active) {
            // Стены
            ctx.fillStyle = '#222';
            ctx.shadowBlur = 0;
            game.obs.forEach(o => {
                ctx.fillRect(offX + o.x*TILE_SIZE + 2, offY + o.y*TILE_SIZE + 2, TILE_SIZE-4, TILE_SIZE-4);
                // Детали стен
                ctx.fillStyle = '#444';
                ctx.fillRect(offX + o.x*TILE_SIZE + 5, offY + o.y*TILE_SIZE + 5, 5, 5);
                ctx.fillStyle = '#222';
            });

            // Цель (Пицца) - Пульсация
            if(game.target) {
                let pulse = 1 + Math.sin(time/200)*0.2;
                let tx = offX + game.target.x*TILE_SIZE + TILE_SIZE/2;
                let ty = offY + game.target.y*TILE_SIZE + TILE_SIZE/2;
                
                ctx.fillStyle = '#ffd700';
                ctx.shadowColor = '#ffd700';
                ctx.shadowBlur = 20;
                ctx.beginPath();
                ctx.arc(tx, ty, 8*pulse, 0, Math.PI*2);
                ctx.fill();
                ctx.shadowBlur = 0;
            }

            // Полиция
            ctx.fillStyle = '#ff0055';
            game.pol.forEach(p => {
                let px = offX + p.x*TILE_SIZE + 5;
                let py = offY + p.y*TILE_SIZE + 5;
                ctx.fillRect(px, py, TILE_SIZE-10, TILE_SIZE-10);
                // Мигалка
                if(Math.floor(time/200)%2==0) {
                    ctx.fillStyle = 'blue';
                    ctx.fillRect(px, py, 10, 5);
                    ctx.fillStyle = '#ff0055';
                }
            });

            // Игрок (Курьер)
            let px = offX + game.p.x*TILE_SIZE + TILE_SIZE/2;
            let py = offY + game.p.y*TILE_SIZE + TILE_SIZE/2;
            
            // Тень/Свечение игрока
            ctx.shadowColor = '#00f3ff';
            ctx.shadowBlur = 15;
            ctx.fillStyle = '#00f3ff';
            
            // Футуристичный треугольник
            ctx.beginPath();
            ctx.moveTo(px, py - 10);
            ctx.lineTo(px + 10, py + 10);
            ctx.lineTo(px - 10, py + 10);
            ctx.closePath();
            ctx.fill();
            ctx.shadowBlur = 0;
        }

        // 3. Частицы (Particles System)
        updateAndDrawParticles(offX, offY);

        requestAnimationFrame(renderLoop);
    }

    function drawRetroGrid(time) {
        ctx.strokeStyle = 'rgba(255, 0, 255, 0.2)'; // Neon pink
        ctx.lineWidth = 1;
        
        let speed = (time * 0.05) % 40;
        
        // Горизонтальные линии (движутся вниз)
        for(let i=0; i<canvas.height; i+=40) {
            let y = i + speed;
            if(y > canvas.height) y -= canvas.height;
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(canvas.width, y);
            ctx.stroke();
        }
        
        // Вертикальные линии (перспектива)
        let cx = canvas.width / 2;
        for(let i=-canvas.width; i<canvas.width*2; i+=60) {
            ctx.beginPath();
            // Слегка наклоняем линии к центру, создавая перспективу
            ctx.moveTo(i + (i-cx)*0.5, 0); 
            ctx.lineTo(i, canvas.height);
            ctx.stroke();
        }
    }

    function addParticle(gx, gy, color) {
        game.particles.push({
            x: gx, y: gy, 
            life: 1.0, 
            color: color, 
            dx: (Math.random()-0.5)*0.1, 
            dy: (Math.random()-0.5)*0.1
        });
    }

    function updateAndDrawParticles(offX, offY) {
        for(let i=game.particles.length-1; i>=0; i--) {
            let p = game.particles[i];
            p.life -= 0.05;
            p.x += p.dx; p.y += p.dy;
            
            if(p.life <= 0) {
                game.particles.splice(i, 1);
                continue;
            }
            
            let px = offX + p.x*TILE_SIZE + TILE_SIZE/2;
            let py = offY + p.y*TILE_SIZE + TILE_SIZE/2;
            
            ctx.fillStyle = p.color == 'gold' ? `rgba(255, 215, 0, ${p.life})` : `rgba(0, 243, 255, ${p.life})`;
            ctx.beginPath();
            ctx.arc(px, py, 5*p.life, 0, Math.PI*2);
            ctx.fill();
        }
    }

    // === UI HELPERS ===
    function updateUI() {
        document.getElementById('ui-cash').innerText = st.cash.toFixed(2);
        document.getElementById('ui-bank').innerText = st.bank.toFixed(2);
        document.getElementById('b-en').style.width = st.en+'%';
        document.getElementById('b-wat').style.width = st.wat+'%';
        document.getElementById('b-hp').style.width = st.hp+'%';
    }

    function showToast(m) {
        let t = document.getElementById('toast');
        t.innerText = m;
        t.style.opacity = 1;
        t.style.top = "40%";
        setTimeout(() => {
            t.style.opacity = 0;
            t.style.top = "50%";
        }, 1500);
    }

    function buy(type, val, cost) {
        if(st.cash >= cost) {
            st.cash -= cost;
            if(type=='en') st.en = Math.min(100, st.en+val);
            if(type=='wat') st.wat = Math.min(100, st.wat+val);
            updateUI(); save();
        } else showToast("NO CREDITS");
    }

    function bankAll() {
        if(st.cash>0) { st.bank+=st.cash; st.cash=0; updateUI(); save(); }
    }

    function repair() {
        if(st.cash>=50) { st.cash-=50; st.hp=100; updateUI(); save(); }
        else showToast("NO CREDITS");
    }

    function toggleMenu() {
        document.getElementById('menu').classList.toggle('open');
    }

    // Start
    init();

</script>
</body>
</html>
