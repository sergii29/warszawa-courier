<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warszawa Courier: TITANIUM</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #050505;
            --panel: rgba(20, 20, 25, 0.95);
            --border: rgba(255, 215, 0, 0.15); /* Gold tint */
            --accent: #FFD700; /* Gold */
            --danger: #FF0040;
            --text: #EAEAEA;
            --grid: rgba(255, 255, 255, 0.03);
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; font-family: 'Segoe UI', monospace; font-weight: 600; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); color: var(--text); }

        /* –ò–ù–¢–ï–†–§–ï–ô–° - –í–ï–†–• */
        #top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 120px;
            background: linear-gradient(180deg, var(--panel) 0%, rgba(0,0,0,0) 100%);
            z-index: 10; padding: 15px 20px;
            display: flex; flex-direction: column; gap: 10px;
        }

        .stats-row { display: flex; justify-content: space-between; align-items: flex-end; }
        .money-block { display: flex; flex-direction: column; }
        .label { font-size: 10px; color: #888; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 2px; }
        .val { font-size: 26px; color: var(--text); text-shadow: 0 2px 10px rgba(255,255,255,0.1); }
        .val.gold { color: var(--accent); text-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }

        /* –ü–û–õ–û–°–ö–ò –†–ï–°–£–†–°–û–í */
        .bars { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 5px; }
        .bar-wrap { background: #222; height: 6px; border-radius: 3px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; width: 100%; transition: width 0.3s ease; }
        
        /* –ò–ì–†–û–í–û–ï –ü–û–õ–ï */
        #game-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(var(--grid) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: 1;
        }

        /* –û–ë–™–ï–ö–¢–´ */
        .entity { 
            position: absolute; width: 36px; height: 36px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 20px; transition: top 0.15s, left 0.15s;
            z-index: 5;
        }
        
        #player { 
            background: var(--accent); border-radius: 50%; color: #000; 
            box-shadow: 0 0 20px var(--accent); z-index: 20; 
            font-size: 22px;
        }
        
        .obs { 
            background: #1a1a1a; border: 1px solid #444; border-radius: 6px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 2;
        }
        
        .police { 
            font-size: 24px; z-index: 15; 
            filter: drop-shadow(0 0 5px var(--danger));
            transition: top 0.6s linear, left 0.6s linear; /* –ü–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –∫–æ–ø–æ–≤ */
        }
        
        .target { 
            animation: pulse 1s infinite; z-index: 10;
            filter: drop-shadow(0 0 10px var(--accent));
        }

        @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.2);} 100%{transform:scale(1);} }
        @keyframes flash { 0%{opacity:0;} 50%{opacity:0.5;} 100%{opacity:0;} }
        
        #siren-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: radial-gradient(circle, transparent 50%, rgba(255, 0, 64, 0.4) 100%);
            z-index: 90; display: none; pointer-events: none;
            animation: flash 0.8s infinite;
        }

        /* –ù–ò–ñ–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ */
        #bot-bar {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 240px;
            background: linear-gradient(0deg, #0f0f12 0%, rgba(15,15,18,0.95) 100%);
            border-top: 1px solid var(--border);
            z-index: 100; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
        }

        #status-txt { color: #888; font-size: 13px; margin-bottom: 15px; width:100%; text-align:center; }

        .btn-big {
            background: var(--accent); color: #000; border: none;
            padding: 15px 40px; border-radius: 12px; font-size: 16px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.2);
            width: 80%;
        }

        /* –î–ñ–û–ô–°–¢–ò–ö */
        .controls { display: grid; grid-template-columns: 70px 70px 70px; gap: 5px; display: none; margin-top: 10px; }
        .c-btn {
            width: 70px; height: 60px; background: #1e1e24; border: 1px solid #333;
            border-radius: 10px; display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: #555; active: scale(0.95);
        }
        .c-btn:active { background: var(--accent); color: #000; }
        
        /* –ú–ï–ù–Æ */
        #menu-btn { 
            position: absolute; top: 130px; left: 20px; z-index: 200; 
            width: 40px; height: 40px; background: rgba(0,0,0,0.5); 
            border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;
            display: flex; align-items: center; justify-content: center; font-size: 20px;
        }

        #sidebar {
            position: fixed; top:0; left:-100%; width: 85%; height:100%;
            background: #0a0a0c; z-index: 1000; padding: 30px;
            transition: 0.3s ease; border-right: 1px solid #333;
        }
        #sidebar.active { left: 0; }
        
        .shop-item {
            background: #141417; padding: 15px; border-radius: 10px;
            margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #222;
        }
        .price-tag { color: var(--accent); font-weight: bold; }

        #save-indicator {
            position: fixed; top: 135px; right: 20px; z-index: 200;
            font-size: 10px; color: #00ff88; opacity: 0; transition: opacity 0.5s;
            background: rgba(0,0,0,0.7); padding: 4px 8px; border-radius: 4px;
        }

    </style>
</head>
<body>

<div id="save-indicator">üíæ SAVED</div>
<div id="siren-overlay"></div>

<div id="top-bar">
    <div class="stats-row">
        <div class="money-block">
            <span class="label">–ù–∞–ª–∏—á–Ω—ã–µ</span>
            <span class="val" id="ui-cash">0.00</span>
        </div>
        <div class="money-block" style="text-align: right;">
            <span class="label">–ë–∞–Ω–∫ PKO</span>
            <span class="val gold" id="ui-bank">0.00</span>
        </div>
    </div>
    <div class="bars">
        <div class="bar-wrap"><div id="bar-en" class="bar-fill" style="background:#FFA500; width:100%"></div></div>
        <div class="bar-wrap"><div id="bar-wat" class="bar-fill" style="background:#00BFFF; width:100%"></div></div>
        <div class="bar-wrap"><div id="bar-hp" class="bar-fill" style="background:#FF0040; width:100%"></div></div>
    </div>
</div>

<div id="game-view">
    <div id="player" class="entity">üö≤</div>
</div>

<div id="menu-btn" onclick="toggleMenu()">‚ò∞</div>

<div id="sidebar">
    <h2 style="color:white; margin-top:0">W. COURIER <span style="color:var(--accent)">PREMIUM</span></h2>
    <div style="font-size:10px; color:gray; margin-bottom:20px">ID: <span id="user-id-display">...</span></div>
    
    <div style="color:#666; font-size:12px; margin-bottom:10px">–ú–ê–ì–ê–ó–ò–ù</div>
    <div id="shop-container"></div>
    
    <div style="margin-top:40px; border-top:1px solid #333; padding-top:20px">
        <div class="shop-item" onclick="bankAll()">
            <span>–ü–æ–ª–æ–∂–∏—Ç—å –≤—Å—ë –≤ –±–∞–Ω–∫</span>
            <span class="price-tag">BANK</span>
        </div>
        <div class="shop-item" onclick="repair()">
            <span>–†–µ–º–æ–Ω—Ç –±–∞–π–∫–∞</span>
            <span class="price-tag" id="repair-cost">50 PLN</span>
        </div>
    </div>
</div>
<div id="overlay" onclick="toggleMenu()" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:900; display:none;"></div>

<div id="bot-bar">
    <div id="status-txt">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
    
    <button id="btn-start" class="btn-big" onclick="startShift()">–ù–ê–ß–ê–¢–¨ –°–ú–ï–ù–£</button>
    
    <div id="joy" class="controls">
        <div style="grid-column:2" class="c-btn" onclick="move(0, -1)">‚ñ≤</div>
        <div style="grid-column:1; grid-row:2" class="c-btn" onclick="move(-1, 0)">‚óÄ</div>
        <div style="grid-column:2; grid-row:2" class="c-btn" onclick="move(0, 1)">‚ñº</div>
        <div style="grid-column:3; grid-row:2" class="c-btn" onclick="move(1, 0)">‚ñ∂</div>
    </div>
    <div id="btn-stop" style="display:none; color:var(--danger); margin-top:15px; text-decoration:underline" onclick="endShift()">–ó–∞–∫–æ–Ω—á–∏—Ç—å —Å–º–µ–Ω—É</div>
</div>

<script>
    // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
    const STEP = 40; // –†–∞–∑–º–µ—Ä –∫–ª–µ—Ç–∫–∏ (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å —Å–µ—Ç–∫–æ–π css)
    const DB_VER = "titan_v1";

    // --- FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
        authDomain: "warszawa-courier.firebaseapp.com",
        databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "warszawa-courier",
        storageBucket: "warszawa-courier.firebasestorage.app",
        messagingSenderId: "295860613508",
        appId: "1:295860613508:web:86fe8364377d6875612dd1"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø (–ö–†–ò–¢–ò–ß–ù–û) ---
    // –ï—Å–ª–∏ –º—ã –≤ Telegram, –±–µ—Ä–µ–º ID –æ—Ç—Ç—É–¥–∞. –ï—Å–ª–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ ‚Äî –±–µ—Ä–µ–º "TEST_USER_01".
    // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫–µ—à–∞ –¥–∞–Ω–Ω—ã–µ –ù–ï –ø—Ä–æ–ø–∞–¥—É—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ.
    const tg = window.Telegram.WebApp; 
    tg.expand();

    let uid;
    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
        uid = "tg_" + tg.initDataUnsafe.user.id;
    } else {
        // –ñ–ï–°–¢–ö–ò–ô ID –î–õ–Ø –¢–ï–°–¢–û–í. –ò–∑–º–µ–Ω–∏ —Ü–∏—Ñ—Ä—É, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –Ω–∞—á–∞—Ç—å —Å –Ω—É–ª—è.
        uid = "TEST_USER_01"; 
        console.log("Browser Mode: Using Fixed ID to prevent data loss");
    }
    document.getElementById('user-id-display').innerText = uid;

    // --- STATE ---
    let data = {
        cash: 0, bank: 0, lvl: 1, 
        en: 100, wat: 100, hp: 100,
        x: 40, y: 120 // Start pos
    };
    
    let game = {
        active: false,
        w: 0, h: 0,
        obs: [], // –°—Ç–µ–Ω—ã
        pol: [], // –ü–æ–ª–∏—Ü–∏—è
        job: null // –¢–µ–∫—É—â–∏–π –∑–∞–∫–∞–∑
    };
    
    let timerInt, polInt;

    // --- INIT & SAVE ---
    function init() {
        const ref = db.ref('players/' + uid);
        ref.once('value', (snap) => {
            const val = snap.val();
            if (val) {
                data = val; // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ
                updateUI();
                showSave("Data Loaded");
            } else {
                save(); // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ
            }
        });
        
        // Resize listener
        updateDim();
        window.addEventListener('resize', updateDim);
    }
    
    function save() {
        db.ref('players/' + uid).set(data).then(() => {
            const ind = document.getElementById('save-indicator');
            ind.style.opacity = 1;
            setTimeout(() => ind.style.opacity = 0, 1000);
        });
    }
    
    function showSave(msg) { console.log(msg); }

    function updateDim() {
        const el = document.getElementById('game-view');
        game.w = el.offsetWidth;
        game.h = el.offsetHeight;
    }

    // --- –ì–ï–ô–ú–ü–õ–ï–ô ---
    function startShift() {
        if(data.en < 10 || data.hp < 10) { alert("–ù—É–∂–Ω–æ –ø–æ–µ—Å—Ç—å –∏–ª–∏ –ø–æ—á–∏–Ω–∏—Ç—å –±–∞–π–∫!"); return; }
        
        game.active = true;
        document.getElementById('btn-start').style.display = 'none';
        document.getElementById('joy').style.display = 'grid';
        document.getElementById('btn-stop').style.display = 'block';
        
        spawnLevel();
        nextJob();
        
        polInt = setInterval(policeLogic, 800); // AI —Ç–∏–∫
    }
    
    function endShift() {
        game.active = false;
        clearInterval(polInt);
        clearMap();
        
        document.getElementById('btn-start').style.display = 'block';
        document.getElementById('joy').style.display = 'none';
        document.getElementById('btn-stop').style.display = 'none';
        document.getElementById('status-txt').innerText = "–°–º–µ–Ω–∞ –æ–∫–æ–Ω—á–µ–Ω–∞";
        document.getElementById('siren-overlay').style.display = 'none';
    }

    // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –£–†–û–í–ù–Ø (–ê–ù–¢–ò-–°–¢–ï–ù–ê) ---
    function spawnLevel() {
        clearMap();
        
        // 1. –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É
        const cols = Math.floor(game.w / STEP);
        const rows = Math.floor(game.h / STEP);
        
        // 2. –°—Ç–∞–≤–∏–º —Å—Ç–µ–Ω—ã (15 —à—Ç—É–∫)
        for(let i=0; i<15; i++) {
            let pos = getSafePos(cols, rows, false);
            if(pos) {
                createEl('div', 'entity obs', pos.x, pos.y, '');
                game.obs.push(pos);
            }
        }
        
        // 3. –°—Ç–∞–≤–∏–º –ø–æ–ª–∏—Ü–∏—é (3 —à—Ç—É–∫–∏)
        for(let i=0; i<3; i++) {
            let pos = getSafePos(cols, rows, true);
            if(pos) {
                let el = createEl('div', 'entity police', pos.x, pos.y, 'üöì');
                game.pol.push({ x: pos.x, y: pos.y, el: el });
            }
        }
        
        // –†–µ–Ω–¥–µ—Ä –∏–≥—Ä–æ–∫–∞
        renderPlayer();
    }

    // --- –£–ú–ù–´–ô –ü–û–ò–°–ö –ú–ï–°–¢–ê ---
    function getSafePos(cols, rows, checkWalls) {
        let limit = 100;
        while(limit-- > 0) {
            let x = Math.floor(Math.random() * (cols-1)) * STEP;
            let y = Math.floor(Math.random() * (rows-1)) * STEP;
            
            // –ù–µ —Å–ø–∞–≤–Ω–∏—Ç—å –Ω–∞ –∏–≥—Ä–æ–∫–µ
            if(dist(x,y, data.x, data.y) < STEP*3) continue;
            
            // –ï—Å–ª–∏ –Ω–∞–¥–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–µ–Ω—ã
            if(checkWalls) {
                if(isWall(x, y)) continue;
            } else {
                // –ï—Å–ª–∏ –º—ã —Å–∞–º–∏ —Å—Ç–µ–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ–±—ã –Ω–µ –Ω–∞–ª–æ–∂–∏—Ç—å—Å—è –Ω–∞ –¥—Ä—É–≥—É—é
                if(game.obs.some(o => o.x === x && o.y === y)) continue;
            }
            
            return {x, y};
        }
        return null;
    }

    function isWall(x, y) {
        return game.obs.some(o => dist(o.x, o.y, x, y) < 10); // <10 –∑–Ω–∞—á–∏—Ç –ø–æ—á—Ç–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
    }

    // --- –î–í–ò–ñ–ï–ù–ò–ï –ò–ì–†–û–ö–ê ---
    function move(dx, dy) {
        if(!game.active) return;
        
        let nx = data.x + (dx * STEP);
        let ny = data.y + (dy * STEP);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü
        if(nx < 0 || ny < 0 || nx > game.w - STEP || ny > game.h - STEP) return;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–µ–Ω
        if(isWall(nx, ny)) {
            // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç —É–¥–∞—Ä–∞?
            return; 
        }
        
        data.x = nx; 
        data.y = ny;
        
        // –¢—Ä–∞—Ç—ã
        data.en -= 0.5; data.wat -= 0.3; data.hp -= 0.1;
        if(data.en <=0 || data.wat <=0) endShift();
        
        renderPlayer();
        checkJob();
        checkPoliceCollision();
        updateUI();
        save(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—ã–π —à–∞–≥ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
    }

    // --- –õ–û–ì–ò–ö–ê –ü–û–õ–ò–¶–ò–ò (AI) ---
    function policeLogic() {
        game.pol.forEach(p => {
            let d = dist(data.x, data.y, p.x, p.y);
            let moveX = 0, moveY = 0;
            
            // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –±–ª–∏–∑–∫–æ (150px) - –∏–¥–µ–º –∫ –Ω–µ–º—É
            if(d < 150) {
                if(p.x < data.x) moveX = STEP;
                else if(p.x > data.x) moveX = -STEP;
                
                if(p.y < data.y) moveY = STEP;
                else if(p.y > data.y) moveY = -STEP;
                
                // –ß—Ç–æ–±—ã –Ω–µ —Ö–æ–¥–∏—Ç—å –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏, –≤—ã–±–∏—Ä–∞–µ–º –æ–¥–Ω—É –æ—Å—å
                if(Math.random() > 0.5 && moveX !== 0) moveY = 0;
                else if(moveY !== 0) moveX = 0;
            } else {
                // –ò–Ω–∞—á–µ —Ä–∞–Ω–¥–æ–º
                let r = Math.floor(Math.random()*4);
                if(r===0) moveX=STEP; if(r===1) moveX=-STEP;
                if(r===2) moveY=STEP; if(r===3) moveY=-STEP;
            }
            
            let nx = p.x + moveX;
            let ny = p.y + moveY;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, –º–æ–∂–µ—Ç –ª–∏ –∫–æ–ø —Ç—É–¥–∞ –ø–æ–π—Ç–∏ (–≥—Ä–∞–Ω–∏—Ü—ã –∏ —Å—Ç–µ–Ω—ã)
            if(nx >= 0 && ny >= 0 && nx < game.w && ny < game.h && !isWall(nx, ny)) {
                p.x = nx; p.y = ny;
                p.el.style.left = nx + 'px';
                p.el.style.top = ny + 'px';
            }
        });
        
        checkPoliceCollision();
    }
    
    function checkPoliceCollision() {
        let alarm = false;
        game.pol.forEach(p => {
            let d = dist(data.x, data.y, p.x, p.y);
            if(d < STEP/2) { // –ü–æ–π–º–∞–ª!
                arrest();
            }
            if(d < STEP*3) alarm = true;
        });
        
        document.getElementById('siren-overlay').style.display = alarm ? 'block' : 'none';
    }
    
    function arrest() {
        alert("–í–ê–° –ê–†–ï–°–¢–û–í–ê–õ–ò! –®—Ç—Ä–∞—Ñ 100 PLN.");
        data.cash -= 100;
        data.x = 40; data.y = 120; // –†–µ—Å–ø–∞–≤–Ω
        renderPlayer();
        endShift();
        updateUI();
        save();
    }

    // --- –ó–ê–ö–ê–ó–´ ---
    function nextJob() {
        if(!game.active) return;
        
        const cols = Math.floor(game.w / STEP);
        const rows = Math.floor(game.h / STEP);
        
        let pos = getSafePos(cols, rows, true);
        if(!pos) pos = {x:0, y:0};
        
        // –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ –ø–∏—Ü—Ü—É
        let el = createEl('div', 'entity target', pos.x, pos.y, 'üçï');
        
        game.job = { x: pos.x, y: pos.y, el: el, pay: (10 + data.lvl*2) };
        document.getElementById('status-txt').innerText = "–ó–ê–ë–ï–†–ò –ó–ê–ö–ê–ó";
    }
    
    function checkJob() {
        if(!game.job) return;
        if(dist(data.x, data.y, game.job.x, game.job.y) < 15) {
            // –í–∑—è–ª –∑–∞–∫–∞–∑
            game.job.el.remove();
            
            // –ù–∞–≥—Ä–∞–¥–∞
            data.cash += game.job.pay;
            data.lvl += 0.1;
            
            alert(`–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ! +${game.job.pay} PLN`);
            
            game.job = null;
            updateUI();
            save();
            
            setTimeout(nextJob, 1000);
        }
    }

    // --- –£–¢–ò–õ–ò–¢–´ ---
    function createEl(tag, cls, x, y, txt) {
        let d = document.createElement(tag);
        d.className = cls;
        d.style.left = x + 'px'; d.style.top = y + 'px';
        d.innerText = txt;
        document.getElementById('game-view').appendChild(d);
        return d;
    }
    
    function clearMap() {
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫—Ä–æ–º–µ –∏–≥—Ä–æ–∫–∞
        const area = document.getElementById('game-view');
        while(area.firstChild) {
            if(area.firstChild.id === 'player') { 
                // –ò–≥—Ä–æ–∫–∞ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º, –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ–º –µ—Å–ª–∏ –Ω–∞–¥–æ, –Ω–æ –ª—É—á—à–µ –æ—Å—Ç–∞–≤–∏—Ç—å –≤ DOM
                break; 
            } 
            area.removeChild(area.firstChild);
        }
        // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –±—ã–ª –ø–µ—Ä–≤—ã–º, —É–¥–∞–ª–∏–ª–∏ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ?
        // –ü—Ä–æ—â–µ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å
        area.innerHTML = '<div id="player" class="entity">üö≤</div>';
        game.obs = []; game.pol = []; game.job = null;
    }
    
    function renderPlayer() {
        const p = document.getElementById('player');
        p.style.left = data.x + 'px'; p.style.top = data.y + 'px';
    }
    
    function dist(x1,y1,x2,y2) { return Math.abs(x1-x2) + Math.abs(y1-y2); }
    
    function updateUI() {
        document.getElementById('ui-cash').innerText = data.cash.toFixed(2);
        document.getElementById('ui-bank').innerText = data.bank.toFixed(2);
        
        document.getElementById('bar-en').style.width = data.en + '%';
        document.getElementById('bar-wat').style.width = data.wat + '%';
        document.getElementById('bar-hp').style.width = data.hp + '%';
        
        // –ú–∞–≥–∞–∑–∏–Ω
        const pMod = 1 + (data.lvl * 0.1);
        const pFood = Math.ceil(15 * pMod);
        const pWater = Math.ceil(10 * pMod);
        
        document.getElementById('shop-container').innerHTML = `
            <div class="shop-item" onclick="buy('en', 30, ${pFood})">
                <span>–•–æ—Ç-–¥–æ–≥ (+30 EN)</span>
                <span class="price-tag">${pFood} PLN</span>
            </div>
            <div class="shop-item" onclick="buy('wat', 40, ${pWater})">
                <span>–í–æ–¥–∞ (+40 WAT)</span>
                <span class="price-tag">${pWater} PLN</span>
            </div>
        `;
        document.getElementById('repair-cost').innerText = Math.ceil(50 * pMod) + " PLN";
    }
    
    function buy(type, val, cost) {
        if(data.cash >= cost) {
            data.cash -= cost;
            if(type === 'en') data.en = Math.min(100, data.en + val);
            if(type === 'wat') data.wat = Math.min(100, data.wat + val);
            updateUI(); save();
        } else alert("–ù–µ—Ç –¥–µ–Ω–µ–≥!");
    }
    
    function bankAll() {
        if(data.cash > 0) {
            data.bank += data.cash;
            data.cash = 0;
            updateUI(); save();
        }
    }
    
    function repair() {
        let cost = parseInt(document.getElementById('repair-cost').innerText);
        if(data.cash >= cost) {
            data.cash -= cost;
            data.hp = 100;
            updateUI(); save();
        } else alert("–ú–∞–ª–æ –¥–µ–Ω–µ–≥");
    }
    
    function toggleMenu() {
        const sb = document.getElementById('sidebar');
        const ov = document.getElementById('overlay');
        if(sb.classList.contains('active')) {
            sb.classList.remove('active'); ov.style.display = 'none';
        } else {
            sb.classList.add('active'); ov.style.display = 'block'; updateUI();
        }
    }

    // –ó–∞–ø—É—Å–∫
    init();

</script>
</body>
</html>
