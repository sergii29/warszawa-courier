<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warsaw Courier: Forever</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root {
            --bg: #f9f9e8;
            --grid: #e2e2ca;
            --lime: #c8ff00;
            --dark: #1a1a1a;
            --blue: #0044ff;
            --red: #ff3333;
            --glass: rgba(255, 255, 255, 0.98);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: 'Arial', sans-serif; }

        /* --- UI TOP --- */
        #top-info {
            height: 130px; background: var(--bg);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-bottom: 2px solid var(--grid);
            position: relative; z-index: 100;
        }
        .warsaw-text { font-size: 11px; font-weight: 900; letter-spacing: 3px; color: #999; text-transform: uppercase; margin-bottom: 5px; }
        .balance-pill { 
            background: white; padding: 8px 30px; border-radius: 50px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); font-size: 1.8rem; font-weight: 800; color: var(--dark);
            border: 1px solid #eee; margin-bottom: 5px;
        }

        /* Stats Bars */
        .stats-container { width: 90%; display: flex; justify-content: space-between; margin-top: 5px; }
        .stat-box { display: flex; align-items: center; gap: 5px; font-size: 11px; font-weight: bold; width: 48%; }
        .bar-bg { flex-grow: 1; height: 6px; background: #ddd; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; width: 100%; transition: width 0.3s; }
        #energy-bar { background: orange; }
        #water-bar { background: #00aaff; }
        #bike-hp-bar { background: #555; } /* –°–æ—Å—Ç–æ—è–Ω–∏–µ –±–∞–π–∫–∞ */

        /* --- MENU BTN --- */
        #menu-btn {
            position: absolute; top: 15px; right: 15px;
            width: 45px; height: 45px; background: white; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer;
            z-index: 101; border: 1px solid #eee;
        }

        /* --- GAME FIELD --- */
        #game-container {
            position: relative; width: 100%; height: calc(100vh - 400px);
            background-color: var(--bg);
            background-image: linear-gradient(var(--grid) 1px, transparent 1px), linear-gradient(90deg, var(--grid) 1px, transparent 1px);
            background-size: 30px 30px; overflow: hidden;
        }

        .entity { 
            position: absolute; width: 30px; height: 30px; 
            display: flex; align-items: center; justify-content: center; 
            z-index: 10; font-size: 18px; 
            transition: left 0.15s linear, top 0.15s linear; 
        }
        #player { background: var(--lime); border: 2px solid var(--dark); border-radius: 50%; z-index: 20; font-size: 16px; }
        .police { font-size: 20px; z-index: 18; transition: left 0.5s ease, top 0.5s ease; }
        .obs { font-size: 16px; opacity: 0.7; z-index: 5; }

        /* --- UI BOTTOM --- */
        #ui-bottom { 
            height: 270px; background: white; 
            display: flex; flex-direction: column; align-items: center; padding-top: 10px; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 100; position: relative;
        }
        #status-bar { 
            height: 25px; font-weight: bold; color: #555; font-size: 12px; 
            display: flex; align-items: center; justify-content: center; text-align: center; width: 100%;
        }

        .joy-grid { display: grid; grid-template-columns: repeat(3, 70px); grid-template-rows: repeat(2, 65px); gap: 8px; margin-top: 10px; }
        .btn-move { background: #f4f4f4; border: none; border-radius: 15px; font-size: 24px; color: var(--dark); box-shadow: 0 4px 0 #ddd; cursor: pointer; }
        .btn-move:active { background: var(--lime); box-shadow: none; transform: translateY(4px); }
        .up { grid-column: 2; }
        .left { grid-column: 1; grid-row: 2; }
        .down { grid-column: 2; grid-row: 2; }
        .right { grid-column: 3; grid-row: 2; }

        #btn-online {
            width: 85%; background: var(--lime); border: none; padding: 20px;
            border-radius: 15px; font-size: 1.2rem; font-weight: 800; cursor: pointer;
            box-shadow: 0 4px 0 #a2ce00; color: var(--dark);
        }

        /* --- MENU OVERLAY (ADVANCED) --- */
        #menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 200; display: none;
            align-items: flex-end; justify-content: center;
        }
        #menu-box {
            width: 100%; height: 85%; background: #fff; border-radius: 25px 25px 0 0;
            padding: 20px; box-shadow: 0 -5px 40px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .menu-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .menu-title { font-size: 22px; font-weight: 900; }
        .close-btn { font-size: 24px; cursor: pointer; padding: 5px; }

        .menu-tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab { 
            padding: 8px 16px; background: #f0f0f0; border-radius: 20px; font-size: 13px; font-weight: bold; 
            white-space: nowrap; cursor: pointer; border: 1px solid transparent;
        }
        .tab.active { background: var(--dark); color: white; }

        .menu-content { flex-grow: 1; overflow-y: auto; padding-bottom: 20px; }
        
        .shop-item {
            display: flex; align-items: center; justify-content: space-between;
            background: #f9f9f9; padding: 15px; border-radius: 15px; margin-bottom: 10px; border: 1px solid #eee;
        }
        .shop-icon { font-size: 30px; margin-right: 15px; }
        .shop-info { flex-grow: 1; text-align: left; }
        .shop-name { font-weight: bold; font-size: 14px; }
        .shop-desc { font-size: 11px; color: #777; margin-top: 2px; }
        .shop-btn {
            background: var(--lime); border: none; padding: 8px 15px; border-radius: 10px;
            font-weight: bold; cursor: pointer; font-size: 12px;
        }
        .shop-btn.disabled { background: #ddd; color: #999; }

        /* Toast */
        .toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85); color: white; padding: 15px 25px;
            border-radius: 30px; font-weight: bold; z-index: 300;
            display: none; text-align: center; font-size: 14px;
        }
        .toast.red { background: rgba(220, 20, 20, 0.9); }
    </style>
</head>
<body>

<div id="menu-btn" onclick="openMenu()">üì±</div>

<div id="menu-overlay">
    <div id="menu-box">
        <div class="menu-header">
            <div class="menu-title">Warsaw OS</div>
            <div class="close-btn" onclick="closeMenu()">‚úï</div>
        </div>
        
        <div class="menu-tabs">
            <div class="tab active" onclick="switchTab('shop')">üçî –ú–∞–≥–∞–∑–∏–Ω</div>
            <div class="tab" onclick="switchTab('vehicles')">üö≤ –í–µ–ª–æ-–°–∞–ª–æ–Ω</div>
            <div class="tab" onclick="switchTab('garage')">üîß –ì–∞—Ä–∞–∂</div>
            <div class="tab" onclick="switchTab('bank')">üè¶ –ë–∞–Ω–∫</div>
        </div>

        <div id="tab-content" class="menu-content">
            </div>
        <div style="font-size: 10px; color: #ccc; text-align: center; margin-top: 10px;">ID: <span id="user-id-display">...</span></div>
    </div>
</div>

<div id="toast" class="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>

<div id="top-info">
    <div class="warsaw-text">Warsaw Courier</div>
    <div class="balance-pill"><span id="cash">0.00</span> PLN</div>
    
    <div class="stats-container">
        <div class="stat-box">‚ö° <div class="bar-bg"><div id="energy-bar" class="bar-fill"></div></div></div>
        <div class="stat-box">üíß <div class="bar-bg"><div id="water-bar" class="bar-fill"></div></div></div>
    </div>
    <div class="stats-container" style="margin-top:2px;">
         <div class="stat-box" style="width:100%">üîß –ë–∞–π–∫ <div class="bar-bg"><div id="bike-hp-bar" class="bar-fill" style="width:100%"></div></div></div>
    </div>
</div>

<div id="game-container">
    <div id="player" class="entity">üö≤</div>
    <div id="target" class="entity" style="display:none"></div>
</div>

<div id="ui-bottom">
    <div id="status-bar">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ?</div>
    <button id="btn-online" onclick="goOnline()">–í–´–ô–¢–ò –í –û–ù–õ–ê–ô–ù</button>
    
    <div class="joy-grid" id="controls" style="display: none;">
        <button class="btn-move up" onclick="move(0, -30)">‚Üë</button>
        <button class="btn-move left" onclick="move(-30, 0)">‚Üê</button>
        <button class="btn-move down" onclick="move(0, 30)">‚Üì</button>
        <button class="btn-move right" onclick="move(30, 0)">‚Üí</button>
    </div>
</div>

<script>
    // --- TELEGRAM INIT ---
    const tg = window.Telegram.WebApp;
    tg.expand(); // –ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

    // –ü–æ–ª—É—á–∞–µ–º ID –∏–∑ —Ç–µ–ª–µ–≥—Ä–∞–º–∞, –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –¥–ª—è —Ç–µ—Å—Ç–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
    let userId = tg.initDataUnsafe?.user?.id;
    if (!userId) {
        userId = localStorage.getItem('wc_userid') || 'test_' + Math.floor(Math.random() * 10000);
        localStorage.setItem('wc_userid', userId);
        console.log("Running in Browser Mode (Not Telegram)");
    }
    document.getElementById('user-id-display').innerText = userId;

    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
        authDomain: "warszawa-courier.firebaseapp.com",
        databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "warszawa-courier",
        storageBucket: "warszawa-courier.firebasestorage.app",
        messagingSenderId: "295860613508",
        appId: "1:295860613508:web:86fe8364377d6875612dd1",
        measurementId: "G-TGSCHBVLX2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- GAME STATE ---
    let playerPos = { x: 30, y: 30 };
    let targetPos = { x: 0, y: 0 };
    let balance = 0.00;
    let energy = 100;
    let water = 100;
    let vehicleCondition = 100; // –°–æ—Å—Ç–æ—è–Ω–∏–µ –±–∞–π–∫–∞
    let currentBikeId = 'default';
    let ownedBikes = ['default'];

    // –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –±–∞–π–∫–æ–≤
    const BIKES = {
        'default': { name: '–†–∂–∞–≤—ã–π –≤–µ–ª–∏–∫', speed: 1, drain: 1.0, price: 0 },
        'ebike250': { name: 'E-Bike 250W', speed: 1, drain: 0.6, price: 500 },
        'ebike350': { name: 'E-Bike 350W', speed: 1, drain: 0.4, price: 1200 },
        'ebike500': { name: 'Monster 500W', speed: 1, drain: 0.1, price: 2500 }
    };

    let jobState = 'NONE';
    let isOnline = false;
    let occupiedNodes = [];
    const step = 30;
    let policeUnits = [];
    let policeInterval = null;

    // --- DB LOAD ---
    function loadUserData() {
        db.ref('users/' + userId).once('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                balance = parseFloat(data.balance) || 0;
                energy = data.energy !== undefined ? data.energy : 100;
                water = data.water !== undefined ? data.water : 100;
                vehicleCondition = data.vehicleCondition !== undefined ? data.vehicleCondition : 100;
                currentBikeId = data.currentBikeId || 'default';
                ownedBikes = data.ownedBikes || ['default'];
                updateUI();
            } else {
                // New user
                saveGameForce();
            }
        });
    }
    loadUserData();

    function saveGameForce() {
        db.ref('users/' + userId).update({
            balance: balance,
            energy: energy,
            water: water,
            vehicleCondition: vehicleCondition,
            currentBikeId: currentBikeId,
            ownedBikes: ownedBikes,
            lastLogin: Date.now()
        });
    }

    function autoSave() {
        db.ref('users/' + userId).update({
            balance: balance,
            energy: energy,
            water: water,
            vehicleCondition: vehicleCondition
        });
    }

    // --- SHOP LOGIC ---
    function openMenu() {
        document.getElementById('menu-overlay').style.display = 'flex';
        switchTab('shop'); // Default tab
    }
    function closeMenu() {
        document.getElementById('menu-overlay').style.display = 'none';
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active'); // Note: event target handling is simplistic here
        
        const content = document.getElementById('tab-content');
        content.innerHTML = '';

        if (tabName === 'shop') {
            content.innerHTML = `
                <div class="shop-item">
                    <div class="shop-icon">üå≠</div>
                    <div class="shop-info"><div class="shop-name">–•–æ—Ç-–¥–æ–≥</div><div class="shop-desc">+20 –≠–Ω–µ—Ä–≥–∏–∏</div></div>
                    <button class="shop-btn" onclick="buyItem('hotdog', 5, 20, 0)">5.00 PLN</button>
                </div>
                <div class="shop-item">
                    <div class="shop-icon">ü•§</div>
                    <div class="shop-info"><div class="shop-name">–í–æ–¥–∞ 0.5–ª</div><div class="shop-desc">+30 –í–æ–¥—ã</div></div>
                    <button class="shop-btn" onclick="buyItem('water', 3, 0, 30)">3.00 PLN</button>
                </div>
                <div class="shop-item">
                    <div class="shop-icon">ü•´</div>
                    <div class="shop-info"><div class="shop-name">Red Bull</div><div class="shop-desc">+50 –≠–Ω–µ—Ä–≥–∏–∏, +5 –í–æ–¥—ã</div></div>
                    <button class="shop-btn" onclick="buyItem('redbull', 12, 50, 5)">12.00 PLN</button>
                </div>
            `;
        } else if (tabName === 'vehicles') {
            let html = '';
            for (let id in BIKES) {
                if (id === 'default') continue;
                let bike = BIKES[id];
                let owned = ownedBikes.includes(id);
                html += `
                <div class="shop-item">
                    <div class="shop-icon">üö≤</div>
                    <div class="shop-info">
                        <div class="shop-name">${bike.name}</div>
                        <div class="shop-desc">–†–∞—Å—Ö–æ–¥ —Å–∏–ª: -${(1-bike.drain)*100}%</div>
                    </div>
                    ${owned 
                        ? `<button class="shop-btn disabled">–ö–£–ü–õ–ï–ù–û</button>` 
                        : `<button class="shop-btn" onclick="buyBike('${id}')">${bike.price} PLN</button>`
                    }
                </div>`;
            }
            content.innerHTML = html;
        } else if (tabName === 'garage') {
            let currentBike = BIKES[currentBikeId];
            let repairCost = Math.floor((100 - vehicleCondition) * 1.5); // 1.5 PLN –∑–∞ 1%
            if (repairCost < 0) repairCost = 0;

            content.innerHTML = `
                <div style="text-align:center; padding:20px;">
                    <div style="font-size:40px">üö≤</div>
                    <h3>${currentBike.name}</h3>
                    <p>–°–æ—Å—Ç–æ—è–Ω–∏–µ: ${vehicleCondition.toFixed(1)}%</p>
                    <div style="margin:15px 0; background:#eee; height:10px; border-radius:5px; overflow:hidden;">
                        <div style="width:${vehicleCondition}%; background:${vehicleCondition<30?'red':'green'}; height:100%"></div>
                    </div>
                    ${vehicleCondition < 100 
                        ? `<button class="shop-btn" style="width:100%; padding:15px;" onclick="repairBike(${repairCost})">–ü–æ—á–∏–Ω–∏—Ç—å –∑–∞ ${repairCost} PLN</button>`
                        : `<button class="shop-btn disabled" style="width:100%">–ü–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–µ–Ω</button>`
                    }
                    <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
                    <h4>–í—ã–±—Ä–∞—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç:</h4>
                    <div id="bike-list"></div>
                </div>
            `;
            // List owned bikes
            setTimeout(() => {
                const list = document.getElementById('bike-list');
                ownedBikes.forEach(id => {
                    let b = BIKES[id];
                    let btn = document.createElement('div');
                    btn.className = 'shop-item';
                    btn.innerHTML = `
                        <div class="shop-info"><div class="shop-name">${b.name}</div></div>
                        <button class="shop-btn" style="background:${currentBikeId===id?'#555':'var(--lime)'; color:${currentBikeId===id?'white':'black'}" onclick="equipBike('${id}')">${currentBikeId===id?'–í—ã–±—Ä–∞–Ω':'–í–∑—è—Ç—å'}</button>
                    `;
                    list.appendChild(btn);
                });
            }, 0);
        } else if (tabName === 'bank') {
            content.innerHTML = `
                <div style="text-align:center; padding:30px; color:#777;">
                    <div style="font-size:50px">üè¶</div>
                    <h3>–ë–∞–Ω–∫ –í–∞—Ä—à–∞–≤—ã</h3>
                    <p>–ó–¥–µ—Å—å –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –¥–µ–ø–æ–∑–∏—Ç—ã –ø–æ–¥ %.</p>
                    <p>–°–µ–π—á–∞—Å –≤–∞—à –±–∞–ª–∞–Ω—Å: <b>${balance.toFixed(2)} PLN</b></p>
                    <div class="shop-item" style="margin-top:20px;">
                        <div>–°—á–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏.</div>
                    </div>
                </div>
            `;
        }
    }

    function buyItem(id, price, addEnergy, addWater) {
        if (balance >= price) {
            balance -= price;
            energy = Math.min(100, energy + addEnergy);
            water = Math.min(100, water + addWater);
            showToast(`–ö—É–ø–ª–µ–Ω–æ! -${price} PLN`);
            updateUI();
            saveGameForce();
        } else {
            showToast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!", true);
        }
    }

    function buyBike(id) {
        let bike = BIKES[id];
        if (balance >= bike.price) {
            balance -= bike.price;
            ownedBikes.push(id);
            currentBikeId = id;
            showToast(`–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! ${bike.name} —Ç–≤–æ–π!`);
            switchTab('garage'); // –ü–µ—Ä–µ–∫–∏–Ω—É—Ç—å –≤ –≥–∞—Ä–∞–∂
            saveGameForce();
            updateUI();
        } else {
            showToast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥!", true);
        }
    }

    function repairBike(cost) {
        if (cost === 0) return;
        if (balance >= cost) {
            balance -= cost;
            vehicleCondition = 100;
            showToast("–ë–∞–π–∫ –∫–∞–∫ –Ω–æ–≤–µ–Ω—å–∫–∏–π!");
            updateUI();
            switchTab('garage'); // refresh
            saveGameForce();
        } else {
            showToast("–ù–µ—Ç –¥–µ–Ω–µ–≥ –Ω–∞ —Ä–µ–º–æ–Ω—Ç!", true);
        }
    }

    function equipBike(id) {
        currentBikeId = id;
        showToast(`–í—ã –ø–µ—Ä–µ—Å–µ–ª–∏ –Ω–∞ ${BIKES[id].name}`);
        switchTab('garage');
        saveGameForce();
    }

    // --- GAME LOGIC ---

    function goOnline() {
        isOnline = true;
        document.getElementById('btn-online').style.display = 'none';
        document.getElementById('controls').style.display = 'grid';
        spawnObstacles();
        spawnPolice();
        newOrder();
        if (policeInterval) clearInterval(policeInterval);
        policeInterval = setInterval(movePolice, 1500);
        updateUI();
    }

    function spawnObstacles() {
        document.querySelectorAll('.obs').forEach(o => o.remove());
        occupiedNodes = [];
        const container = document.getElementById('game-container');
        const cols = Math.floor(container.offsetWidth / step);
        const rows = Math.floor(container.offsetHeight / step);
        for(let i=0; i < 18; i++) {
            let ox = Math.floor(Math.random() * cols) * step;
            let oy = Math.floor(Math.random() * rows) * step;
            let dist = Math.abs(ox - playerPos.x) + Math.abs(oy - playerPos.y);
            if(dist > step * 3) {
                occupiedNodes.push({x: ox, y: oy});
                let div = document.createElement('div');
                div.className = 'entity obs';
                div.style.left = ox + 'px'; div.style.top = oy + 'px';
                div.innerText = 'üöß';
                container.appendChild(div);
            }
        }
    }

    function spawnPolice() {
        document.querySelectorAll('.police').forEach(p => p.remove());
        policeUnits = [];
        const container = document.getElementById('game-container');
        const cols = Math.floor(container.offsetWidth / step);
        const rows = Math.floor(container.offsetHeight / step);
        for(let i=0; i<3; i++) {
             let px = Math.floor(Math.random() * cols) * step;
             let py = Math.floor(Math.random() * rows) * step;
             if (!occupiedNodes.some(n => n.x === px && n.y === py) && 
                 (Math.abs(px - playerPos.x) + Math.abs(py - playerPos.y) > step * 4)) {
                 let div = document.createElement('div');
                 div.className = 'entity police';
                 div.innerText = 'üöì';
                 div.style.left = px + 'px'; div.style.top = py + 'px';
                 container.appendChild(div);
                 policeUnits.push({ x: px, y: py, el: div });
             }
        }
    }

    function movePolice() {
        if (!isOnline) return;
        const container = document.getElementById('game-container');
        const cols = Math.floor(container.offsetWidth / step);
        const rows = Math.floor(container.offsetHeight / step);
        policeUnits.forEach(police => {
            let dirs = [{dx:0, dy:-step}, {dx:0, dy:step}, {dx:-step, dy:0}, {dx:step, dy:0}];
            let move = dirs[Math.floor(Math.random() * dirs.length)];
            let nx = police.x + move.dx;
            let ny = police.y + move.dy;
            if(nx >= 0 && nx < cols*step && ny >= 0 && ny < rows*step && !occupiedNodes.some(n => n.x === nx && n.y === ny)) {
                police.x = nx; police.y = ny;
                police.el.style.left = nx + 'px'; police.el.style.top = ny + 'px';
            }
            if (police.x === playerPos.x && police.y === playerPos.y) policeCatch();
        });
    }

    function policeCatch() {
        showToast("–ü–û–õ–ò–¶–ò–Ø! –®–¢–†–ê–§ 50 PLN!", true);
        balance -= 50.00;
        if (balance < 0) balance = 0;
        playerPos = { x: 30, y: 30 };
        autoSave();
        updateUI();
    }

    function move(dx, dy) {
        if (!isOnline) return;
        if (energy <= 0) {
            showToast("–ù–µ—Ç —Å–∏–ª! –ù—É–∂–µ–Ω Red Bull!", true);
            openMenu(); // –°—Ä–∞–∑—É –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –∫—É–ø–∏—Ç—å
            return;
        }
        if (vehicleCondition <= 0) {
            showToast("–ë–∞–π–∫ —Å–ª–æ–º–∞–Ω! –í —Ä–µ–º–æ–Ω—Ç!", true);
            openMenu();
            return;
        }

        let nx = playerPos.x + dx;
        let ny = playerPos.y + dy;
        const container = document.getElementById('game-container');

        if(nx < 0 || nx >= (Math.floor(container.offsetWidth/step)*step) || 
           ny < 0 || ny >= (Math.floor(container.offsetHeight/step)*step)) return;

        if(occupiedNodes.some(node => node.x === nx && node.y === ny)) {
            document.getElementById('status-bar').innerText = "üöß –¢–£–ü–ò–ö!";
            return;
        }
        if(policeUnits.some(p => p.x === nx && p.y === ny)) {
            policeCatch(); return;
        }

        playerPos.x = nx; playerPos.y = ny;
        
        // –†–∞—Å—Ö–æ–¥ –∑–∞–≤–∏—Å –æ—Ç –±–∞–π–∫–∞
        let currentBike = BIKES[currentBikeId] || BIKES['default'];
        energy -= currentBike.drain;
        water -= 0.5;
        vehicleCondition -= 0.05; // –ò–∑–Ω–æ—Å

        if (energy < 0) energy = 0;
        if (water < 0) water = 0;
        if (vehicleCondition < 0) vehicleCondition = 0;

        updateUI();
        checkTarget();
        autoSave();
    }

    function getFreeNode() {
        const container = document.getElementById('game-container');
        const cols = Math.floor(container.offsetWidth / step);
        const rows = Math.floor(container.offsetHeight / step);
        let node; let isOccupied = true; let attempt = 0;
        while(isOccupied && attempt < 100) {
            node = { x: Math.floor(Math.random() * cols) * step, y: Math.floor(Math.random() * rows) * step };
            isOccupied = occupiedNodes.some(n => n.x === node.x && n.y === node.y) || 
                         (node.x === playerPos.x && node.y === playerPos.y) ||
                         policeUnits.some(p => p.x === node.x && p.y === node.y);
            attempt++;
        }
        return node;
    }

    function newOrder() {
        jobState = 'RESTAURANT';
        targetPos = getFreeNode();
        const t = document.getElementById('target');
        t.style.display = 'flex'; t.style.left = targetPos.x + 'px'; t.style.top = targetPos.y + 'px';
        t.innerHTML = 'üçï';
        document.getElementById('status-bar').innerText = "–ó–∞–∫–∞–∑: –ü–∏—Ü—Ü–µ—Ä–∏—è";
    }

    function checkTarget() {
        if(playerPos.x === targetPos.x && playerPos.y === targetPos.y) {
            if(jobState === 'RESTAURANT') {
                jobState = 'CLIENT';
                targetPos = getFreeNode();
                const t = document.getElementById('target');
                t.style.left = targetPos.x + 'px'; t.style.top = targetPos.y + 'px';
                t.innerHTML = 'üìç';
                document.getElementById('status-bar').innerText = "–í–µ–∑–∏ –∫–ª–∏–µ–Ω—Ç—É!";
                showToast("–ü–∏—Ü—Ü–∞ —É —Ç–µ–±—è!");
            } else if(jobState === 'CLIENT') {
                balance += 15.00;
                document.getElementById('status-bar').innerText = "+15.00 PLN";
                showToast("+15.00 PLN");
                newOrder();
            }
        }
    }

    function updateUI() {
        document.getElementById('player').style.left = playerPos.x + 'px';
        document.getElementById('player').style.top = playerPos.y + 'px';
        document.getElementById('cash').innerText = balance.toFixed(2);
        document.getElementById('energy-bar').style.width = energy + '%';
        document.getElementById('water-bar').style.width = water + '%';
        document.getElementById('bike-hp-bar').style.width = vehicleCondition + '%';
        
        let hpColor = '#c8ff00';
        if(vehicleCondition < 50) hpColor = 'orange';
        if(vehicleCondition < 20) hpColor = 'red';
        document.getElementById('bike-hp-bar').style.backgroundColor = hpColor;
    }
    
    function showToast(msg, isAlert = false) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.className = 'toast ' + (isAlert ? 'red' : '');
        t.style.display = 'block';
        setTimeout(() => { t.style.display = 'none'; }, 2000);
    }

    updateUI();
</script>
</body>
</html>
