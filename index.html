<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Courier Warsaw</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #ffffff;
}

#map {
  height: 75vh;
  width: 100%;
}

#panel {
  height: 25vh;
  padding: 12px;
  box-shadow: 0 -6px 20px rgba(0,0,0,0.15);
}

button {
  width: 100%;
  padding: 16px;
  font-size: 17px;
  font-weight: 600;
  border: none;
  border-radius: 12px;
  background: #00aaff;
  color: white;
  margin-top: 8px;
}

button.gray {
  background: #e4eef4;
  color: #333;
}

.status {
  font-size: 15px;
  margin-bottom: 6px;
}
.stats {
  font-size: 13px;
  opacity: 0.8;
}
</style>
</head>

<body>

<div id="map"></div>

<div id="panel">
  <div class="status" id="status">üîò –û—Ñ–ª–∞–π–Ω</div>
  <div class="stats">
    ‚ö° –≠–Ω–µ—Ä–≥–∏—è: <span id="energy">100</span>% |
    üçî –ï–¥–∞: <span id="food">60</span>% |
    üö≤ –í–µ–ª: <span id="bike">100</span>%
  </div>
  <button id="mainBtn" onclick="mainAction()">üü¢ –í—ã–π—Ç–∏ –æ–Ω–ª–∞–π–Ω</button>
</div>

<script>
/* ===== –°–û–°–¢–û–Ø–ù–ò–ï ===== */
let state = {
  phase: "offline", // offline, online, toRestaurant, toClient
  energy: 100,
  food: 60,
  bike: 100,
  step: 0
};

/* ===== –ö–ê–†–¢–ê –í–ê–†–®–ê–í–´ ===== */
const map = L.map('map').setView([52.2297, 21.0122], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap'
}).addTo(map);

/* ===== –ú–ê–†–ö–ï–†–´ ===== */
let courierPos = [52.2297, 21.0122];
let restaurantPos = [52.2335, 21.0020];
let clientPos = [52.2210, 21.0250];

const courierMarker = L.marker(courierPos).addTo(map);
let targetLine = null;

/* ===== UI ===== */
function updateUI() {
  energy.innerText = Math.floor(state.energy);
  food.innerText = Math.floor(state.food);
  bike.innerText = Math.floor(state.bike);

  if (state.phase === "offline") {
    status.innerText = "üîò –û—Ñ–ª–∞–π–Ω";
    mainBtn.innerText = "üü¢ –í—ã–π—Ç–∏ –æ–Ω–ª–∞–π–Ω";
  }
  if (state.phase === "online") {
    status.innerText = "üü¢ –û–Ω–ª–∞–π–Ω. –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞‚Ä¶";
    mainBtn.innerText = "üîî –ñ–¥–∞—Ç—å –∑–∞–∫–∞–∑";
  }
  if (state.phase === "toRestaurant") {
    status.innerText = "üçî –ï–¥–µ—à—å –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω";
    mainBtn.innerText = "üö¥ –ï—Ö–∞—Ç—å";
  }
  if (state.phase === "toClient") {
    status.innerText = "üè† –í–µ–∑—ë—à—å –∑–∞–∫–∞–∑ –∫–ª–∏–µ–Ω—Ç—É";
    mainBtn.innerText = "üö¥ –ï—Ö–∞—Ç—å";
  }
}

/* ===== –õ–û–ì–ò–ö–ê ===== */
function mainAction() {
  if (state.phase === "offline") {
    state.phase = "online";
  }
  else if (state.phase === "online") {
    state.phase = "toRestaurant";
    drawRoute(courierPos, restaurantPos);
    state.step = 0;
  }
  else if (state.phase === "toRestaurant") {
    moveStep(restaurantPos, "toClient");
  }
  else if (state.phase === "toClient") {
    moveStep(clientPos, "online");
  }

  drain();
  updateUI();
}

/* ===== –î–í–ò–ñ–ï–ù–ò–ï ===== */
function moveStep(target, nextPhase) {
  const dx = (target[0] - courierPos[0]) / 15;
  const dy = (target[1] - courierPos[1]) / 15;

  courierPos[0] += dx;
  courierPos[1] += dy;

  courierMarker.setLatLng(courierPos);
  map.panTo(courierPos, { animate: true });

  state.step++;
  if (state.step >= 15) {
    courierPos = [...target];
    courierMarker.setLatLng(courierPos);
    clearRoute();
    state.phase = nextPhase;
  }
}

/* ===== –ú–ê–†–®–†–£–¢ ===== */
function drawRoute(from, to) {
  clearRoute();
  targetLine = L.polyline([from, to], { color: "#00aaff" }).addTo(map);
}
function clearRoute() {
  if (targetLine) map.removeLayer(targetLine);
}

/* ===== –ò–ó–ù–û–° ===== */
function drain() {
  if (state.phase === "toRestaurant" || state.phase === "toClient") {
    state.energy -= 2;
    state.food -= 1.5;
    state.bike -= 1;
  }
}

/* INIT */
updateUI();
</script>

</body>
</html>
