<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warsaw Courier: DEBUG</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #f9f9e8;
            --grid: #e2e2ca;
            --lime: #c8ff00;
            --dark: #1a1a1a;
            --red: #ff3333;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: 'Arial', sans-serif; }

        /* --- –ö–ù–û–ü–ö–ê –ú–ï–ù–Æ (3 –ü–û–õ–û–°–ö–ò) --- */
        #hamburger-btn {
            position: fixed; /* –§–∏–∫—Å–∏—Ä—É–µ–º –Ω–∞–º–µ—Ä—Ç–≤–æ */
            top: 15px; left: 15px;
            width: 50px; height: 50px; 
            background: white; 
            border: 2px solid var(--dark);
            border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;
            cursor: pointer;
            z-index: 10000; /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
            box-shadow: 0 5px 0 rgba(0,0,0,0.2);
        }
        #hamburger-btn:active { transform: translateY(3px); box-shadow: none; }
        .line { width: 30px; height: 4px; background: var(--dark); border-radius: 2px; }

        /* --- UI TOP --- */
        #top-info {
            height: 140px; background: var(--bg);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-bottom: 2px solid var(--grid);
            position: relative; z-index: 100;
            padding-top: 20px;
        }
        .balance-pill { 
            background: white; padding: 5px 30px; border-radius: 50px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); font-size: 1.8rem; font-weight: 800; color: var(--dark);
            border: 1px solid #eee; margin-bottom: 5px;
        }
        .stats-container { width: 90%; display: flex; justify-content: space-between; margin-top: 5px; }
        .stat-box { display: flex; align-items: center; gap: 5px; font-size: 11px; font-weight: bold; width: 48%; }
        .bar-bg { flex-grow: 1; height: 8px; background: #ddd; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; width: 100%; transition: width 0.3s; }
        #energy-bar { background: orange; }
        #water-bar { background: #00aaff; }
        #bike-hp-bar { background: #555; }

        /* --- –ë–û–ö–û–í–û–ï –ú–ï–ù–Æ --- */
        #sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 10001; display: none;
        }
        #sidebar {
            position: fixed; top: 0; left: -320px; /* –°–ø—Ä—è—Ç–∞–Ω–æ */
            width: 85%; max-width: 300px; height: 100%;
            background: #fff; z-index: 10002;
            transition: left 0.3s ease-in-out;
            display: flex; flex-direction: column;
            border-right: 2px solid var(--dark);
        }
        #sidebar.open { left: 0; } 

        .sidebar-header {
            padding: 20px; background: var(--dark); color: white;
            display: flex; justify-content: space-between; align-items: center;
        }
        .sidebar-tabs { display: flex; background: #eee; padding: 10px; gap: 5px; overflow-x: auto; }
        .tab { 
            padding: 8px 10px; background: white; border-radius: 5px; font-size: 12px; font-weight: bold; 
            border: 1px solid #ccc; cursor: pointer; white-space: nowrap;
        }
        .tab.active { background: var(--lime); border-color: black; }
        .sidebar-content { flex-grow: 1; overflow-y: auto; padding: 10px; }
        
        /* –≠–ª–µ–º–µ–Ω—Ç—ã –º–∞–≥–∞–∑–∏–Ω–∞ */
        .shop-item {
            background: #fff; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .buy-btn { background: var(--dark); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;}

        /* --- –ò–ì–†–û–í–û–ï –ü–û–õ–ï --- */
        #game-container {
            position: relative; width: 100%; height: calc(100vh - 410px);
            background-image: radial-gradient(var(--grid) 15%, transparent 16%);
            background-size: 20px 20px; overflow: hidden;
        }
        .entity { 
            position: absolute; width: 30px; height: 30px; 
            display: flex; align-items: center; justify-content: center; 
            z-index: 10; font-size: 20px; transition: all 0.2s linear;
        }
        #player { background: var(--lime); border: 2px solid var(--dark); border-radius: 50%; z-index: 20; font-size: 16px; }

        /* --- –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø --- */
        #ui-bottom { 
            height: 270px; background: white; 
            display: flex; flex-direction: column; align-items: center; padding-top: 10px; 
            border-top: 2px solid var(--grid); z-index: 90;
        }
        #btn-online {
            width: 80%; padding: 15px; background: var(--lime); border: 2px solid var(--dark);
            font-weight: bold; font-size: 18px; cursor: pointer; border-radius: 10px;
        }
        .joy-grid { display: grid; grid-template-columns: repeat(3, 60px); grid-template-rows: repeat(2, 60px); gap: 5px; margin-top: 10px; }
        .btn-move { background: #eee; border: 1px solid #ccc; font-size: 24px; border-radius: 10px; }
        .btn-move:active { background: #ccc; }
        .up { grid-column: 2; }
        .left { grid-column: 1; grid-row: 2; }
        .down { grid-column: 2; grid-row: 2; }
        .right { grid-column: 3; grid-row: 2; }

        /* –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –û–ë –û–®–ò–ë–ö–ê–• */
        #error-log {
            position: fixed; bottom: 0; left: 0; width: 100%; max-height: 100px;
            background: rgba(0,0,0,0.8); color: red; font-size: 10px; 
            overflow-y: scroll; z-index: 20000; padding: 5px; display: none;
        }
        .toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); color: white; padding: 10px 20px; border-radius: 20px;
            display: none; z-index: 20000;
        }
    </style>
</head>
<body>

<div id="error-log"></div>

<div id="hamburger-btn" onclick="toggleMenu()">
    <div class="line"></div>
    <div class="line"></div>
    <div class="line"></div>
</div>

<div id="sidebar-overlay" onclick="toggleMenu()"></div>
<div id="sidebar">
    <div class="sidebar-header">
        <span>–ú–ï–ù–Æ</span>
        <span onclick="toggleMenu()" style="font-size:24px; cursor:pointer;">‚úï</span>
    </div>
    <div class="sidebar-tabs">
        <div class="tab active" onclick="renderShop()">–ú–∞–≥–∞–∑–∏–Ω</div>
        <div class="tab" onclick="renderGarage()">–ì–∞—Ä–∞–∂</div>
        <div class="tab" onclick="alert('–ë–∞–Ω–∫ –∑–∞–∫—Ä—ã—Ç')">–ë–∞–Ω–∫</div>
    </div>
    <div id="menu-content" class="sidebar-content">
        </div>
    <div style="padding:10px; font-size:10px; text-align:center; color:#999;">ID: <span id="uid-disp">...</span></div>
</div>

<div id="toast" class="toast">Info</div>

<div id="top-info">
    <div class="balance-pill"><span id="cash">0.00</span> PLN</div>
    <div class="stats-container">
        <div class="stat-box">‚ö° <div class="bar-bg"><div id="energy-bar" class="bar-fill" style="width:100%"></div></div></div>
        <div class="stat-box">üíß <div class="bar-bg"><div id="water-bar" class="bar-fill" style="width:100%"></div></div></div>
    </div>
    <div class="stats-container" style="margin-top:5px">
        <div class="stat-box" style="width:100%">üö≤ <div class="bar-bg"><div id="bike-bar" class="bar-fill" style="width:100%; background:#555"></div></div></div>
    </div>
</div>

<div id="game-container">
    <div id="player" class="entity">üö≤</div>
    <div id="target" class="entity" style="display:none">üçï</div>
</div>

<div id="ui-bottom">
    <button id="btn-online" onclick="goOnline()">–ù–ê–ß–ê–¢–¨ –†–ê–ë–û–¢–£</button>
    <div class="joy-grid" id="controls" style="display:none">
        <button class="btn-move up" onclick="move(0, -30)">‚Üë</button>
        <button class="btn-move left" onclick="move(-30, 0)">‚Üê</button>
        <button class="btn-move down" onclick="move(0, 30)">‚Üì</button>
        <button class="btn-move right" onclick="move(30, 0)">‚Üí</button>
    </div>
</div>

<script>
    // 1. –õ–û–í–ò–ú –û–®–ò–ë–ö–ò, –ß–¢–û–ë–´ –¢–´ –ò–• –í–ò–î–ï–õ
    window.onerror = function(msg, url, line) {
        const log = document.getElementById('error-log');
        log.style.display = 'block';
        log.innerHTML += `ERR: ${msg} (Line ${line})<br>`;
        return false;
    };

    // 2. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    let db = null;
    let userId = 'demo_user';

    try {
        const tg = window.Telegram.WebApp;
        tg.expand();
        userId = tg.initDataUnsafe?.user?.id || 'browser_test_' + Math.floor(Math.random()*1000);
        document.getElementById('uid-disp').innerText = userId;

        const firebaseConfig = {
            apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
            authDomain: "warszawa-courier.firebaseapp.com",
            databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "warszawa-courier",
            storageBucket: "warszawa-courier.firebasestorage.app",
            messagingSenderId: "295860613508",
            appId: "1:295860613508:web:86fe8364377d6875612dd1",
            measurementId: "G-TGSCHBVLX2"
        };
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        console.log("DB OK");
    } catch (e) {
        console.error("Firebase/TG Fail:", e);
        showToast("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è! –ò–≥—Ä–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω.");
    }

    // 3. –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò–ì–†–´
    let state = {
        bal: 0, en: 100, wat: 100, hp: 100,
        x: 30, y: 30,
        bike: 'default',
        bikes: ['default']
    };
    
    // 4. –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
    function loadData() {
        if(db) {
            db.ref('users/' + userId).once('value', s => {
                let d = s.val();
                if(d) {
                    state.bal = parseFloat(d.balance) || 0;
                    state.en = d.energy ?? 100;
                    state.wat = d.water ?? 100;
                    state.hp = d.hp ?? 100;
                    state.bikes = d.bikes || ['default'];
                    state.bike = d.bike || 'default';
                }
                updateUI();
            });
        }
    }
    loadData();

    function saveData() {
        if(db) {
            db.ref('users/' + userId).update({
                balance: state.bal, energy: state.en, water: state.wat, hp: state.hp,
                bike: state.bike, bikes: state.bikes
            });
        }
        updateUI();
    }

    // 5. –õ–û–ì–ò–ö–ê –ú–ï–ù–Æ (–†–ê–ë–û–¢–ê–ï–¢ –ñ–ï–õ–ï–ó–ù–û)
    function toggleMenu() {
        const sb = document.getElementById('sidebar');
        const ov = document.getElementById('sidebar-overlay');
        if(sb.classList.contains('open')) {
            sb.classList.remove('open');
            ov.style.display = 'none';
        } else {
            sb.classList.add('open');
            ov.style.display = 'block';
            renderShop(); // –°—Ä–∞–∑—É –≥—Ä—É–∑–∏–º –º–∞–≥–∞–∑–∏–Ω
        }
    }

    function renderShop() {
        const c = document.getElementById('menu-content');
        c.innerHTML = `
            <div class="shop-item">
                <div><b>–•–æ—Ç-–¥–æ–≥ (5 PLN)</b><br><small>+20 –≠–Ω–µ—Ä–≥–∏–∏</small></div>
                <button class="buy-btn" onclick="buy('food', 5)">–ö—É–ø–∏—Ç—å</button>
            </div>
            <div class="shop-item">
                <div><b>Red Bull (12 PLN)</b><br><small>+50 –≠–Ω–µ—Ä–≥–∏–∏</small></div>
                <button class="buy-btn" onclick="buy('bull', 12)">–ö—É–ø–∏—Ç—å</button>
            </div>
            <div class="shop-item">
                <div><b>E-Bike 250W (500 PLN)</b><br><small>–ú–µ–Ω—å—à–µ —É—Å—Ç–∞–ª–æ—Å—Ç–∏</small></div>
                <button class="buy-btn" onclick="buyBike('ebike250', 500)">–ö—É–ø–∏—Ç—å</button>
            </div>
        `;
    }

    function renderGarage() {
        const c = document.getElementById('menu-content');
        c.innerHTML = `<div style="padding:10px; text-align:center">
            <h3>–¢–≤–æ–π –±–∞–π–∫: ${state.bike}</h3>
            <p>–ó–¥–æ—Ä–æ–≤—å–µ: ${state.hp.toFixed(0)}%</p>
            <button class="buy-btn" style="width:100%; margin-bottom:10px" onclick="repair()">–ü–æ—á–∏–Ω–∏—Ç—å (10 PLN)</button>
            <hr>
            <p>–î–æ—Å—Ç—É–ø–Ω–æ:</p>
            ${state.bikes.map(b => `<div class="shop-item">${b} <button onclick="equip('${b}')">–í–∑—è—Ç—å</button></div>`).join('')}
        </div>`;
    }

    function buy(type, price) {
        if(state.bal >= price) {
            state.bal -= price;
            if(type === 'food') state.en = Math.min(100, state.en + 20);
            if(type === 'bull') state.en = Math.min(100, state.en + 50);
            showToast("–ö—É–ø–ª–µ–Ω–æ!");
            saveData();
            renderShop(); // –û–±–Ω–æ–≤–∏—Ç—å
        } else {
            showToast("–ù–µ—Ç –¥–µ–Ω–µ–≥!");
        }
    }

    function buyBike(id, price) {
        if(state.bikes.includes(id)) { showToast("–£–∂–µ –µ—Å—Ç—å!"); return; }
        if(state.bal >= price) {
            state.bal -= price;
            state.bikes.push(id);
            showToast("–ë–∞–π–∫ –∫—É–ø–ª–µ–Ω!");
            saveData();
            renderShop();
        } else { showToast("–ù–µ—Ç –¥–µ–Ω–µ–≥!"); }
    }

    function repair() {
        if(state.bal >= 10 && state.hp < 100) {
            state.bal -= 10;
            state.hp = 100;
            showToast("–ü–æ—á–∏–Ω–∏–ª!");
            saveData();
            renderGarage();
        } else { showToast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥ –∏–ª–∏ –±–∞–π–∫ —Ü–µ–ª"); }
    }

    function equip(id) {
        state.bike = id;
        showToast("–í–∑—è—Ç: " + id);
        saveData();
        renderGarage();
    }

    // 6. –ò–ì–†–û–í–û–ô –ü–†–û–¶–ï–°–°
    let isOnline = false;
    function goOnline() {
        isOnline = true;
        document.getElementById('btn-online').style.display = 'none';
        document.getElementById('controls').style.display = 'grid';
        spawnTarget();
        updateUI();
    }

    function move(dx, dy) {
        if(!isOnline) return;
        if(state.en <= 0) { showToast("–ù–ï–¢ –≠–ù–ï–†–ì–ò–ò! –°–∫—É—à–∞–π –•–æ—Ç-–¥–æ–≥."); toggleMenu(); return; }
        
        // –ì—Ä–∞–Ω–∏—Ü—ã
        let nx = state.x + dx;
        let ny = state.y + dy;
        // –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø—Ä–∏–º–µ—Ä–Ω–æ
        let maxW = document.getElementById('game-container').offsetWidth - 30;
        let maxH = document.getElementById('game-container').offsetHeight - 30;
        
        if(nx < 0 || ny < 0 || nx > maxW || ny > maxH) return;

        state.x = nx; state.y = ny;
        state.en -= (state.bike === 'ebike250' ? 0.5 : 1.5);
        state.wat -= 0.5;
        state.hp -= 0.2;

        checkCollisions();
        updateUI();
        saveData();
    }

    let target = {x: 100, y: 100, active: true};
    function spawnTarget() {
        let maxW = document.getElementById('game-container').offsetWidth - 60;
        let maxH = document.getElementById('game-container').offsetHeight - 60;
        target.x = Math.floor(Math.random() * maxW / 30) * 30;
        target.y = Math.floor(Math.random() * maxH / 30) * 30;
        target.active = true;
        
        let t = document.getElementById('target');
        t.style.display = 'flex';
        t.style.left = target.x + 'px';
        t.style.top = target.y + 'px';
    }

    function checkCollisions() {
        // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏
        if(Math.abs(state.x - target.x) < 20 && Math.abs(state.y - target.y) < 20 && target.active) {
            state.bal += 15;
            showToast("+15 PLN");
            target.active = false;
            setTimeout(spawnTarget, 500);
        }
    }

    function updateUI() {
        document.getElementById('cash').innerText = state.bal.toFixed(2);
        document.getElementById('energy-bar').style.width = Math.max(0, state.en) + '%';
        document.getElementById('water-bar').style.width = Math.max(0, state.wat) + '%';
        document.getElementById('bike-bar').style.width = Math.max(0, state.hp) + '%';
        
        let p = document.getElementById('player');
        p.style.left = state.x + 'px';
        p.style.top = state.y + 'px';
    }

    function showToast(msg) {
        let t = document.getElementById('toast');
        t.innerText = msg;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 1500);
    }

</script>
</body>
</html>
