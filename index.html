<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Courier Pro: Warsaw</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- –î–ò–ó–ê–ô–ù: DARK GLASS --- */
        :root {
            --bg-glass: rgba(20, 20, 20, 0.85);
            --accent: #3b82f6; /* –°–∏–Ω–∏–π */
            --accent-repair: #f59e0b; /* –û—Ä–∞–Ω–∂–µ–≤—ã–π –¥–ª—è —Ä–µ–º–æ–Ω—Ç–∞ */
            --accent-glow: rgba(59, 130, 246, 0.4);
            --danger: #ef4444;
            --success: #10b981;
            --text-main: #ffffff;
            --text-muted: #9ca3af;
            --radius: 16px;
        }

        body {
            margin: 0; padding: 0;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* –ö–ê–†–¢–ê –ù–ê –§–û–ù–ï */
        #map {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
            filter: grayscale(80%) invert(10%) contrast(110%);
        }

        /* –ò–ù–¢–ï–†–§–ï–ô–° –ü–û–í–ï–†–• –ö–ê–†–¢–´ */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ */
        .top-bar {
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%);
            padding: 15px;
            pointer-events: auto;
            display: flex;
            justify-content: space-between;
        }

        .stats-card {
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            padding: 10px 15px;
            border-radius: var(--radius);
            border: 1px solid rgba(255,255,255,0.1);
            min-width: 100px;
        }

        .stat-row { font-size: 13px; color: var(--text-muted); display: flex; justify-content: space-between; margin-bottom: 2px; }
        .stat-val { font-size: 16px; font-weight: 700; color: var(--text-main); }
        .money-val { color: var(--success); font-size: 18px; }

        /* –ü–û–õ–û–°–ö–ò –†–ï–°–£–†–°–û–í */
        .res-bar-bg { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin-top:2px; }
        .res-bar-fill { height: 100%; width: 100%; transition: width 0.3s; }
        .fill-energy { background: var(--accent); }
        .fill-water { background: #0ea5e9; }
        .fill-mood { background: #d946ef; }

        /* –ù–ò–ñ–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ */
        .bottom-dock {
            background: var(--bg-glass);
            backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 20px 20px 40px 20px;
            pointer-events: auto;
            border-radius: 24px 24px 0 0;
        }

        /* –ö–ù–û–ü–ö–ò –ú–ï–ù–Æ */
        .nav-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* –¢—Ä–∏ –∫–æ–ª–æ–Ω–∫–∏ */
            gap: 8px;
            margin-bottom: 15px;
        }
        .nav-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.05);
            color: var(--text-muted);
            padding: 10px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .nav-btn:active { background: rgba(255,255,255,0.15); }
        .nav-btn i { font-size: 16px; }

        /* –ì–õ–ê–í–ù–ê–Ø –ö–ù–û–ü–ö–ê (–ü–ï–î–ê–õ–¨) */
        .action-btn {
            width: 100%;
            background: var(--accent);
            color: white;
            font-size: 18px;
            font-weight: 800;
            padding: 18px;
            border: none;
            border-radius: var(--radius);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }
        .action-btn:active { transform: scale(0.97); }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ä–µ–º–æ–Ω—Ç–∞ */
        .btn-repair {
            background: var(--accent-repair) !important;
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4) !important;
        }

        /* –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */
        .modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            z-index: 100;
            justify-content: center;
            align-items: flex-end;
        }
        .modal-content {
            background: #1c1c1e;
            width: 100%;
            max-height: 80vh;
            border-radius: 24px 24px 0 0;
            padding: 20px;
            color: #fff;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .shop-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .shop-btn {
            background: var(--success);
            color: #000; border: none; padding: 8px 16px;
            border-radius: 20px; font-weight: bold; font-size: 12px;
        }

        /* –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: #fff; padding: 10px 20px;
            border-radius: 30px; font-size: 13px; z-index: 200;
            display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="ui-layer">
        
        <div class="top-bar">
            <div class="stats-card">
                <div class="stat-row">–ë–ê–õ–ê–ù–° <i class="fas fa-wallet"></i></div>
                <div class="stat-val money-val" id="cash-display">0 PLN</div>
                <div class="stat-row" style="margin-top:5px;">–†–ï–ô–¢–ò–ù–ì</div>
                <div class="stat-val" id="lvl-display" style="color:var(--accent);">LVL 1</div>
            </div>

            <div class="stats-card" style="text-align:right;">
                <div class="stat-row">–í–ï–õ–û–°–ò–ü–ï–î</div>
                <div class="res-bar-bg"><div id="bike-bar" class="res-bar-fill" style="background:orange;"></div></div>
                <div class="stat-row" style="margin-top:2px;"><span id="bike-hp">100%</span></div>
                
                <div class="stat-row" style="margin-top:5px;">–°–£–ú–ö–ê</div>
                <div class="stat-val" id="gear-hp" style="font-size:14px;">100%</div>
            </div>
        </div>

        <div class="bottom-dock">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                <div>
                    <div class="stat-row"><span>–≠–ù–ï–†–ì–ò–Ø</span> <span id="energy-val">100%</span></div>
                    <div class="res-bar-bg"><div id="energy-bar" class="res-bar-fill fill-energy"></div></div>
                </div>
                <div>
                    <div class="stat-row"><span>–í–û–î–ê</span> <span id="water-val">100%</span></div>
                    <div class="res-bar-bg"><div id="water-bar" class="res-bar-fill fill-water"></div></div>
                </div>
            </div>

            <div class="nav-grid">
                <button class="nav-btn" onclick="openShop()">
                    <i class="fas fa-shopping-cart"></i> <span>–ú–ê–ì–ê–ó–ò–ù</span>
                </button>
                <button class="nav-btn" onclick="drinkFreeWater()">
                    <i class="fas fa-faucet" style="color:#0ea5e9;"></i> <span>–ü–û–ü–ò–¢–¨</span>
                </button>
                <button class="nav-btn" onclick="showToast('–ü—Ä–æ—Ñ–∏–ª—å –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">
                    <i class="fas fa-user"></i> <span>–ü–†–û–§–ò–õ–¨</span>
                </button>
            </div>

            <button id="main-btn" class="action-btn" onclick="pedal()">
                <i class="fas fa-bicycle"></i> –ó–ê–ì–†–£–ó–ö–ê...
            </button>
            <div id="order-info" style="text-align:center; font-size:12px; color:#aaa; margin-top:10px; display:none;">
                –î–∏—Å—Ç–∞–Ω—Ü–∏—è: <span id="dist-display">0</span> –º
            </div>
        </div>
    </div>

    <div id="shop-modal" class="modal" onclick="if(event.target === this) this.style.display='none'">
        <div class="modal-content">
            <h2>üè™ 7-Eleven</h2>
            <div id="shop-list"></div>
            <button onclick="document.getElementById('shop-modal').style.display='none'" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:12px; margin-top:20px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // 1. –ù–ê–°–¢–†–û–ô–ö–ò –ò –°–û–•–†–ê–ù–ï–ù–ò–ï
        const SAVE_KEY = 'PROJECT2_FIXED_V1'; 

        // –ö–∞—Ä—Ç–∞
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([52.2297, 21.0122], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

        const courierIcon = L.divIcon({
            html: '<div style="background:#3b82f6; width:15px; height:15px; border-radius:50%; border:2px solid white; box-shadow:0 0 10px #3b82f6;"></div>',
            className: 'courier-marker'
        });
        const targetIcon = L.divIcon({
            html: '<div style="background:#ef4444; width:15px; height:15px; border-radius:50%; border:2px solid white; animation: pulse 1s infinite;"></div>',
            className: 'target-marker'
        });

        let courierMarker = L.marker([52.2297, 21.0122], {icon: courierIcon}).addTo(map);
        let targetMarker = null;

        // 2. –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´
        let state = {
            cash: 50,       // –ù–µ–º–Ω–æ–≥–æ –¥–µ–Ω–µ–≥ –Ω–∞ —Å—Ç–∞—Ä—Ç
            energy: 100,
            water: 100,
            mood: 100,
            bike: 100,      // 100% –ø—Ä–æ—á–Ω–æ—Å—Ç—å
            gear: 100,
            exp: 0,
            lvl: 1,
            currentOrder: null
        };
        
        let lastDrinkTime = 0; // –î–ª—è –∫—É–ª–¥–∞—É–Ω–∞ —Ñ–æ–Ω—Ç–∞–Ω—á–∏–∫–∞

        // 3. –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê
        function init() {
            loadGame();
            updateUI();
            updateMainButtonState();
            // –†–∞—Å—Ö–æ–¥ —Ä–µ—Å—É—Ä—Å–æ–≤ (–ó–∞–º–µ–¥–ª–µ–Ω–Ω—ã–π!)
            setInterval(autoTick, 5000); 
            setInterval(saveGame, 10000);
        }

        function autoTick() {
            // –í–æ–¥–∞ —Ç—Ä–∞—Ç–∏—Ç—Å—è –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ (0.2 –≤–º–µ—Å—Ç–æ 1.0)
            if(state.currentOrder) {
                state.water = Math.max(0, state.water - 0.2);
                state.mood = Math.max(0, state.mood - 0.2);
            } else {
                // –ï—Å–ª–∏ —Å—Ç–æ–∏–º - –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç–¥—ã—Ö
                if(state.energy < 50) state.energy += 0.5;
            }
            updateUI();
        }

        function pedal() {
            // --- –õ–û–ì–ò–ö–ê 1: –†–ï–ú–û–ù–¢ (–ï—Å–ª–∏ –≤–µ–ª–∏–∫ —Å–ª–æ–º–∞–Ω) ---
            if (state.bike <= 0) {
                if (state.energy >= 10) {
                    state.energy -= 10;
                    state.bike += 15; // –ß–∏–Ω–∏–º —Ä—É–∫–∞–º–∏
                    showToast("üîß –ì–∞–π–∫–∏ –ø–æ–¥–∫—Ä—É—á–µ–Ω—ã! (+15% HP)", "success");
                } else {
                    showToast("üò´ –ù–µ—Ç —Å–∏–ª —á–∏–Ω–∏—Ç—å! –ü–æ–µ—à—å.", "error");
                }
                updateUI();
                updateMainButtonState();
                return;
            }

            // --- –õ–û–ì–ò–ö–ê 2: –ï–ó–î–ê (–û–±—ã—á–Ω–∞—è) ---
            if (!state.currentOrder) {
                startOrder();
                return;
            }

            if (state.energy <= 0) {
                showToast("‚ö° –ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏! –°–Ω–∏–∫–µ—Ä—Å?", "error");
                return;
            }

            // –î–≤–∏–∂–µ–Ω–∏–µ
            const dest = state.currentOrder.dest;
            const pos = courierMarker.getLatLng();
            const newLat = pos.lat + (dest[0] - pos.lat) * 0.1; 
            const newLng = pos.lng + (dest[1] - pos.lng) * 0.1;

            courierMarker.setLatLng([newLat, newLng]);
            map.setView([newLat, newLng]); 

            // –†–∞—Å—Ö–æ–¥
            state.energy = Math.max(0, state.energy - 2);
            state.bike = Math.max(0, state.bike - 0.5); // –ò–∑–Ω–æ—Å –≤–µ–ª–∏–∫–∞
            state.gear = Math.max(0, state.gear - 0.2);

            // –î–∏—Å—Ç–∞–Ω—Ü–∏—è
            const dist = map.distance([newLat, newLng], dest);
            document.getElementById('dist-display').innerText = Math.floor(dist);

            if (dist < 20) finishOrder();
            
            updateUI();
            updateMainButtonState();
        }

        // --- –§–£–ù–ö–¶–ò–ò –ó–ê–ö–ê–ó–ê ---
        function startOrder() {
            const center = [52.2297, 21.0122];
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–π —Ç–æ—á–∫–∏
            const dest = [
                center[0] + (Math.random() - 0.5) * 0.02,
                center[1] + (Math.random() - 0.5) * 0.02
            ];
            state.currentOrder = { dest: dest, pay: 20 + Math.floor(Math.random() * 20) };
            
            if (targetMarker) map.removeLayer(targetMarker);
            targetMarker = L.marker(dest, {icon: targetIcon}).addTo(map);
            
            document.getElementById('order-info').style.display = 'block';
            showToast("üì¶ –ó–∞–∫–∞–∑ –ø–æ–ª—É—á–µ–Ω! –í–ø–µ—Ä–µ–¥.");
            updateMainButtonState();
        }

        function finishOrder() {
            state.cash += state.currentOrder.pay;
            state.exp += 10;
            if (state.exp > 100 * state.lvl) { state.lvl++; state.exp = 0; showToast("üéâ LEVEL UP!"); }
            
            showToast(`‚úÖ +${state.currentOrder.pay} PLN`);
            state.currentOrder = null;
            if (targetMarker) map.removeLayer(targetMarker);
            document.getElementById('order-info').style.display = 'none';
            saveGame();
            updateMainButtonState();
        }

        // --- –ë–ï–°–ü–õ–ê–¢–ù–ê–Ø –í–û–î–ê ---
        function drinkFreeWater() {
            const now = Date.now();
            if (now - lastDrinkTime < 60000) { // 60 —Å–µ–∫—É–Ω–¥ –∫–¥
                const wait = Math.ceil((60000 - (now - lastDrinkTime))/1000);
                showToast(`‚è≥ –§–æ–Ω—Ç–∞–Ω –ø—É—Å—Ç. –ñ–¥–∏ ${wait} —Å–µ–∫.`);
                return;
            }
            state.water = Math.min(100, state.water + 25);
            lastDrinkTime = now;
            showToast("üíß –ì–ª–æ—Ç–æ–∫ –≤–æ–¥—ã (+25%)", "success");
            updateUI();
        }

        // --- –ú–ê–ì–ê–ó–ò–ù ---
        const items = [
            { id: 'snickers', name: '–°–Ω–∏–∫–µ—Ä—Å', price: 10, effect: { energy: 30 }, icon: 'üç´' },
            { id: 'water', name: '–í–æ–¥–∞ 0.5', price: 5, effect: { water: 50 }, icon: 'üíß' },
            { id: 'repair', name: '–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è', price: 40, effect: { bike: 100 }, icon: 'üîß' } // –ü–æ–ª–Ω—ã–π —Ä–µ–º–æ–Ω—Ç
        ];

        function openShop() {
            const list = document.getElementById('shop-list');
            list.innerHTML = '';
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'shop-item';
                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:24px">${item.icon}</span>
                        <div>
                            <div style="font-weight:bold">${item.name}</div>
                            <div style="font-size:12px; color:#aaa;">${item.price} PLN</div>
                        </div>
                    </div>
                    <button class="shop-btn" onclick="buyItem('${item.id}')">–ö–£–ü–ò–¢–¨</button>
                `;
                list.appendChild(div);
            });
            document.getElementById('shop-modal').style.display = 'flex';
        }

        function buyItem(id) {
            const item = items.find(i => i.id === id);
            if (state.cash >= item.price) {
                state.cash -= item.price;
                if (item.effect.energy) state.energy = Math.min(100, state.energy + item.effect.energy);
                if (item.effect.water) state.water = Math.min(100, state.water + item.effect.water);
                if (item.effect.bike) state.bike = Math.min(100, state.bike + item.effect.bike);
                showToast(`–ö—É–ø–ª–µ–Ω–æ: ${item.name}`, "success");
                updateUI();
                updateMainButtonState();
            } else {
                showToast("‚ùå –ù–µ—Ç –¥–µ–Ω–µ–≥!", "error");
            }
        }

        // --- UI –û–ë–ù–û–í–õ–ï–ù–ò–ï ---
        function updateUI() {
            document.getElementById('cash-display').innerText = state.cash + ' PLN';
            document.getElementById('lvl-display').innerText = 'LVL ' + state.lvl;
            
            document.getElementById('energy-bar').style.width = state.energy + '%';
            document.getElementById('energy-val').innerText = Math.floor(state.energy) + '%';
            
            document.getElementById('water-bar').style.width = state.water + '%';
            document.getElementById('water-val').innerText = Math.floor(state.water) + '%';
            
            document.getElementById('bike-bar').style.width = state.bike + '%';
            document.getElementById('bike-hp').innerText = Math.floor(state.bike) + '%';
            
            document.getElementById('gear-hp').innerText = Math.floor(state.gear) + '%';
        }

        function updateMainButtonState() {
            const btn = document.getElementById('main-btn');
            
            if (state.bike <= 0) {
                // –†–ï–ñ–ò–ú –†–ï–ú–û–ù–¢–ê
                btn.innerHTML = '<i class="fas fa-wrench"></i> –ß–ò–ù–ò–¢–¨ (–†—É–∫–∞–º–∏)';
                btn.classList.add('btn-repair');
            } else {
                // –û–ë–´–ß–ù–´–ô –†–ï–ñ–ò–ú
                btn.classList.remove('btn-repair');
                if (state.currentOrder) {
                    btn.innerHTML = '<i class="fas fa-bicycle"></i> –ö–†–£–¢–ò–¢–¨ –ü–ï–î–ê–õ–ò';
                } else {
                    btn.innerHTML = '<i class="fas fa-search"></i> –ù–ê–ô–¢–ò –ó–ê–ö–ê–ó';
                }
            }
        }

        function showToast(msg, type="info") {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            t.style.borderColor = type === 'error' ? 'red' : (type === 'success' ? '#10b981' : 'rgba(255,255,255,0.1)');
            setTimeout(() => t.style.display = 'none', 2000);
        }

        function saveGame() { localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }
        function loadGame() {
            const saved = localStorage.getItem(SAVE_KEY);
            if (saved) state = JSON.parse(saved);
        }

        // –°—Ç–∞—Ä—Ç!
        init();

    </script>
    <style>
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.5); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</body>
</html>
