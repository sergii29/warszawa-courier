<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warsaw Courier Tycoon</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin: 0; padding: 0; background: #000; color: #fff; font-family: sans-serif; overflow: hidden; user-select: none; -webkit-user-select: none; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        
        /* –ò–ù–¢–ï–†–§–ï–ô–° */
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2000; display: flex; flex-direction: column; justify-content: space-between; }
        .pointer { pointer-events: auto; }
        
        .top-bar { background: rgba(0,0,0,0.85); padding: 10px; border-bottom: 2px solid #00e676; display: flex; justify-content: space-between; }
        .btm-bar { background: rgba(0,0,0,0.9); padding: 10px; border-top: 1px solid #333; display: flex; gap: 5px; }
        .btn { flex: 1; padding: 12px; background: #222; border: 1px solid #444; color: #fff; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn:active { background: #444; }

        /* –û–ö–ù–ê */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: none; align-items: center; justify-content: center; pointer-events: auto; }
        .modal-box { background: #1e1e1e; width: 90%; max-width: 400px; padding: 20px; border-radius: 12px; border: 1px solid #444; max-height: 80vh; overflow-y: auto; }
        .close { float: right; font-size: 24px; cursor: pointer; color: #aaa; }
        
        /* –õ–û–ì–ò */
        #logs { position: absolute; top: 60px; right: 10px; width: 200px; pointer-events: none; display: flex; flex-direction: column; align-items: flex-end; }
        .log-msg { background: rgba(0,0,0,0.7); padding: 4px 8px; margin-bottom: 4px; border-right: 3px solid #00e676; font-size: 12px; color: #eee; }

        /* –ö–ê–†–¢–ê */
        .courier-icon { font-size: 20px; line-height: 20px; text-align: center; }
        .brand-icon { font-size: 24px; text-shadow: 0 0 5px #000; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="ui-layer">
        <div class="top-bar pointer">
            <div style="font-size: 18px;">üí∞ <span id="ui-bal" style="color:#00e676">0</span> PLN</div>
            <div style="font-size: 12px; color:#aaa">VER: MONOLITH 1.0</div>
        </div>
        
        <div id="logs"></div>

        <div class="btm-bar pointer">
            <button class="btn" onclick="openModal('shop')">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
            <button class="btn" onclick="openModal('fleet')">üë• –§–ª–æ—Ç</button>
            <button class="btn" onclick="openModal('salary')">üí∏ –î–æ—Ö–æ–¥</button>
            <button class="btn" onclick="openModal('bank')" style="color:#ffd700; border-color:#ffd700">üè¶ –ë–∞–Ω–∫</button>
        </div>
    </div>

    <div id="modal-shop" class="modal"><div class="modal-box" id="con-shop"></div></div>
    <div id="modal-fleet" class="modal"><div class="modal-box" id="con-fleet"></div></div>
    <div id="modal-salary" class="modal"><div class="modal-box" id="con-salary"></div></div>
    <div id="modal-bank" class="modal"><div class="modal-box" id="con-bank"></div></div>

    <script>
        // === 1. –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò ===
        const CONFIG = {
            restShare: 0.35, // 35% –æ—Ç —á–µ–∫–∞ - –Ω–∞—à–∞ –¥–æ–ª—è
            minOrder: 25,
            maxOrder: 150
        };

        const BRANDS = {
            'kebab': { name: 'Kebab King', cost: 3000, icon: 'üåØ' },
            'mcd':   { name: 'McDonalds',  cost: 5000, icon: 'üçî' },
            'star':  { name: 'Starbucks',  cost: 6000, icon: '‚òï' }
        };

        const LOCATIONS = [
            { id: 'kb_center', type:'kebab', name:'Kebab Center', lat:52.230, lng:21.015, price:1000 },
            { id: 'kb_wola',   type:'kebab', name:'Kebab Wola',   lat:52.235, lng:20.990, price:1200 },
            { id: 'mc_zlota',  type:'mcd',   name:'McD Zlote',    lat:52.231, lng:21.003, price:2500 },
            { id: 'st_old',    type:'star',  name:'Starbucks Old',lat:52.248, lng:21.012, price:3000 },
            { id: 'kb_praga',  type:'kebab', name:'Kebab Praga',  lat:52.250, lng:21.030, price:1100 }
        ];

        // === 2. –°–ò–°–¢–ï–ú–ê –°–û–•–†–ê–ù–ï–ù–ò–ô ===
        let state = {
            balance: 5000,
            inventory: { bike:0, bag:0, jacket:0 },
            licenses: {},
            branches: [],
            wage: 15,
            bank: { credit:0 }
        };
        let couriers = [];
        let map = null;

        function loadGame() {
            try {
                const save = localStorage.getItem('WAW_GAME_FINAL');
                if(save) state = JSON.parse(save);
                // –ó–∞—â–∏—Ç–∞ –æ—Ç —Å—Ç–∞—Ä—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π
                if(!state.inventory) state.inventory = { bike:0, bag:0, jacket:0 };
                if(!state.bank) state.bank = { credit:0 };
            } catch(e) { console.error("Save error", e); }
            updateUI();
        }

        function saveGame() {
            localStorage.setItem('WAW_GAME_FINAL', JSON.stringify(state));
            updateUI();
        }

        // === 3. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
        window.onload = function() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
            if(typeof L === 'undefined') {
                alert("–û–®–ò–ë–ö–ê: –ö–∞—Ä—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
                return;
            }

            // –ö–∞—Ä—Ç–∞
            map = L.map('map', { zoomControl: false }).setView([52.230, 21.012], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

            // –û—Ñ–∏—Å
            const officeIcon = L.divIcon({html:'üè¢', className:'brand-icon', iconSize:[30,30]});
            L.marker([52.2297, 21.0122], {icon:officeIcon}).addTo(map).bindTooltip("–û–§–ò–°");

            loadGame();
            drawMapPoints();
            checkFleet();
            
            // –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞
            setInterval(gameLoop, 1000); // 1 —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É
            log("–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞!");
        };

        // === 4. –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ===
        function gameLoop() {
            // –î–≤–∏–∂–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–æ–≤
            const targets = LOCATIONS.filter(l => state.branches.includes(l.id));

            couriers.forEach(c => {
                // –ï—Å–ª–∏ –Ω–µ—Ç —Ä–∞–±–æ—Ç—ã - —Å—Ç–æ–∏–º
                if(c.state === 'IDLE') {
                    if(targets.length > 0) {
                        const t = targets[Math.floor(Math.random() * targets.length)];
                        c.target = { lat: t.lat, lng: t.lng, type: 'REST' };
                        c.state = 'MOVING';
                    }
                }
                
                // –î–≤–∏–≥–∞–µ–º—Å—è
                if(c.state === 'MOVING') {
                    const dLat = c.target.lat - c.pos.lat;
                    const dLng = c.target.lng - c.pos.lng;
                    const dist = Math.sqrt(dLat*dLat + dLng*dLng);
                    const speed = 0.001; // –°–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è —Ç–µ—Å—Ç–∞

                    if(dist < speed) {
                        c.pos = c.target;
                        if(c.target.type === 'REST') {
                            c.state = 'WAITING';
                            c.wait = 3; // –ñ–¥–µ–º 3 —Å–µ–∫
                            updateMarker(c.marker, 'ü•°');
                        } else {
                            // –ü—Ä–∏–±—ã–ª—å
                            const order = Math.floor(Math.random() * (CONFIG.maxOrder - CONFIG.minOrder)) + CONFIG.minOrder;
                            const profit = Math.floor(order * CONFIG.restShare) - state.wage;
                            state.balance += profit;
                            saveGame();
                            log(`–ó–∞–∫–∞–∑: ${order}PLN. –ß–∏—Å—Ç—ã–º–∏: +${profit}`);
                            
                            c.state = 'IDLE';
                            updateMarker(c.marker, 'üö¥');
                        }
                    } else {
                        // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è
                        const ratio = speed / dist;
                        c.pos.lat += dLat * ratio;
                        c.pos.lng += dLng * ratio;
                        c.marker.setLatLng([c.pos.lat, c.pos.lng]);
                    }
                }

                // –ñ–¥–µ–º
                if(c.state === 'WAITING') {
                    c.wait--;
                    if(c.wait <= 0) {
                        const off = 0.01;
                        c.target = { 
                            lat: c.pos.lat + (Math.random()*off*2 - off), 
                            lng: c.pos.lng + (Math.random()*off*2 - off), 
                            type: 'CLIENT' 
                        };
                        c.state = 'MOVING';
                        updateMarker(c.marker, 'üéí');
                    }
                }
            });
        }

        function checkFleet() {
            const max = Math.min(state.inventory.bike, state.inventory.bag, state.inventory.jacket);
            while(couriers.length < max) {
                const mk = L.marker([52.2297, 21.0122], {icon: L.divIcon({html:'üö¥', className:'courier-icon'})}).addTo(map);
                couriers.push({ marker: mk, pos: {lat:52.2297, lng:21.0122}, state: 'IDLE', target: null, wait: 0 });
                log("–ö—É—Ä—å–µ—Ä –≤—ã—à–µ–ª –Ω–∞ —Å–º–µ–Ω—É!");
            }
        }

        function drawMapPoints() {
            LOCATIONS.forEach(loc => {
                if(state.branches.includes(loc.id)) {
                    const b = BRANDS[loc.type];
                    const ic = L.divIcon({html: b.icon, className:'brand-icon'});
                    L.marker([loc.lat, loc.lng], {icon:ic}).addTo(map);
                }
            });
        }

        // === 5. UI –§–£–ù–ö–¶–ò–ò ===
        function updateUI() {
            document.getElementById('ui-bal').innerText = state.balance;
        }

        function log(msg) {
            const box = document.getElementById('logs');
            box.innerHTML = `<div class="log-msg">${msg}</div>` + box.innerHTML;
            if(box.children.length > 5) box.lastChild.remove();
        }
        
        function updateMarker(m, h) { if(m.getElement()) m.getElement().innerHTML = h; }

        // === 6. –û–ö–ù–ê –ò –ü–û–ö–£–ü–ö–ò ===
        window.openModal = function(id) {
            document.querySelectorAll('.modal').forEach(m => m.style.display='none');
            document.getElementById('modal-'+id).style.display='flex';
            if(id==='shop') renderShop();
            if(id==='fleet') renderFleet();
            if(id==='salary') renderSalary();
            if(id==='bank') renderBank();
        }
        
        window.closeModals = function() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }

        // --- –ú–ê–ì–ê–ó–ò–ù ---
        function renderShop(tab='eq') {
            let h = `<span class="close" onclick="closeModals()">&times;</span><h3>–ú–∞–≥–∞–∑–∏–Ω</h3>`;
            h += `<div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="btn" onclick="renderShop('eq')">–°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ</button>
                <button class="btn" onclick="renderShop('lic')">–õ–∏—Ü–µ–Ω–∑–∏–∏</button>
                <button class="btn" onclick="renderShop('loc')">–¢–æ—á–∫–∏</button>
            </div>`;
            
            if(tab==='eq') {
                h += `<div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
                    <div style="background:#222; padding:5px; text-align:center;">üö≤ 1500<br><button class="btn" style="background:#00e676; color:#000" onclick="buyItem('bike',1500)">–ö—É–ø–∏—Ç—å</button></div>
                    <div style="background:#222; padding:5px; text-align:center;">üéí 150<br><button class="btn" style="background:#00e676; color:#000" onclick="buyItem('bag',150)">–ö—É–ø–∏—Ç—å</button></div>
                    <div style="background:#222; padding:5px; text-align:center;">üß• 200<br><button class="btn" style="background:#00e676; color:#000" onclick="buyItem('jacket',200)">–ö—É–ø–∏—Ç—å</button></div>
                </div>`;
            }
            if(tab==='lic') {
                for(let k in BRANDS) {
                    let b = BRANDS[k];
                    let has = state.licenses[k] ? '‚úÖ' : `<button class="btn" onclick="buyLic('${k}',${b.cost})">${b.cost}</button>`;
                    h += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${b.name}</span>${has}</div>`;
                }
            }
            if(tab==='loc') {
                LOCATIONS.forEach(l => {
                    if(!state.licenses[l.type]) return;
                    let has = state.branches.includes(l.id) ? '‚úÖ' : `<button class="btn" onclick="buyBranch('${l.id}',${l.price})">${l.price}</button>`;
                    h += `<div style="display:flex; justify-content:space-between; margin-bottom:5px; border-left:2px solid green; padding-left:5px;"><span>${l.name}</span>${has}</div>`;
                });
            }
            document.getElementById('con-shop').innerHTML = h;
        }

        // --- –î–ï–ô–°–¢–í–ò–Ø ---
        window.buyItem = (i,p) => { 
            if(state.balance>=p) { state.balance-=p; state.inventory[i]++; saveGame(); checkFleet(); renderShop('eq'); log("–ö—É–ø–ª–µ–Ω–æ!"); } 
        }
        window.buyLic = (k,p) => { 
            if(state.balance>=p) { state.balance-=p; state.licenses[k]=true; saveGame(); renderShop('lic'); log("–õ–∏—Ü–µ–Ω–∑–∏—è –∫—É–ø–ª–µ–Ω–∞!"); } 
        }
        window.buyBranch = (id,p) => { 
            if(state.balance>=p) { state.balance-=p; state.branches.push(id); saveGame(); drawMapPoints(); renderShop('loc'); log("–¢–æ—á–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞!"); } 
        }

        // --- –û–°–¢–ê–õ–¨–ù–´–ï –û–ö–ù–ê ---
        function renderFleet() {
            document.getElementById('con-fleet').innerHTML = `<span class="close" onclick="closeModals()">&times;</span><h3>–§–ª–æ—Ç</h3>
            <p>–ê–∫—Ç–∏–≤–Ω—ã–µ: <b style="color:#00e676">${couriers.length}</b></p>
            <p>–°–∫–ª–∞–¥: üö≤${state.inventory.bike} üéí${state.inventory.bag} üß•${state.inventory.jacket}</p>
            <button class="btn" style="background:red" onclick="if(confirm('–°–±—Ä–æ—Å?')){localStorage.clear();location.reload();}">–°–ë–†–û–°</button>`;
        }
        function renderSalary() {
            document.getElementById('con-salary').innerHTML = `<span class="close" onclick="closeModals()">&times;</span><h3>–î–æ—Ö–æ–¥</h3>
            <h1>${state.wage} PLN</h1>
            <input type="range" min="0" max="50" value="${state.wage}" style="width:100%" oninput="state.wage=parseInt(this.value); renderSalary(); saveGame();">
            <p>–í–∞—à–∞ –≤—ã–ø–ª–∞—Ç–∞ –∫—É—Ä—å–µ—Ä—É.</p>`;
        }
        function renderBank() {
            document.getElementById('con-bank').innerHTML = `<span class="close" onclick="closeModals()">&times;</span><h3>–ë–∞–Ω–∫</h3>
            <h1>${state.balance}</h1>
            <p>–ö—Ä–µ–¥–∏—Ç: <b style="color:red">${state.bank.credit}</b></p>
            <button class="btn" onclick="bankOp(5000)">–í–∑—è—Ç—å 5–∫</button> <button class="btn" onclick="bankOp(-5000)">–í–µ—Ä–Ω—É—Ç—å 5–∫</button>`;
        }
        window.bankOp = (v) => {
            if(v>0) { state.balance+=v; state.bank.credit+=v; }
            if(v<0 && state.balance>=-v) { state.balance+=v; state.bank.credit+=v; }
            saveGame(); renderBank();
        }

    </script>
</body>
</html>
