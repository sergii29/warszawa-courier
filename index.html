<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warszawa Courier: DIAMOND</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --bg: #000000;
            --glass: rgba(20, 20, 20, 0.85);
            --border: rgba(255, 255, 255, 0.1);
            --gold: #FFD700;
            --neon: #00FF9D;
            --danger: #FF0055;
            --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; font-family: var(--font); }
        body { margin: 0; padding: 0; background: var(--bg); color: white; overflow: hidden; height: 100vh; width: 100vw; }

        /* –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò / –û–®–ò–ë–û–ö */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #debug-log { font-size: 10px; color: #555; margin-top: 20px; font-family: monospace; max-width: 90%; text-align: center; }

        /* –ò–ù–¢–ï–†–§–ï–ô–° */
        #ui-top {
            position: absolute; top: 0; left: 0; width: 100%; height: 140px;
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%);
            z-index: 100; padding: 15px;
            display: flex; flex-direction: column; gap: 10px;
        }

        .stat-row { display: flex; justify-content: space-between; align-items: flex-end; }
        .stat-box { display: flex; flex-direction: column; }
        .label { font-size: 10px; color: #777; letter-spacing: 1px; text-transform: uppercase; }
        .value { font-size: 28px; font-weight: 800; }
        .gold-text { color: var(--gold); text-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }

        .bars { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 5px; }
        .bar-bg { background: #222; height: 4px; border-radius: 2px; width: 100%; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.3s; }

        /* –ò–ì–†–û–í–û–ô –ú–ò–† */
        #game-world {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: 1;
        }

        .ent { 
            position: absolute; width: 40px; height: 40px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 24px; transition: top 0.2s, left 0.2s; 
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
        }
        .obs { 
            background: #111; border: 1px solid #333; border-radius: 8px; 
            box-shadow: inset 0 0 10px #000;
            width: 38px; height: 38px;
        }
        .police { z-index: 10; font-size: 26px; transition: top 0.8s linear, left 0.8s linear; }
        
        #player { 
            z-index: 20; background: var(--gold); color: black; border-radius: 50%;
            font-size: 22px; box-shadow: 0 0 20px var(--gold);
        }

        /* –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò –ú–ï–ù–Æ */
        #ui-bot {
            position: absolute; bottom: 0; left: 0; width: 100%; 
            background: rgba(10, 10, 12, 0.95);
            border-top: 1px solid var(--border); backdrop-filter: blur(10px);
            z-index: 100; padding: 20px; border-radius: 24px 24px 0 0;
            display: flex; flex-direction: column; align-items: center;
        }

        .btn-main {
            background: var(--gold); color: black; font-weight: 900;
            padding: 18px 0; width: 100%; border-radius: 16px; border: none;
            font-size: 16px; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.2);
            margin-bottom: 10px;
        }

        .d-pad { display: grid; grid-template-columns: 70px 70px 70px; gap: 5px; display: none; }
        .pad-btn {
            background: #1a1a1a; border: 1px solid #333; border-radius: 12px;
            height: 60px; display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: #666; 
        }
        .pad-btn:active { background: #333; color: white; transform: scale(0.95); }

        #sidebar {
            position: fixed; top: 0; left: -100%; width: 85%; height: 100%;
            background: #050505; z-index: 1000; padding: 30px;
            transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            border-right: 1px solid #222; box-shadow: 100px 0 100px rgba(0,0,0,0.8);
        }
        #sidebar.open { left: 0; }

        .shop-row {
            background: #111; padding: 15px; border-radius: 12px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #222;
        }

        #menu-toggle { position: absolute; top: 130px; left: 20px; z-index: 90; opacity: 0.5; font-size: 24px; }
        #toast { position: fixed; top: 150px; left: 50%; transform: translateX(-50%); background: #222; padding: 10px 20px; border-radius: 20px; z-index: 5000; border: 1px solid #444; display: none; font-size: 12px;}

        /* –°–ò–†–ï–ù–ê */
        @keyframes flash { 0%, 100% { box-shadow: inset 0 0 0 transparent; } 50% { box-shadow: inset 0 0 100px rgba(255,0,50,0.3); } }
        .alarm { animation: flash 1s infinite; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <div style="margin-top: 20px; font-weight: bold; letter-spacing: 2px;">–ó–ê–ì–†–£–ó–ö–ê</div>
    <div id="debug-log">Init...</div>
</div>

<div id="ui-top">
    <div class="stat-row">
        <div class="stat-box">
            <span class="label">–ù–∞–ª–∏—á–Ω—ã–µ</span>
            <span class="value" id="d-cash">0.00</span>
        </div>
        <div class="stat-box" style="align-items: flex-end;">
            <span class="label">–ë–∞–Ω–∫</span>
            <span class="value gold-text" id="d-bank">0.00</span>
        </div>
    </div>
    <div class="bars">
        <div><div class="label" style="color:#FFAA00">EDA</div><div class="bar-bg"><div id="b-en" class="bar-fill" style="background:#FFAA00; width:100%"></div></div></div>
        <div><div class="label" style="color:#00AAFF">H2O</div><div class="bar-bg"><div id="b-wat" class="bar-fill" style="background:#00AAFF; width:100%"></div></div></div>
        <div><div class="label" style="color:#FF0055">HP</div><div class="bar-bg"><div id="b-hp" class="bar-fill" style="background:#FF0055; width:100%"></div></div></div>
    </div>
</div>

<div id="game-world">
    <div id="player" class="ent">üö≤</div>
</div>

<div id="menu-toggle" onclick="toggleMenu()">‚ò∞</div>

<div id="sidebar">
    <h2 style="margin: 0 0 30px 0; color: white;">COURIER <span style="color:var(--gold)">OS</span></h2>
    <div class="label">ID: <span id="uid-disp">...</span></div>
    <br>
    <div class="label">–ú–ê–ì–ê–ó–ò–ù</div>
    <div id="shop-list"></div>
    <br>
    <div class="shop-row" onclick="bankAll()" style="border-color: var(--gold)">
        <span>–ü–æ–ª–æ–∂–∏—Ç—å –≤ –±–∞–Ω–∫</span>
        <span style="color:var(--gold)">SAFE</span>
    </div>
    <div class="shop-row" onclick="repair()" style="border-color: var(--danger)">
        <span>–†–µ–º–æ–Ω—Ç</span>
        <span style="color:var(--danger)">50 PLN</span>
    </div>
</div>
<div id="overlay" onclick="toggleMenu()" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:900; display:none;"></div>

<div id="toast">Msg</div>

<div id="ui-bot">
    <div id="msg" style="color:#666; margin-bottom:15px; font-size:12px">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    <button id="btn-go" class="btn-main" onclick="startShift()">–ù–ê–ß–ê–¢–¨ –†–ê–ë–û–¢–£</button>
    <div id="btn-end" style="color: var(--danger); font-size: 12px; margin-top: 15px; display:none; text-decoration: underline;" onclick="endShift()">–ó–ê–ö–û–ù–ß–ò–¢–¨ –°–ú–ï–ù–£</div>

    <div id="joy" class="d-pad">
        <div class="pad-btn" style="grid-column:2" onclick="mv(0,-1)">‚ñ≤</div>
        <div class="pad-btn" style="grid-column:1; grid-row:2" onclick="mv(-1,0)">‚óÄ</div>
        <div class="pad-btn" style="grid-column:2; grid-row:2" onclick="mv(0,1)">‚ñº</div>
        <div class="pad-btn" style="grid-column:3; grid-row:2" onclick="mv(1,0)">‚ñ∂</div>
    </div>
</div>

<script>
    // --- –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö ---
    function log(m) { 
        console.log(m);
        document.getElementById('debug-log').innerText += "\n> " + m.toString().slice(0,50);
    }
    window.onerror = function(msg, url, line) {
        log("ERR: " + msg);
        return false;
    };

    // --- CONFIG ---
    const STEP = 40;
    const SAVE_KEY = "WARSZAWA_LOCAL_V2"; 
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    let st = { cash: 0, bank: 0, lvl: 1, en: 100, wat: 100, hp: 100, x: 40, y: 120 };
    let sys = { active: false, obs: [], pol: [], job: null, w: 0, h: 0, offlineMode: false };
    let loops = {};
    let dbRef = null;
    let uid = "user_default";

    // --- INIT ---
    window.onload = async function() {
        try {
            // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
            const fbConfig = {
                apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
                authDomain: "warszawa-courier.firebaseapp.com",
                databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
                projectId: "warszawa-courier",
                appId: "1:295860613508:web:86fe8364377d6875612dd1"
            };
            
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(fbConfig);
                log("Firebase Linked");
            } else {
                throw new Error("No Firebase Lib");
            }

            // 2. –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (Telegram –∏–ª–∏ LocalStorage)
            const tg = window.Telegram?.WebApp;
            if(tg) tg.expand();
            
            if(tg?.initDataUnsafe?.user?.id) {
                uid = "tg_" + tg.initDataUnsafe.user.id;
                log("ID: Telegram");
            } else {
                let savedId = localStorage.getItem('w_uid');
                if(!savedId) {
                    savedId = "dev_" + Math.random().toString(36).substr(2,6);
                    localStorage.setItem('w_uid', savedId);
                }
                uid = savedId;
                log("ID: Local");
            }
            document.getElementById('uid-disp').innerText = uid;

            // 3. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            dbRef = firebase.database().ref('users/' + uid);
            
            // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å —Ç–∞–π–º–∞—É—Ç–æ–º (–µ—Å–ª–∏ –Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞)
            const snap = await Promise.race([
                dbRef.once('value'),
                new Promise((_, rej) => setTimeout(() => rej("Timeout"), 3000))
            ]).catch(e => {
                log("Offline Mode Active");
                sys.offlineMode = true;
                return null;
            });

            if(snap && snap.exists()) {
                st = snap.val();
                log("Data Loaded (Cloud)");
            } else if (sys.offlineMode) {
                // –ï—Å–ª–∏ –æ—Ñ—Ñ–ª–∞–π–Ω, –≥—Ä—É–∑–∏–º –∏–∑ LocalStorage
                const localData = localStorage.getItem(SAVE_KEY);
                if(localData) {
                    st = JSON.parse(localData);
                    log("Data Loaded (Local)");
                }
            } else {
                save(); // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –≤ –æ–±–ª–∞–∫–µ
                log("New User Created");
            }

            // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
            render();
            updateDims();
            setTimeout(() => {
                document.getElementById('loader').style.opacity = 0;
                setTimeout(()=>document.getElementById('loader').style.display='none', 500);
            }, 1000);

        } catch (e) {
            log("CRITICAL: " + e.message);
            // –î–∞–∂–µ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä—É
            document.getElementById('debug-log').style.color = 'red';
            setTimeout(() => {
                document.getElementById('loader').style.display = 'none'; // –í—Å–µ —Ä–∞–≤–Ω–æ –ø—É—Å–∫–∞–µ–º
            }, 3000);
        }
    };

    function save() {
        // –î–≤–æ–π–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: LocalStorage + Cloud
        localStorage.setItem(SAVE_KEY, JSON.stringify(st));
        if(!sys.offlineMode && dbRef) {
            dbRef.update(st).catch(() => {
                sys.offlineMode = true; // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –æ—Ñ—Ñ–ª–∞–π–Ω
                log("Write Err -> Offline");
            });
        }
    }

    // --- GAMEPLAY ---
    function startShift() {
        if(st.en < 10 || st.hp < 10) return msg("–ù—É–∂–µ–Ω —Ä–µ–º–æ–Ω—Ç –∏–ª–∏ –µ–¥–∞!", true);
        
        sys.active = true;
        document.getElementById('btn-go').style.display = 'none';
        document.getElementById('joy').style.display = 'grid';
        document.getElementById('btn-end').style.display = 'block';
        
        spawnWorld();
        newJob();
        
        if(loops.pol) clearInterval(loops.pol);
        loops.pol = setInterval(policeAI, 800);
    }

    function endShift() {
        sys.active = false;
        clearInterval(loops.pol);
        document.getElementById('game-world').innerHTML = '<div id="player" class="ent">üö≤</div>'; // –û—á–∏—Å—Ç–∫–∞
        sys.obs = []; sys.pol = []; sys.job = null;
        renderPlayer();
        
        document.getElementById('btn-go').style.display = 'block';
        document.getElementById('joy').style.display = 'none';
        document.getElementById('btn-end').style.display = 'none';
        document.getElementById('msg').innerText = "–°–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞";
        document.body.classList.remove('alarm');
    }

    // --- ENGINE ---
    function updateDims() {
        const el = document.getElementById('game-world');
        sys.w = el.offsetWidth; sys.h = el.offsetHeight;
    }

    function spawnWorld() {
        // –°–ø–∞–≤–Ω —Å—Ç–µ–Ω
        for(let i=0; i<12; i++) {
            let p = getPos(false);
            if(p) {
                mkDiv('div', 'ent obs', p.x, p.y, '');
                sys.obs.push(p);
            }
        }
        // –°–ø–∞–≤–Ω –ø–æ–ª–∏—Ü–∏–∏
        for(let i=0; i<3; i++) {
            let p = getPos(true);
            if(p) {
                let el = mkDiv('div', 'ent police', p.x, p.y, 'üöì');
                sys.pol.push({x:p.x, y:p.y, el:el});
            }
        }
        renderPlayer();
    }

    function getPos(checkObs) {
        let cols = Math.floor(sys.w/STEP), rows = Math.floor(sys.h/STEP);
        for(let k=0; k<50; k++) {
            let x = Math.floor(Math.random()*(cols-1))*STEP;
            let y = Math.floor(Math.random()*(rows-1))*STEP;
            if(Math.abs(x-st.x)+Math.abs(y-st.y) < 100) continue; // –ù–µ –Ω–∞ –∏–≥—Ä–æ–∫–µ
            
            let wall = false;
            if(checkObs && sys.obs.some(o => Math.abs(o.x-x)+Math.abs(o.y-y)<10)) wall=true;
            if(!wall) return {x,y};
        }
        return null;
    }

    function mv(dx, dy) {
        if(!sys.active) return;
        let nx = st.x + dx*STEP;
        let ny = st.y + dy*STEP;

        // –ì—Ä–∞–Ω–∏—Ü—ã
        if(nx<0 || ny<0 || nx>sys.w-30 || ny>sys.h-30) return;
        // –°—Ç–µ–Ω—ã
        if(sys.obs.some(o => Math.abs(o.x-nx)+Math.abs(o.y-ny)<10)) return;

        st.x = nx; st.y = ny;
        st.en -= 0.5; st.wat -= 0.3; st.hp -= 0.1;
        
        if(st.en<=0 || st.wat<=0) endShift();
        
        renderPlayer();
        checkJob();
        save(); // –ê–≤—Ç–æ—Å–µ–π–≤ —à–∞–≥–∞
    }

    function policeAI() {
        let alertMode = false;
        sys.pol.forEach(p => {
            let dist = Math.abs(st.x - p.x) + Math.abs(st.y - p.y);
            let mx = 0, my = 0;

            if(dist < 150) { // –ê–≥—Ä–µ—Å—Å–∏—è
                alertMode = true;
                if(p.x < st.x) mx = STEP; else if(p.x > st.x) mx = -STEP;
                if(Math.abs(st.y - p.y) > Math.abs(st.x - p.x)) {
                    mx = 0;
                    if(p.y < st.y) my = STEP; else if(p.y > st.y) my = -STEP;
                }
            } else { // –ü–∞—Ç—Ä—É–ª—å
                let r = Math.floor(Math.random()*4);
                if(r==0) mx=STEP; if(r==1) mx=-STEP; if(r==2) my=STEP; if(r==3) my=-STEP;
            }

            let nx = p.x + mx, ny = p.y + my;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–ª–∏–∑–∏–π –∫–æ–ø–∞
            if(nx>=0 && ny>=0 && nx<sys.w && ny<sys.h && !sys.obs.some(o=>Math.abs(o.x-nx)+Math.abs(o.y-ny)<10)) {
                p.x = nx; p.y = ny;
                p.el.style.left = nx+'px'; p.el.style.top = ny+'px';
            }
            
            // –ü–æ–∏–º–∫–∞
            if(Math.abs(st.x-p.x)+Math.abs(st.y-p.y) < 20) {
                arrest();
            }
        });
        
        if(alertMode) document.body.classList.add('alarm');
        else document.body.classList.remove('alarm');
    }
    
    function arrest() {
        st.cash -= 100;
        msg("–ê–†–ï–°–¢! -100 PLN", true);
        st.x=40; st.y=120;
        endShift();
        save(); render();
    }

    // --- JOBS ---
    function newJob() {
        if(!sys.active) return;
        let p = getPos(true);
        if(!p) p={x:100,y:100};
        
        let el = mkDiv('div', 'ent', p.x, p.y, 'üì¶');
        el.style.color = '#00FF9D'; el.style.animation = 'spin 2s infinite';
        sys.job = {x:p.x, y:p.y, el:el, pay: 15 + (st.lvl*2)};
        document.getElementById('msg').innerText = "–î–æ—Å—Ç–∞–≤—å –ø–æ—Å—ã–ª–∫—É!";
    }

    function checkJob() {
        if(!sys.job) return;
        if(Math.abs(st.x - sys.job.x) + Math.abs(st.y - sys.job.y) < 20) {
            sys.job.el.remove();
            st.cash += sys.job.pay;
            st.lvl += 0.2;
            msg(`+${sys.job.pay.toFixed(0)} PLN`, false);
            sys.job = null;
            render(); save();
            setTimeout(newJob, 1000);
        }
    }

    // --- UI & HELPERS ---
    function render() {
        document.getElementById('d-cash').innerText = st.cash.toFixed(2);
        document.getElementById('d-bank').innerText = st.bank.toFixed(2);
        document.getElementById('b-en').style.width = st.en + '%';
        document.getElementById('b-wat').style.width = st.wat + '%';
        document.getElementById('b-hp').style.width = st.hp + '%';

        let p1 = Math.ceil(20 * (1+st.lvl*0.1));
        let p2 = Math.ceil(15 * (1+st.lvl*0.1));
        
        document.getElementById('shop-list').innerHTML = `
            <div class="shop-row" onclick="buy('en',30,${p1})"><span>–ï–¥–∞ (+30)</span><span class="gold-text">${p1} PLN</span></div>
            <div class="shop-row" onclick="buy('wat',40,${p2})"><span>–í–æ–¥–∞ (+40)</span><span class="gold-text">${p2} PLN</span></div>
        `;
    }

    function renderPlayer() {
        let p = document.getElementById('player');
        p.style.left = st.x + 'px'; p.style.top = st.y + 'px';
    }

    function mkDiv(tag, cls, x, y, txt) {
        let d = document.createElement(tag); d.className = cls;
        d.style.left=x+'px'; d.style.top=y+'px'; d.innerText=txt;
        document.getElementById('game-world').appendChild(d); return d;
    }

    function buy(type, val, cost) {
        if(st.cash >= cost) {
            st.cash -= cost;
            if(type=='en') st.en = Math.min(100, st.en+val);
            if(type=='wat') st.wat = Math.min(100, st.wat+val);
            render(); save();
        } else msg("–ù–µ—Ç –¥–µ–Ω–µ–≥!", true);
    }
    
    function bankAll() {
        if(st.cash>0) { st.bank+=st.cash; st.cash=0; render(); save(); }
    }
    
    function repair() {
        if(st.cash>=50) { st.cash-=50; st.hp=100; render(); save(); }
    }

    function msg(txt, isErr) {
        let t = document.getElementById('toast');
        t.innerText = txt; t.style.color = isErr ? 'red' : 'white';
        t.style.display = 'block';
        setTimeout(()=>t.style.display='none', 2000);
    }
    
    function toggleMenu() {
        document.getElementById('sidebar').classList.toggle('open');
        let ov = document.getElementById('overlay');
        ov.style.display = ov.style.display=='block'?'none':'block';
    }
</script>
</body>
</html>
