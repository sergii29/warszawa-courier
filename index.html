<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Warsaw Night Courier</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0a; color: #fff; overflow: hidden; height: 100vh; }
        
        #map { height: 100%; width: 100%; position: absolute; top: 0; left: 0; z-index: 1; }
        .leaflet-tile { filter: brightness(0.3) saturate(0.6) contrast(1.3) !important; }
        
        .ui-layer { position: absolute; z-index: 100; pointer-events: none; width: 100%; height: 100%; }
        .ui-layer > * { pointer-events: auto; }
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è */
        .top-panel { position: absolute; top: 0; left: 0; right: 0; padding: 10px; background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent); }
        
        .balance-box { background: rgba(0,0,0,0.8); padding: 6px 15px; border-radius: 15px; border: 1px solid #00e676; display: inline-block; margin-bottom: 8px; }
        .balance-amount { font-size: 18px; font-weight: bold; color: #00e676; }
        
        .stats-grid { display: flex; gap: 8px; justify-content: center; }
        .stat-card { background: rgba(20,20,20,0.9); padding: 8px 12px; border-radius: 12px; text-align: center; min-width: 70px; border: 2px solid; transition: all 0.3s; }
        .stat-card.energy { border-color: #ffcc00; }
        .stat-card.water { border-color: #00ccff; }
        .stat-card.mood { border-color: #d500f9; }
        .stat-card.critical { animation: pulse-red 1s infinite; border-color: #ff3d00 !important; }
        
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 5px #ff3d00; } 50% { box-shadow: 0 0 20px #ff3d00; } }
        
        .stat-icon { font-size: 16px; margin-bottom: 2px; }
        .stat-value { font-size: 14px; font-weight: bold; }
        .stat-bar { width: 100%; height: 3px; background: #333; border-radius: 2px; margin-top: 4px; overflow: hidden; }
        .stat-fill { height: 100%; transition: width 0.3s; }
        
        /* –ö–ù–û–ü–ö–ò –°–í–ï–†–•–£ ‚Äî –ú–ê–õ–ï–ù–¨–ö–ò–ï */
        .action-bar { 
            position: absolute; 
            top: 115px; 
            left: 10px; 
            right: 10px; 
            display: flex; 
            gap: 6px; 
            z-index: 100;
        }
        
        .action-btn-small { 
            flex: 1; 
            padding: 8px 4px; 
            border: none; 
            border-radius: 10px; 
            font-size: 10px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            min-height: 50px;
        }
        
        .action-btn-small:active { transform: scale(0.95); }
        
        .btn-water { background: linear-gradient(135deg, #00ccff, #0099cc); color: #000; }
        .btn-energy { background: linear-gradient(135deg, #ffcc00, #ff9900); color: #000; }
        .btn-find { background: linear-gradient(135deg, #00e676, #00c853); color: #000; }
        .btn-shop { background: linear-gradient(135deg, #e91e63, #c2185b); color: #fff; }
        .btn-stats { background: linear-gradient(135deg, #9c27b0, #7b1fa2); color: #fff; }
        
        .action-icon { font-size: 16px; }
        .action-text { font-size: 9px; }
        .action-cost { font-size: 8px; opacity: 0.9; }
        
        /* –ü–∞–Ω–µ–ª–∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
        .center-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            background: rgba(15,15,15,0.98);
            border-radius: 25px;
            padding: 20px;
            border: 2px solid #00e676;
            z-index: 150;
            display: none;
        }
        
        .center-panel.active { display: block; animation: popIn 0.3s; }
        
        @keyframes popIn { from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        
        .center-title { font-size: 20px; font-weight: bold; margin-bottom: 8px; text-align: center; }
        .center-subtitle { color: #888; font-size: 12px; margin-bottom: 15px; text-align: center; }
        
        /* –ü–∞–Ω–µ–ª—å –¥–æ—Å—Ç–∞–≤–∫–∏ ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è —Å–Ω–∏–∑—É */
        .delivery-panel-compact {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(15,15,15,0.95);
            border-radius: 20px;
            padding: 15px;
            border: 1px solid #333;
            display: none;
            z-index: 100;
        }
        
        .delivery-panel-compact.active { display: block; }
        
        .delivery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .delivery-title { font-size: 16px; font-weight: bold; }
        .delivery-status { font-size: 12px; color: #00e676; }
        
        .progress-line { height: 6px; background: #333; border-radius: 3px; overflow: hidden; margin-bottom: 10px; }
        .progress-fill-line { height: 100%; background: linear-gradient(90deg, #00e676, #00c853); width: 0%; transition: width 0.5s; }
        
        .delivery-buttons { display: flex; gap: 10px; }
        .btn-small { flex: 1; padding: 12px; border: none; border-radius: 12px; font-size: 13px; font-weight: bold; cursor: pointer; }
        
        /* –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω */
        .game-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .game-overlay.active { display: flex; }
        
        .game-box {
            background: #1a1a1a;
            border-radius: 25px;
            padding: 25px;
            width: 90%;
            max-width: 350px;
            border: 2px solid #2979ff;
            text-align: center;
        }
        
        .game-title { font-size: 22px; font-weight: bold; margin-bottom: 15px; color: #2979ff; }
        .game-road-big { 
            width: 100%; 
            height: 200px; 
            background: linear-gradient(to bottom, #0f0f0f, #1a1a1a); 
            border-radius: 15px; 
            position: relative; 
            overflow: hidden; 
            margin-bottom: 20px;
            border: 3px solid #444;
        }
        
        .lane-big { position: absolute; width: 100%; height: 33.33%; border-bottom: 2px dashed #555; }
        .player-bike-big { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); font-size: 40px; transition: top 0.1s; z-index: 10; }
        .obstacle-big { position: absolute; right: -50px; font-size: 35px; animation: moveLeftBig 2s linear; z-index: 5; }
        
        @keyframes moveLeftBig { from { right: -50px; } to { right: 110%; } }
        
        .game-hint-big { color: #888; margin-bottom: 15px; }
        .game-controls { display: flex; gap: 20px; justify-content: center; }
        .game-control-btn { 
            width: 100px; 
            height: 100px; 
            border-radius: 50%; 
            border: 3px solid; 
            background: transparent; 
            font-size: 40px; 
            cursor: pointer;
            transition: all 0.1s;
        }
        
        .game-control-btn.up { border-color: #2979ff; color: #2979ff; }
        .game-control-btn.down { border-color: #7c4dff; color: #7c4dff; }
        .game-control-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }
        
        /* –ü–∞–Ω–µ–ª—å –±—ã—Å—Ç—Ä–æ–π –ø–∞—É–∑—ã/–º–∞–≥–∞–∑–∏–Ω–∞ */
        .quick-rest-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(20,20,20,0.98);
            padding: 25px;
            border-radius: 25px;
            border: 2px solid #00e676;
            z-index: 300;
            width: 90%;
            max-width: 350px;
            transition: transform 0.3s;
            text-align: center;
        }
        
        .quick-rest-panel.active { transform: translate(-50%, -50%) scale(1); }
        
        .rest-title { font-size: 22px; font-weight: bold; margin-bottom: 15px; color: #00e676; }
        
        .rest-option { 
            background: rgba(40,40,40,0.9); 
            padding: 15px; 
            border-radius: 15px; 
            margin-bottom: 10px; 
            border: 2px solid #444;
            cursor: pointer;
        }
        
        .rest-option:hover { border-color: #00e676; }
        
        .overlay-backdrop {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 290;
            display: none;
        }
        
        .overlay-backdrop.active { display: block; }
        
        /* –°–æ–±—ã—Ç–∏–µ */
        .event-overlay { 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.9); 
            z-index: 250; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
        }
        
        .event-overlay.active { display: flex; }
        
        .event-card { 
            background: #1a1a1a; 
            border-radius: 25px; 
            padding: 30px; 
            max-width: 350px; 
            width: 100%; 
            border: 2px solid #ff9100; 
            text-align: center; 
        }
        
        .event-icon { font-size: 60px; margin-bottom: 15px; }
        .event-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .event-text { color: #aaa; margin-bottom: 20px; line-height: 1.5; }
        .event-choices { display: flex; flex-direction: column; gap: 10px; }
        
        /* –ü–∏—Ç-—Å—Ç–æ–ø */
        .pitstop-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 220;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .pitstop-overlay.active { display: flex; }
        
        .pitstop-card {
            background: #1a1a1a;
            border-radius: 25px;
            padding: 25px;
            max-width: 350px;
            width: 100%;
            border: 2px solid #00e676;
            text-align: center;
        }
        
        .pitstop-title { font-size: 24px; font-weight: bold; margin-bottom: 20px; }
        .pitstop-items { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .pitstop-item {
            background: rgba(40,40,40,0.9);
            padding: 15px;
            border-radius: 15px;
            border: 2px solid #444;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .pitstop-item:hover { border-color: #00e676; }
        .pitstop-item-header { display: flex; align-items: center; gap: 10px; font-size: 18px; margin-bottom: 5px; }
        .pitstop-item-desc { font-size: 12px; color: #888; }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .toast { 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background: rgba(0,0,0,0.95); 
            padding: 20px 30px; 
            border-radius: 20px; 
            border: 2px solid #00e676; 
            color: #00e676; 
            font-weight: bold; 
            opacity: 0; 
            pointer-events: none; 
            transition: opacity 0.3s; 
            z-index: 400; 
            text-align: center; 
            max-width: 300px; 
        }
        
        .toast.show { opacity: 1; }
        .toast.error { border-color: #ff3d00; color: #ff3d00; }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.2s; margin-bottom: 8px; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: linear-gradient(135deg, #00e676, #00c853); color: #000; }
        .btn-warning { background: linear-gradient(135deg, #ff9100, #ff6d00); color: #000; }
        .btn-danger { background: linear-gradient(135deg, #ff3d00, #dd2c00); color: #fff; }
        
        /* –ú–∞—Ä–∫–µ—Ä—ã */
        .marker-courier { background: #00e676; width: 24px; height: 24px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 0 20px #00e676; animation: pulse-green 2s infinite; }
        .marker-dest { background: #ff3d00; width: 30px; height: 30px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 0 25px #ff3d00; }
        .marker-pitstop { background: #2979ff; width: 28px; height: 28px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 0 15px #2979ff; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        
        @keyframes pulse-green { 0%, 100% { box-shadow: 0 0 10px #00e676; } 50% { box-shadow: 0 0 25px #00e676; } }
        
        .route-tag { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px; margin-left: 5px; }
        .tag-fast { background: #ff3d00; color: #fff; }
        .tag-safe { background: #00e676; color: #000; }
        .tag-profit { background: #ffd600; color: #000; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="ui-layer">
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
        <div class="top-panel">
            <div class="balance-box">
                <div class="balance-amount" id="balance">50 PLN</div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card energy" id="energy-card">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-value" id="energy-val">100</div>
                    <div class="stat-bar"><div class="stat-fill" id="energy-bar" style="width: 100%"></div></div>
                </div>
                <div class="stat-card water" id="water-card">
                    <div class="stat-icon">üíß</div>
                    <div class="stat-value" id="water-val">100</div>
                    <div class="stat-bar"><div class="stat-fill" id="water-bar" style="width: 100%"></div></div>
                </div>
                <div class="stat-card mood" id="mood-card">
                    <div class="stat-icon">üòé</div>
                    <div class="stat-value" id="mood-val">100</div>
                    <div class="stat-bar"><div class="stat-fill" id="mood-bar" style="width: 100%"></div></div>
                </div>
            </div>
        </div>
        
        <!-- –ö–ù–û–ü–ö–ò –°–í–ï–†–•–£ -->
        <div class="action-bar" id="action-bar">
            <button class="action-btn-small btn-water" onclick="quickRefill('water')">
                <span class="action-icon">üíß</span>
                <span class="action-text">–í–æ–¥–∞</span>
                <span class="action-cost">3 PLN</span>
            </button>
            <button class="action-btn-small btn-energy" onclick="quickRefill('energy')">
                <span class="action-icon">‚ö°</span>
                <span class="action-text">–ö–æ—Ñ–µ</span>
                <span class="action-cost">5 PLN</span>
            </button>
            <button class="action-btn-small btn-find" onclick="findOrder()">
                <span class="action-icon">üîç</span>
                <span class="action-text">–ó–ê–ö–ê–ó</span>
            </button>
            <button class="action-btn-small btn-shop" onclick="openShop()">
                <span class="action-icon">üõí</span>
                <span class="action-text">–ú–∞–≥–∞–∑</span>
            </button>
            <button class="action-btn-small btn-stats" onclick="showStats()">
                <span class="action-icon">üìä</span>
                <span class="action-text">–°—Ç–∞—Ç</span>
            </button>
        </div>
        
        <!-- –í–´–ë–û–† –ú–ê–†–®–†–£–¢–ê -->
        <div class="center-panel" id="route-panel">
            <div class="center-title">üó∫Ô∏è –í—ã–±–µ—Ä–∏ –º–∞—Ä—à—Ä—É—Ç</div>
            <div class="center-subtitle">–ö–∞–∂–¥—ã–π –ø—É—Ç—å –∏–º–µ–µ—Ç —Å–≤–æ–∏ —Ä–∏—Å–∫–∏ –∏ –Ω–∞–≥—Ä–∞–¥—ã</div>
            <div id="route-options"></div>
        </div>
        
        <!-- –ü–ê–ù–ï–õ–¨ –î–û–°–¢–ê–í–ö–ò -->
        <div class="delivery-panel-compact" id="delivery-panel">
            <div class="delivery-header">
                <div class="delivery-title" id="delivery-title">üçî –î–æ—Å—Ç–∞–≤–∫–∞</div>
                <div class="delivery-status" id="delivery-status">–í –ø—É—Ç–∏...</div>
            </div>
            <div class="progress-line">
                <div class="progress-fill-line" id="progress-fill"></div>
            </div>
            <div class="delivery-buttons">
                <button class="btn-small btn-primary" id="drive-btn" onclick="startDriving()" style="display:none;">üö≤ –ï—Ö–∞—Ç—å</button>
                <button class="btn-small btn-danger" onclick="cancelDelivery()">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
    
    <!-- –ò–ì–†–û–í–û–ô –≠–ö–†–ê–ù -->
    <div class="game-overlay" id="game-overlay">
        <div class="game-box">
            <div class="game-title">‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –¥–æ—Ä–æ–≥–µ!</div>
            <div class="game-road-big" id="game-road">
                <div class="lane-big" style="top: 0;"></div>
                <div class="lane-big" style="top: 33.33%;"></div>
                <div class="lane-big" style="top: 66.66%;"></div>
                <div class="player-bike-big" id="player">üö¥</div>
            </div>
            <div class="game-hint-big">–£–∫–ª–æ–Ω—è–π—Å—è –æ—Ç –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π!</div>
            <div class="game-controls">
                <button class="game-control-btn up" onclick="moveBike(-1)">‚¨ÜÔ∏è</button>
                <button class="game-control-btn down" onclick="moveBike(1)">‚¨áÔ∏è</button>
            </div>
        </div>
    </div>
    
    <!-- –ü–ò–¢-–°–¢–û–ü -->
    <div class="pitstop-overlay" id="pitstop-overlay">
        <div class="pitstop-card">
            <div class="pitstop-title" id="pitstop-title">‚õΩ –ü–∏—Ç-—Å—Ç–æ–ø</div>
            <div class="pitstop-items" id="pitstop-items"></div>
            <button class="btn btn-warning" onclick="skipPitstop()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –ø–æ–∫—É–ø–æ–∫</button>
        </div>
    </div>
    
    <!-- –°–û–ë–´–¢–ò–ï -->
    <div class="event-overlay" id="event-overlay">
        <div class="event-card">
            <div class="event-icon" id="event-icon">‚ö†Ô∏è</div>
            <div class="event-title" id="event-title">–°–æ–±—ã—Ç–∏–µ</div>
            <div class="event-text" id="event-text">–ß—Ç–æ-—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ...</div>
            <div class="event-choices" id="event-choices"></div>
        </div>
    </div>
    
    <!-- –ü–ê–ù–ï–õ–¨ –ë–´–°–¢–†–û–ô –ü–ê–£–ó–´/–ú–ê–ì–ê–ó–ò–ù–ê -->
    <div class="overlay-backdrop" id="rest-backdrop" onclick="closeQuickRest()"></div>
    <div class="quick-rest-panel" id="quick-rest-panel">
        <div class="rest-title" id="rest-title">ü•§ –ë—ã—Å—Ç—Ä–∞—è –ø–∞—É–∑–∞</div>
        <div id="rest-options"></div>
        <button class="btn" style="background: transparent; border: 2px solid #666; color: #888;" onclick="closeQuickRest()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    
    <div class="toast" id="toast"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
        
        const firebaseConfig = {
            apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
            authDomain: "warszawa-courier.firebaseapp.com",
            databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "warszawa-courier",
            storageBucket: "warszawa-courier.firebasestorage.app",
            messagingSenderId: "295860613508",
            appId: "1:295860613508:web:86fe8364377d6875612dd1"
        };

        const WARSAW_CENTER = [52.2297, 21.0122];
        
        // ==================== –î–ê–ù–ù–´–ï ====================
        
        const QUICK_ITEMS = {
            water: [
                { name: '–í–æ–¥–∞ 0.5–ª', icon: 'üíß', cost: 3, energy: 0, water: 40, mood: 5, desc: '–û—Å–≤–µ–∂–∞–µ—Ç' },
                { name: '–í–æ–¥–∞ 1.5–ª', icon: 'ü•§', cost: 5, energy: -5, water: 70, mood: 10, desc: '–ü–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ' }
            ],
            energy: [
                { name: '–≠—Å–ø—Ä–µ—Å—Å–æ', icon: '‚òï', cost: 5, energy: 35, water: -5, mood: 10, desc: '–ë—ã—Å—Ç—Ä—ã–π –∫–æ—Ñ–µ–∏–Ω' },
                { name: 'Red Bull', icon: '‚ö°', cost: 8, energy: 60, water: -10, mood: 5, desc: '–ú–∞–∫—Å–∏–º—É–º —ç–Ω–µ—Ä–≥–∏–∏' }
            ]
        };
        
        const PITSTOPS = {
            gas: { name: '–ê–ó–°', icon: '‚õΩ', items: [
                { name: '–ö–æ—Ñ–µ', cost: 4, energy: 25, water: -5, mood: 10, icon: '‚òï' },
                { name: '–í–æ–¥–∞', cost: 3, energy: 5, water: 40, mood: 0, icon: 'üíß' }
            ]},
            cafe: { name: '–ö–∞—Ñ–µ', icon: '‚òï', items: [
                { name: '–û–±–µ–¥', cost: 12, energy: 40, water: 20, mood: 30, icon: 'üçΩÔ∏è' },
                { name: '–õ–∞—Ç—Ç–µ', cost: 6, energy: 20, water: 10, mood: 15, icon: '‚òï' }
            ]}
        };
        
        const RESTAURANTS = [
            { name: "McDonald's", icon: "üçî" },
            { name: "KFC", icon: "üçó" },
            { name: "Pizza Hut", icon: "üçï" },
            { name: "Sushi Master", icon: "üç£" },
            { name: "Kebab King", icon: "üåØ" }
        ];
        
        const ROAD_EVENTS = [
            { 
                icon: 'üåßÔ∏è', title: '–õ–∏–≤–µ–Ω—å!', text: '–î–æ—Ä–æ–≥–∏ —Å–∫–æ–ª—å–∑–∫–∏–µ. –ß—Ç–æ –¥–µ–ª–∞–µ–º?',
                choices: [
                    { text: '–ï—Ö–∞—Ç—å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ (+–≤—Ä–µ–º—è)', effect: { time: 10, mood: -5 } },
                    { text: '–†–∏—Å–∫–Ω—É—Ç—å (+—Å–∫–æ—Ä–æ—Å—Ç—å, -–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)', effect: { time: -5, risk: 20 } }
                ]
            },
            { 
                icon: 'üöî', title: '–ü–æ–ª–∏—Ü–∏—è', text: '–ü–∞—Ç—Ä—É–ª—å –æ—Å—Ç–∞–Ω–æ–≤–∏–ª.',
                choices: [
                    { text: '–ü–æ–∫–∞–∑–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã (-5 –º–∏–Ω)', effect: { time: 5, mood: -10 } },
                    { text: '–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∫–æ—Ñ–µ (-15 PLN)', effect: { money: -15 } }
                ]
            },
            { 
                icon: 'üöß', title: '–ü—Ä–æ–±–∫–∞', text: '–ì–ª–∞–≤–Ω–∞—è –¥–æ—Ä–æ–≥–∞ –≤—Å—Ç–∞–ª–∞.',
                choices: [
                    { text: '–ñ–¥–∞—Ç—å (-–≤—Ä–µ–º—è, -–Ω–µ—Ä–≤—ã)', effect: { time: 8, mood: -15 } },
                    { text: '–û–±—ä–µ–∑–¥ (+—Ä–∏—Å–∫)', effect: { time: -3, risk: 25 } }
                ]
            }
        ];
        
        // ==================== –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ ====================
        
        let state = {
            balance: 50,
            energy: 100,
            water: 100,
            mood: 100,
            experience: 0,
            level: 1,
            stats: { totalDeliveries: 0, totalEarned: 0, accidents: 0, bestTip: 0 },
            currentOrder: null,
            currentRoute: null,
            isDelivering: false,
            progress: 0,
            currentStop: 0,
            gameActive: false,
            bikeLane: 1,
            accidents: 0,
            gameHits: 0
        };
        
        let map, courierMarker, destMarker, routeLine, pitstopMarkers = [];
        let gameInterval, obstacleInterval;

        // ==================== –°–û–•–†–ê–ù–ï–ù–ò–ï ====================
        
        function saveGame() {
            const data = {
                balance: state.balance,
                energy: state.energy,
                water: state.water,
                mood: state.mood,
                stats: state.stats,
                level: state.level,
                experience: state.experience
            };
            localStorage.setItem('warsaw_courier_save', JSON.stringify(data));
        }
        
        function loadGame() {
            const saved = localStorage.getItem('warsaw_courier_save');
            if (saved) {
                const data = JSON.parse(saved);
                state.balance = data.balance ?? 50;
                state.energy = data.energy ?? 100;
                state.water = data.water ?? 100;
                state.mood = data.mood ?? 100;
                state.stats = data.stats ?? { totalDeliveries: 0, totalEarned: 0, accidents: 0, bestTip: 0 };
                state.level = data.level ?? 1;
                state.experience = data.experience ?? 0;
                return true;
            }
            return false;
        }

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        
        function init() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView(WARSAW_CENTER, 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
            
            const courierIcon = L.divIcon({
                html: '<div class="marker-courier"></div>',
                className: 'custom-marker',
                iconSize: [24, 24]
            });
            courierMarker = L.marker(WARSAW_CENTER, { icon: courierIcon }).addTo(map);
            
            updateUI();
            setInterval(gameTick, 1000);
            
            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            setInterval(saveGame, 5000);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
            window.addEventListener('beforeunload', saveGame);
            
            showToast('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ! –ù–∞–∂–º–∏ –ó–ê–ö–ê–ó', 3000);
        }
        
        // ==================== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        
        function updateUI() {
            document.getElementById('balance').textContent = Math.floor(state.balance) + ' PLN';
            ['energy', 'water', 'mood'].forEach(stat => {
                const val = Math.floor(state[stat]);
                document.getElementById(stat + '-val').textContent = val;
                document.getElementById(stat + '-bar').style.width = val + '%';
                const card = document.getElementById(stat + '-card');
                card.classList.toggle('critical', val < 25);
            });
        }
        
        function gameTick() {
            if (state.isDelivering && !state.gameActive) {
                state.energy -= 0.2;
                state.water -= 0.15;
                state.mood -= 0.1;
                
                if (state.energy <= 0 || state.water <= 0) {
                    failDelivery('–†–µ—Å—É—Ä—Å—ã –∫–æ–Ω—á–∏–ª–∏—Å—å! –ó–∞–∫–∞–∑ –ø—Ä–æ–≤–∞–ª–µ–Ω.');
                }
                updateUI();
            }
        }
        
        function showToast(msg, duration = 2500) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), duration);
        }

        // ==================== –ë–´–°–¢–†–û–ï –ü–û–ü–û–õ–ù–ï–ù–ò–ï ====================
        
        function quickRefill(type) {
            if (state.isDelivering) {
                showToast('‚ùå –í–æ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–µ–ª—å–∑—è!', 2000);
                return;
            }
            
            const title = type === 'water' ? 'ü•§ –ù–∞–ø–∏—Ç–∫–∏' : '‚òï –≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∏';
            document.getElementById('rest-title').textContent = title;
            
            const container = document.getElementById('rest-options');
            container.innerHTML = '';
            
            QUICK_ITEMS[type].forEach(item => {
                const div = document.createElement('div');
                div.className = 'rest-option';
                div.onclick = () => buyQuickItem(item);
                div.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; font-size: 18px; margin-bottom: 5px;">
                        <span>${item.icon}</span>
                        <div style="flex: 1; text-align: left;">
                            <div style="font-weight: bold;">${item.name}</div>
                            <div style="font-size: 12px; color: #888;">${item.desc}</div>
                        </div>
                        <div style="font-weight: bold; color: #00e676;">${item.cost} PLN</div>
                    </div>
                    <div style="font-size: 13px; color: #aaa;">
                        ‚ö°${item.energy > 0 ? '+' : ''}${item.energy} üíß${item.water > 0 ? '+' : ''}${item.water} üòé${item.mood > 0 ? '+' : ''}${item.mood}
                    </div>
                `;
                container.appendChild(div);
            });
            
            document.getElementById('quick-rest-panel').classList.add('active');
            document.getElementById('rest-backdrop').classList.add('active');
        }
        
        function buyQuickItem(item) {
            if (state.balance < item.cost) {
                showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!', 2000);
                return;
            }
            state.balance -= item.cost;
            state.energy = Math.min(100, Math.max(0, state.energy + item.energy));
            state.water = Math.min(100, Math.max(0, state.water + item.water));
            state.mood = Math.min(100, Math.max(0, state.mood + item.mood));
            updateUI();
            saveGame();
            closeQuickRest();
            showToast(`${item.icon} –ì–æ—Ç–æ–≤–æ!`, 2000);
        }
        
        function closeQuickRest() {
            document.getElementById('quick-rest-panel').classList.remove('active');
            document.getElementById('rest-backdrop').classList.remove('active');
        }

        // ==================== –ü–û–ò–°–ö –ó–ê–ö–ê–ó–ê ====================
        
        function findOrder() {
            if (state.energy < 20 || state.water < 20) {
                showToast('‚ö†Ô∏è –ú–∞–ª–æ —Ä–µ—Å—É—Ä—Å–æ–≤! –ü–æ–ø–æ–ª–Ω–∏ —Å–Ω–∞—á–∞–ª–∞.', 3000);
                return;
            }
            
            const rest = RESTAURANTS[Math.floor(Math.random() * RESTAURANTS.length)];
            const dist = (1.5 + Math.random() * 4).toFixed(1);
            const basePrice = Math.floor(15 + parseFloat(dist) * 8);
            
            const routes = [
                {
                    id: 'fast',
                    name: 'üèéÔ∏è –ö–æ—Ä–æ—Ç–∫–∏–π',
                    tag: 'tag-fast',
                    tagText: '–ë—ã—Å—Ç—Ä–æ',
                    time: Math.floor(dist * 2),
                    risk: 40,
                    energyCost: 20,
                    waterCost: 15,
                    price: basePrice + 5,
                    pitstops: 0,
                    desc: `${dist} –∫–º ‚Ä¢ –†–∏—Å–∫: –≤—ã—Å–æ–∫–∏–π`
                },
                {
                    id: 'safe',
                    name: 'üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π',
                    tag: 'tag-safe',
                    tagText: '–ù–∞–¥—ë–∂–Ω–æ',
                    time: Math.floor(dist * 4),
                    risk: 10,
                    energyCost: 12,
                    waterCost: 10,
                    price: basePrice,
                    pitstops: 1,
                    desc: `${dist} –∫–º ‚Ä¢ 1 –ø–∏—Ç-—Å—Ç–æ–ø`
                },
                {
                    id: 'profit',
                    name: 'üí∞ –ü—Ä–∏–±—ã–ª—å–Ω—ã–π',
                    tag: 'tag-profit',
                    tagText: '–î–æ—Ö–æ–¥',
                    time: Math.floor(dist * 5),
                    risk: 25,
                    energyCost: 30,
                    waterCost: 20,
                    price: Math.floor(basePrice * 1.4),
                    pitstops: 2,
                    desc: `${dist} –∫–º ‚Ä¢ 2 –ø–∏—Ç-—Å—Ç–æ–ø–∞`
                }
            ];
            
            state.currentOrder = {
                restaurant: rest,
                distance: parseFloat(dist),
                basePrice: basePrice,
                routes: routes,
                destLat: WARSAW_CENTER[0] + (Math.random() - 0.5) * 0.06,
                destLng: WARSAW_CENTER[1] + (Math.random() - 0.5) * 0.08
            };
            
            const container = document.getElementById('route-options');
            container.innerHTML = '';
            
            routes.forEach((route, idx) => {
                const div = document.createElement('div');
                div.className = 'rest-option';
                div.style.marginBottom = '10px';
                div.onclick = () => selectRoute(idx);
                div.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; font-size: 16px; margin-bottom: 5px;">
                        ${route.name}
                        <span class="route-tag ${route.tag}">${route.tagText}</span>
                    </div>
                    <div style="font-size: 12px; color: #aaa; display: flex; gap: 12px; flex-wrap: wrap;">
                        <span>‚è±Ô∏è ${route.time} –º–∏–Ω</span>
                        <span>‚ö° -${route.energyCost}</span>
                        <span>üíß -${route.waterCost}</span>
                        <span style="color: #00e676; font-weight: bold;">${route.price} PLN</span>
                    </div>
                    <div style="margin-top: 5px; font-size: 11px; color: #666;">${route.desc}</div>
                `;
                container.appendChild(div);
            });
            
            document.getElementById('route-panel').classList.add('active');
        }
        
        function selectRoute(idx) {
            state.currentRoute = state.currentOrder.routes[idx];
            
            const types = Object.keys(PITSTOPS);
            state.currentRoute.pitstopData = [];
            for (let i = 0; i < state.currentRoute.pitstops; i++) {
                const type = types[Math.floor(Math.random() * types.length)];
                state.currentRoute.pitstopData.push({
                    type: type,
                    ...PITSTOPS[type],
                    progress: Math.floor(((i + 1) / (state.currentRoute.pitstops + 1)) * 100)
                });
            }
            
            document.getElementById('route-panel').classList.remove('active');
            startDelivery();
        }
        
        function startDelivery() {
            state.isDelivering = true;
            state.progress = 0;
            state.currentStop = 0;
            state.accidents = 0;
            state.gameHits = 0;
            
            state.energy -= state.currentRoute.energyCost * 0.3;
            state.water -= state.currentRoute.waterCost * 0.3;
            
            const dest = [state.currentOrder.destLat, state.currentOrder.destLng];
            
            const destIcon = L.divIcon({
                html: '<div class="marker-dest"></div>',
                className: 'custom-marker',
                iconSize: [30, 30]
            });
            destMarker = L.marker(dest, { icon: destIcon }).addTo(map);
            
            state.currentRoute.pitstopData.forEach((stop, idx) => {
                const lat = WARSAW_CENTER[0] + (dest[0] - WARSAW_CENTER[0]) * (stop.progress / 100);
                const lng = WARSAW_CENTER[1] + (dest[1] - WARSAW_CENTER[1]) * (stop.progress / 100);
                
                const stopIcon = L.divIcon({
                    html: `<div class="marker-pitstop">${stop.icon}</div>`,
                    className: 'custom-marker',
                    iconSize: [28, 28]
                });
                const marker = L.marker([lat, lng], { icon: stopIcon }).addTo(map);
                pitstopMarkers.push(marker);
            });
            
            routeLine = L.polyline([WARSAW_CENTER, dest], {
                color: '#00e676',
                weight: 4,
                opacity: 0.6,
                dashArray: '8, 8'
            }).addTo(map);
            
            map.fitBounds([WARSAW_CENTER, dest], { padding: [60, 60] });
            
            document.getElementById('delivery-title').innerHTML = `${state.currentOrder.restaurant.icon} –î–æ—Å—Ç–∞–≤–∫–∞`;
            document.getElementById('delivery-panel').classList.add('active');
            document.getElementById('drive-btn').style.display = 'block';
            
            updateProgress();
            updateUI();
            
            showToast('–ù–∞–∂–º–∏ –ï–•–ê–¢–¨ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!', 3000);
        }
        
        function updateProgress() {
            document.getElementById('progress-fill').style.width = state.progress + '%';
        }

        // ==================== –î–û–°–¢–ê–í–ö–ê ====================
        
        function startDriving() {
            document.getElementById('drive-btn').style.display = 'none';
            document.getElementById('delivery-status').textContent = '–ï–¥–µ–º...';
            autoDrive();
        }
        
        function autoDrive() {
            const nextStop = state.currentRoute.pitstopData[state.currentStop];
            if (nextStop && state.progress >= nextStop.progress) {
                showPitstop(nextStop);
                return;
            }
            
            if (state.progress >= 100) {
                finishDelivery();
                return;
            }
            
            const rand = Math.random();
            
            if (rand < 0.3) {
                startMiniGame();
            } else if (rand < 0.3 + (state.currentRoute.risk / 100)) {
                triggerEvent();
            } else {
                state.progress += 15;
                state.energy -= 3;
                state.water -= 2;
                updateProgress();
                updateUI();
                setTimeout(autoDrive, 1000);
            }
        }
        
        // ==================== –ú–ò–ù–ò-–ò–ì–†–ê ====================
        
        function startMiniGame() {
            state.gameActive = true;
            state.bikeLane = 1;
            state.gameHits = 0;
            
            document.getElementById('game-overlay').classList.add('active');
            document.getElementById('delivery-status').textContent = '–û–ø–∞—Å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫!';
            
            updateBikePosition();
            
            let spawnCount = 0;
            obstacleInterval = setInterval(() => {
                spawnObstacle();
                spawnCount++;
                if (spawnCount >= 5) {
                    clearInterval(obstacleInterval);
                    setTimeout(endMiniGame, 2500);
                }
            }, 800);
        }
        
        function updateBikePosition() {
            const bike = document.getElementById('player');
            if (bike) {
                bike.style.top = (state.bikeLane * 33.33 + 16.66) + '%';
            }
        }
        
        function moveBike(dir) {
            if (!state.gameActive) return;
            state.bikeLane += dir;
            if (state.bikeLane < 0) state.bikeLane = 0;
            if (state.bikeLane > 2) state.bikeLane = 2;
            updateBikePosition();
        }
        
        function spawnObstacle() {
            const road = document.getElementById('game-road');
            if (!road) return;
            
            const obstacle = document.createElement('div');
            obstacle.className = 'obstacle-big';
            obstacle.textContent = ['üöó', 'üöß', 'üï≥Ô∏è', 'üêï'][Math.floor(Math.random() * 4)];
            
            const lane = Math.floor(Math.random() * 3);
            obstacle.style.top = (lane * 33.33 + 8) + '%';
            obstacle.dataset.lane = lane;
            
            road.appendChild(obstacle);
            
            setTimeout(() => {
                if (!state.gameActive) return;
                
                const bike = document.getElementById('player');
                const bikeRect = bike.getBoundingClientRect();
                const obsRect = obstacle.getBoundingClientRect();
                
                if (parseInt(obstacle.dataset.lane) === state.bikeLane && 
                    Math.abs(bikeRect.left - obsRect.left) < 60) {
                    state.gameHits++;
                    showToast('üí• –£–¥–∞—Ä!', 1000);
                }
                
                setTimeout(() => obstacle.remove(), 2000);
            }, 1800);
        }
        
        function endMiniGame() {
            state.gameActive = false;
            document.getElementById('game-overlay').classList.remove('active');
            document.querySelectorAll('.obstacle-big').forEach(o => o.remove());
            
            if (state.gameHits === 0) {
                showToast('üåü –ò–¥–µ–∞–ª—å–Ω–æ! –ë–æ–Ω—É—Å: +5 PLN', 2000);
                state.currentOrder.bonus = (state.currentOrder.bonus || 0) + 5;
                state.progress += 10;
            } else if (state.gameHits === 1) {
                showToast('‚úÖ –ù–µ–ø–ª–æ—Ö–æ', 1500);
                state.progress += 5;
            } else {
                showToast(`üí• ${state.gameHits} –∞–≤–∞—Ä–∏–π! -10 —ç–Ω–µ—Ä–≥–∏–∏`, 2000);
                state.energy -= 10;
                state.mood -= 10;
                state.accidents++;
            }
            
            updateProgress();
            updateUI();
            setTimeout(autoDrive, 2000);
        }
        
        // ==================== –ü–ò–¢-–°–¢–û–ü ====================
        
        function showPitstop(stop) {
            document.getElementById('pitstop-title').innerHTML = `${stop.icon} ${stop.name}`;
            const container = document.getElementById('pitstop-items');
            container.innerHTML = '';
            
            stop.items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'pitstop-item';
                div.onclick = () => buyAtPitstop(item);
                div.innerHTML = `
                    <div class="pitstop-item-header">
                        <span style="font-size: 24px;">${item.icon}</span>
                        <div style="flex: 1; text-align: left;">
                            <div style="font-weight: bold;">${item.name}</div>
                            <div class="pitstop-item-desc">${item.cost} PLN</div>
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #aaa; margin-top: 5px;">
                        ‚ö°${item.energy > 0 ? '+' : ''}${item.energy} üíß${item.water > 0 ? '+' : ''}${item.water} üòé${item.mood > 0 ? '+' : ''}${item.mood}
                    </div>
                `;
                container.appendChild(div);
            });
            
            document.getElementById('pitstop-overlay').classList.add('active');
        }
        
        function buyAtPitstop(item) {
            if (state.balance < item.cost) {
                showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!', 2000);
                return;
            }
            
            state.balance -= item.cost;
            state.energy = Math.min(100, state.energy + item.energy);
            state.water = Math.min(100, state.water + item.water);
            state.mood = Math.min(100, state.mood + item.mood);
            
            state.currentStop++;
            updateUI();
            document.getElementById('pitstop-overlay').classList.remove('active');
            showToast(`${item.icon} –ö—É–ø–ª–µ–Ω–æ!`, 2000);
            setTimeout(autoDrive, 1500);
        }
        
        function skipPitstop() {
            state.currentStop++;
            document.getElementById('pitstop-overlay').classList.remove('active');
            setTimeout(autoDrive, 500);
        }
        
        // ==================== –°–û–ë–´–¢–ò–Ø ====================
        
        function triggerEvent() {
            const event = ROAD_EVENTS[Math.floor(Math.random() * ROAD_EVENTS.length)];
            
            document.getElementById('event-icon').textContent = event.icon;
            document.getElementById('event-title').textContent = event.title;
            document.getElementById('event-text').textContent = event.text;
            
            const container = document.getElementById('event-choices');
            container.innerHTML = '';
            
            event.choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-primary';
                btn.textContent = choice.text;
                btn.onclick = () => resolveEvent(choice.effect);
                container.appendChild(btn);
            });
            
            document.getElementById('event-overlay').classList.add('active');
        }
        
        function resolveEvent(effect) {
            document.getElementById('event-overlay').classList.remove('active');
            
            if (effect.time) {
                state.progress += effect.time;
                if (state.progress < 0) state.progress = 0;
            }
            if (effect.money) state.balance += effect.money;
            if (effect.energy) state.energy = Math.max(0, state.energy + effect.energy);
            if (effect.water) state.water = Math.max(0, state.water + effect.water);
            if (effect.mood) state.mood = Math.max(0, state.mood + effect.mood);
            if (effect.risk && Math.random() * 100 < effect.risk) {
                showToast('üí• –ê–≤–∞—Ä–∏—è –∏–∑-–∑–∞ —Ä–∏—Å–∫–∞!', 2000);
                state.energy -= 15;
                state.mood -= 10;
            }
            
            updateProgress();
            updateUI();
            setTimeout(autoDrive, 1500);
        }
        
        // ==================== –ó–ê–í–ï–†–®–ï–ù–ò–ï ====================
        
        function finishDelivery() {
            let earned = state.currentRoute.price;
            
            if (state.mood > 80) earned += Math.floor(earned * 0.15);
            if (state.currentOrder.bonus) earned += state.currentOrder.bonus;
            if (state.accidents > 0) earned -= state.accidents * 5;
            
            const tip = Math.floor(Math.random() * (state.mood / 15));
            earned += tip;
            
            state.balance += Math.max(0, earned);
            state.stats.totalDeliveries++;
            state.stats.totalEarned += Math.max(0, earned);
            if (tip > state.stats.bestTip) state.stats.bestTip = tip;
            
            state.experience += 10;
            if (state.experience >= state.level * 50) {
                state.level++;
                state.experience = 0;
            }
            
            document.getElementById('delivery-panel').classList.remove('active');
            resetMap();
            
            saveGame();
            showToast(`üí∞ +${Math.max(0, earned)} PLN!`, 4000);
            updateUI();
        }
        
        function failDelivery(reason) {
            document.getElementById('delivery-panel').classList.remove('active');
            resetMap();
            showToast(reason, 4000);
            updateUI();
        }
        
        function cancelDelivery() {
            if (confirm('–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑? –®—Ç—Ä–∞—Ñ 10 PLN')) {
                state.balance = Math.max(0, state.balance - 10);
                document.getElementById('delivery-panel').classList.remove('active');
                resetMap();
                saveGame();
                showToast('–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω. –®—Ç—Ä–∞—Ñ: 10 PLN', 3000);
                updateUI();
            }
        }
        
        function resetMap() {
            state.isDelivering = false;
            state.currentOrder = null;
            state.currentRoute = null;
            state.progress = 0;
            state.currentStop = 0;
            state.gameActive = false;
            
            if (destMarker) map.removeLayer(destMarker);
            if (routeLine) map.removeLayer(routeLine);
            pitstopMarkers.forEach(m => map.removeLayer(m));
            pitstopMarkers = [];
            
            courierMarker.setLatLng(WARSAW_CENTER);
            map.setView(WARSAW_CENTER, 13);
            
            clearInterval(obstacleInterval);
        }

        // ==================== –ú–ê–ì–ê–ó–ò–ù ====================
        
        function openShop() {
            if (state.isDelivering) {
                showToast('‚ùå –°–Ω–∞—á–∞–ª–∞ –∑–∞–≤–µ—Ä—à–∏ –¥–æ—Å—Ç–∞–≤–∫—É!', 2000);
                return;
            }
            
            const items = [
                { id: 'bike1', name: '–ì–æ—Ä–Ω—ã–π –≤–µ–ª–∏–∫', icon: 'üö≤', cost: 150, desc: '-20% —ç–Ω–µ—Ä–≥–∏–∏' },
                { id: 'bike2', name: '–≠–ª–µ–∫—Ç—Ä–æ–±–∞–π–∫', icon: 'üõµ', cost: 400, desc: '–ë–µ–∑ —ç–Ω–µ—Ä–≥–∏–∏!' },
                { id: 'helmet', name: '–®–ª–µ–º', icon: '‚õëÔ∏è', cost: 80, desc: '–ó–∞—â–∏—Ç–∞ –æ—Ç –∞–≤–∞—Ä–∏–π' },
                { id: 'thermos', name: '–¢–µ—Ä–º–æ—Å', icon: 'üç∂', cost: 60, desc: '-30% –≤–æ–¥—ã' },
                { id: 'music', name: '–ù–∞—É—à–Ω–∏–∫–∏', icon: 'üéß', cost: 100, desc: '-40% –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è' },
                { id: 'vip', name: 'VIP', icon: 'üëë', cost: 500, desc: '+50% –∫ –∑–∞–∫–∞–∑–∞–º' }
            ];
            
            const owned = JSON.parse(localStorage.getItem('warsaw_courier_shop') || '[]');
            let html = '';
            
            items.forEach(item => {
                const have = owned.includes(item.id);
                html += `<div style="background:#222;padding:10px;border-radius:10px;margin-bottom:8px;border:2px solid ${have?'#0f0':'#444'}">
                    <div style="display:flex;align-items:center;gap:10px">
                        <span style="font-size:24px">${item.icon}</span>
                        <div style="flex:1">
                            <div style="font-weight:bold">${item.name} ${have?'‚úÖ':''}</div>
                            <div style="font-size:11px;color:#888">${item.desc}</div>
                        </div>
                        <div style="color:${have?'#0f0':'#ff0'};font-weight:bold">${have?'–ï–°–¢–¨':item.cost+'PLN'}</div>
                    </div>
                    ${!have?`<button class="btn btn-primary" onclick="buyShopItem('${item.id}',${item.cost})" style="margin-top:8px;width:100%;padding:8px">–ö—É–ø–∏—Ç—å</button>`:''}
                </div>`;
            });
            
            document.getElementById('rest-title').textContent = 'üõí –ú–∞–≥–∞–∑–∏–Ω';
            document.getElementById('rest-options').innerHTML = html;
            document.getElementById('quick-rest-panel').classList.add('active');
            document.getElementById('rest-backdrop').classList.add('active');
        }
        
        function buyShopItem(id, cost) {
            if (state.balance < cost) {
                showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!', 2000);
                return;
            }
            state.balance -= cost;
            const owned = JSON.parse(localStorage.getItem('warsaw_courier_shop') || '[]');
            owned.push(id);
            localStorage.setItem('warsaw_courier_shop', JSON.stringify(owned));
            saveGame();
            updateUI();
            showToast('‚úÖ –ö—É–ø–ª–µ–Ω–æ!', 2000);
            closeQuickRest();
        }
        
        function showStats() {
            const html = `<div style="font-size:14px;line-height:2">
                üì¶ –î–æ—Å—Ç–∞–≤–æ–∫: <b>${state.stats.totalDeliveries}</b><br>
                üí∞ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: <b>${state.stats.totalEarned} PLN</b><br>
                üí• –ê–≤–∞—Ä–∏–π: <b>${state.stats.accidents}</b><br>
                üèÜ –ß–∞–µ–≤—ã–µ: <b>${state.stats.bestTip} PLN</b><br>
                ‚≠ê –£—Ä–æ–≤–µ–Ω—å: <b>${state.level}</b>
            </div>`;
            
            document.getElementById('rest-title').textContent = 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞';
            document.getElementById('rest-options').innerHTML = html;
            document.getElementById('quick-rest-panel').classList.add('active');
            document.getElementById('rest-backdrop').classList.add('active');
        }

        // ==================== –°–¢–ê–†–¢ ====================
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ü–ï–†–ï–î –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
        loadGame();
        init();
    </script>
</body>
</html>







<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–æ–∂–¥—è */
    #rain-canvas {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 50; opacity: 0.4;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
    .floating-text {
        position: fixed;
        color: #fff;
        font-weight: bold;
        font-size: 20px;
        pointer-events: none;
        animation: floatUp 1.5s ease-out forwards;
        z-index: 1000;
        text-shadow: 0 0 5px #000;
    }
    
    @keyframes floatUp {
        0% { transform: translate(-50%, 0) scale(1); opacity: 1; }
        100% { transform: translate(-50%, -100px) scale(1.5); opacity: 0; }
    }

    /* –≠—Ñ—Ñ–µ–∫—Ç –≤—Å–ø—ã—à–∫–∏ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ */
    .flash-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: white; opacity: 0; pointer-events: none; z-index: 999;
        transition: opacity 0.1s;
    }
</style>

<canvas id="rain-canvas"></canvas>
<div id="flash-overlay" class="flash-overlay"></div>

<script>
    console.log("Applying Atmosphere Patch...");

    // 1. –°–ò–°–¢–ï–ú–ê –î–û–ñ–î–Ø
    const canvas = document.getElementById('rain-canvas');
    const ctx = canvas.getContext('2d');
    let w, h;
    const rainDrops = [];

    function resizeRain() {
        w = canvas.width = window.innerWidth;
        h = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeRain);
    resizeRain();

    function createRain() {
        for (let i = 0; i < 100; i++) {
            rainDrops.push({
                x: Math.random() * w,
                y: Math.random() * h,
                l: Math.random() * 20 + 10, // –¥–ª–∏–Ω–∞
                v: Math.random() * 10 + 20  // —Å–∫–æ—Ä–æ—Å—Ç—å
            });
        }
    }

    function drawRain() {
        ctx.clearRect(0, 0, w, h);
        ctx.strokeStyle = 'rgba(174, 194, 224, 0.5)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        rainDrops.forEach(d => {
            ctx.moveTo(d.x, d.y);
            ctx.lineTo(d.x, d.y + d.l);
            d.y += d.v;
            if (d.y > h) {
                d.y = -20;
                d.x = Math.random() * w;
            }
        });
        ctx.stroke();
        requestAnimationFrame(drawRain);
    }
    
    createRain();
    drawRain();

    // 2. –°–ò–°–¢–ï–ú–ê –í–°–ü–õ–´–í–ê–Æ–©–ï–ì–û –¢–ï–ö–°–¢–ê
    function spawnFloatingText(text, x, y, color = '#fff') {
        const el = document.createElement('div');
        el.className = 'floating-text';
        el.textContent = text;
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        el.style.color = color;
        
        if (color === '#00e676') el.style.textShadow = '0 0 10px #00e676';
        if (color === '#ff3d00') el.style.textShadow = '0 0 10px #ff3d00';
        
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1500);
    }

    function triggerFlash() {
        const flash = document.getElementById('flash-overlay');
        flash.style.opacity = 0.2;
        setTimeout(() => flash.style.opacity = 0, 100);
    }

    // 3. MONKEY PATCHING (–í–Ω–µ–¥—Ä–µ–Ω–∏–µ –≤ —Ç–≤–æ–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∏—Ö —É–¥–∞–ª–µ–Ω–∏—è)
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏
    const originalFinishDelivery = finishDelivery;
    
    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –µ—ë
    finishDelivery = function() {
        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –±–∞–ª–∞–Ω—Å –î–û –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
        const oldBalance = state.balance;
        
        // –í—ã–∑—ã–≤–∞–µ–º —Ç–≤–æ—é –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
        originalFinishDelivery.apply(this, arguments);
        
        // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É
        const earned = Math.floor(state.balance - oldBalance);
        
        if (earned > 0) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç –ø–æ —Ü–µ–Ω—Ç—Ä—É —ç–∫—Ä–∞–Ω–∞
            spawnFloatingText(`+${earned} PLN`, window.innerWidth / 2, window.innerHeight / 2, '#00e676');
            triggerFlash();
        }
    };

    // –ü–∞—Ç—á–∏–º –ø–æ–∫—É–ø–∫—É –≤ –º–∞–≥–∞–∑–∏–Ω–µ/–ø–∏—Ç-—Å—Ç–æ–ø–µ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç—Ä–∞—Ç
    const originalBuy = buyAtPitstop;
    buyAtPitstop = function(item) {
        if (state.balance >= item.cost) {
            spawnFloatingText(`-${item.cost} PLN`, window.innerWidth / 2, window.innerHeight / 2 + 50, '#ff3d00');
        }
        originalBuy.apply(this, arguments);
    };

    // –ü–∞—Ç—á–∏–º –±—ã—Å—Ç—Ä—É—é –ø–æ–∫—É–ø–∫—É
    const originalQuickBuy = buyQuickItem;
    buyQuickItem = function(item) {
        if (state.balance >= item.cost) {
            spawnFloatingText(`-${item.cost} PLN`, window.innerWidth / 2, window.innerHeight / 2 + 50, '#ff3d00');
        }
        originalQuickBuy.apply(this, arguments);
    };

    // –ü–∞—Ç—á–∏–º –º–∏–Ω–∏-–∏–≥—Ä—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–¥–∞—Ä–æ–≤
    const originalEndGame = endMiniGame;
    endMiniGame = function() {
        const hits = state.gameHits;
        originalEndGame.apply(this, arguments);
        
        if (hits === 0) {
             spawnFloatingText(`–ò–î–ï–ê–õ–¨–ù–û!`, window.innerWidth / 2, window.innerHeight / 3, '#ffd600');
        }
    };

</script>












<style>
    /* –≠—Ñ—Ñ–µ–∫—Ç —Ç—Ä—è—Å–∫–∏ —ç–∫—Ä–∞–Ω–∞ –ø—Ä–∏ —É–¥–∞—Ä–µ */
    @keyframes shake {
        0% { transform: translate(1px, 1px) rotate(0deg); }
        10% { transform: translate(-1px, -2px) rotate(-1deg); }
        20% { transform: translate(-3px, 0px) rotate(1deg); }
        30% { transform: translate(3px, 2px) rotate(0deg); }
        40% { transform: translate(1px, -1px) rotate(1deg); }
        50% { transform: translate(-1px, 2px) rotate(-1deg); }
        60% { transform: translate(-3px, 1px) rotate(0deg); }
        70% { transform: translate(3px, 1px) rotate(-1deg); }
        80% { transform: translate(-1px, -1px) rotate(1deg); }
        90% { transform: translate(1px, 2px) rotate(0deg); }
        100% { transform: translate(1px, -2px) rotate(-1deg); }
    }
    .shake-hard { animation: shake 0.5s; }
    .shake-medium { animation: shake 0.3s; }

    /* –°—Ç–∏–ª—å –¥–ª—è —Ç–∞–π–º–µ—Ä–æ–≤ –≤ –º–∞–≥–∞–∑–∏–Ω–µ */
    .item-timer { font-size: 11px; color: #ff9100; margin-top: 4px; font-family: monospace; }
</style>

<script>
    console.log("Applying Hardcore Reality Patch...");

    // 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –°–†–û–ö–û–í –ì–û–î–ù–û–°–¢–ò (–≤ –º–∏–Ω—É—Ç–∞—Ö) –ò –ü–†–ï–ü–Ø–¢–°–¢–í–ò–ô
    const ITEM_DURATIONS = {
        'bike1': 20,    // –ê—Ä–µ–Ω–¥–∞ –Ω–∞ 20 –º–∏–Ω
        'bike2': 15,    // –≠–ª–µ–∫—Ç—Ä–æ–±–∞–π–∫ –Ω–∞ 15 –º–∏–Ω
        'helmet': 10,   // –®–ª–µ–º –Ω–∞ 10 –º–∏–Ω
        'thermos': 30,  // –¢–µ—Ä–º–æ—Å –Ω–∞ 30 –º–∏–Ω
        'music': 12,    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –º—É–∑—ã–∫—É 12 –º–∏–Ω
        'vip': 5        // VIP —Å—Ç–∞—Ç—É—Å –Ω–∞ 5 –º–∏–Ω
    };

    const OBSTACLE_TYPES = {
        'üöó': { type: 'car', damage: 15, fine: 0, effect: '–¢–†–ê–í–ú–ê: -–≠–Ω–µ—Ä–≥–∏—è!', func: () => applyDebuff('injury') },
        'üöß': { type: 'construction', damage: 5, fine: 0, effect: '–ó–ê–î–ï–†–ñ–ö–ê: -–ü—É—Ç—å', func: () => { state.progress = Math.max(0, state.progress - 10); updateProgress(); } },
        'üöî': { type: 'police', damage: 0, fine: 15, effect: '–®–¢–†–ê–§: -15 PLN', func: () => { state.balance -= 15; updateUI(); } },
        'üï≥Ô∏è': { type: 'hole', damage: 5, fine: 0, effect: '–£–î–ê–†: –ï–¥–∞ –ø–æ–º—è–ª–∞—Å—å', func: () => { state.mood -= 20; updateUI(); } }
    };

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–µ–±–∞—Ñ—Ñ–æ–≤
    state.debuffs = { injury: false };

    // 2. –ü–ï–†–ï–û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ú–ê–ì–ê–ó–ò–ù–ê (–°–∏—Å—Ç–µ–º–∞ –≤—Ä–µ–º–µ–Ω–∏)
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤
    function getActiveItems() {
        const raw = localStorage.getItem('warsaw_courier_shop_v2');
        if (!raw) return {};
        
        let items = JSON.parse(raw);
        const now = Date.now();
        const active = {};
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ
        Object.keys(items).forEach(id => {
            if (items[id] > now) {
                active[id] = items[id];
            }
        });
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—á–∏—â–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
        if (Object.keys(active).length !== Object.keys(items).length) {
            localStorage.setItem('warsaw_courier_shop_v2', JSON.stringify(active));
        }
        return active;
    }

    // –ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∫—É–ø–∫–∏
    buyShopItem = function(id, cost) {
        if (state.balance < cost) {
            showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!', 2000);
            return;
        }
        
        state.balance -= cost;
        const active = getActiveItems();
        const durationMs = (ITEM_DURATIONS[id] || 10) * 60 * 1000;
        
        // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ–¥–ª–µ–≤–∞–µ–º, –∏–Ω–∞—á–µ —Å–æ–∑–¥–∞–µ–º
        const currentExpiry = active[id] || Date.now();
        active[id] = (currentExpiry > Date.now() ? currentExpiry : Date.now()) + durationMs;
        
        localStorage.setItem('warsaw_courier_shop_v2', JSON.stringify(active));
        
        saveGame();
        updateUI();
        showToast(`‚úÖ –ö—É–ø–ª–µ–Ω–æ –Ω–∞ ${ITEM_DURATIONS[id]} –º–∏–Ω!`, 2000);
        
        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç
        openShop(); 
    };

    // –ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–æ–≤)
    openShop = function() {
        if (state.isDelivering) {
            showToast('‚ùå –°–Ω–∞—á–∞–ª–∞ –∑–∞–≤–µ—Ä—à–∏ –¥–æ—Å—Ç–∞–≤–∫—É!', 2000);
            return;
        }
        
        const items = [
            { id: 'bike1', name: '–ê—Ä–µ–Ω–¥–∞ MTB', icon: 'üö≤', cost: 20, desc: '–ê—Ä–µ–Ω–¥–∞ 20 –º–∏–Ω: -20% —Ä–∞—Å—Ö–æ–¥–∞' },
            { id: 'bike2', name: '–ê—Ä–µ–Ω–¥–∞ Electro', icon: 'üõµ', cost: 50, desc: '–ê—Ä–µ–Ω–¥–∞ 15 –º–∏–Ω: –•–∞–ª—è–≤–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è' },
            { id: 'helmet', name: '–°—Ç—Ä–∞—Ö–æ–≤–∫–∞', icon: '‚õëÔ∏è', cost: 15, desc: '10 –º–∏–Ω: –ó–∞—â–∏—Ç–∞ –æ—Ç —à—Ç—Ä–∞—Ñ–æ–≤' },
            { id: 'thermos', name: '–¢–µ—Ä–º–æ—Å', icon: 'üç∂', cost: 10, desc: '30 –º–∏–Ω: –í–æ–¥–∞ –Ω–µ –æ—Å—Ç—ã–≤–∞–µ—Ç' },
            { id: 'vip', name: 'VIP –õ–∏—Ü–µ–Ω–∑–∏—è', icon: 'üëë', cost: 100, desc: '5 –º–∏–Ω: –ñ–∏—Ä–Ω—ã–µ –∑–∞–∫–∞–∑—ã' }
        ];
        
        const active = getActiveItems();
        const now = Date.now();
        let html = '';
        
        items.forEach(item => {
            const expiry = active[item.id];
            const isActive = expiry && expiry > now;
            let timeStr = '';
            
            if (isActive) {
                const leftSec = Math.floor((expiry - now) / 1000);
                const m = Math.floor(leftSec / 60);
                const s = leftSec % 60;
                timeStr = `${m}:${s < 10 ? '0'+s : s}`;
            }

            html += `<div style="background:#222;padding:10px;border-radius:10px;margin-bottom:8px;border:2px solid ${isActive ? '#00e676' : '#444'}">
                <div style="display:flex;align-items:center;gap:10px">
                    <span style="font-size:24px">${item.icon}</span>
                    <div style="flex:1">
                        <div style="font-weight:bold">${item.name}</div>
                        <div style="font-size:11px;color:#888">${item.desc}</div>
                        ${isActive ? `<div class="item-timer">‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: ${timeStr}</div>` : ''}
                    </div>
                    ${!isActive ? 
                        `<button class="btn btn-primary" onclick="buyShopItem('${item.id}',${item.cost})" style="width:auto;padding:6px 12px;font-size:12px;">${item.cost} P</button>` : 
                        `<button class="btn" style="width:auto;padding:6px 12px;font-size:12px;background:#333;color:#fff;" onclick="buyShopItem('${item.id}',${item.cost})">–ü—Ä–æ–¥–ª–∏—Ç—å</button>`
                    }
                </div>
            </div>`;
        });
        
        document.getElementById('rest-title').textContent = 'üõí –ê—Ä–µ–Ω–¥–∞ –∏ –ë–∞—Ñ—Ñ—ã';
        document.getElementById('rest-options').innerHTML = html;
        document.getElementById('quick-rest-panel').classList.add('active');
        document.getElementById('rest-backdrop').classList.add('active');
    };

    // 3. –ü–ï–†–ï–û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ú–ò–ù–ò-–ò–ì–†–´ (–£–º–Ω—ã–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è)

    // –§—É–Ω–∫—Ü–∏—è –¥–µ–±–∞—Ñ—Ñ–∞
    function applyDebuff(name) {
        state.debuffs[name] = true;
        setTimeout(() => { state.debuffs[name] = false; showToast('ü©π –¢—Ä–∞–≤–º–∞ –ø—Ä–æ—à–ª–∞', 2000); }, 15000); // 15 —Å–µ–∫ —Ç—Ä–∞–≤–º—ã
    }

    // –•—É–∫ –≤ –∏–≥—Ä–æ–≤–æ–π —Ç–∏–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç—Ä–∞–≤–º—ã
    const originalGameTick = gameTick;
    gameTick = function() {
        originalGameTick();
        if (state.debuffs && state.debuffs.injury && state.isDelivering) {
            // –ï—Å–ª–∏ —Ç—Ä–∞–≤–º–∞, —ç–Ω–µ—Ä–≥–∏—è –ø–∞–¥–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
            state.energy -= 0.3; 
        }
    };

    // –ü–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ spawnObstacle –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–∏–ø–æ–≤
    spawnObstacle = function() {
        const road = document.getElementById('game-road');
        if (!road) return;
        
        const obstacle = document.createElement('div');
        obstacle.className = 'obstacle-big';
        
        // –í—ã–±–æ—Ä —Ç–∏–ø–∞
        const keys = Object.keys(OBSTACLE_TYPES);
        const icon = keys[Math.floor(Math.random() * keys.length)];
        // –ò–Ω–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–∏—Ü–∏—é (—Ä–µ–¥–∫–æ)
        const finalIcon = (Math.random() < 0.1) ? 'üöî' : icon;
        
        obstacle.textContent = finalIcon;
        obstacle.dataset.typeIcon = finalIcon; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–ø
        
        const lane = Math.floor(Math.random() * 3);
        obstacle.style.top = (lane * 33.33 + 8) + '%';
        obstacle.dataset.lane = lane;
        
        road.appendChild(obstacle);
        
        // –õ–æ–≥–∏–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è –∏ —É–¥–∞—Ä–∞
        setTimeout(() => {
            if (!state.gameActive) return;
            
            const bike = document.getElementById('player');
            const bikeRect = bike.getBoundingClientRect();
            const obsRect = obstacle.getBoundingClientRect();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–ª–∏–∑–∏–∏
            if (parseInt(obstacle.dataset.lane) === state.bikeLane && 
                Math.abs(bikeRect.left - obsRect.left) < 60) {
                
                // === –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –£–î–ê–†–ê ===
                const typeData = OBSTACLE_TYPES[obstacle.dataset.typeIcon] || OBSTACLE_TYPES['üöó'];
                
                // –í–∏–∑—É–∞–ª
                document.body.classList.add('shake-hard');
                setTimeout(() => document.body.classList.remove('shake-hard'), 500);
                obstacle.style.backgroundColor = 'rgba(255,0,0,0.5)';
                
                // –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è
                state.gameHits++;
                state.energy -= typeData.damage;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏ (—à–ª–µ–º–∞)
                const activeItems = getActiveItems();
                if (activeItems['helmet']) {
                    showToast(`üõ°Ô∏è –®–ª–µ–º —Å–ø–∞—Å –æ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∞: ${typeData.effect}`, 1500);
                } else {
                    showToast(`üí• ${typeData.effect}`, 2000);
                    if (typeData.func) typeData.func();
                }
            }
            
            setTimeout(() => obstacle.remove(), 2000);
        }, 1800);
    };

</script>












<style>
    /* –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–Ω–µ–ª—å, —á—Ç–æ–±—ã –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å –Ω–æ–≤—É—é */
    .action-bar { display: none !important; }

    /* –ù–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
    .neo-control-panel {
        position: fixed;
        top: 80px; /* –ß—É—Ç—å –Ω–∏–∂–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
        left: 50%;
        transform: translateX(-50%);
        width: 95%;
        max-width: 450px;
        display: flex;
        justify-content: space-between;
        background: rgba(10, 10, 10, 0.6);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 8px;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 800;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }

    .neo-btn {
        flex: 1;
        border: none;
        background: transparent;
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 5px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border-radius: 12px;
        position: relative;
        margin: 0 2px;
    }

    .neo-btn:active { transform: scale(0.9); }
    
    /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏/–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
    .neo-btn:hover { background: rgba(255, 255, 255, 0.1); }

    .neo-icon { font-size: 20px; margin-bottom: 2px; filter: drop-shadow(0 0 5px rgba(255,255,255,0.3)); }
    .neo-label { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; }
    
    /* –¶–≤–µ—Ç–æ–≤—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
    .neo-btn.water .neo-icon { text-shadow: 0 0 10px #00ccff; }
    .neo-btn.energy .neo-icon { text-shadow: 0 0 10px #ffcc00; }
    .neo-btn.find { background: rgba(0, 230, 118, 0.15); border: 1px solid rgba(0, 230, 118, 0.3); }
    .neo-btn.find .neo-icon { font-size: 24px; animation: pulse-btn 2s infinite; }
    .neo-btn.shop .neo-icon { text-shadow: 0 0 10px #e91e63; }

    @keyframes pulse-btn {
        0% { transform: scale(1); text-shadow: 0 0 0px #00e676; }
        50% { transform: scale(1.1); text-shadow: 0 0 15px #00e676; }
        100% { transform: scale(1); text-shadow: 0 0 0px #00e676; }
    }
</style>

<div class="neo-control-panel">
    <button class="neo-btn water" onclick="quickRefill('water')">
        <span class="neo-icon">üíß</span>
        <span class="neo-label">–í–æ–¥–∞</span>
    </button>
    <button class="neo-btn energy" onclick="quickRefill('energy')">
        <span class="neo-icon">‚ö°</span>
        <span class="neo-label">–ë–æ–¥—Ä–æ—Å—Ç—å</span>
    </button>
    <button class="neo-btn find" onclick="findOrder()">
        <span class="neo-icon">üì±</span>
        <span class="neo-label" style="color:#00e676">–ó–ê–ö–ê–ó</span>
    </button>
    <button class="neo-btn shop" onclick="openShop()">
        <span class="neo-icon">üõí</span>
        <span class="neo-label">–ú–∞—Ä–∫–µ—Ç</span>
    </button>
    <button class="neo-btn stats" onclick="showStats()">
        <span class="neo-icon">üìä</span>
        <span class="neo-label">–ü—Ä–æ—Ñ–∏–ª—å</span>
    </button>
</div>

<script>
    console.log("Applying Logic & UI Patch...");

    // 1. –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –õ–û–ì–ò–ö–ò –ü–†–ï–î–ú–ï–¢–û–í (–ë–∞–ª–∞–Ω—Å)
    // –¢–µ–ø–µ—Ä—å –≤–æ–¥–∞ –Ω–µ –æ—Ç–Ω–∏–º–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é, –∞ —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∏ –ª–∏—à—å —Å–ª–µ–≥–∫–∞ —Å—É—à–∞—Ç
    
    // –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é QUICK_ITEMS
    QUICK_ITEMS = {
        water: [
            { 
                name: '–í–æ–¥–∞ 0.33', 
                icon: 'üíß', 
                cost: 2, 
                energy: 0, 
                water: 30, 
                mood: 5, 
                desc: '–ß–∏—Å—Ç–æ–µ —É–≤–ª–∞–∂–Ω–µ–Ω–∏–µ. –ù–∏–∫–∞–∫–∏—Ö –º–∏–Ω—É—Å–æ–≤.' 
            },
            { 
                name: '–°–ø–æ—Ä—Ç-–ò–∑–æ—Ç–æ–Ω–∏–∫', 
                icon: 'ü•§', 
                cost: 6, 
                energy: 10, 
                water: 60, 
                mood: 5, 
                desc: '–í–æ–¥–∞ + –≠–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç—ã. –î–∞–µ—Ç —Å–∏–ª—ã.' 
            }
        ],
        energy: [
            { 
                name: '–≠—Å–ø—Ä–µ—Å—Å–æ', 
                icon: '‚òï', 
                cost: 5, 
                energy: 30, 
                water: -3, 
                mood: 15, 
                desc: '–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç. –°–ª–µ–≥–∫–∞ —Å—É—à–∏—Ç.' 
            },
            { 
                name: 'Monster Energy', 
                icon: '‚ö°', 
                cost: 10, 
                energy: 70, 
                water: -8, 
                mood: 25, 
                desc: '–ú–æ—â–Ω—ã–π –∑–∞—Ä—è–¥! –•–æ—á–µ—Ç—Å—è –ø–∏—Ç—å.' 
            }
        ]
    };

    // 2. –û–ë–ù–û–í–õ–ï–ù–ò–ï –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ú–ï–ù–Æ –ü–û–ö–£–ü–ö–ò (–ß—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –Ω–æ–≤—ã–µ —Å—Ç–∞—Ç—ã –∫—Ä–∞—Å–∏–≤–æ)
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª, —á—Ç–æ–±—ã –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –ª–æ–≥–∏–∫—É –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    quickRefill = function(type) {
        if (state.isDelivering) {
            showToast('‚ùå –ó–∞ —Ä—É–ª–µ–º –Ω–µ–ª—å–∑—è!', 2000);
            return;
        }
        
        const title = type === 'water' ? 'ü•§ –ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è' : '‚ö° –ó–∞—Ä—è–¥–∫–∞';
        document.getElementById('rest-title').textContent = title;
        
        const container = document.getElementById('rest-options');
        container.innerHTML = '';
        
        QUICK_ITEMS[type].forEach(item => {
            const div = document.createElement('div');
            div.className = 'rest-option';
            div.onclick = () => buyQuickItem(item);
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤—É—é —Å—Ç—Ä–æ–∫—É —Å—Ç–∞—Ç–æ–≤
            let statsHtml = '';
            if(item.energy > 0) statsHtml += `<span style="color:#ffcc00">‚ö°+${item.energy}</span> `;
            if(item.water > 0) statsHtml += `<span style="color:#00ccff">üíß+${item.water}</span> `;
            if(item.water < 0) statsHtml += `<span style="color:#aaa">üíß${item.water}</span> `; // –ú–∏–Ω—É—Å –≤–æ–¥–∞ —Å–µ—Ä—ã–º
            if(item.mood > 0) statsHtml += `<span style="color:#d500f9">üòé+${item.mood}</span> `;

            div.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="font-size: 30px;">${item.icon}</span>
                    <div style="flex: 1; text-align: left;">
                        <div style="font-weight: bold; font-size: 16px;">${item.name}</div>
                        <div style="font-size: 11px; color: #888; margin-top:2px;">${item.desc}</div>
                        <div style="font-size: 12px; margin-top: 4px; font-weight:500;">
                            ${statsHtml}
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width: auto; padding: 5px 15px; font-size: 14px;">
                        ${item.cost} P
                    </button>
                </div>
            `;
            container.appendChild(div);
        });
        
        document.getElementById('quick-rest-panel').classList.add('active');
        document.getElementById('rest-backdrop').classList.add('active');
    };

</script>
