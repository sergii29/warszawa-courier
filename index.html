<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warsaw Courier Tycoon: Stable</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* --- –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò --- */
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; background: #000; color: #fff; overflow: hidden; user-select: none; -webkit-user-select: none; }
        
        #map { height: 100vh; width: 100vw; z-index: 0; background: #1a1a1a; }

        /* –ò–ö–û–ù–ö–ò */
        .emoji-icon {
            font-size: 26px; text-align: center; line-height: 26px;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.8));
            transition: transform 0.2s linear;
        }
        .office-icon { font-size: 35px; filter: drop-shadow(0 0 8px #00e676); z-index: 1000 !important; }
        
        /* –ò–ù–¢–ï–†–§–ï–ô–° (–ü–û–í–ï–†–• –ö–ê–†–¢–´) */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* –í–ê–ñ–ù–û: –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∫–ª–∏–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É */
            z-index: 500;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        /* –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ */
        .top-bar {
            background: rgba(18, 18, 18, 0.95);
            padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            pointer-events: auto; /* –í–∫–ª—é—á–∞–µ–º –∫–ª–∏–∫–∏ —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å */
            border-bottom: 2px solid #00e676;
            box-shadow: 0 4px 15px rgba(0,0,0,0.7);
        }
        .balance-box { font-size: 1.1rem; font-weight: bold; color: #00e676; text-shadow: 0 0 5px rgba(0,230,118,0.3); }
        .timer-box { font-family: monospace; color: #ff5252; font-weight: bold; font-size: 0.9rem; }

        /* –õ–û–ì–ò (–£–í–ï–î–û–ú–õ–ï–ù–ò–Ø) */
        .log-container {
            position: absolute; top: 80px; right: 10px; width: 60%; max-width: 250px;
            display: flex; flex-direction: column; align-items: flex-end;
            pointer-events: none;
        }
        .log-entry {
            background: rgba(0, 0, 0, 0.8); color: #fff;
            padding: 5px 10px; margin-bottom: 4px; border-radius: 4px;
            font-size: 0.75rem; border-left: 3px solid #00e676;
            animation: fadeIn 0.3s forwards;
        }

        /* –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ */
        .bottom-bar {
            background: rgba(18, 18, 18, 0.98); padding: 15px;
            border-top: 1px solid #333; display: flex; gap: 8px;
            pointer-events: auto; /* –í–∫–ª—é—á–∞–µ–º –∫–ª–∏–∫–∏ */
            padding-bottom: 25px; /* iOS safe area */
        }
        .btn-menu {
            flex: 1; padding: 12px; border: 1px solid #444; background: #2a2a2a; color: #fff;
            border-radius: 8px; font-weight: 600; font-size: 0.9rem;
            cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .btn-menu:active { background: #444; transform: scale(0.98); }
        .btn-rent { background: #3c1515; border-color: #b71c1c; color: #ff8a80; }

        /* –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; display: none;
            justify-content: center; align-items: center;
            pointer-events: auto;
        }
        .modal-content {
            background: #1e1e1e; width: 90%; max-width: 450px;
            border-radius: 12px; padding: 20px; max-height: 80vh; overflow-y: auto;
            border: 1px solid #333; position: relative;
        }
        .close-btn {
            position: absolute; top: 15px; right: 15px; font-size: 24px;
            color: #888; cursor: pointer; padding: 5px;
        }
        
        /* –°–ï–¢–ö–ê –ú–ê–ì–ê–ó–ò–ù–ê */
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
        .shop-item { background: #252525; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #333; }
        .shop-item h4 { margin: 0 0 5px; font-size: 0.85rem; color: #eee; }
        .shop-btn { width: 100%; padding: 8px; background: #00e676; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        
        /* –≠–ö–†–ê–ù –ü–†–ò–í–ï–¢–°–¢–í–ò–Ø */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 5000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center; padding: 20px;
        }
        .big-btn {
            background: #00e676; color: #000; border: none; padding: 15px 40px;
            font-size: 1.2rem; font-weight: bold; border-radius: 50px; cursor: pointer;
            margin-top: 20px; box-shadow: 0 0 20px rgba(0,230,118,0.4);
        }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="color: #00e676;">Warszawa Courier</h1>
        <p id="status-text" style="color: #888;">–°–≤—è–∑—å —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö...</p>
        <button id="btn-start" class="big-btn" style="display:none;" onclick="enterGame()">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
        <button id="btn-select-office" class="big-btn" style="display:none; background:#2979ff; color:#fff;" onclick="prepareMapForSelection()">–í—ã–±—Ä–∞—Ç—å –û—Ñ–∏—Å</button>
    </div>

    <div class="ui-layer" id="game-ui" style="display: none;">
        <div class="top-bar">
            <div>
                <div style="font-size: 0.7rem; color: #aaa;">–ë–ê–õ–ê–ù–°</div>
                <div class="balance-box" id="ui-balance">0 PLN</div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 0.7rem; color: #aaa;">–ê–†–ï–ù–î–ê</div>
                <div class="timer-box" id="ui-timer">5:00</div>
            </div>
        </div>

        <div class="log-container" id="log-area"></div>

        <div class="bottom-bar">
            <button class="btn-menu" onclick="openModal('shop-modal')">
                <span>üö≤</span> –ú–∞–≥–∞–∑–∏–Ω
            </button>
            <button class="btn-menu" onclick="openModal('fleet-modal')">
                <span>üìä</span> –§–ª–æ—Ç (<span id="active-couriers-count">0</span>)
            </button>
            <button class="btn-menu btn-rent" onclick="openModal('office-modal')">
                <span>üè†</span> –û—Ñ–∏—Å
            </button>
        </div>
    </div>

    <div id="shop-modal" class="modal-overlay" onclick="closeModal(event, 'shop-modal')">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('shop-modal').style.display='none'">&times;</span>
            <h3 style="margin-top:0;">–°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ</h3>
            <p style="font-size:0.8rem; color:#aaa;">–î–ª—è –Ω–∞–π–º–∞ 1 –∫—É—Ä—å–µ—Ä–∞ –Ω—É–∂–µ–Ω: –í–µ–ª–∏–∫ + –°—É–º–∫–∞ + –ö—É—Ä—Ç–∫–∞.</p>
            
            <div class="shop-grid">
                <div class="shop-item">
                    <h4>–í–µ–ª–æ—Å–∏–ø–µ–¥</h4>
                    <div style="color:#00e676">1500 PLN</div>
                    <div style="font-size:0.7rem;">–ù–∞ —Å–∫–ª–∞–¥–µ: <span id="qty-bike">0</span></div>
                    <button class="shop-btn" onclick="buy('bike_250', 1500)">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div class="shop-item">
                    <h4>–¢–µ—Ä–º–æ—Å—É–º–∫–∞</h4>
                    <div style="color:#00e676">150 PLN</div>
                    <div style="font-size:0.7rem;">–ù–∞ —Å–∫–ª–∞–¥–µ: <span id="qty-bag">0</span></div>
                    <button class="shop-btn" onclick="buy('bag', 150)">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div class="shop-item">
                    <h4>–£–Ω–∏—Ñ–æ—Ä–º–∞</h4>
                    <div style="color:#00e676">200 PLN</div>
                    <div style="font-size:0.7rem;">–ù–∞ —Å–∫–ª–∞–¥–µ: <span id="qty-jacket">0</span></div>
                    <button class="shop-btn" onclick="buy('jacket', 200)">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div class="shop-item">
                    <h4>–õ–∏—Ü–µ–Ω–∑–∏—è Kebab</h4>
                    <div style="color:#ff9800">2500 PLN</div>
                    <button class="shop-btn" style="background:#ff9800; color:#000;" onclick="buyLicense('kebab_king')">–ö—É–ø–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <div id="fleet-modal" class="modal-overlay" onclick="closeModal(event, 'fleet-modal')">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('fleet-modal').style.display='none'">&times;</span>
            <h3 style="margin-top:0;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –§–ª–æ—Ç–∞</h3>
            <div style="background:#222; padding:15px; border-radius:8px; margin-bottom:10px;">
                <div>üö¥ –í–µ–ª–∏–∫–∏: <span id="f-bikes" style="color:#fff;">0</span></div>
                <div>üéí –°—É–º–∫–∏: <span id="f-bags" style="color:#fff;">0</span></div>
                <div>üß• –ö—É—Ä—Ç–∫–∏: <span id="f-jackets" style="color:#fff;">0</span></div>
                <hr style="border-color:#444;">
                <div style="font-weight:bold; color:#00e676;">–ê–∫—Ç–∏–≤–Ω—ã–µ –∫—É—Ä—å–µ—Ä—ã: <span id="f-active">0</span></div>
            </div>
            <p style="font-size:0.8rem; color:#aaa;">–ö—É—Ä—å–µ—Ä—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∫–æ–≥–¥–∞ —Å–æ–±—Ä–∞–Ω –ø–æ–ª–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Ç —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è.</p>
        </div>
    </div>

    <div id="office-modal" class="modal-overlay" onclick="closeModal(event, 'office-modal')">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('office-modal').style.display='none'">&times;</span>
            <h3 style="margin-top:0;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –û—Ñ–∏—Å–æ–º</h3>
            <button class="shop-btn" style="background:#d32f2f; color:#fff; margin-bottom:10px;" onclick="payRent()">
                –û–ø–ª–∞—Ç–∏—Ç—å –ê—Ä–µ–Ω–¥—É (-500 PLN)
            </button>
            <div style="margin-top: 20px; border-top: 1px solid #444; padding-top: 10px;">
                <p style="color:#ff5252; font-size:0.8rem;">–û–ü–ê–°–ù–ê–Ø –ó–û–ù–ê</p>
                <button class="shop-btn" style="background:#333; color:#ff5252; border:1px solid #ff5252;" onclick="hardReset()">
                    ‚ö†Ô∏è –ü–û–õ–ù–´–ô –°–ë–†–û–° (WIPE)
                </button>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
            authDomain: "warszawa-courier.firebaseapp.com",
            databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "warszawa-courier",
            storageBucket: "warszawa-courier.firebasestorage.app",
            messagingSenderId: "295860613508",
            appId: "1:295860613508:web:86fe8364377d6875612dd1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const USER_ID = "boss_real_001"; // –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π ID –¥–ª—è —Ç–µ—Å—Ç–∞

        // --- 2. GLOBAL DATA ---
        let map;
        let officeMarker;
        let courierMarkers = []; 
        let restaurantMarkers = [];
        
        // Default State
        let state = {
            balance: 5000,
            office: { lat: null, lng: null, rentPaid: Date.now() },
            inventory: { bike_250: 0, bag: 0, jacket: 0 },
            licenses: {} // { 'kebab_king': true }
        };

        const RESTAURANTS = [
            { id: 'kebab_king', name: 'Kebab King', lat: 52.230, lng: 21.015, emoji: 'üåØ' },
            { id: 'mcd', name: 'McDonalds', lat: 52.235, lng: 21.008, emoji: 'üçî' }
        ];

        // --- 3. INITIALIZATION ---
        window.onload = () => {
            initMap();
            loadData();
        };

        function initMap() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
            map = L.map('map', {
                zoomControl: false, 
                attributionControl: false
            }).setView([52.2297, 21.0122], 13);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            }).addTo(map);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±–∏—Ä–∞–µ–º –æ—Ñ–∏—Å)
            map.on('click', (e) => {
                const screen = document.getElementById('start-screen');
                if (screen.style.display === 'none') {
                    // –ò–≥—Ä–∞ –∏–¥–µ—Ç, –∫–ª–∏–∫–∏ –ø–æ –∫–∞—Ä—Ç–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º (–∏–ª–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ)
                } else if (document.getElementById('btn-select-office').style.display === 'block') {
                    // –†–µ–∂–∏–º –≤—ã–±–æ—Ä–∞ –æ—Ñ–∏—Å–∞
                    registerOffice(e.latlng.lat, e.latlng.lng);
                }
            });
        }

        // --- 4. DATA SYNC ---
        function loadData() {
            db.ref('players/' + USER_ID).on('value', (snap) => {
                const val = snap.val();
                if (val) {
                    state = { ...state, ...val };
                    // –§–∏–∫—Å —Å—Ç—Ä—É–∫—Ç—É—Ä
                    if (!state.inventory) state.inventory = { bike_250: 0, bag: 0, jacket: 0 };
                    if (!state.licenses) state.licenses = {};
                    
                    if (state.office.lat) {
                        document.getElementById('status-text').innerText = "–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.";
                        document.getElementById('btn-start').style.display = 'inline-block';
                        document.getElementById('btn-select-office').style.display = 'none';
                    } else {
                        document.getElementById('status-text').innerText = "–ù–µ—Ç –æ—Ñ–∏—Å–∞.";
                        document.getElementById('btn-start').style.display = 'none';
                        document.getElementById('btn-select-office').style.display = 'inline-block';
                    }
                } else {
                    // –ù–æ–≤—ã–π –∏–≥—Ä–æ–∫
                    document.getElementById('status-text').innerText = "–ù–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å.";
                    document.getElementById('btn-select-office').style.display = 'inline-block';
                }
                updateUI();
                manageCouriers(); // –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω—É–∂–Ω–æ –ª–∏ —Å–ø–∞–≤–Ω–∏—Ç—å –∫—É—Ä—å–µ—Ä–æ–≤
            });
        }

        function saveData() {
            db.ref('players/' + USER_ID).set(state);
        }

        // --- 5. GAME FLOW ---
        function prepareMapForSelection() {
            document.getElementById('start-screen').style.display = 'none';
            log("üìç –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –æ—Ñ–∏—Å!");
        }

        function registerOffice(lat, lng) {
            state.office.lat = lat;
            state.office.lng = lng;
            state.office.rentPaid = Date.now();
            saveData();
            
            // –°—Ä–∞–∑—É –∑–∞–ø—É—Å–∫–∞–µ–º
            enterGame();
        }

        function enterGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = 'flex';
            
            // –°—Ç–∞–≤–∏–º –º–∞—Ä–∫–µ—Ä –æ—Ñ–∏—Å–∞
            if (officeMarker) map.removeLayer(officeMarker);
            const icon = L.divIcon({ className: 'office-icon', html: 'üè¢', iconSize: [40,40], iconAnchor: [20,20] });
            officeMarker = L.marker([state.office.lat, state.office.lng], {icon: icon}).addTo(map);
            
            map.setView([state.office.lat, state.office.lng], 15);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã
            spawnRestaurants();

            // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
            startGameLoop();
        }

        function spawnRestaurants() {
            // –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ
            restaurantMarkers.forEach(m => map.removeLayer(m));
            restaurantMarkers = [];

            // –î–ª—è —Ç–µ—Å—Ç–∞ –¥–æ–±–∞–≤–∏–º –ª–∏—Ü–µ–Ω–∑–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –Ω–µ—Ç –¥–µ–Ω–µ–≥, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ö–∞–Ω–∏–∫—É
            // –ù–æ –ø–æ –ª–æ–≥–∏–∫–µ –∏–≥—Ä—ã –Ω—É–∂–Ω–æ –ø–æ–∫—É–ø–∞—Ç—å.
            RESTAURANTS.forEach(r => {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω –Ω–∞ –∫–∞—Ä—Ç–µ (–¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –∫—É–ø–ª–µ–Ω, –Ω–æ –±–ª–µ–¥–Ω—ã–π)
                // –ò–ª–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫—É–ø–ª–µ–Ω. –ü—É—Å—Ç—å –±—É–¥–µ—Ç –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω.
                const isBought = state.licenses[r.id];
                const opacity = isBought ? 1 : 0.5;
                const html = `<div style="font-size:24px; opacity:${opacity}">${r.emoji}</div>`;
                const icon = L.divIcon({ className: '', html: html, iconSize: [24,24] });
                const m = L.marker([r.lat, r.lng], {icon: icon}).addTo(map);
                restaurantMarkers.push(m);
            });
        }

        // --- 6. COURIER LOGIC (THE IMPORTANT PART) ---
        function manageCouriers() {
            // –õ–æ–≥–∏–∫–∞: 1 –∫—É—Ä—å–µ—Ä = 1 –≤–µ–ª–∏–∫ + 1 —Å—É–º–∫–∞ + 1 –∫—É—Ä—Ç–∫–∞
            const inv = state.inventory;
            const maxCouriers = Math.min(inv.bike_250, inv.bag, inv.jacket);
            
            document.getElementById('active-couriers-count').innerText = maxCouriers;
            document.getElementById('f-active').innerText = maxCouriers;

            // –ï—Å–ª–∏ –∫—É—Ä—å–µ—Ä–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ –º–µ–Ω—å—à–µ —á–µ–º –ø–æ–ª–æ–∂–µ–Ω–æ -> –¥–æ–±–∞–≤–ª—è–µ–º
            while (courierMarkers.length < maxCouriers) {
                spawnCourier();
            }
        }

        function spawnCourier() {
            if (!state.office.lat) return;

            const icon = L.divIcon({ className: 'emoji-icon', html: 'üö¥', iconSize: [26,26] });
            const marker = L.marker([state.office.lat, state.office.lng], {icon: icon}).addTo(map);
            
            // –î–∞–Ω–Ω—ã–µ –∫—É—Ä—å–µ—Ä–∞
            const courierData = {
                marker: marker,
                pos: { lat: state.office.lat, lng: state.office.lng },
                target: null,
                state: 'IDLE', // IDLE, TO_REST, TO_CLIENT, RETURN
                wait: 0
            };
            
            courierMarkers.push(courierData);
            log("–ö—É—Ä—å–µ—Ä –≤—ã—à–µ–ª –Ω–∞ —Å–º–µ–Ω—É! üö¥");
        }

        function startGameLoop() {
            setInterval(() => {
                // –ê—Ä–µ–Ω–¥–∞
                const now = Date.now();
                const diff = now - state.office.rentPaid;
                const timeLeft = (5 * 60 * 1000) - diff;
                
                if (timeLeft > 0) {
                    const m = Math.floor(timeLeft/60000);
                    const s = Math.floor((timeLeft%60000)/1000);
                    document.getElementById('ui-timer').innerText = `${m}:${s<10?'0':''}${s}`;
                } else {
                    document.getElementById('ui-timer').innerText = "–î–û–õ–ì";
                }

                // –î–≤–∏–∂–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–æ–≤
                moveCouriers();

            }, 200); // 5 —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        }

        function moveCouriers() {
            const SPEED = 0.00015; // –°–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è

            courierMarkers.forEach(c => {
                // 1. –ü–æ–∏—Å–∫ –∑–∞–¥–∞—á–∏
                if (c.state === 'IDLE') {
                    // –ò—â–µ–º –ª—é–±–æ–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω (–¥–∞–∂–µ –±–µ–∑ –ª–∏—Ü–µ–Ω–∑–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∞, –Ω–æ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º —Å –ª–∏—Ü–µ–Ω–∑–∏–µ–π)
                    // –í–æ–∑—å–º–µ–º –±–ª–∏–∂–∞–π—à–∏–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω –∏–∑ —Å–ø–∏—Å–∫–∞
                    const targetRest = RESTAURANTS[Math.floor(Math.random() * RESTAURANTS.length)];
                    c.target = { lat: targetRest.lat, lng: targetRest.lng, type: 'REST' };
                    c.state = 'MOVING';
                }

                // 2. –î–≤–∏–∂–µ–Ω–∏–µ
                if (c.state === 'MOVING' && c.target) {
                    const dLat = c.target.lat - c.pos.lat;
                    const dLng = c.target.lng - c.pos.lng;
                    const dist = Math.sqrt(dLat*dLat + dLng*dLng);

                    if (dist < SPEED) {
                        // –ü—Ä–∏–±—ã–ª
                        c.pos = c.target;
                        
                        if (c.target.type === 'REST') {
                            c.state = 'WAITING';
                            c.wait = 10; // 2 —Å–µ–∫—É–Ω–¥—ã (10 * 200–º—Å)
                            updateCourierIcon(c.marker, '‚è≥');
                        } else if (c.target.type === 'CLIENT') {
                            // –ü—Ä–∏–±—ã–ª—å
                            const profit = Math.floor(Math.random() * 20) + 10;
                            state.balance += profit;
                            saveData();
                            log(`–î–æ—Å—Ç–∞–≤–∫–∞! +${profit} PLN üíµ`);
                            
                            c.state = 'IDLE'; // –û–±—Ä–∞—Ç–Ω–æ –∏—Å–∫–∞—Ç—å –∑–∞–∫–∞–∑
                            updateCourierIcon(c.marker, 'üö¥');
                        }
                    } else {
                        // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è
                        const ratio = SPEED / dist;
                        c.pos.lat += dLat * ratio;
                        c.pos.lng += dLng * ratio;
                    }
                    c.marker.setLatLng([c.pos.lat, c.pos.lng]);
                }

                // 3. –û–∂–∏–¥–∞–Ω–∏–µ (–≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ)
                if (c.state === 'WAITING') {
                    c.wait--;
                    if (c.wait <= 0) {
                        // –í–∑—è–ª –∑–∞–∫–∞–∑, –µ–¥–µ—Ç –∫ –∫–ª–∏–µ–Ω—Ç—É (—Å–ª—É—á–∞–π–Ω–∞—è —Ç–æ—á–∫–∞ —Ä—è–¥–æ–º)
                        const offset = 0.01;
                        c.target = { 
                            lat: c.pos.lat + (Math.random()*offset*2 - offset),
                            lng: c.pos.lng + (Math.random()*offset*2 - offset),
                            type: 'CLIENT'
                        };
                        c.state = 'MOVING';
                        updateCourierIcon(c.marker, 'üéí');
                    }
                }
            });
        }

        function updateCourierIcon(marker, emoji) {
            const el = marker.getElement();
            if (el) el.innerHTML = emoji;
        }

        // --- 7. ACTIONS ---
        function buy(item, cost) {
            if (state.balance >= cost) {
                state.balance -= cost;
                state.inventory[item]++;
                saveData();
                log(`–ö—É–ø–ª–µ–Ω–æ: ${item}`);
            } else {
                log("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥!", "red");
            }
        }
        
        function buyLicense(id) {
             if (state.balance >= 2500) {
                state.balance -= 2500;
                state.licenses[id] = true;
                saveData();
                spawnRestaurants(); // –û–±–Ω–æ–≤–∏—Ç—å –≤–∏–¥
                log("–õ–∏—Ü–µ–Ω–∑–∏—è –∫—É–ø–ª–µ–Ω–∞!");
            } else {
                log("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥!", "red");
            }
        }

        function payRent() {
            if (state.balance >= 500) {
                state.balance -= 500;
                state.office.rentPaid = Date.now();
                saveData();
                log("–ê—Ä–µ–Ω–¥–∞ –ø—Ä–æ–¥–ª–µ–Ω–∞.");
            }
        }

        function hardReset() {
            if(confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω.")) {
                state = null; // force clear local
                db.ref('players/' + USER_ID).remove().then(() => {
                    location.reload();
                });
            }
        }

        // --- UI UTILS ---
        function updateUI() {
            document.getElementById('ui-balance').innerText = state.balance + " PLN";
            
            // Inventory counts
            document.getElementById('qty-bike').innerText = state.inventory.bike_250;
            document.getElementById('qty-bag').innerText = state.inventory.bag;
            document.getElementById('qty-jacket').innerText = state.inventory.jacket;
            
            // Fleet modal counts
            document.getElementById('f-bikes').innerText = state.inventory.bike_250;
            document.getElementById('f-bags').innerText = state.inventory.bag;
            document.getElementById('f-jackets').innerText = state.inventory.jacket;
        }

        function log(msg, color="#fff") {
            const area = document.getElementById('log-area');
            const el = document.createElement('div');
            el.className = 'log-entry';
            el.innerText = msg;
            if(color === 'red') el.style.borderLeftColor = '#ff5252';
            area.appendChild(el);
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ
            if (area.children.length > 5) area.removeChild(area.firstChild);
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(e, id) { if(e.target.id === id) document.getElementById(id).style.display = 'none'; }

    </script>
</body>
</html>
