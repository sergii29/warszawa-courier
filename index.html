<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Courier Simulator Warsaw</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#fff}
#map{height:72vh}
#panel{height:28vh;padding:10px;box-shadow:0 -6px 20px rgba(0,0,0,.15)}
button{width:100%;padding:14px;font-size:16px;font-weight:600;border:none;border-radius:12px;background:#00aaff;color:#fff;margin-top:6px}
button.gray{background:#e4eef4;color:#333}
.tab{display:none}
.tab.active{display:block}
.order{background:#f4f8fb;padding:10px;border-radius:10px;margin-top:6px;font-size:14px}
.small{font-size:13px;opacity:.8}
</style>
</head>

<body>

<div id="map"></div>

<div id="panel">
  <div id="mainTab" class="tab active">
    <div id="status">ğŸ”˜ ĞÑ„Ğ»Ğ°Ğ¹Ğ½</div>
    <div class="small">
      âš¡ <span id="energy">100</span>% |
      ğŸ” <span id="food">60</span>% |
      ğŸš² <span id="bike">100</span>% |
      ğŸ”‹ <span id="battery">100</span>%
      ğŸ’° <span id="money">0</span> zÅ‚
    </div>

    <div id="orderBox"></div>

    <button onclick="mainAction()" id="mainBtn">ğŸŸ¢ Ğ’Ñ‹Ğ¹Ñ‚Ğ¸ Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½</button>
    <button class="gray" onclick="openShop()">ğŸ›’ ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½</button>
  </div>

  <div id="shopTab" class="tab">
    <b>ğŸ›’ ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½</b>
    <button onclick="buy('food')">ğŸ” Ğ•Ğ´Ğ° (+30%) â€” 12 zÅ‚</button>
    <button onclick="buy('bike')">ğŸ”§ Ğ ĞµĞ¼Ğ¾Ğ½Ñ‚ Ğ²ĞµĞ»Ğ¾ â€” 20 zÅ‚</button>
    <button onclick="buy('battery')">ğŸ”‹ Ğ—Ğ°Ñ€ÑĞ´ â€” 10 zÅ‚</button>
    <button onclick="buy('energy')">â˜• ĞšĞ¾Ñ„Ğµ â€” 15 zÅ‚</button>
    <button class="gray" onclick="closeShop()">â¬… ĞĞ°Ğ·Ğ°Ğ´</button>
  </div>
</div>

<script>
/* ===== Ğ¡ĞĞ¡Ğ¢ĞĞ¯ĞĞ˜Ğ• ===== */
let s = JSON.parse(localStorage.getItem("courier_warsaw")) || {
  phase:"offline",
  energy:100, food:60, bike:100, battery:100,
  money:0,
  step:0,
  order:null
};

/* ===== ĞšĞĞ Ğ¢Ğ ===== */
const map = L.map('map').setView([52.2297,21.0122],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let courierPos=[52.2297,21.0122];
const courier=L.marker(courierPos).addTo(map);
let route=null;

/* ===== Ğ”ĞĞĞĞ«Ğ• Ğ—ĞĞšĞĞ—ĞĞ’ ===== */
const restaurants=[
  {name:"La Pizza Napoletana",pos:[52.2335,21.002]},
  {name:"Kebab King",pos:[52.221,21.01]},
  {name:"Burger House",pos:[52.226,21.025]}
];

/* ===== UI ===== */
function updateUI(){
  energy.innerText=Math.floor(s.energy);
  food.innerText=Math.floor(s.food);
  bike.innerText=Math.floor(s.bike);
  battery.innerText=Math.floor(s.battery);
  money.innerText=s.money;
}
function save(){localStorage.setItem("courier_warsaw",JSON.stringify(s));}

/* ===== ĞĞ¡ĞĞĞ’ĞĞĞ¯ ĞšĞĞĞŸĞšĞ ===== */
function mainAction(){
  if(s.phase==="offline"){
    s.phase="online";
    status.innerText="ğŸŸ¢ ĞĞ½Ğ»Ğ°Ğ¹Ğ½. ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ğ°â€¦";
    mainBtn.innerText="ğŸ”” Ğ–Ğ´Ğ°Ñ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ·";
  }
  else if(s.phase==="online"){
    spawnOrder();
  }
  else if(s.phase==="toRestaurant"){
    moveStep(s.order.restaurant.pos,()=>{
      s.phase="waiting";
      status.innerText="â³ ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ğ°â€¦";
      setTimeout(()=>{
        s.phase="toClient";
        status.innerText="ğŸ“¦ Ğ—Ğ°Ğ±Ñ€Ğ°Ğ» Ğ·Ğ°ĞºĞ°Ğ·. Ğ•Ğ´ĞµÑˆÑŒ Ğº ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ";
        drawRoute(courierPos,s.order.clientPos);
        mainBtn.innerText="ğŸš´ Ğ•Ñ…Ğ°Ñ‚ÑŒ";
      },2000);
    });
  }
  else if(s.phase==="toClient"){
    moveStep(s.order.clientPos,()=>{
      s.money+=s.order.pay;
      s.phase="online";
      orderBox.innerHTML="";
      status.innerText="ğŸŸ¢ ĞĞ½Ğ»Ğ°Ğ¹Ğ½. Ğ—Ğ°ĞºĞ°Ğ· Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½";
      mainBtn.innerText="ğŸ”” Ğ–Ğ´Ğ°Ñ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ·";
    });
  }
  drain();
  save();updateUI();
}

/* ===== Ğ—ĞĞšĞĞ— ===== */
function spawnOrder(){
  const r=restaurants[Math.floor(Math.random()*restaurants.length)];
  const client=[52.22+Math.random()*0.02,21.01+Math.random()*0.02];
  const dist=distance(courierPos,r.pos);
  const pay=Math.floor(6+dist*2.5);

  s.order={restaurant:r,clientPos:client,pay,dist};

  orderBox.innerHTML=`
    <div class="order">
      ğŸ´ ${r.name}<br>
      ğŸ“ ${dist.toFixed(1)} ĞºĞ¼<br>
      ğŸ’° ${pay} zÅ‚
    </div>`;
  s.phase="toRestaurant";
  status.innerText="ğŸ” ĞŸÑ€Ğ¸Ğ½ÑÑ‚ Ğ·Ğ°ĞºĞ°Ğ·. Ğ•Ğ´ĞµÑˆÑŒ Ğ² Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½";
  mainBtn.innerText="ğŸš´ Ğ•Ñ…Ğ°Ñ‚ÑŒ";
  drawRoute(courierPos,r.pos);
}

/* ===== Ğ”Ğ’Ğ˜Ğ–Ğ•ĞĞ˜Ğ• ===== */
function moveStep(target,done){
  const dx=(target[0]-courierPos[0])/15;
  const dy=(target[1]-courierPos[1])/15;
  courierPos[0]+=dx; courierPos[1]+=dy;
  courier.setLatLng(courierPos);
  map.panTo(courierPos,{animate:true});
  s.step++;
  if(s.step>=15){
    courierPos=[...target];
    courier.setLatLng(courierPos);
    clearRoute();
    s.step=0;
    done();
  }
}

/* ===== Ğ ĞĞ¡Ğ¥ĞĞ” ===== */
function drain(){
  if(s.phase==="toRestaurant"||s.phase==="toClient"){
    s.energy-=2; s.food-=1; s.bike-=1; s.battery-=1;
  }
}

/* ===== ĞœĞĞ“ĞĞ—Ğ˜Ğ ===== */
function openShop(){mainTab.classList.remove("active");shopTab.classList.add("active")}
function closeShop(){shopTab.classList.remove("active");mainTab.classList.add("active")}
function buy(type){
  if(type==="food"&&s.money>=12){s.money-=12;s.food+=30}
  if(type==="bike"&&s.money>=20){s.money-=20;s.bike=100}
  if(type==="battery"&&s.money>=10){s.money-=10;s.battery=100}
  if(type==="energy"&&s.money>=15){s.money-=15;s.energy+=30}
  updateUI();save();
}

/* ===== Ğ’Ğ¡ĞŸĞĞœĞĞ“ ===== */
function drawRoute(a,b){clearRoute();route=L.polyline([a,b],{color:"#00aaff"}).addTo(map)}
function clearRoute(){if(route)map.removeLayer(route)}
function distance(a,b){
  return Math.sqrt(Math.pow(a[0]-b[0],2)+Math.pow(a[1]-b[1],2))*111;
}

updateUI();
</script>

</body>
</html>
