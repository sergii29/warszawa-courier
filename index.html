<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warszawa Courier: Night City</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root {
            /* Premium Dark Palette */
            --bg: #0f1115; 
            --panel: rgba(30, 34, 45, 0.85);
            --grid-line: rgba(255, 255, 255, 0.05);
            --accent: #00ff88; /* Cyber Green */
            --warn: #ff3355;   /* Cyber Red */
            --gold: #ffb700;
            --text-main: #e0e0e0;
            --text-muted: #8b9bb4;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; font-family: 'Segoe UI', Roboto, Helvetica, monospace; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); color: var(--text-main); }

        /* –ò–ì–†–û–í–û–ï –ü–û–õ–ï */
        #game-area {
            position: absolute; top: 110px; left: 0; right: 0; bottom: 220px;
            background-image: linear-gradient(var(--grid-line) 1px, transparent 1px), linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 30px 30px; 
            z-index: 1; overflow: hidden; 
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
            border-top: 1px solid rgba(255,255,255,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        /* –°–ò–†–ï–ù–ê */
        @keyframes siren-flash { 0% {box-shadow: inset 0 0 0 0 transparent;} 50% {box-shadow: inset 0 0 50px 20px rgba(255, 51, 85, 0.4);} 100% {box-shadow: inset 0 0 0 0 transparent;} }
        .siren-active { animation: siren-flash 1s infinite; }

        /* –°–£–©–ù–û–°–¢–ò */
        .entity { 
            position: absolute; width: 30px; height: 30px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 18px; transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }
        #player { 
            z-index: 100; font-size: 20px; 
            background: var(--accent); color: #000;
            border-radius: 50%; box-shadow: 0 0 15px var(--accent);
        }
        .police { 
            z-index: 50; transition: top 0.8s linear, left 0.8s linear; 
            font-size: 22px;
        }
        .obs { 
            z-index: 10; opacity: 0.8; 
            background: #2a2e38; border-radius: 4px; border: 1px solid #444;
            color: transparent; /* –°–∫—Ä—ã–≤–∞–µ–º —ç–º–æ–¥–∑–∏, –æ—Å—Ç–∞–≤–ª—è–µ–º –±–ª–æ–∫ */
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .obs::after { content: ''; width: 6px; height: 6px; background: #555; border-radius: 50%; }

        /* UI HEADER */
        #top-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 110px;
            background: var(--panel); backdrop-filter: blur(10px);
            z-index: 200; padding: 15px; display: flex; flex-direction: column; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .wallet-row { display: flex; width: 100%; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .balance-group { display: flex; flex-direction: column; }
        .stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { font-size: 22px; font-weight: 700; color: var(--text-main); font-family: monospace; letter-spacing: -1px; }
        .stat-value.gold { color: var(--gold); }
        
        .bars-container { width: 100%; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .bar-col { display: flex; flex-direction: column; gap: 4px; }
        .bar-track { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.3s; border-radius: 2px; }

        /* UI BOTTOM */
        #bot-ui {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 220px;
            background: var(--panel); backdrop-filter: blur(10px);
            z-index: 200; border-top: 1px solid rgba(255,255,255,0.05);
            display: flex; flex-direction: column; align-items: center; padding-top: 15px;
        }

        /* CONTROLS */
        .joy-pad { display: grid; grid-template-columns: 65px 65px 65px; grid-template-rows: 55px 55px; gap: 6px; margin-top: 5px;}
        .j-btn { 
            background: linear-gradient(145deg, #2a2e38, #22252e); 
            border: 1px solid rgba(255,255,255,0.05); 
            border-radius: 12px; font-size: 20px; color: var(--text-muted);
            display: flex; align-items: center; justify-content: center; cursor: pointer; 
            box-shadow: 0 4px 0 #15171c; transition: transform 0.1s;
        }
        .j-btn:active { background: #1e2129; box-shadow: 0 1px 0 #15171c; transform: translateY(3px); color: var(--accent); }
        .u { grid-column: 2; grid-row: 1; } .l { grid-column: 1; grid-row: 2; } 
        .d { grid-column: 2; grid-row: 2; } .r { grid-column: 3; grid-row: 2; }

        .btn-main { 
            background: linear-gradient(90deg, var(--accent), #00cc6a); 
            color: #000; border: none; padding: 16px 60px; 
            font-weight: 800; border-radius: 30px; margin-top: 30px; 
            box-shadow: 0 10px 20px rgba(0, 255, 136, 0.2);
            text-transform: uppercase; letter-spacing: 1px;
        }

        /* MODALS & MENUS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .popup { background: #1e222d; padding: 25px; border-radius: 16px; width: 85%; max-width: 320px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 40px rgba(0,0,0,0.5); text-align: center; }
        
        #menu-btn { position: absolute; top: 15px; left: 15px; width: 40px; height: 40px; background: rgba(255,255,255,0.1); z-index: 201; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; gap:5px; backdrop-filter: blur(4px); }
        .ml { width: 20px; height: 2px; background: var(--text-main); border-radius: 2px; }
        
        #sidebar { 
            position: fixed; top:0; left:-320px; width:300px; height:100%; 
            background: #15171c; z-index:2001; transition:0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            border-right: 1px solid rgba(255,255,255,0.1); padding:25px; overflow-y:auto; 
            box-shadow: 10px 0 30px rgba(0,0,0,0.5);
        }
        #sidebar.open { left:0; }
        
        .bank-card { 
            background: linear-gradient(135deg, #1a2980, #26d0ce); 
            color: white; padding: 20px; border-radius: 16px; margin-bottom: 15px; 
            box-shadow: 0 10px 20px rgba(38, 208, 206, 0.2); 
            position: relative; overflow: hidden;
        }
        .bank-card::after { content:'PKO'; position:absolute; right:-10px; bottom:-10px; font-size:60px; opacity:0.1; font-weight:900; font-style:italic;}

        .buy-btn {
            background: rgba(255,255,255,0.1); border:none; color:white;
            padding: 8px 16px; border-radius: 8px; font-weight:600; font-size:12px;
        }
        .buy-btn.action { background: var(--accent); color: black; }
        .buy-btn.danger { background: var(--warn); color: white; }

        #arrest-screen {
            position: fixed; top:0; left:0; width:100%; height:100%; z-index: 9000;
            background: #000; display: none; flex-direction: column;
            align-items: center; justify-content: center; color: var(--warn);
        }
        
        #toast { 
            position: fixed; top: 130px; left: 50%; transform: translateX(-50%); 
            background: rgba(20, 20, 20, 0.9); color: white; 
            padding: 10px 20px; border-radius: 30px; z-index: 5000; 
            display: none; font-size: 12px; font-weight: bold; border: 1px solid #333;
        }

        h3, h4 { color: var(--text-main); margin: 0 0 10px 0; }
        hr { border: 0; border-bottom: 1px solid rgba(255,255,255,0.1); margin: 15px 0; }
    </style>
</head>
<body>

<div id="top-ui">
    <div class="wallet-row">
        <div class="balance-group">
            <div class="stat-label">–ù–∞–ª–∏—á–Ω—ã–µ</div>
            <div class="stat-value" id="cash">0.00</div>
        </div>
        <div class="balance-group" style="align-items: flex-end;">
            <div class="stat-label">–ë–∞–Ω–∫ PKO</div>
            <div class="stat-value gold" id="bank">0.00</div>
        </div>
    </div>
    
    <div class="bars-container">
        <div class="bar-col">
            <div style="display:flex; justify-content:space-between; font-size:9px; color:orange"><span>–≠–ù–ï–†–ì–ò–Ø</span><span id="txt-en">100</span></div>
            <div class="bar-track"><div id="b-en" class="bar-fill" style="width:100%; background:orange"></div></div>
        </div>
        <div class="bar-col">
            <div style="display:flex; justify-content:space-between; font-size:9px; color:#00aaff"><span>–í–û–î–ê</span><span id="txt-wat">100</span></div>
            <div class="bar-track"><div id="b-wat" class="bar-fill" style="width:100%; background:#00aaff"></div></div>
        </div>
        <div class="bar-col">
            <div style="display:flex; justify-content:space-between; font-size:9px; color:#ff3355"><span>–ë–ê–ô–ö</span><span id="txt-hp">100</span></div>
            <div class="bar-track"><div id="b-hp" class="bar-fill" style="width:100%; background:#ff3355"></div></div>
        </div>
    </div>
</div>

<div id="menu-btn" onclick="toggleMenu()"><div class="ml"></div><div class="ml"></div><div class="ml"></div></div>

<div id="arrest-screen">
    <div style="font-size:60px; margin-bottom:20px; animation: pulse 0.5s infinite">üöî</div>
    <h1 style="font-weight:900; letter-spacing:4px; text-transform:uppercase">–ê–†–ï–°–¢–û–í–ê–ù</h1>
    <p style="color:#888; margin-top:-10px">–¢–≤–æ–π –±–∞–π–∫ –∫–æ–Ω—Ñ–∏—Å–∫–æ–≤–∞–Ω –Ω–∞ —à—Ç—Ä–∞—Ñ—Å—Ç–æ—è–Ω–∫—É</p>
    <h2 style="color: white; margin-top:20px">-150 PLN –®–¢–†–ê–§</h2>
</div>

<div id="game-area">
    <div id="player" class="entity">üö≤</div>
    <div id="target" class="entity" style="display:none; filter: drop-shadow(0 0 8px gold);">üì¶</div>
</div>

<div id="bot-ui">
    <div style="display:flex; justify-content:space-between; width:100%; padding: 0 20px; font-size:12px; color:var(--text-muted)">
        <span id="status">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</span>
        <span id="timer" style="color:var(--warn); font-weight:bold; display:none">00:00</span>
    </div>

    <button id="btn-start" class="btn-main" onclick="startShift()">–ù–ê–ß–ê–¢–¨ –°–ú–ï–ù–£</button>
    <div id="btn-stop" style="display:none; color:var(--warn); font-size:12px; margin-top:10px; cursor:pointer; text-decoration:underline" onclick="endShift()">–ó–ê–ö–û–ù–ß–ò–¢–¨ –†–ê–ë–û–¢–£</div>

    <div id="joy" class="joy-pad" style="display:none">
        <div class="j-btn u" onclick="move(0, -1)">‚ñ≤</div>
        <div class="j-btn l" onclick="move(-1, 0)">‚óÄ</div>
        <div class="j-btn d" onclick="move(0, 1)">‚ñº</div>
        <div class="j-btn r" onclick="move(1, 0)">‚ñ∂</div>
    </div>
</div>

<div id="sidebar">
    <div style="font-size:10px; color:gray; text-transform:uppercase; margin-bottom:20px">Warszawa Courier v7.0 Night City</div>
    
    <h3>–ú–ê–ì–ê–ó–ò–ù</h3>
    <div id="shop-list"></div>
    
    <hr>
    <h3>–ë–ê–ù–ö–ò–ù–ì</h3>
    <div id="bank-ui"></div>
    
    <hr>
    <h3>–ì–ê–†–ê–ñ</h3>
    <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center">
        <div>
            <div style="font-weight:bold">–†–µ–º–æ–Ω—Ç –±–∞–π–∫–∞</div>
            <div style="font-size:10px; color:gray">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å 100% HP</div>
        </div>
        <button class="buy-btn action" onclick="repairBike()">FIX</button>
    </div>
    
    <div style="margin-top:30px; font-size:10px; color:gray; word-break:break-all">ID: <span id="uid">...</span></div>
</div>
<div id="side-overlay" onclick="toggleMenu()" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; display:none; backdrop-filter: blur(2px);"></div>

<div id="job-modal" class="modal">
    <div class="popup">
        <h2 style="color:var(--accent)">–ù–û–í–´–ô –ó–ê–ö–ê–ó</h2>
        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px; margin:15px 0; text-align:left">
            <div style="margin-bottom:5px">üìç –î–∏—Å—Ç–∞–Ω—Ü–∏—è: <b id="j-dist" style="color:white">0</b> –∫–º</div>
            <div>üí∞ –û–ø–ª–∞—Ç–∞: <b id="j-pay" style="color:var(--gold); font-size:18px">0.00</b> PLN</div>
        </div>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button class="buy-btn" style="flex:1; padding:12px; font-size:14px" onclick="ansJob(false)">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            <button class="buy-btn action" style="flex:1; padding:12px; font-size:14px" onclick="ansJob(true)">–ü–†–ò–ù–Ø–¢–¨</button>
        </div>
    </div>
</div>

<div id="toast">Message</div>

<script>
    // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
        authDomain: "warszawa-courier.firebaseapp.com",
        databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "warszawa-courier",
        storageBucket: "warszawa-courier.firebasestorage.app",
        messagingSenderId: "295860613508",
        appId: "1:295860613508:web:86fe8364377d6875612dd1"
    };
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç —Å–±–æ–µ–≤
    try {
        firebase.initializeApp(firebaseConfig);
    } catch(e) { console.log("Firebase already init"); }
    const db = firebase.database();

    // --- –°–ò–°–¢–ï–ú–ê –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò ---
    const tg = window.Telegram.WebApp; tg.expand();
    
    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ID: Telegram -> LocalStorage -> –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ
    let userId = tg.initDataUnsafe?.user?.id;
    if(!userId) {
        userId = localStorage.getItem('warszawa_uid');
        if(!userId) {
            userId = 'anon_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('warszawa_uid', userId);
        }
    }
    document.getElementById('uid').innerText = userId;

    // --- –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ (State) ---
    // –ö–ª—é—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: WARSZAWA_FOREVER (–ª–æ–≥–∏—á–µ—Å–∫–∏ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ë–î)
    const DB_VER = 7; 
    const STEP = 30;
    
    let st = {
        bal: 0.00, bank: 0.00, debt: 0.00, lvl: 1,
        en: 100, wat: 100, hp: 100,
        x: 30, y: 30
    };

    let isShift = false;
    let isPaused = false;
    let police = [];
    let obs = [];
    let loops = {};
    let target = { active: false, x:0, y:0, type:0, offer:null };

    // --- –Ø–î–†–û (Init & Save) ---
    function init() {
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö. –ï—Å–ª–∏ –∫–µ—à –æ—á–∏—â–µ–Ω, –¥–∞–Ω–Ω—ã–µ –ø–æ–¥—Ç—è–Ω—É—Ç—Å—è –∏–∑ Cloud –ø–æ ID
        db.ref('users/' + userId).once('value', s => {
            const d = s.val();
            if(d) {
                // –ú—è–≥–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –±–∞–ª–∞–Ω—Å, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –µ—Å–ª–∏ –Ω–∞–¥–æ
                st.bal = Number(d.bal) || 0;
                st.bank = Number(d.bank) || 0;
                st.debt = Number(d.debt) || 0;
                st.lvl = d.lvl || 1;
                // –†–µ—Å—É—Ä—Å—ã –Ω–µ –≤—Å–µ–≥–¥–∞ –Ω—É–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –¥–æ 100, –Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ –ø–∞—É–∑—ã:
                st.en = d.en || 100; st.wat = d.wat || 100; st.hp = d.hp || 100;
            } else {
                save(); // –ù–æ–≤—ã–π —é–∑–µ—Ä
            }
            render();
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü –Ω–∞ —Å–ª—É—á–∞–π –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —ç–∫—Ä–∞–Ω–∞
            setInterval(ensureBounds, 2000);
        });
    }

    function save() {
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ "–ù–∞–º–µ—Ä—Ç–≤–æ"
        db.ref('users/' + userId).update({
            ver: DB_VER,
            bal: st.bal, bank: st.bank, debt: st.debt, lvl: st.lvl,
            en: st.en, wat: st.wat, hp: st.hp,
            last_login: Date.now()
        });
    }

    function ensureBounds() {
        if(isPaused || !isShift) return;
        const box = document.getElementById('game-area');
        if(!box) return;
        
        const maxX = box.offsetWidth - 30;
        const maxY = box.offsetHeight - 30;
        let fix = false;

        // –¢–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è, –µ—Å–ª–∏ –∑–∞—Å—Ç—Ä—è–ª –∑–∞ —ç–∫—Ä–∞–Ω–æ–º
        if(st.x < 0){st.x=0; fix=true;} 
        if(st.y < 0){st.y=0; fix=true;}
        if(st.x > maxX){st.x=maxX-(maxX%STEP); fix=true;} 
        if(st.y > maxY){st.y=maxY-(maxY%STEP); fix=true;}
        
        if(fix) { renderPlayer(); save(); }
    }

    function forceRescue() {
        // –ê–≤–∞—Ä–∏–π–Ω—ã–π —Å–±—Ä–æ—Å –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –±–∞–∑—É
        st.x = 30; st.y = 30; 
        renderPlayer(); save();
    }

    // --- –ì–ï–ô–ú–ü–õ–ï–ô ---
    function startShift() {
        if(st.en < 10) return showToast("–ù—É–∂–Ω–æ –ø–æ–µ—Å—Ç—å! (–ú–∞–≥–∞–∑–∏–Ω)");
        if(st.hp <= 10) return showToast("–ë–∞–π–∫ —Ä–∞–∑–±–∏—Ç! (–ì–∞—Ä–∞–∂)");
        
        isShift = true; isPaused = false;
        
        // UI –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ
        document.getElementById('btn-start').style.display = 'none';
        document.getElementById('joy').style.display = 'grid';
        document.getElementById('btn-stop').style.display = 'block';
        document.getElementById('status').innerText = "–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤...";
        
        spawnWorld(); // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–æ—Ä–æ–¥–∞
        newJobPhase(1); // –ü–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑
        
        if(loops.pol) clearInterval(loops.pol);
        loops.pol = setInterval(policeAI, 800); // 0.8 —Å–µ–∫ —Ç–∏–∫ (–±—ã—Å—Ç—Ä–µ–µ —á–µ–º —Ä–∞–Ω—å—à–µ)
    }

    function endShift() {
        isShift = false;
        clearInterval(loops.timer); clearInterval(loops.pol);
        document.getElementById('btn-start').style.display = 'block';
        document.getElementById('joy').style.display = 'none';
        document.getElementById('btn-stop').style.display = 'none';
        document.getElementById('target').style.display = 'none';
        document.getElementById('timer').style.display = 'none';
        document.getElementById('status').innerText = "–°–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞";
        document.getElementById('game-area').classList.remove('siren-active');
        
        // –û—á–∏—Å—Ç–∫–∞ –∫–∞—Ä—Ç—ã
        obs.forEach(o=>o.el.remove()); obs=[];
        police.forEach(p=>p.el.remove()); police=[];
    }

    function move(dx, dy) {
        if(!isShift || isPaused) return;
        
        const box = document.getElementById('game-area');
        let nx = st.x + (dx * STEP);
        let ny = st.y + (dy * STEP);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü
        if(nx < 0 || ny < 0 || nx > box.offsetWidth-30 || ny > box.offsetHeight-30) return showToast("–ì—Ä–∞–Ω–∏—Ü–∞ –∑–æ–Ω—ã!");
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π (–°–¢–ï–ù–´)
        if(obs.some(o => dist(o.x, o.y, nx, ny) < 10)) return showToast("üöß –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ!");
        
        st.x = nx; st.y = ny;
        
        // –†–∞—Å—Ö–æ–¥ —Ä–µ—Å—É—Ä—Å–æ–≤
        st.en -= 0.4; st.wat -= 0.2; st.hp -= 0.05;
        if(st.en<=0 || st.wat<=0) endShift();
        
        renderPlayer();
        checkPoliceProx(); // –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        checkJob();
        save();
    }

    // --- –õ–û–ì–ò–ö–ê –ú–ò–†–ê (–ë–ï–ó –ë–ê–ì–û–í) ---
    function spawnWorld() {
        // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ
        obs.forEach(o=>o.el.remove()); obs=[];
        police.forEach(p=>p.el.remove()); police=[];

        const box = document.getElementById('game-area');
        const cols = Math.floor(box.offsetWidth/STEP);
        const rows = Math.floor(box.offsetHeight/STEP);
        
        // 1. –°–ø–∞–≤–Ω –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π (–Ω–µ —Ä—è–¥–æ–º —Å –∏–≥—Ä–æ–∫–æ–º)
        for(let i=0; i<12; i++) { // –ë–æ–ª—å—à–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π –¥–ª—è –∏–Ω—Ç–µ—Ä–µ—Å–∞
            let p = getRandomValidPos(cols, rows, false); // false = –Ω–µ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å obs, –∏—Ö –µ—â–µ –Ω–µ—Ç, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∏–º –∏–≥—Ä–æ–∫–∞
            if(p) {
                let el = mkEnt('obs', '', p.x, p.y); // –ü—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç, —Å—Ç–∏–ª–∏ —Ä–µ—à–∞—é—Ç
                obs.push({...p, el});
            }
        }
        
        // 2. –°–ø–∞–≤–Ω –ø–æ–ª–∏—Ü–∏–∏ (–≤–¥–∞–ª–∏ –æ—Ç –∏–≥—Ä–æ–∫–∞)
        for(let i=0; i<4; i++) { 
            let p = getRandomValidPos(cols, rows, true);
            if(p) {
                let el = mkEnt('police', 'üöì', p.x, p.y);
                police.push({...p, el});
            }
        }
    }

    // –£–º–Ω—ã–π –ø–æ–∏—Å–∫ —Å–≤–æ–±–æ–¥–Ω–æ–π –∫–ª–µ—Ç–∫–∏ (—Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å–ø–∞–≤–Ω–∞ –≤ —Å—Ç–µ–Ω–∞—Ö)
    function getRandomValidPos(cols, rows, checkObs) {
        let attempts = 0;
        let p = {x:0, y:0};
        do {
            p.x = Math.floor(Math.random() * (cols-1)) * STEP;
            p.y = Math.floor(Math.random() * (rows-1)) * STEP;
            
            // –ù–µ —Å–ø–∞–≤–Ω–∏—Ç—å –Ω–∞ –∏–≥—Ä–æ–∫–µ (—Ä–∞–¥–∏—É—Å 60px)
            if(dist(p.x, p.y, st.x, st.y) < 60) continue;
            
            // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ –ø–æ–ø–∞–ª–∏ –ª–∏ –≤ —Å—Ç–µ–Ω—É
            let collision = false;
            if(checkObs) {
                if(obs.some(o => dist(o.x, o.y, p.x, p.y) < 10)) collision = true;
            }
            if(!collision) return p;
            
            attempts++;
        } while(attempts < 50);
        return null; // –ù–µ –Ω–∞—à–ª–∏ –º–µ—Å—Ç–æ (—Ä–µ–¥–∫–æ)
    }

    // --- –ü–û–õ–ò–¶–ò–Ø 2.0 (–£–ú–ù–ê–Ø) ---
    function policeAI() {
        if(!isShift || isPaused) return;
        const box = document.getElementById('game-area');

        police.forEach(p => {
            let dx = 0, dy = 0;
            let dToPlayer = dist(st.x, st.y, p.x, p.y);
            
            // –ê–ì–†–ï–°–°–ò–Ø: –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –±–ª–∏–∂–µ 150px (5 –∫–ª–µ—Ç–æ–∫), –∫–æ–ø –∏–¥–µ—Ç –∫ –Ω–µ–º—É
            if(dToPlayer < 150) {
                if(st.x > p.x) dx = STEP; else if(st.x < p.x) dx = -STEP;
                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Å–∏ —Å –±–æ–ª—å—à–∏–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ–º
                if(Math.abs(st.y - p.y) > Math.abs(st.x - p.x)) {
                   dx = 0;
                   if(st.y > p.y) dy = STEP; else if(st.y < p.y) dy = -STEP;
                }
            } else {
                // –ü–ê–¢–†–£–õ–¨: –°–ª—É—á–∞–π–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
                let dirs = [{x:0,y:-STEP}, {x:0,y:STEP}, {x:-STEP,y:0}, {x:STEP,y:0}];
                let m = dirs[Math.floor(Math.random()*4)];
                dx = m.x; dy = m.y;
            }

            let nx = p.x + dx; 
            let ny = p.y + dy;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü –∏ —Å—Ç–µ–Ω –¥–ª—è –∫–æ–ø–∞
            let wall = obs.some(o => dist(o.x, o.y, nx, ny) < 10);
            let bounds = (nx >= 0 && ny >= 0 && nx <= box.offsetWidth-30 && ny <= box.offsetHeight-30);
            
            if(bounds && !wall) {
                p.x = nx; p.y = ny;
                p.el.style.left = nx+'px'; p.el.style.top = ny+'px';
            }
        });
        checkPoliceProx();
    }

    function checkPoliceProx() {
        if(!isShift || isPaused) return;
        let caught = false;
        let near = false;

        police.forEach(p => {
            let d = dist(st.x, st.y, p.x, p.y);
            if(d < 15) caught = true; // –ü–æ–π–º–∞–ª
            if(d < 90) near = true;   // –°–∏—Ä–µ–Ω–∞ (3 –∫–ª–µ—Ç–∫–∏)
        });

        const area = document.getElementById('game-area');
        if(near && !caught) {
            area.classList.add('siren-active');
            if(!area.dataset.warn) { showToast("üö® –ö–û–ü–´ –ù–ê –•–í–û–°–¢–ï!"); area.dataset.warn="1"; }
        } else {
            area.classList.remove('siren-active');
            area.dataset.warn="";
        }

        if(caught) arrestSequence();
    }

    function arrestSequence() {
        isPaused = true;
        st.bal -= 150; // –í—ã—Å–æ–∫–∏–π —à—Ç—Ä–∞—Ñ
        // –ö–æ–Ω—Ñ–∏—Å–∫–∞—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
        st.en = Math.max(0, st.en - 20);
        
        document.getElementById('game-area').classList.remove('siren-active');
        document.getElementById('arrest-screen').style.display = 'flex';
        save(); render();

        setTimeout(() => {
            document.getElementById('arrest-screen').style.display = 'none';
            isPaused = false;
            forceRescue(); // –†–µ—Å–ø–∞–≤–Ω –Ω–∞ –±–∞–∑–µ
            endShift();
        }, 3000);
    }

    // --- –ó–ê–ö–ê–ó–´ ---
    function newJobPhase(ph) {
        target.type = ph;
        const box = document.getElementById('game-area');
        const cols = Math.floor(box.offsetWidth/STEP);
        const rows = Math.floor(box.offsetHeight/STEP);
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–º–Ω—ã–π —Å–ø–∞–≤–Ω, —á—Ç–æ–±—ã –ø–∏—Ü—Ü–∞ –Ω–µ –±—ã–ª–∞ –≤ —Å—Ç–µ–Ω–µ
        let p = getRandomValidPos(cols, rows, true);
        if(!p) p = {x:0, y:0}; // –§–æ–ª–±—ç–∫

        target.x = p.x; target.y = p.y; target.active = true;
        
        const el = document.getElementById('target');
        el.style.display = 'flex'; el.style.left = p.x+'px'; el.style.top = p.y+'px';
        
        if(ph===1) {
            el.innerText = 'üçï'; 
            document.getElementById('status').innerText = "–ó–∞–±–µ—Ä–∏ –∑–∞–∫–∞–∑ –≤ –ø–∏—Ü—Ü–µ—Ä–∏–∏";
            startTimer(60);
        } else {
            el.innerText = 'üë§'; 
            document.getElementById('status').innerText = "–î–æ—Å—Ç–∞–≤—å –∫–ª–∏–µ–Ω—Ç—É!";
            startTimer(30);
        }
    }

    function checkJob() {
        if(target.active && dist(st.x, st.y, target.x, target.y) < 15) {
            if(target.type === 1) {
                clearInterval(loops.timer); target.active = false;
                
                // –§–æ—Ä–º—É–ª–∞ –æ–ø–ª–∞—Ç—ã –æ—Ç —É—Ä–æ–≤–Ω—è
                let base = 5;
                let multiplier = 1 + (st.lvl * 0.15); // +15% –∑–∞ —É—Ä–æ–≤–µ–Ω—å
                let pay = (base * multiplier).toFixed(2);
                let km = (Math.random()*3 + 1).toFixed(1);
                
                target.offer = {dist: km, pay: parseFloat(pay)};
                
                document.getElementById('j-dist').innerText = km;
                document.getElementById('j-pay').innerText = pay;
                document.getElementById('job-modal').style.display = 'flex';
            } else {
                finish(true);
            }
        }
    }

    function ansJob(y) {
        document.getElementById('job-modal').style.display='none';
        if(y) { newJobPhase(2); } 
        else { 
            st.bal = Math.max(0, st.bal - 2); // –®—Ç—Ä–∞—Ñ –∑–∞ –æ—Ç–∫–∞–∑ –Ω–µ–±–æ–ª—å—à–æ–π
            render(); newJobPhase(1); 
        }
    }

    function finish(ok) {
        clearInterval(loops.timer); target.active = false;
        document.getElementById('target').style.display = 'none';
        document.getElementById('timer').style.display = 'none';
        
        if(ok) { 
            st.bal += target.offer.pay; 
            showToast(`‚úÖ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: +${target.offer.pay} PLN`); 
            st.lvl += 0.05; // –ü—Ä–æ–∫–∞—á–∫–∞ —É—Ä–æ–≤–Ω—è –º–µ–¥–ª–µ–Ω–Ω–æ
        }
        else { 
            st.bal -= 10; 
            showToast("‚ùå –û–ø–æ–∑–¥–∞–Ω–∏–µ! –®—Ç—Ä–∞—Ñ -10 PLN"); 
        }
        
        save(); render();
        // –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –∑–∞–∫–∞–∑–æ–º
        setTimeout(()=>{ if(isShift) newJobPhase(1); }, 2000);
    }

    function startTimer(s) {
        clearInterval(loops.timer);
        const tEl = document.getElementById('timer');
        tEl.style.display='block';
        tEl.innerText = formatTime(s);
        
        loops.timer = setInterval(()=>{
            s--; 
            tEl.innerText = formatTime(s);
            if(s<=0) finish(false);
        }, 1000);
    }
    function formatTime(s){ return (s<10?'0':'')+s; }

    // --- –ë–ê–ù–ö –ò –ú–ê–ì–ê–ó–ò–ù ---
    function renderBank() {
        const div = document.getElementById('bank-ui');
        div.innerHTML = `
            <div class="bank-card">
                <div style="font-size:10px; opacity:0.7; letter-spacing:1px">–ë–ê–õ–ê–ù–° –°–ß–ï–¢–ê</div>
                <div style="font-size:28px; font-weight:bold; text-shadow:0 2px 0 rgba(0,0,0,0.2)">${st.bank.toFixed(2)} PLN</div>
            </div>
            
            <div style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); padding:15px; border-radius:12px; margin-top:10px">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                    <span style="font-weight:bold; font-size:12px; color:var(--text-muted)">–ö–†–ï–î–ò–¢–ù–ê–Ø –õ–ò–ù–ò–Ø</span>
                    <span style="font-weight:bold; color:${st.debt>0 ? 'var(--warn)' : 'var(--accent)'}">${st.debt.toFixed(2)} PLN</span>
                </div>
                ${st.debt > 0 
                    ? `<button class="buy-btn action" style="width:100%; background:var(--warn)" onclick="repayLoan()">–ü–û–ì–ê–°–ò–¢–¨ –î–û–õ–ì</button>`
                    : `<button class="buy-btn" style="width:100%; border:1px solid var(--gold); color:var(--gold)" onclick="takeLoan()">–í–∑—è—Ç—å 500 PLN</button>
                       <div style="font-size:9px; color:gray; text-align:center; margin-top:5px">–í–µ—Ä–Ω—É—Ç—å –Ω—É–∂–Ω–æ 600 PLN (+20%)</div>`
                }
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px">
                <button class="buy-btn action" onclick="bankOp(1)">–í–ö–õ–ê–î (–í—Å—ë)</button>
                <button class="buy-btn danger" onclick="bankOp(-1)">–°–ù–Ø–¢–¨ (–í—Å—ë)</button>
            </div>
        `;
    }

    function takeLoan() {
        if(st.debt > 0) return showToast("–£–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫—Ä–µ–¥–∏—Ç!");
        st.bal += 500;
        st.debt = 600; 
        showToast("–ö—Ä–µ–¥–∏—Ç –æ–¥–æ–±—Ä–µ–Ω –±–∞–Ω–∫–æ–º.");
        save(); render();
    }

    function repayLoan() {
        if(st.bal >= st.debt) {
            st.bal -= st.debt;
            st.debt = 0;
            showToast("–ö—Ä–µ–¥–∏—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫—Ä—ã—Ç!");
            save(); render();
        } else {
            showToast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!");
        }
    }

    function bankOp(dir) {
        if(dir===1 && st.bal>0) { st.bank+=st.bal; st.bal=0; showToast("–î–µ–Ω—å–≥–∏ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"); }
        if(dir===-1 && st.bank>0) { st.bal+=st.bank; st.bank=0; showToast("–ù–∞–ª–∏—á–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã"); }
        save(); render();
    }

    // --- –†–ï–ù–î–ï–† –ò –£–¢–ò–õ–ò–¢–´ ---
    function mkEnt(c,i,x,y){
        let d=document.createElement('div'); d.className='entity '+c; d.innerText=i;
        d.style.left=x+'px'; d.style.top=y+'px';
        document.getElementById('game-area').appendChild(d); return d;
    }
    function dist(x1,y1,x2,y2){ return Math.abs(x1-x2)+Math.abs(y1-y2); }
    
    function render() {
        document.getElementById('cash').innerText = st.bal.toFixed(2);
        document.getElementById('bank').innerText = st.bank.toFixed(2);
        
        // –ë–∞—Ä—ã —Ä–µ—Å—É—Ä—Å–æ–≤
        document.getElementById('b-en').style.width = st.en+'%';
        document.getElementById('b-wat').style.width = st.wat+'%';
        document.getElementById('b-hp').style.width = st.hp+'%';
        
        document.getElementById('txt-en').innerText = Math.floor(st.en)+'%';
        document.getElementById('txt-wat').innerText = Math.floor(st.wat)+'%';
        document.getElementById('txt-hp').innerText = Math.floor(st.hp)+'%';

        // –ú–∞–≥–∞–∑–∏–Ω (–¶–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –æ—Ç —É—Ä–æ–≤–Ω—è –∏–Ω—Ñ–ª—è—Ü–∏–∏)
        let inflation = 1 + (st.lvl * 0.05);
        const price = (base) => Math.ceil(base * inflation);
        
        document.getElementById('shop-list').innerHTML = `
            <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #333">
                <span style="font-size:14px">üå≠ –•–æ—Ç-–¥–æ–≥ <span style="font-size:10px; color:gray">+20 EN</span></span> 
                <button class="buy-btn" onclick="buy('en',20,${price(15)})">${price(15)} PLN</button>
            </div>
            <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #333">
                <span style="font-size:14px">ü•§ –≠–Ω–µ—Ä–≥–µ—Ç–∏–∫ <span style="font-size:10px; color:gray">+30 WT</span></span> 
                <button class="buy-btn" onclick="buy('wat',30,${price(10)})">${price(10)} PLN</button>
            </div>
        `;
        renderBank();
    }

    function renderPlayer() {
        const p = document.getElementById('player');
        p.style.left = st.x+'px'; p.style.top = st.y+'px';
    }

    function buy(t,v,c){ 
        if(st.bal>=c){
            st.bal-=c; 
            if(t=='en') st.en = Math.min(100, st.en+v); 
            if(t=='wat') st.wat = Math.min(100, st.wat+v); 
            render(); save();
        } else showToast("–ù–µ—Ç –¥–µ–Ω–µ–≥!");
    }
    
    function repairBike(){ 
        let cost = 50; 
        if(st.bal>=cost){
            st.bal-=cost; st.hp=100; 
            showToast("–ë–∞–π–∫ –∫–∞–∫ –Ω–æ–≤–µ–Ω—å–∫–∏–π!"); render(); save();
        } else showToast("–†–µ–º–æ–Ω—Ç —Å—Ç–æ–∏—Ç 50 PLN");
    }
    
    function showToast(m){
        const t=document.getElementById('toast'); 
        t.innerText=m; t.style.display='block'; 
        setTimeout(()=>t.style.display='none',2000);
    }
    
    function toggleMenu(){
        const s=document.getElementById('sidebar'); 
        const o=document.getElementById('side-overlay'); 
        if(s.classList.contains('open')){
            s.classList.remove('open');o.style.display='none';
        }else{
            s.classList.add('open');o.style.display='block';render();
        }
    }

    init();
</script>
</body>
</html>
