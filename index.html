<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–∏–º—É–ª—è—Ç–æ—Ä –ñ–∏–∑–Ω–∏: –í–∞—Ä—à–∞–≤–∞</title>
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --accent-color: #bb86fc;
            --secondary-bg: #1e1e1e;
            --success-color: #03dac6;
            --danger-color: #cf6679;
            --warning-color: #ffb74d;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* HEADER */
        header {
            background-color: var(--secondary-bg);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .status-bar {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 0.9rem;
        }

        .status-row {
            display: flex;
            gap: 15px;
        }

        .money { color: var(--success-color); font-weight: bold; }
        .level { color: var(--accent-color); }
        .time { color: var(--warning-color); font-size: 0.8rem; }

        .settings-btn {
            background: none;
            border: 1px solid var(--text-color);
            color: var(--text-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* MAIN CONTENT AREA */
        #game-area {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            position: relative;
        }

        /* TABS */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* PROGESS BARS */
        .stats-container {
            background-color: var(--secondary-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .stat-item {
            margin-bottom: 10px;
        }

        .stat-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 3px;
        }

        .progress-bar-bg {
            background-color: #333;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            transition: width 0.5s ease, background-color 0.3s;
        }

        /* ACTIONS & JOBS */
        .action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .card {
            background-color: var(--secondary-bg);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #333;
            transition: transform 0.1s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100px;
        }

        .card:active { transform: scale(0.98); }
        .card.disabled { opacity: 0.5; pointer-events: none; border-color: #444; }
        .card h3 { margin: 0 0 5px 0; font-size: 1rem; }
        .card p { margin: 0; font-size: 0.8rem; color: #aaa; }
        .card .cost { color: var(--warning-color); font-size: 0.8rem; margin-top: 5px; }

        /* BOTTLE COLLECTING */
        #bottle-area {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            overflow: hidden;
        }
        .bottle {
            position: absolute;
            font-size: 24px;
            cursor: pointer;
            pointer-events: auto;
            animation: float 3s infinite ease-in-out;
            transition: transform 0.1s;
            user-select: none;
            padding: 10px; /* –£–≤–µ–ª–∏—á–∏–º –æ–±–ª–∞—Å—Ç—å –∫–ª–∏–∫–∞ */
        }
        .bottle:active { transform: scale(1.2); }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* FOOTER NAV */
        nav {
            background-color: var(--secondary-bg);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid #333;
        }

        .nav-btn {
            background: none;
            border: none;
            color: #777;
            font-size: 0.7rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .nav-btn.active { color: var(--accent-color); }
        .nav-btn span { font-size: 1.2rem; margin-bottom: 2px; }

        /* MODALS */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: var(--secondary-bg);
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 300px;
            text-align: center;
            border: 1px solid var(--accent-color);
        }
        .modal input {
            width: 90%;
            padding: 8px;
            margin: 10px 0;
            background: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 5px;
        }
        .modal button {
            background: var(--accent-color);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            color: black;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
        }

        /* Career Specifics */
        .job-status {
            font-size: 0.8rem;
            color: var(--success-color);
            margin-top: 5px;
        }
        .bonus-desc {
            font-size: 0.7rem;
            color: #888;
            margin-top: 2px;
            font-style: italic;
        }

        /* Shop Styles */
        .shop-category {
            margin-bottom: 20px;
        }
        .shop-category h3 {
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
            color: var(--accent-color);
        }
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #252525;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
        }
        .shop-item-info {
            display: flex;
            flex-direction: column;
        }
        .shop-item-name { font-weight: bold; font-size: 0.95rem; }
        .shop-item-desc { font-size: 0.75rem; color: #aaa; }
        .shop-btn {
            background: var(--accent-color);
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            color: #000;
            font-weight: bold;
            font-size: 0.8rem;
            min-width: 70px;
            cursor: pointer;
        }
        .shop-btn:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
        }

        /* Penalty Mode Overlay */
        #penalty-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            color: red;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>

    <div id="penalty-overlay">
        <h1>–°–ò–°–¢–ï–ú–ê –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê</h1>
        <p>–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (Free LVL).</p>
        <p>–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–∫—Ä—ã—Ç –Ω–∞ 10 –º–∏–Ω—É—Ç.</p>
        <p>–ó–∞—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–Ω–¥–æ–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã (x2 –∏–ª–∏ -50%).</p>
        <p id="penalty-timer">10:00</p>
    </div>

    <header>
        <div class="status-bar" id="status-bar">
            <div class="status-row">
                <span class="money" id="money-display">0 PLN</span>
                <span class="level" id="level-display">LVL 1</span>
            </div>
            <div class="time" id="game-time">–î–µ–Ω—å 1, 08:00</div>
        </div>
        <button class="settings-btn" onclick="openAdmin()">‚öôÔ∏è</button>
    </header>

    <div id="game-area">
        <div id="tab-home" class="tab-content active">
            <div class="stats-container">
                <div class="stat-item">
                    <div class="stat-label"><span>–ó–¥–æ—Ä–æ–≤—å–µ</span><span id="health-val">100%</span></div>
                    <div class="progress-bar-bg"><div class="progress-bar-fill" id="health-bar" style="width: 100%; background: #cf6679;"></div></div>
                </div>
                <div class="stat-item">
                    <div class="stat-label"><span>–≠–Ω–µ—Ä–≥–∏—è</span><span id="energy-val">100%</span></div>
                    <div class="progress-bar-bg"><div class="progress-bar-fill" id="energy-bar" style="width: 100%; background: #ffb74d;"></div></div>
                </div>
                <div class="stat-item">
                    <div class="stat-label"><span>–°—ã—Ç–æ—Å—Ç—å</span><span id="hunger-val">100%</span></div>
                    <div class="progress-bar-bg"><div class="progress-bar-fill" id="hunger-bar" style="width: 100%; background: #03dac6;"></div></div>
                </div>
                <div class="stat-item">
                    <div class="stat-label"><span>–í–æ–¥–∞</span><span id="thirst-val">100%</span></div>
                    <div class="progress-bar-bg"><div class="progress-bar-fill" id="thirst-bar" style="width: 100%; background: #2196f3;"></div></div>
                </div>
                <div class="stat-item">
                    <div class="stat-label"><span>–°—á–∞—Å—Ç—å–µ</span><span id="happiness-val">50%</span></div>
                    <div class="progress-bar-bg"><div class="progress-bar-fill" id="happiness-bar" style="width: 50%; background: #e040fb;"></div></div>
                </div>
            </div>

            <h3>–î–µ–π—Å—Ç–≤–∏—è</h3>
            <div class="action-grid">
                <div class="card" onclick="collectBottlesMode()">
                    <h3>üçæ –°–æ–±–∏—Ä–∞—Ç—å –±—É—Ç—ã–ª–∫–∏</h3>
                    <p>–ò—Å–∫–∞—Ç—å —Ç–∞—Ä—É –Ω–∞ —É–ª–∏—Ü–µ</p>
                    <p class="cost">+ –≠–Ω–µ—Ä–≥–∏—è —Ç—Ä–∞—Ç–∏—Ç—Å—è</p>
                </div>
                <div class="card" onclick="begMoney()">
                    <h3>ü§≤ –ü–æ–ø—Ä–æ—à–∞–π–Ω–∏—á–∞—Ç—å</h3>
                    <p>–ü—Ä–æ—Å–∏—Ç—å –º–µ–ª–æ—á—å —É –ø—Ä–æ—Ö–æ–∂–∏—Ö</p>
                    <p class="cost">-5 –°—á–∞—Å—Ç—å—è</p>
                </div>
                <div class="card" onclick="sleep()">
                    <h3>üí§ –°–ø–∞—Ç—å (–ü–∞—Ä–∫)</h3>
                    <p>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç–Ω–µ—Ä–≥–∏—é</p>
                    <p class="cost">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</p>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <h3>–í–∞—à–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</h3>
                <p id="current-housing">–ñ–∏–ª—å–µ: –£–ª–∏—Ü–∞ (–ë–µ–∑–¥–æ–º–Ω—ã–π)</p>
                <p id="current-transport">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç: –ü–µ—à–∫–æ–º</p>
            </div>
        </div>

        <div id="tab-career" class="tab-content">
            <h3>–†–∞–±–æ—Ç–∞</h3>
            <div class="action-grid" id="jobs-container">
                </div>
        </div>

        <div id="tab-shop" class="tab-content">
            <h3>–ú–∞–≥–∞–∑–∏–Ω</h3>
            <div id="shop-container">
                </div>
        </div>
    </div>

    <div id="bottle-overlay" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:50;">
        <div id="bottle-area"></div>
        <button onclick="stopCollecting()" style="position:absolute; bottom:80px; left:50%; transform:translateX(-50%); padding:10px 20px; background:var(--danger-color); border:none; color:white; border-radius:5px; pointer-events:auto;">–ó–∞–∫–æ–Ω—á–∏—Ç—å —Å–±–æ—Ä</button>
        <div style="position:absolute; top:20px; width:100%; text-align:center; color:white; pointer-events:none;">–ù–∞–∂–∏–º–∞–π –Ω–∞ –±—É—Ç—ã–ª–∫–∏!</div>
    </div>

    <nav>
        <button class="nav-btn active" onclick="switchTab('home')"><span>üè†</span>–ì–ª–∞–≤–Ω–∞—è</button>
        <button class="nav-btn" onclick="switchTab('career')"><span>üíº</span>–ö–∞—Ä—å–µ—Ä–∞</button>
        <button class="nav-btn" onclick="switchTab('shop')"><span>üõí</span>–ú–∞–≥–∞–∑–∏–Ω</button>
    </nav>

    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <h3>Admin Panel</h3>
            <input type="password" id="admin-pass" placeholder="Password">
            <div id="admin-controls" style="display:none;">
                <button onclick="adminAddMoney()">+1000 PLN</button>
                <button onclick="adminAddLevel()">+1 Level</button>
                <button onclick="adminReset()">Reset Game</button>
                <button onclick="closeAdmin()">Close</button>
            </div>
            <button id="admin-login-btn" onclick="checkAdmin()">Login</button>
            <button id="admin-close-btn" onclick="closeAdmin()">Cancel</button>
        </div>
    </div>

    <script>
        // --- GAME STATE ---
        const SAVE_KEY = 'WARSZAWA_FOREVER';
        let state = {
            money: 0,
            level: 1,
            xp: 0,
            xpToNext: 100,
            time: { day: 1, hour: 8, minute: 0 },
            stats: {
                health: 100,
                energy: 100,
                hunger: 100,
                thirst: 100,
                happiness: 50
            },
            housing: 'street',
            transport: 'feet',
            inventory: [],
            activeJob: null, // 'courier' etc
            courierMode: false,
            energyDrinkActive: false, // Prevents energy loss temporarily
            penaltyMode: false,
            penaltyEndTime: 0,
            initialStateSnapshot: null // For rollback if cheating
        };

        const HOUSING_TYPES = {
            'street': { name: "–£–ª–∏—Ü–∞", recovery: 1 },
            'hostel': { name: "–•–æ—Å—Ç–µ–ª", recovery: 2, price: 50 }, // price per night
            'apartment': { name: "–ö–≤–∞—Ä—Ç–∏—Ä–∞", recovery: 4, price: 150 }
        };

        const TRANSPORT_TYPES = {
            'feet': { name: "–ü–µ—à–∫–æ–º", speed: 1 },
            'scooter': { name: "–°–∞–º–æ–∫–∞—Ç", speed: 1.5, price: 500 },
            'car': { name: "–°—Ç–∞—Ä–æ–µ –∞–≤—Ç–æ", speed: 3, price: 5000 }
        };

        const SHOP_ITEMS = [
            { id: 'water', name: "–í–æ–¥–∞ 0.5–ª", price: 3, type: 'consumable', effect: { thirst: 30 }, desc: "–£—Ç–æ–ª—è–µ—Ç –∂–∞–∂–¥—É" },
            { id: 'bread', name: "–ë—É–ª–∫–∞", price: 5, type: 'consumable', effect: { hunger: 20 }, desc: "–î–µ—à–µ–≤–∞—è –µ–¥–∞" },
            { id: 'kebab', name: "–ö–µ–±–∞–±", price: 25, type: 'consumable', effect: { hunger: 60, happiness: 5 }, desc: "–í–∫—É—Å–Ω–æ –∏ —Å—ã—Ç–Ω–æ" },
            { id: 'energy_drink', name: "–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫", price: 15, type: 'consumable', effect: { energy: 40, thirst: -10 }, special: 'stop_energy_drain', desc: "–≠–Ω–µ—Ä–≥–∏—è –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—Å—è (–í–æ–¥–∞ —Ç—Ä–∞—Ç–∏—Ç—Å—è!)" },
            { id: 'medkit', name: "–ê–ø—Ç–µ—á–∫–∞", price: 50, type: 'consumable', effect: { health: 30 }, desc: "–õ–µ—á–∏—Ç —Ä–∞–Ω—ã" },
            { id: 'scooter', name: "–ö—É–ø–∏—Ç—å –°–∞–º–æ–∫–∞—Ç", price: 500, type: 'transport', itemKey: 'scooter', desc: "–î–≤–∏–∂–µ–Ω–∏–µ x1.5" },
            { id: 'car', name: "–ö—É–ø–∏—Ç—å –ê–≤—Ç–æ", price: 5000, type: 'transport', itemKey: 'car', desc: "–î–≤–∏–∂–µ–Ω–∏–µ x3" },
            { id: 'rent_hostel', name: "–°–Ω—è—Ç—å –•–æ—Å—Ç–µ–ª (—Å—É—Ç–∫–∏)", price: 50, type: 'housing', itemKey: 'hostel', desc: "–õ—É—á—à–∏–π —Å–æ–Ω" },
            { id: 'rent_apt', name: "–°–Ω—è—Ç—å –ö–≤–∞—Ä—Ç–∏—Ä—É (—Å—É—Ç–∫–∏)", price: 150, type: 'housing', itemKey: 'apartment', desc: "–ú–∞–∫—Å. –∫–æ–º—Ñ–æ—Ä—Ç" }
        ];

        const JOBS = [
            { id: 'courier', name: "–ö—É—Ä—å–µ—Ä Glovo", reqLvl: 2, salary: 25, energyCost: 10, waterCost: 15, type: 'manual', desc: "–î–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã. –¢—Ä–∞—Ç–∏—Ç –≤–æ–¥—É –∏ —ç–Ω–µ—Ä–≥–∏—é!" },
            { id: 'uber', name: "–¢–∞–∫—Å–∏ Uber", reqLvl: 5, salary: 60, energyCost: 15, waterCost: 10, type: 'manual', reqTransport: 'car', desc: "–ù—É–∂–Ω–∞ –º–∞—à–∏–Ω–∞." },
            { id: 'office', name: "–û—Ñ–∏—Å –ü–ª–∞–Ω–∫—Ç–æ–Ω", reqLvl: 10, salary: 150, energyCost: 20, waterCost: 5, type: 'shift', desc: "–°—Ç–∞–±–∏–ª—å–Ω–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞." }
        ];

        let activeTab = 'home';
        let gameLoop;
        let bottleInterval;
        let penaltyTimer;

        // --- INIT & SAVE SYSTEM ---
        function init() {
            loadGame();
            renderJobs();
            setupShopStructure(); // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –º–∞–≥–∞–∑–∏–Ω–∞ –û–î–ò–ù —Ä–∞–∑
            updateUI();
            
            gameLoop = setInterval(gameTick, 2000); // Game minute every 2 real seconds
            
            // Auto-save
            setInterval(saveGame, 10000);
        }

        function saveGame() {
            localStorage.setItem(SAVE_KEY, JSON.stringify(state));
        }

        function loadGame() {
            const saved = localStorage.getItem(SAVE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed };
                // Resume penalty if active
                if(state.penaltyMode) {
                    activatePenaltyMode(true);
                }
            } else {
                // Save initial state for rollback
                state.initialStateSnapshot = JSON.parse(JSON.stringify(state));
            }
        }

        function resetGame() {
            localStorage.removeItem(SAVE_KEY);
            location.reload();
        }

        // --- CORE MECHANICS ---
        function gameTick() {
            // Time
            state.time.minute += 10;
            if (state.time.minute >= 60) {
                state.time.minute = 0;
                state.time.hour++;
                if (state.time.hour >= 24) {
                    state.time.hour = 0;
                    state.time.day++;
                    dailyReset();
                }
            }

            // Passive stat decay
            changeStat('hunger', -1);
            changeStat('thirst', -1.5);
            
            // Energy drink expiry check (simplified duration logic, e.g., low chance to expire or separate timer)
            // For simplicity, let's say it lasts 1 hour of game time. But here we just assume it's instantaneous boost, 
            // OR if it's a buff, we handle it differently. 
            // Previous instruction said: "–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥ —ç–Ω–µ—Ä–≥–∏–∏".
            // Implementation: We'll decrement a counter if we added one, but for now let's say it works for 30 game minutes.
            if (state.energyDrinkTimer > 0) {
                state.energyDrinkTimer -= 10;
                if (state.energyDrinkTimer <= 0) {
                    state.energyDrinkActive = false;
                    notify("–î–µ–π—Å—Ç–≤–∏–µ —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å");
                }
            }

            // Auto-work logic if implemented (currently manual mostly)
            
            checkGameOver();
            updateUI();
        }

        function dailyReset() {
            // Rent deduction
            if (state.housing === 'hostel' && state.money >= 50) {
                state.money -= 50;
                notify("–û–ø–ª–∞—Ç–∞ —Ö–æ—Å—Ç–µ–ª–∞: -50 PLN");
            } else if (state.housing === 'hostel') {
                state.housing = 'street';
                notify("–í—ã—Å–µ–ª–∏–ª–∏ –∏–∑ —Ö–æ—Å—Ç–µ–ª–∞!");
            }
            // Similar for apartment
        }

        function changeStat(stat, val) {
            if (stat === 'energy' && val < 0 && state.energyDrinkActive) {
                // Energy drain blocked, but water still drains if logic requires
                return;
            }
            state.stats[stat] = Math.max(0, Math.min(100, state.stats[stat] + val));
        }

        function addMoney(amount) {
            if (state.penaltyMode) {
                // Randomize or hide
                const roll = Math.random();
                if (roll > 0.5) amount = amount * 2;
                else amount = amount * 0.5;
                // We don't show animation, but add internal
                state.money += amount;
            } else {
                state.money += amount;
                showFloatingText(`+${amount.toFixed(1)} PLN`, event ? event.clientX : window.innerWidth/2, event ? event.clientY : window.innerHeight/2);
            }
            addXP(amount * 0.1);
        }

        function addXP(amount) {
            state.xp += amount;
            if (state.xp >= state.xpToNext) {
                state.level++;
                state.xp = 0;
                state.xpToNext *= 1.5;
                notify(`–ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å: ${state.level}!`);
                renderJobs(); // Update job unlock status
            }
        }

        // --- ACTIONS ---
        // BOTTLE COLLECTING (Fixed Lag)
        function collectBottlesMode() {
            document.getElementById('bottle-overlay').style.display = 'block';
            spawnBottlesLoop();
        }

        function stopCollecting() {
            document.getElementById('bottle-overlay').style.display = 'none';
            clearInterval(bottleInterval);
            document.getElementById('bottle-area').innerHTML = '';
        }

        function spawnBottlesLoop() {
            spawnBottle(); // Spawn one immediately
            bottleInterval = setInterval(() => {
                if (Math.random() > 0.3) spawnBottle();
            }, 800);
        }

        function spawnBottle() {
            const area = document.getElementById('bottle-area');
            const bottle = document.createElement('div');
            bottle.className = 'bottle';
            bottle.textContent = 'üçæ';
            bottle.style.left = Math.random() * 80 + 10 + '%';
            bottle.style.top = Math.random() * 80 + 10 + '%';
            
            // FIX: Instant click response
            bottle.onmousedown = (e) => { // Using mousedown for faster reaction than click
                e.stopPropagation();
                e.preventDefault(); // Prevent double firing
                bottle.remove();
                
                // Logic
                changeStat('energy', -1); 
                changeStat('thirst', -1);
                addMoney(Math.random() * 2 + 0.5);
            };

            // Mobile touch support optimization
            bottle.ontouchstart = (e) => {
                e.stopPropagation();
                e.preventDefault();
                bottle.remove();
                changeStat('energy', -1); 
                changeStat('thirst', -1);
                addMoney(Math.random() * 2 + 0.5);
            };

            area.appendChild(bottle);

            // Auto remove after some time
            setTimeout(() => {
                if(bottle.parentNode) bottle.remove();
            }, 4000);
        }

        function begMoney() {
            changeStat('happiness', -5);
            changeStat('energy', -2);
            if (Math.random() > 0.6) {
                addMoney(Math.random() * 5);
            } else {
                notify("–ù–∏–∫—Ç–æ –Ω–µ –¥–∞–ª –¥–µ–Ω–µ–≥...");
            }
            updateUI();
        }

        function sleep() {
            let recovery = HOUSING_TYPES[state.housing].recovery;
            // Simplified sleep (insta-fill for UX)
            changeStat('energy', 20 * recovery);
            changeStat('hunger', -10);
            state.time.hour += 2;
            notify("–í—ã –ø–æ—Å–ø–∞–ª–∏.");
            updateUI();
        }

        // --- JOB SYSTEM ---
        function renderJobs() {
            const container = document.getElementById('jobs-container');
            container.innerHTML = '';
            JOBS.forEach(job => {
                const locked = state.level < job.reqLvl;
                const div = document.createElement('div');
                div.className = `card ${locked ? 'disabled' : ''}`;
                div.innerHTML = `
                    <h3>${job.name}</h3>
                    <p>${job.desc}</p>
                    <p class="job-status">${locked ? `–ù—É–∂–µ–Ω LVL ${job.reqLvl}` : `–ó–∞—Ä–ø–ª–∞—Ç–∞: ${job.salary} PLN`}</p>
                    ${job.id === 'courier' ? '<div class="bonus-desc">–†–∞—Å—Ö–æ–¥: –í–æ–¥–∞ –∏ –≠–Ω–µ—Ä–≥–∏—è</div>' : ''}
                `;
                if (!locked) {
                    div.onclick = () => doJob(job);
                }
                container.appendChild(div);
            });
        }

        function doJob(job) {
            // Checks
            if (state.stats.energy < job.energyCost) { notify("–ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏!"); return; }
            if (state.stats.thirst < job.waterCost) { notify("–í—ã —Ö–æ—Ç–∏—Ç–µ –ø–∏—Ç—å!"); return; }
            if (job.reqTransport && state.transport !== job.reqTransport && state.transport !== 'car') {
                notify("–ù—É–∂–µ–Ω —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç: " + job.reqTransport); return;
            }

            // Execute
            changeStat('energy', -job.energyCost);
            // Specific Courier logic: Water consumed always
            changeStat('thirst', -job.waterCost);
            
            // Advance time
            state.time.minute += 30;
            
            addMoney(job.salary);
            updateUI();
        }

        // --- SHOP SYSTEM (FIXED FLICKERING) ---
        
        // 1. Create structure ONLY ONCE
        function setupShopStructure() {
            const container = document.getElementById('shop-container');
            container.innerHTML = ''; // Clear once on init
            
            // Group by type if needed, but simple list for now
            SHOP_ITEMS.forEach(item => {
                const el = document.createElement('div');
                el.className = 'shop-item';
                el.id = `shop-item-${item.id}`; // Add ID for updates
                
                el.innerHTML = `
                    <div class="shop-item-info">
                        <span class="shop-item-name">${item.name}</span>
                        <span class="shop-item-desc">${item.desc}</span>
                        <span class="shop-item-desc" style="color:var(--warning-color)">${item.price} PLN</span>
                        ${item.id === 'energy_drink' ? '<span class="shop-item-desc" style="color:#aaf; font-size:0.65rem;">–ë—É—Å—Ç: –°—Ç–æ–ø —Ä–∞—Å—Ö–æ–¥ —ç–Ω–µ—Ä–≥–∏–∏</span>' : ''}
                    </div>
                    <button class="shop-btn" id="btn-shop-${item.id}" onclick="buyItem('${item.id}')">–ö—É–ø–∏—Ç—å</button>
                `;
                container.appendChild(el);
            });
        }

        // 2. Update status (enable/disable) without HTML rebuild
        function updateShopButtons() {
            SHOP_ITEMS.forEach(item => {
                const btn = document.getElementById(`btn-shop-${item.id}`);
                if (btn) {
                    if (state.money < item.price) {
                        btn.disabled = true;
                        btn.textContent = "–ú–∞–ª–æ –¥–µ–Ω–µ–≥";
                    } else {
                        btn.disabled = false;
                        btn.textContent = "–ö—É–ø–∏—Ç—å";
                    }
                }
            });
        }

        function buyItem(id) {
            const item = SHOP_ITEMS.find(i => i.id === id);
            if (state.money >= item.price) {
                state.money -= item.price;
                
                if (item.type === 'consumable') {
                    if (item.effect) {
                        for (let key in item.effect) changeStat(key, item.effect[key]);
                    }
                    if (item.special === 'stop_energy_drain') {
                        state.energyDrinkActive = true;
                        state.energyDrinkTimer = 60; // 60 game minutes (approx 2 real minutes)
                        notify("–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫! –≠–Ω–µ—Ä–≥–∏—è –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—Å—è.");
                    }
                } else if (item.type === 'transport') {
                    state.transport = item.itemKey;
                    notify(`–ö—É–ø–ª–µ–Ω —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç: ${item.name}`);
                } else if (item.type === 'housing') {
                    state.housing = item.itemKey;
                    notify(`–ê—Ä–µ–Ω–¥–æ–≤–∞–Ω–æ: ${item.name}`);
                }
                
                updateUI();
            }
        }

        // --- UI UPDATES ---
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`tab-${tab}`).classList.add('active');
            activeTab = tab;
            
            // Highlight nav button
            const navIndex = ['home', 'career', 'shop'].indexOf(tab);
            if (navIndex >= 0) document.querySelectorAll('.nav-btn')[navIndex].classList.add('active');

            if (tab === 'shop') updateShopButtons(); // Update buttons immediately on switch
        }

        function updateUI() {
            if (state.penaltyMode) {
                // Hide specific elements handled by CSS/Overlay mostly
            }

            // Header
            document.getElementById('money-display').textContent = state.penaltyMode ? '???' : Math.floor(state.money) + ' PLN';
            document.getElementById('level-display').textContent = 'LVL ' + state.level;
            document.getElementById('game-time').textContent = `–î ${state.time.day}, ${String(state.time.hour).padStart(2,'0')}:${String(state.time.minute).padStart(2,'0')}`;

            // Stats
            updateBar('health', state.stats.health);
            updateBar('energy', state.stats.energy);
            updateBar('hunger', state.stats.hunger);
            updateBar('thirst', state.stats.thirst);
            updateBar('happiness', state.stats.happiness);

            // Text info
            document.getElementById('current-housing').textContent = `–ñ–∏–ª—å–µ: ${HOUSING_TYPES[state.housing].name}`;
            document.getElementById('current-transport').textContent = `–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç: ${TRANSPORT_TYPES[state.transport].name}`;

            // Shop Buttons - ONLY Update if tab is active to save performance
            if (activeTab === 'shop') {
                updateShopButtons();
            }
        }

        function updateBar(id, val) {
            document.getElementById(`${id}-val`).textContent = Math.floor(val) + '%';
            document.getElementById(`${id}-bar`).style.width = val + '%';
        }

        function notify(msg) {
            showFloatingText(msg, window.innerWidth/2, window.innerHeight - 100);
        }

        function showFloatingText(text, x, y) {
            const el = document.createElement('div');
            el.textContent = text;
            el.style.position = 'fixed';
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            el.style.color = '#fff';
            el.style.background = 'rgba(0,0,0,0.7)';
            el.style.padding = '5px 10px';
            el.style.borderRadius = '5px';
            el.style.pointerEvents = 'none';
            el.style.transition = 'all 1s ease';
            el.style.zIndex = 1000;
            document.body.appendChild(el);
            
            setTimeout(() => {
                el.style.top = (y - 50) + 'px';
                el.style.opacity = 0;
            }, 50);

            setTimeout(() => el.remove(), 1000);
        }

        function checkGameOver() {
            if (state.stats.health <= 0) {
                alert("–í—ã –ø–æ–≥–∏–±–ª–∏! –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞.");
                resetGame();
            }
        }

        // --- PENALTY LOGIC ---
        function activatePenaltyMode(isResume = false) {
            state.penaltyMode = true;
            document.getElementById('penalty-overlay').style.display = 'flex';
            document.getElementById('money-display').style.display = 'none'; // hide
            
            if (!isResume) {
                state.penaltyEndTime = Date.now() + 10 * 60 * 1000;
            }

            if (penaltyTimer) clearInterval(penaltyTimer);
            penaltyTimer = setInterval(() => {
                const left = state.penaltyEndTime - Date.now();
                if (left <= 0) {
                    endPenaltyMode(true);
                } else {
                    const m = Math.floor(left / 60000);
                    const s = Math.floor((left % 60000) / 1000);
                    document.getElementById('penalty-timer').textContent = `${m}:${String(s).padStart(2,'0')}`;
                }
            }, 1000);
        }

        function endPenaltyMode(success) {
            state.penaltyMode = false;
            document.getElementById('penalty-overlay').style.display = 'none';
            document.getElementById('money-display').style.display = 'inline';
            clearInterval(penaltyTimer);

            if (!success) {
                // User tried to trick, revert to initial
                state = JSON.parse(JSON.stringify(state.initialStateSnapshot));
                alert("–ü–æ–ø—ã—Ç–∫–∞ –æ–±–º–∞–Ω–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å. –û—Ç–∫–∞—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è.");
            } else {
                alert("–®—Ç—Ä–∞—Ñ–Ω–æ–µ –≤—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ. –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.");
            }
            saveGame();
            location.reload(); 
        }

        // --- ADMIN PANEL ---
        function openAdmin() {
            document.getElementById('admin-modal').style.display = 'flex';
        }
        function closeAdmin() {
            document.getElementById('admin-modal').style.display = 'none';
            document.getElementById('admin-pass').value = '';
            document.getElementById('admin-controls').style.display = 'none';
            document.getElementById('admin-login-btn').style.display = 'inline-block';
        }
        function checkAdmin() {
            const pass = document.getElementById('admin-pass').value;
            // Simple hash check or just string check
            if (pass === 'admin123' || pass === 'WARSZAWA') { 
                document.getElementById('admin-controls').style.display = 'block';
                document.getElementById('admin-login-btn').style.display = 'none';
            } else {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
            }
        }
        function adminAddMoney() {
            addMoney(1000);
            updateUI();
        }
        function adminAddLevel() {
            // Check for "Free LVL" cheat logic
            const isFreeCheat = confirm("–≠—Ç–æ –ª–µ–≥–∞–ª—å–Ω–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ? –û—Ç–º–µ–Ω–∞ = —á–∏—Ç-–∫–æ–¥ (+Free LVL)");
            if (isFreeCheat) {
                state.level++;
                renderJobs();
                updateUI();
            } else {
                // Trigger punishment logic
                activatePenaltyMode();
                closeAdmin();
            }
        }
        function adminReset() {
            if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å?")) resetGame();
        }

        // Start
        window.onload = init;

    </script>
</body>
</html>

