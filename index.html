<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Warsaw Night Courier</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0a; color: #fff; overflow: hidden; height: 100vh; }
        
        #map { height: 100%; width: 100%; position: absolute; top: 0; left: 0; z-index: 1; }
        .leaflet-tile { filter: brightness(0.3) saturate(0.6) contrast(1.3) !important; }
        
        .ui-layer { position: absolute; z-index: 100; pointer-events: none; width: 100%; height: 100%; }
        .ui-layer > * { pointer-events: auto; }
        
        /* === –î–û–ñ–î–¨ === */
        .rain-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5; /* –ù–∏–∂–µ –≤—Å–µ—Ö UI —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
            overflow: hidden;
        }
        
        .rain-drop {
            position: absolute;
            width: 1px;
            height: 15px;
            background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.4));
            animation: rain-fall linear infinite;
        }
        
        @keyframes rain-fall {
            0% { transform: translateY(-20px); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(100vh); opacity: 0; }
        }
        
        /* === –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ === */
        .top-hud {
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 101;
        }
        
        .resources-bar {
            display: flex;
            gap: 6px;
            background: rgba(0,0,0,0.7);
            padding: 6px 10px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 101;
        }
        
        .resource-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .resource-icon { font-size: 14px; }
        .resource-val.energy { color: #ffd700; }
        .resource-val.water { color: #00d4ff; }
        .resource-val.mood { color: #ff00ff; }
        
        .resource-bar-mini {
            width: 30px;
            height: 3px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .resource-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }
        
        .resource-fill.energy { background: #ffd700; }
        .resource-fill.water { background: #00d4ff; }
        .resource-fill.mood { background: #ff00ff; }
        
        .balance-chip {
            background: linear-gradient(135deg, #00e676, #00c853);
            color: #000;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            z-index: 101;
        }
        
        /* === –ù–û–í–û–ï –ú–ï–ù–Æ === */
        .main-menu {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: flex-end;
            gap: 15px;
            z-index: 100;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .main-menu.hidden {
            transform: translateX(-50%) translateY(150px);
            opacity: 0;
            pointer-events: none;
        }
        
        /* –ì–ª–∞–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –ó–ê–ö–ê–ó */
        .order-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00e676, #00c853);
            border: 4px solid rgba(0,230,118,0.3);
            color: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 25px rgba(0,230,118,0.4);
        }
        
        .order-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 35px rgba(0,230,118,0.6);
        }
        
        .order-btn:active { transform: scale(0.95); }
        
        .order-btn .icon { font-size: 28px; }
        .order-btn .label { font-size: 11px; font-weight: 700; }
        
        /* –ë–æ–∫–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ */
        .side-btn {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: rgba(30,30,30,0.9);
            border: 1px solid rgba(255,255,255,0.15);
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }
        
        .side-btn:hover { transform: translateY(-3px); }
        .side-btn:active { transform: scale(0.92); }
        
        .side-btn .icon { font-size: 20px; }
        .side-btn .label { font-size: 9px; font-weight: 600; }
        
        .side-btn.food { border-color: #00d4ff; }
        .side-btn.food .icon { color: #00d4ff; }
        
        .side-btn.shop { border-color: #ff4081; }
        .side-btn.shop .icon { color: #ff4081; }
        
        /* –ú–∞–ª–µ–Ω—å–∫–∏–µ –∫–Ω–æ–ø–∫–∏ —Å–≤–µ—Ä—Ö—É */
        .top-actions {
            position: absolute;
            bottom: 105px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 101;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .top-actions.hidden {
            transform: translateX(-50%) translateY(100px);
            opacity: 0;
            pointer-events: none;
        }
        
        .mini-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(30,30,30,0.9);
            border: 1px solid rgba(255,255,255,0.1);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }
        
        .mini-btn:hover { transform: scale(1.1); }
        .mini-btn.bank { border-color: #ffd700; color: #ffd700; }
        .mini-btn.stats { border-color: #9c27b0; color: #9c27b0; }
        .mini-btn.gear { border-color: #00d4ff; color: #00d4ff; }
        
        /* === –ü–ê–ù–ï–õ–ò === */
        .center-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 380px;
            background: rgba(15,15,15,0.98);
            border-radius: 24px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 150;
            display: none;
        }
        
        .center-panel.active { display: block; }
        
        .panel-title { font-size: 22px; font-weight: 700; margin-bottom: 6px; text-align: center; }
        .panel-subtitle { color: #888; font-size: 13px; margin-bottom: 20px; text-align: center; }
        
        /* === –î–û–°–¢–ê–í–ö–ê === */
        .delivery-panel {
            position: absolute;
            bottom: 100px;
            left: 15px;
            right: 15px;
            background: rgba(15,15,15,0.95);
            border-radius: 20px;
            padding: 16px;
            border: 1px solid rgba(0,230,118,0.3);
            display: none;
        }
        
        .delivery-panel.active { display: block; }
        
        .delivery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .delivery-title { font-size: 16px; font-weight: 600; }
        .delivery-status { font-size: 12px; color: #00e676; }
        
        .progress-track {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00e676, #00c853);
            width: 0%;
            transition: width 0.5s;
        }
        
        .delivery-buttons { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #00e676; color: #000; }
        .btn-danger { background: rgba(255,61,0,0.2); color: #ff3d00; border: 1px solid rgba(255,61,0,0.3); }
        
        /* === –ò–ì–†–ê === */
        .game-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .game-overlay.active { display: flex; }
        
        .game-box {
            background: #1a1a1a;
            border-radius: 24px;
            padding: 24px;
            width: 90%;
            max-width: 340px;
            border: 1px solid rgba(41,121,255,0.3);
            text-align: center;
        }
        
        .game-title { font-size: 20px; font-weight: 700; margin-bottom: 16px; color: #2979ff; }
        
        .game-road { 
            width: 100%; 
            height: 180px; 
            background: linear-gradient(to bottom, #0f0f0f, #1a1a1a); 
            border-radius: 16px; 
            position: relative; 
            overflow: hidden; 
            margin-bottom: 20px;
            border: 2px solid rgba(255,255,255,0.1);
        }
        
        .lane { position: absolute; width: 100%; height: 33.33%; border-bottom: 2px dashed rgba(255,255,255,0.1); }
        .player-bike { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 36px; transition: top 0.1s; z-index: 10; }
        .obstacle { position: absolute; right: -50px; font-size: 32px; animation: moveLeft 2s linear; z-index: 5; }
        
        @keyframes moveLeft { from { right: -50px; } to { right: 110%; } }
        
        .game-controls { display: flex; gap: 20px; justify-content: center; }
        .control-btn { 
            width: 80px; 
            height: 80px; 
            border-radius: 50%; 
            border: 2px solid; 
            background: transparent; 
            font-size: 32px; 
            cursor: pointer;
        }
        
        .control-btn.up { border-color: #2979ff; color: #2979ff; }
        .control-btn.down { border-color: #7c4dff; color: #7c4dff; }
        
        /* === –ü–ò–¢-–°–¢–û–ü === */
        .pitstop-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 220;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .pitstop-overlay.active { display: flex; }
        
        .pitstop-card {
            background: #1a1a1a;
            border-radius: 24px;
            padding: 24px;
            max-width: 340px;
            width: 100%;
            border: 1px solid rgba(0,230,118,0.3);
            text-align: center;
        }
        
        .pitstop-title { font-size: 22px; font-weight: 700; margin-bottom: 20px; }
        
        .pitstop-item {
            background: rgba(40,40,40,0.8);
            padding: 14px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            margin-bottom: 10px;
            text-align: left;
        }
        
        .pitstop-item-header { display: flex; align-items: center; gap: 10px; font-size: 16px; }
        .pitstop-item-price { margin-left: auto; color: #00e676; font-weight: 600; }
        
        .btn-close {
            width: 100%;
            padding: 14px;
            border: 1px solid rgba(255,255,255,0.2);
            background: transparent;
            color: #888;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        /* === –°–û–ë–´–¢–ò–ï === */
        .event-overlay { 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.95); 
            z-index: 250; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
        }
        
        .event-overlay.active { display: flex; }
        
        .event-card { 
            background: #1a1a1a; 
            border-radius: 24px; 
            padding: 28px; 
            max-width: 340px; 
            width: 100%; 
            border: 1px solid rgba(255,145,0,0.3); 
            text-align: center; 
        }
        
        .event-icon { font-size: 56px; margin-bottom: 12px; }
        .event-title { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
        .event-text { color: #aaa; margin-bottom: 20px; line-height: 1.5; font-size: 14px; }
        
        /* === –ú–ê–ì–ê–ó–ò–ù === */
        .shop-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 300;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .shop-overlay.active { display: flex; }
        
        .shop-card {
            background: #1a1a1a;
            border-radius: 24px;
            padding: 24px;
            max-width: 340px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .shop-title { font-size: 20px; font-weight: 700; margin-bottom: 16px; text-align: center; }
        
        .shop-item {
            background: rgba(40,40,40,0.8);
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            border: 1px solid transparent;
        }
        
        .shop-item-price { color: #00e676; font-weight: 700; font-size: 14px; }
        
        /* === –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø === */
        .toast { 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background: rgba(0,0,0,0.95); 
            padding: 18px 28px; 
            border-radius: 16px; 
            border: 1px solid #00e676; 
            color: #00e676; 
            font-weight: 600; 
            opacity: 0; 
            pointer-events: none; 
            transition: opacity 0.3s; 
            z-index: 400; 
            text-align: center; 
        }
        
        .toast.show { opacity: 1; }
        
        /* === –ú–ê–†–ö–ï–†–´ === */
        .marker-courier { background: #00e676; width: 20px; height: 20px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 0 20px #00e676; }
        .marker-dest { background: #ff3d00; width: 26px; height: 26px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 0 25px #ff3d00; }
        .marker-pitstop { background: #2979ff; width: 24px; height: 24px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 0 15px #2979ff; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        
        .route-option {
            background: rgba(40,40,40,0.8);
            padding: 14px;
            border-radius: 14px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
        }
        
        .route-tag { padding: 3px 8px; border-radius: 8px; font-size: 10px; font-weight: 600; }
        .tag-fast { background: #ff3d00; color: #fff; }
        .tag-safe { background: #00e676; color: #000; }
        .tag-profit { background: #ffd600; color: #000; }
        .route-price { color: #00e676; font-weight: 700; }
        
        /* === –ë–ê–ù–ö === */
        .bank-section { margin-bottom: 16px; }
        .bank-section-title { font-size: 14px; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        
        .bank-balance-box {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #000;
            padding: 14px;
            border-radius: 14px;
            text-align: center;
            margin-bottom: 12px;
        }
        
        .bank-balance-label { font-size: 11px; opacity: 0.7; margin-bottom: 4px; }
        .bank-balance-amount { font-size: 24px; font-weight: 700; }
        
        .credit-warning {
            background: rgba(255, 61, 0, 0.15);
            border: 1px solid rgba(255, 61, 0, 0.3);
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            color: #ff3d00;
            margin-bottom: 12px;
            display: none;
        }
        
        .credit-warning.active { display: block; }
        
        .bank-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .bank-input {
            flex: 1;
            background: rgba(40,40,40,0.8);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 10px;
            color: #fff;
            font-size: 14px;
            outline: none;
        }
        
        .bank-input:focus { border-color: #ffd700; }
        
        .bank-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .bank-btn:active { transform: scale(0.95); }
        
        .bank-btn.gold {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #000;
        }
        
        .bank-btn.red {
            background: rgba(255, 61, 0, 0.2);
            color: #ff3d00;
            border: 1px solid rgba(255, 61, 0, 0.3);
        }
        
        .credit-info {
            background: rgba(40,40,40,0.6);
            padding: 12px;
            border-radius: 10px;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .credit-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .credit-info-row:last-child { margin-bottom: 0; }
        
        .credit-status-good { color: #00e676; }
        .credit-status-bad { color: #ff3d00; }
        
        .loan-option {
            background: rgba(40,40,40,0.8);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .loan-option:hover { border-color: #ffd700; }
        
        .loan-option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .loan-amount { font-size: 18px; font-weight: 700; color: #ffd700; }
        .loan-rate { font-size: 11px; color: #888; }
        .loan-payment { font-size: 12px; color: #aaa; }
        
        .rating-bar {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .rating-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }
        
        .rating-fill.good { background: linear-gradient(90deg, #00e676, #00c853); }
        .rating-fill.medium { background: linear-gradient(90deg, #ffd700, #ffaa00); }
        .rating-fill.bad { background: linear-gradient(90deg, #ff3d00, #dd2c00); }
        
        /* === –ü–û–ì–û–î–ê –ò –í–†–ï–ú–Ø === */
        .weather-indicator {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 6px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 101;
        }
        
        .weather-indicator.rain { border-color: #00d4ff; color: #00d4ff; }
        .weather-indicator.night { border-color: #9c27b0; color: #9c27b0; }
        .weather-indicator.bonus { border-color: #ffd700; color: #ffd700; }
        
        .inflation-warning {
            position: absolute;
            top: 78px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 61, 0, 0.2);
            color: #ff3d00;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            border: 1px solid rgba(255, 61, 0, 0.3);
            display: none;
        }
        
        .inflation-warning.active { display: block; }
        
        /* === –ê–ß–ò–í–ö–ò === */
        .achievement {
            background: rgba(40,40,40,0.8);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .achievement.unlocked { border-color: #ffd700; background: rgba(255,215,0,0.1); }
        .achievement.locked { opacity: 0.5; }
        
        .achievement-icon { font-size: 28px; }
        .achievement-info { flex: 1; }
        .achievement-name { font-weight: 600; font-size: 14px; }
        .achievement-desc { font-size: 11px; color: #888; }
        .achievement-reward { font-size: 11px; color: #00e676; }
        
        /* === –≠–ö–û–ù–û–ú–ò–ö–ê –ü–ê–ù–ï–õ–¨ === */
        .economy-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .economy-stat:last-child { border-bottom: none; }
        
        .economy-label { font-size: 13px; color: #888; }
        .economy-value { font-weight: 600; }
        .economy-value.good { color: #00e676; }
        .economy-value.bad { color: #ff3d00; }
        .economy-value.warning { color: #ffd700; }
        
        .inflation-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 6px;
        }
        
        .inflation-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        .inflation-fill.low { background: #00e676; }
        .inflation-fill.medium { background: #ffd700; }
        .inflation-fill.high { background: #ff3d00; }
        
        /* === –£–†–û–í–ï–ù–¨ –ò –ò–ù–í–ï–ù–¢–ê–†–¨ === */
        .level-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: linear-gradient(135deg, #9c27b0, #e91e63);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            z-index: 101;
        }
        
        .xp-bar {
            position: absolute;
            top: 32px;
            left: 8px;
            width: 80px;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
            z-index: 101;
        }
        
        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #9c27b0, #e91e63);
            transition: width 0.3s;
        }
        
        .inventory-bar {
            position: absolute;
            top: 42px;
            left: 8px;
            z-index: 101;
            display: flex;
            gap: 4px;
        }
        
        .inventory-slot {
            width: 28px;
            height: 28px;
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            position: relative;
        }
        
        .inventory-slot.active {
            border-color: #00e676;
            box-shadow: 0 0 8px rgba(0,230,118,0.4);
        }
        
        .inventory-slot .timer {
            position: absolute;
            bottom: -2px;
            right: -2px;
            font-size: 8px;
            background: #ff3d00;
            padding: 1px 3px;
            border-radius: 4px;
        }
        
        /* === –ö–ê–ó–ò–ù–û –ö–ù–û–ü–ö–ê === */
        .casino-fab {
            position: absolute;
            bottom: 170px;
            right: 15px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e91e63, #9c27b0);
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(233, 30, 99, 0.5);
            transition: all 0.3s, transform 0.3s ease, opacity 0.3s ease;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .casino-fab.hidden {
            transform: scale(0);
            opacity: 0;
            pointer-events: none;
        }
        
        .casino-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(233, 30, 99, 0.7);
        }
        
        .casino-fab:active { transform: scale(0.95); }
        
        .casino-fab.pulse {
            animation: casino-pulse 2s infinite;
        }
        
        @keyframes casino-pulse {
            0%, 100% { box-shadow: 0 4px 20px rgba(233, 30, 99, 0.5); }
            50% { box-shadow: 0 4px 30px rgba(233, 30, 99, 0.9), 0 0 20px rgba(233, 30, 99, 0.5); }
        }
        
        /* === –ö–ê–ó–ò–ù–û –°–¢–ò–õ–ò === */
        .casino-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 500;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .casino-overlay.active { display: flex; }
        
        .casino-card {
            background: linear-gradient(135deg, #1a0a1a, #0d0d0d);
            border-radius: 24px;
            padding: 24px;
            max-width: 360px;
            width: 100%;
            border: 2px solid #e91e63;
            box-shadow: 0 0 40px rgba(233, 30, 99, 0.3);
        }
        
        .casino-title {
            font-size: 26px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 4px;
            background: linear-gradient(90deg, #ffd700, #ff4081);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .casino-subtitle {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-bottom: 20px;
        }
        
        .casino-balance {
            background: rgba(0,0,0,0.5);
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid rgba(255,215,0,0.3);
        }
        
        .casino-balance-label { font-size: 11px; color: #888; }
        .casino-balance-amount { font-size: 28px; font-weight: 700; color: #ffd700; }
        
        .casino-game {
            background: rgba(40,20,40,0.6);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            text-align: center;
        }
        
        .slot-machine {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .slot-reel {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #2a1a2a, #1a0a1a);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            border: 2px solid #e91e63;
            transition: all 0.3s;
        }
        
        .slot-reel.spinning {
            animation: slot-spin 0.1s linear infinite;
        }
        
        @keyframes slot-spin {
            0% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }
        
        .slot-reel.win {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255,215,0,0.5);
        }
        
        .casino-bet {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 12px;
        }
        
        .bet-btn {
            padding: 8px 16px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.5);
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .bet-btn:hover { border-color: #e91e63; }
        .bet-btn.active {
            background: linear-gradient(135deg, #e91e63, #9c27b0);
            border-color: transparent;
        }
        
        .spin-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #e91e63, #9c27b0);
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .spin-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .casino-result {
            margin-top: 12px;
            font-size: 14px;
            min-height: 20px;
        }
        
        .casino-result.win { color: #00e676; }
        .casino-result.lose { color: #ff3d00; }
        
        /* === –°–û–ü–ï–†–ù–ò–ö–ò === */
        .rival-marker {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 15px currentColor;
            animation: rival-pulse 2s infinite;
        }
        
        .rival-marker.red { background: #ff3d00; color: #ff3d00; }
        .rival-marker.blue { background: #2979ff; color: #2979ff; }
        .rival-marker.purple { background: #9c27b0; color: #9c27b0; }
        
        @keyframes rival-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .rival-popup {
            background: rgba(0,0,0,0.9);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            border: 1px solid;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <!-- –î–û–ñ–î–¨ -->
    <div class="rain-overlay" id="rain"></div>
    
    <div id="map"></div>
    
    <div class="ui-layer">
        <!-- –í–ï–†–•: —É—Ä–æ–≤–µ–Ω—å + –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å + —Ä–µ—Å—É—Ä—Å—ã + –±–∞–ª–∞–Ω—Å -->
        <div class="level-badge" id="level-badge">Lv.1 –ù–æ–≤–∏—á–æ–∫</div>
        <div class="xp-bar"><div class="xp-fill" id="xp-fill" style="width: 0%"></div></div>
        <div class="inventory-bar" id="inventory-bar">
            <div class="inventory-slot" id="inv-0"></div>
            <div class="inventory-slot" id="inv-1"></div>
            <div class="inventory-slot" id="inv-2"></div>
        </div>
        
        <div class="top-hud">
            <div class="resources-bar">
                <div class="resource-item">
                    <span class="resource-icon">‚ö°</span>
                    <span class="resource-val energy" id="energy-val">100</span>
                    <div class="resource-bar-mini"><div class="resource-fill energy" id="energy-bar" style="width: 100%"></div></div>
                </div>
                <div class="resource-item">
                    <span class="resource-icon">üíß</span>
                    <span class="resource-val water" id="water-val">100</span>
                    <div class="resource-bar-mini"><div class="resource-fill water" id="water-bar" style="width: 100%"></div></div>
                </div>
                <div class="resource-item">
                    <span class="resource-icon">üòé</span>
                    <span class="resource-val mood" id="mood-val">100</span>
                    <div class="resource-bar-mini"><div class="resource-fill mood" id="mood-bar" style="width: 100%"></div></div>
                </div>
            </div>
            <div class="balance-chip" id="balance">50 ‚ÇΩ</div>
        </div>
        
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø–æ–≥–æ–¥—ã –∏ —ç–∫–æ–Ω–æ–º–∏–∫–∏ -->
        <div class="weather-indicator" id="weather-indicator">
            <span id="weather-icon">üåßÔ∏è</span>
            <span id="weather-text">–î–æ–∂–¥—å +25% –∫ –∑–∞–∫–∞–∑–∞–º</span>
        </div>
        <div class="inflation-warning" id="inflation-warning">
            üìà –ò–Ω—Ñ–ª—è—Ü–∏—è: —Ü–µ–Ω—ã –≤—ã—Ä–æ—Å–ª–∏!
        </div>
        
        <!-- –ú–∞–ª–µ–Ω—å–∫–∏–µ –∫–Ω–æ–ø–∫–∏ —Å–≤–µ—Ä—Ö—É -->
        <div class="top-actions">
            <button class="mini-btn bank" onclick="openBank()" title="–ë–∞–Ω–∫">üè¶</button>
            <button class="mini-btn stats" onclick="showStats()" title="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞">üìä</button>
            <button class="mini-btn gear" onclick="openGearShop()" title="–°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ">üéí</button>
            <button class="mini-btn" style="border-color: #ffd700; color: #ffd700;" onclick="openAchievements()" title="–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è">üèÜ</button>
            <button class="mini-btn" style="border-color: #00e676; color: #00e676;" onclick="openEconomy()" title="–≠–∫–æ–Ω–æ–º–∏–∫–∞">üìà</button>
        </div>
        
        <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
        <div class="main-menu">
            <!-- –ï–¥–∞ (–≤—ã–ø–∞–¥–∞–µ—Ç –≤–æ–¥–∞/–∫–æ—Ñ–µ) -->
            <div style="position: relative;">
                <button class="side-btn food" onclick="toggleFoodMenu()">
                    <span class="icon">üçî</span>
                    <span class="label">–ï–¥–∞</span>
                </button>
                <!-- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –µ–¥—ã -->
                <div id="food-menu" style="display: none; position: fixed; bottom: 180px; left: 50%; transform: translateX(-50%); background: rgba(20,20,20,0.98); border-radius: 12px; padding: 8px; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(10px); z-index: 500; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
                    <button onclick="openShopType('water'); toggleFoodMenu();" style="display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: transparent; border: none; color: #fff; font-size: 13px; white-space: nowrap; cursor: pointer; border-radius: 8px;">
                        <span>üíß</span> <span>–í–æ–¥–∞ 3‚ÇΩ</span>
                    </button>
                    <button onclick="openShopType('energy'); toggleFoodMenu();" style="display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: transparent; border: none; color: #fff; font-size: 13px; white-space: nowrap; cursor: pointer; border-radius: 8px;">
                        <span>‚òï</span> <span>–ö–æ—Ñ–µ 5‚ÇΩ</span>
                    </button>
                </div>
            </div>
            
            <!-- –ì–ª–∞–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –ó–ê–ö–ê–ó -->
            <button class="order-btn" onclick="findOrder()">
                <span class="icon">üö≤</span>
                <span class="label">–ó–ê–ö–ê–ó</span>
            </button>
            
            <!-- –®–æ–ø (–≤—ã–ø–∞–¥–∞–µ—Ç –º–∞–≥–∞–∑–∏–Ω/—Å–Ω–∞—Ä—è–∂) -->
            <div style="position: relative;">
                <button class="side-btn shop" onclick="toggleShopMenu()">
                    <span class="icon">üõí</span>
                    <span class="label">–®–æ–ø</span>
                </button>
                <!-- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é —à–æ–ø–∞ -->
                <div id="shop-menu" style="display: none; position: fixed; bottom: 180px; left: 50%; transform: translateX(-50%); background: rgba(20,20,20,0.98); border-radius: 12px; padding: 8px; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(10px); z-index: 500; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
                    <button onclick="openShop(); toggleShopMenu();" style="display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: transparent; border: none; color: #fff; font-size: 13px; white-space: nowrap; cursor: pointer; border-radius: 8px;">
                        <span>üõçÔ∏è</span> <span>–ú–∞–≥–∞–∑–∏–Ω</span>
                    </button>
                    <button onclick="openGearShop(); toggleShopMenu();" style="display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: transparent; border: none; color: #fff; font-size: 13px; white-space: nowrap; cursor: pointer; border-radius: 8px;">
                        <span>üéí</span> <span>–°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- –ü–ê–ù–ï–õ–¨ –í–´–ë–û–†–ê –ú–ê–†–®–†–£–¢–ê -->
        <div class="center-panel" id="route-panel">
            <div class="panel-title">üó∫Ô∏è –í—ã–±–µ—Ä–∏ –º–∞—Ä—à—Ä—É—Ç</div>
            <div class="panel-subtitle">–ö–∞–∂–¥—ã–π –ø—É—Ç—å ‚Äî —Å–≤–æ–π —Ä–∏—Å–∫ –∏ –Ω–∞–≥—Ä–∞–¥–∞</div>
            <div id="route-options"></div>
        </div>
        
        <!-- –ü–ê–ù–ï–õ–¨ –î–û–°–¢–ê–í–ö–ò -->
        <div class="delivery-panel" id="delivery-panel">
            <div class="delivery-header">
                <div class="delivery-title" id="delivery-title">üçî –î–æ—Å—Ç–∞–≤–∫–∞</div>
                <div class="delivery-status" id="delivery-status">–í –ø—É—Ç–∏...</div>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="delivery-buttons">
                <button class="btn btn-primary" id="drive-btn" onclick="startDriving()" style="display:none;">üö≤ –ï—Ö–∞—Ç—å</button>
                <button class="btn btn-danger" onclick="cancelDelivery()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
    
    <!-- –ö–ê–ó–ò–ù–û –ö–ù–û–ü–ö–ê -->
    <button class="casino-fab pulse" onclick="openCasino()">üé∞</button>
    
    <!-- –ò–ì–†–ê -->
    <div class="game-overlay" id="game-overlay">
        <div class="game-box">
            <div class="game-title">‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –¥–æ—Ä–æ–≥–µ!</div>
            <div class="game-road" id="game-road">
                <div class="lane" style="top: 0;"></div>
                <div class="lane" style="top: 33.33%;"></div>
                <div class="lane" style="top: 66.66%;"></div>
                <div class="player-bike" id="player">üö¥</div>
            </div>
            <div class="game-controls">
                <button class="control-btn up" onclick="moveBike(-1)">‚¨ÜÔ∏è</button>
                <button class="control-btn down" onclick="moveBike(1)">‚¨áÔ∏è</button>
            </div>
        </div>
    </div>
    
    <!-- –ü–ò–¢-–°–¢–û–ü -->
    <div class="pitstop-overlay" id="pitstop-overlay">
        <div class="pitstop-card">
            <div class="pitstop-title" id="pitstop-title">‚õΩ –ü–∏—Ç-—Å—Ç–æ–ø</div>
            <div id="pitstop-items"></div>
            <button class="btn-close" onclick="skipPitstop()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
    </div>
    
    <!-- –°–û–ë–´–¢–ò–ï -->
    <div class="event-overlay" id="event-overlay">
        <div class="event-card">
            <div class="event-icon" id="event-icon">‚ö†Ô∏è</div>
            <div class="event-title" id="event-title">–°–æ–±—ã—Ç–∏–µ</div>
            <div class="event-text" id="event-text">–ß—Ç–æ-—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ...</div>
            <div id="event-choices"></div>
        </div>
    </div>
    
    <!-- –ú–ê–ì–ê–ó–ò–ù -->
    <div class="shop-overlay" id="shop-overlay">
        <div class="shop-card">
            <div class="shop-title" id="shop-title">üõí –ú–∞–≥–∞–∑–∏–Ω</div>
            <div id="shop-items"></div>
            <button class="btn-close" onclick="closeShop()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    
    <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
    <div class="shop-overlay" id="stats-overlay">
        <div class="shop-card">
            <div class="shop-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
            <div id="stats-content"></div>
            <button class="btn-close" onclick="closeStats()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    
    <!-- –ê–ß–ò–í–ö–ò -->
    <div class="shop-overlay" id="achievements-overlay">
        <div class="shop-card" style="max-width: 380px; max-height: 85vh;">
            <div class="shop-title">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
            <div id="achievements-content" style="max-height: 60vh; overflow-y: auto; padding-right: 5px;"></div>
            <button class="btn-close" onclick="closeAchievements()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    
    <!-- –≠–ö–û–ù–û–ú–ò–ö–ê -->
    <div class="shop-overlay" id="economy-overlay">
        <div class="shop-card" style="max-width: 340px; max-height: 85vh;">
            <div class="shop-title">üìà –≠–∫–æ–Ω–æ–º–∏–∫–∞</div>
            <div id="economy-content" style="max-height: 60vh; overflow-y: auto; padding-right: 5px;"></div>
            <button class="btn-close" onclick="closeEconomy()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    
    <!-- –ë–ê–ù–ö -->
    <div class="shop-overlay" id="bank-overlay">
        <div class="shop-card" style="max-width: 380px;">
            <div class="shop-title">üè¶ Night Bank</div>
            <div id="bank-content"></div>
            <button class="btn-close" onclick="closeBank()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    
    <!-- –ö–ê–ó–ò–ù–û -->
    <div class="casino-overlay" id="casino-overlay">
        <div class="casino-card">
            <div class="casino-title">üé∞ NIGHT CASINO</div>
            <div class="casino-subtitle">–†–∏—Å–∫–Ω–∏ –≤—Å—ë –∏–ª–∏ —Å—Ç–∞–Ω—å –±–æ–≥–∞—Ç—ã–º!</div>
            
            <div class="casino-balance">
                <div class="casino-balance-label">–í–∞—à –±–∞–ª–∞–Ω—Å</div>
                <div class="casino-balance-amount" id="casino-balance">50 ‚ÇΩ</div>
            </div>
            
            <div class="casino-game">
                <div class="slot-machine">
                    <div class="slot-reel" id="slot1">üçí</div>
                    <div class="slot-reel" id="slot2">üçã</div>
                    <div class="slot-reel" id="slot3">üçá</div>
                </div>
                
                <div class="casino-bet">
                    <button class="bet-btn active" onclick="setBet(5)" data-bet="5">5‚ÇΩ</button>
                    <button class="bet-btn" onclick="setBet(10)" data-bet="10">10‚ÇΩ</button>
                    <button class="bet-btn" onclick="setBet(25)" data-bet="25">25‚ÇΩ</button>
                    <button class="bet-btn" onclick="setBet(50)" data-bet="50">50‚ÇΩ</button>
                </div>
                
                <button class="spin-btn" id="spin-btn" onclick="spinSlots()">üé∞ –ö–†–£–¢–ò–¢–¨!</button>
                
                <div class="casino-result" id="casino-result"></div>
            </div>
            
            <div style="font-size:11px;color:#666;text-align:center;margin-top:10px;">
                üçíüçíüçí = x10 | üçãüçãüçã = x5 | üçáüçáüçá = x3 | –õ—é–±—ã–µ 2 = x2
            </div>
            
            <button class="btn-close" onclick="closeCasino()" style="margin-top:16px;">–í—ã–π—Ç–∏</button>
        </div>
    </div>
    
    <!-- –°–ù–ê–†–Ø–ñ–ï–ù–ò–ï -->
    <div class="shop-overlay" id="gear-overlay">
        <div class="shop-card">
            <div class="shop-title">üéí –°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ</div>
            <div id="gear-content"></div>
            <button class="btn-close" onclick="closeGearShop()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const WARSAW_CENTER = [52.2297, 21.0122];
        
        const SHOP_ITEMS = {
            water: [
                { name: '–í–æ–¥–∞ 0.5–ª', icon: 'üíß', cost: 3, energy: 0, water: 40, mood: 5 },
                { name: '–í–æ–¥–∞ 1.5–ª', icon: 'ü•§', cost: 5, energy: -5, water: 70, mood: 10 }
            ],
            energy: [
                { name: '–≠—Å–ø—Ä–µ—Å—Å–æ', icon: '‚òï', cost: 5, energy: 35, water: -5, mood: 10 },
                { name: 'Red Bull', icon: '‚ö°', cost: 8, energy: 60, water: -10, mood: 5 }
            ],
            all: [
                { name: '–ë—É—Ä–≥–µ—Ä', icon: 'üçî', cost: 15, energy: 50, water: 10, mood: 30 },
                { name: '–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫', icon: '‚ö°', cost: 8, energy: 60, water: -10, mood: 5 },
                { name: '–í–æ–¥–∞ 1.5–ª', icon: 'ü•§', cost: 5, energy: -5, water: 70, mood: 10 }
            ]
        };
        
        const PITSTOPS = {
            gas: { name: '–ê–ó–°', icon: '‚õΩ', items: [
                { name: '–ö–æ—Ñ–µ', cost: 4, energy: 25, water: -5, mood: 10, icon: '‚òï' },
                { name: '–í–æ–¥–∞', cost: 3, energy: 5, water: 40, mood: 0, icon: 'üíß' }
            ]},
            cafe: { name: '–ö–∞—Ñ–µ', icon: '‚òï', items: [
                { name: '–û–±–µ–¥', cost: 12, energy: 40, water: 20, mood: 30, icon: 'üçΩÔ∏è' },
                { name: '–õ–∞—Ç—Ç–µ', cost: 6, energy: 20, water: 10, mood: 15, icon: '‚òï' }
            ]}
        };
        
        // === –≠–ö–û–ù–û–ú–ò–ß–ï–°–ö–ê–Ø –°–ò–°–¢–ï–ú–ê ===
        const ECONOMY = {
            inflationRate: 0.02,        // +2% –∑–∞ –∫–∞–∂–¥—É—é –¥–æ—Å—Ç–∞–≤–∫—É
            inflationCap: 2.0,          // –ú–∞–∫—Å x2 —Ü–µ–Ω—ã
            rainBonus: 0.25,            // +25% –≤ –¥–æ–∂–¥—å
            nightBonus: 0.50,           // +50% –Ω–æ—á—å—é
            nightPenalty: 0.30,         // -30% —ç–Ω–µ—Ä–≥–∏–∏ –Ω–æ—á—å—é
            crisisChance: 0.1,          // 10% —à–∞–Ω—Å –∫—Ä–∏–∑–∏—Å–∞
            crisisDuration: 300,        // 5 –º–∏–Ω—É—Ç –∫—Ä–∏–∑–∏—Å
            crisisPenalty: 0.30         // -30% –∫ –∑–∞–∫–∞–∑–∞–º –≤ –∫—Ä–∏–∑–∏—Å
        };
        
        // === –ê–ß–ò–í–ö–ò ===
        const ACHIEVEMENTS = [
            { id: 'first_delivery', name: '–ü–µ—Ä–≤—ã–µ —à–∞–≥–∏', desc: '–í—ã–ø–æ–ª–Ω–∏—Ç–µ 1 –¥–æ—Å—Ç–∞–≤–∫—É', icon: 'üö≤', check: () => state.stats.totalDeliveries >= 1, reward: 10 },
            { id: 'delivery_10', name: '–û–ø—ã—Ç–Ω—ã–π –∫—É—Ä—å–µ—Ä', desc: '–í—ã–ø–æ–ª–Ω–∏—Ç–µ 10 –¥–æ—Å—Ç–∞–≤–æ–∫', icon: 'üì¶', check: () => state.stats.totalDeliveries >= 10, reward: 50 },
            { id: 'delivery_50', name: '–ú–∞—Å—Ç–µ—Ä –¥–æ—Å—Ç–∞–≤–∫–∏', desc: '–í—ã–ø–æ–ª–Ω–∏—Ç–µ 50 –¥–æ—Å—Ç–∞–≤–æ–∫', icon: 'üèÜ', check: () => state.stats.totalDeliveries >= 50, reward: 200 },
            { id: 'delivery_100', name: '–õ–µ–≥–µ–Ω–¥–∞ –Ω–æ—á–∏', desc: '–í—ã–ø–æ–ª–Ω–∏—Ç–µ 100 –¥–æ—Å—Ç–∞–≤–æ–∫', icon: 'üëë', check: () => state.stats.totalDeliveries >= 100, reward: 500 },
            { id: 'rich_100', name: '–ü–µ—Ä–≤—ã–µ –¥–µ–Ω—å–≥–∏', desc: '–ó–∞—Ä–∞–±–æ—Ç–∞–π—Ç–µ 100‚ÇΩ', icon: 'üí∞', check: () => state.stats.totalEarned >= 100, reward: 20 },
            { id: 'rich_500', name: '–ë–∏–∑–Ω–µ—Å–º–µ–Ω', desc: '–ó–∞—Ä–∞–±–æ—Ç–∞–π—Ç–µ 500‚ÇΩ', icon: 'üíé', check: () => state.stats.totalEarned >= 500, reward: 100 },
            { id: 'rich_1000', name: '–ú–∏–ª–ª–∏–æ–Ω–µ—Ä', desc: '–ó–∞—Ä–∞–±–æ—Ç–∞–π—Ç–µ 1000‚ÇΩ', icon: 'üè¶', check: () => state.stats.totalEarned >= 1000, reward: 300 },
            { id: 'no_accidents_10', name: '–ê–∫–∫—É—Ä–∞—Ç–Ω—ã–π', desc: '10 –¥–æ—Å—Ç–∞–≤–æ–∫ –±–µ–∑ –∞–≤–∞—Ä–∏–π', icon: 'üõ°Ô∏è', check: () => state.stats.accidents === 0 && state.stats.totalDeliveries >= 10, reward: 50 },
            { id: 'level_3', name: '–í–∑–ª—ë—Ç –∫–∞—Ä—å–µ—Ä—ã', desc: '–î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ 3 —É—Ä–æ–≤–Ω—è', icon: 'üìà', check: () => state.level >= 3, reward: 30 },
            { id: 'level_5', name: '–≠–ª–∏—Ç–∞', desc: '–î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ 5 —É—Ä–æ–≤–Ω—è', icon: '‚≠ê', check: () => state.level >= 5, reward: 100 },
            { id: 'casino_win', name: '–í–µ–∑—É–Ω—á–∏–∫', desc: '–í—ã–∏–≥—Ä–∞–π—Ç–µ –≤ –∫–∞–∑–∏–Ω–æ 50‚ÇΩ', icon: 'üé∞', check: () => state.stats.casinoWins >= 50, reward: 25 },
            { id: 'rain_master', name: '–î–æ–∂–¥–µ–≤–∏–∫', desc: '–î–æ—Å—Ç–∞–≤—å—Ç–µ –≤ –¥–æ–∂–¥—å 5 —Ä–∞–∑', icon: 'üåßÔ∏è', check: () => state.stats.rainDeliveries >= 5, reward: 40 }
        ];
        
        let economyState = {
            inflationMultiplier: 1.0,   // –¢–µ–∫—É—â–∏–π –º–Ω–æ–∂–∞—Ç–µ–ª—å —Ü–µ–Ω
            deliveriesCount: 0,         // –°—á—ë—Ç—á–∏–∫ –¥–ª—è –∏–Ω—Ñ–ª—è—Ü–∏–∏
            isCrisis: false,            // –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –∫—Ä–∏–∑–∏—Å
            crisisEndTime: 0,           // –ö–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è –∫—Ä–∏–∑–∏—Å
            isNight: false,             // –ù–æ—á—å —Å–µ–π—á–∞—Å?
            isRain: true,               // –î–æ–∂–¥—å —Å–µ–π—á–∞—Å?
            unlockedAchievements: []    // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞—á–∏–≤–∫–∏
        };
        
        const RESTAURANTS = [
            { name: "McDonald's", icon: "üçî" },
            { name: "KFC", icon: "üçó" },
            { name: "Pizza Hut", icon: "üçï" },
            { name: "Sushi Master", icon: "üç£" },
            { name: "Kebab King", icon: "üåØ" }
        ];
        
        const ROAD_EVENTS = [
            { icon: 'üåßÔ∏è', title: '–õ–∏–≤–µ–Ω—å!', text: '–î–æ—Ä–æ–≥–∏ —Å–∫–æ–ª—å–∑–∫–∏–µ.', choices: [
                { text: '–ï—Ö–∞—Ç—å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ', effect: { time: 10, mood: -5 } },
                { text: '–†–∏—Å–∫–Ω—É—Ç—å', effect: { time: -5, risk: 20 } }
            ]},
            { icon: 'üöî', title: '–ü–æ–ª–∏—Ü–∏—è', text: '–ü–∞—Ç—Ä—É–ª—å –æ—Å—Ç–∞–Ω–æ–≤–∏–ª.', choices: [
                { text: '–ü–æ–∫–∞–∑–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã', effect: { time: 5, mood: -10 } },
                { text: '–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∫–æ—Ñ–µ (-15‚ÇΩ)', effect: { money: -15 } }
            ]},
            { icon: 'üöß', title: '–ü—Ä–æ–±–∫–∞', text: '–ì–ª–∞–≤–Ω–∞—è –¥–æ—Ä–æ–≥–∞ –≤—Å—Ç–∞–ª–∞.', choices: [
                { text: '–ñ–¥–∞—Ç—å', effect: { time: 8, mood: -15 } },
                { text: '–û–±—ä–µ–∑–¥', effect: { time: -3, risk: 25 } }
            ]}
        ];
        
        let state = {
            balance: 50, energy: 100, water: 100, mood: 100,
            experience: 0, level: 1,
            stats: { totalDeliveries: 0, totalEarned: 0, accidents: 0, bestTip: 0, casinoWins: 0, rainDeliveries: 0 },
            currentOrder: null, currentRoute: null, isDelivering: false,
            progress: 0, currentStop: 0, gameActive: false, bikeLane: 1, gameHits: 0,
            inventory: [], // –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
            activeItems: { raincoat: false, thermos: false, powerbank: false, gps: false }
        };
        
        // === –ò–ù–í–ï–ù–¢–ê–†–¨ ===
        const SHOP_GEAR = [
            { id: 'raincoat', name: '–î–æ–∂–¥–µ–≤–∏–∫', icon: 'üß•', cost: 80, desc: '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –Ω–µ –ø–∞–¥–∞–µ—Ç –≤ –¥–æ–∂–¥—å', duration: 300 },
            { id: 'thermos', name: '–¢–µ—Ä–º–æ—Å', icon: 'üçµ', cost: 60, desc: '–í–æ–¥–∞ –Ω–µ –ø–∞–¥–∞–µ—Ç 5 –º–∏–Ω—É—Ç', duration: 300 },
            { id: 'powerbank', name: 'Powerbank', icon: 'üîã', cost: 70, desc: '–≠–Ω–µ—Ä–≥–∏—è –Ω–µ –ø–∞–¥–∞–µ—Ç 5 –º–∏–Ω—É—Ç', duration: 300 },
            { id: 'gps', name: 'GPS-–Ω–∞–≤–∏–≥–∞—Ç–æ—Ä', icon: 'üì°', cost: 150, desc: '–ú–∞—Ä—à—Ä—É—Ç—ã –Ω–∞ 20% –∫–æ—Ä–æ—á–µ', duration: -1 }
        ];
        
        // === –£–†–û–í–ù–ò ===
        const LEVELS = {
            1: { title: '–ù–æ–≤–∏—á–æ–∫', xpNeed: 0, bonus: '' },
            2: { title: '–ö—É—Ä—å–µ—Ä', xpNeed: 100, bonus: '–°–∫–∏–¥–∫–∞ 5% –≤ –º–∞–≥–∞–∑–∏–Ω–µ' },
            3: { title: '–û–ø—ã—Ç–Ω—ã–π', xpNeed: 300, bonus: '–°–∫–∏–¥–∫–∞ 10% –≤ –º–∞–≥–∞–∑–∏–Ω–µ' },
            4: { title: '–ü—Ä–æ—Ñ–∏', xpNeed: 600, bonus: '–°–∫–∏–¥–∫–∞ 15% –≤ –º–∞–≥–∞–∑–∏–Ω–µ' },
            5: { title: '–ú–∞—Å—Ç–µ—Ä', xpNeed: 1000, bonus: '–°–∫–∏–¥–∫–∞ 20% –≤ –º–∞–≥–∞–∑–∏–Ω–µ' },
            6: { title: '–õ–µ–≥–µ–Ω–¥–∞', xpNeed: 2000, bonus: '–°–∫–∏–¥–∫–∞ 25% + x2 XP' }
        };
        
        let map, courierMarker, destMarker, routeLine, pitstopMarkers = [];
        let obstacleInterval;
        
        // === –ö–ê–ó–ò–ù–û ===
        let currentBet = 5;
        const slotSymbols = ['üçí', 'üçã', 'üçá', 'üíé', '7Ô∏è‚É£', 'üé∞'];
        const slotWeights = [30, 25, 20, 15, 8, 2]; // –®–∞–Ω—Å—ã –≤—ã–ø–∞–¥–µ–Ω–∏—è
        let isSpinning = false;
        
        // === –°–û–ü–ï–†–ù–ò–ö–ò ===
        let rivals = [];
        const rivalNames = ['Speedy', 'Night Rider', 'Flash', 'Shadow', 'Ghost'];
        const rivalColors = ['red', 'blue', 'purple'];

        // === –≠–ö–û–ù–û–ú–ò–ö–ê ===
        function saveEconomy() {
            localStorage.setItem('warsaw_courier_economy', JSON.stringify(economyState));
        }
        
        function loadEconomy() {
            const saved = localStorage.getItem('warsaw_courier_economy');
            if (saved) {
                economyState = { ...economyState, ...JSON.parse(saved) };
            }
        }
        
        function updateEconomy() {
            const now = new Date();
            const hour = now.getHours();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ—á—å (22:00 - 06:00)
            economyState.isNight = hour >= 22 || hour < 6;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏–∑–∏—Å
            if (economyState.isCrisis && Date.now() > economyState.crisisEndTime) {
                economyState.isCrisis = false;
                showToast('üìà –ö—Ä–∏–∑–∏—Å –∑–∞–∫–æ–Ω—á–∏–ª—Å—è!', 3000);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–≥–æ–¥—ã
            updateWeatherIndicator();
        }
        
        function updateWeatherIndicator() {
            const indicator = document.getElementById('weather-indicator');
            const icon = document.getElementById('weather-icon');
            const text = document.getElementById('weather-text');
            const inflationWarning = document.getElementById('inflation-warning');
            
            let bonusText = '';
            let totalBonus = 0;
            
            if (economyState.isRain) {
                totalBonus += ECONOMY.rainBonus;
                bonusText += 'üåßÔ∏è –î–æ–∂–¥—å +' + (ECONOMY.rainBonus * 100) + '% ';
            }
            if (economyState.isNight) {
                totalBonus += ECONOMY.nightBonus;
                bonusText += 'üåô –ù–æ—á—å +' + (ECONOMY.nightBonus * 100) + '% ';
            }
            if (economyState.isCrisis) {
                bonusText += 'üí• –ö—Ä–∏–∑–∏—Å -' + (ECONOMY.crisisPenalty * 100) + '%!';
                indicator.className = 'weather-indicator';
                indicator.style.borderColor = '#ff3d00';
                indicator.style.color = '#ff3d00';
            } else if (totalBonus > 0) {
                indicator.className = 'weather-indicator bonus';
            } else {
                indicator.className = 'weather-indicator';
            }
            
            icon.textContent = economyState.isRain ? 'üåßÔ∏è' : economyState.isNight ? 'üåô' : '‚òÄÔ∏è';
            text.textContent = bonusText || '–û–±—ã—á–Ω—ã–π –¥–µ–Ω—å';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–ª—è—Ü–∏—é
            if (economyState.inflationMultiplier > 1.3) {
                inflationWarning.classList.add('active');
            } else {
                inflationWarning.classList.remove('active');
            }
        }
        
        function applyInflation() {
            economyState.deliveriesCount++;
            economyState.inflationMultiplier = Math.min(
                ECONOMY.inflationCap,
                1 + (economyState.deliveriesCount * ECONOMY.inflationRate)
            );
            saveEconomy();
        }
        
        function getCurrentPrice(basePrice) {
            let multiplier = economyState.inflationMultiplier;
            
            // –ë–æ–Ω—É—Å—ã/—à—Ç—Ä–∞—Ñ—ã
            if (economyState.isRain) multiplier += ECONOMY.rainBonus;
            if (economyState.isNight) multiplier += ECONOMY.nightBonus;
            if (economyState.isCrisis) multiplier -= ECONOMY.crisisPenalty;
            
            return Math.floor(basePrice * Math.max(0.5, multiplier));
        }
        
        function triggerCrisis() {
            if (Math.random() < ECONOMY.crisisChance && !economyState.isCrisis) {
                economyState.isCrisis = true;
                economyState.crisisEndTime = Date.now() + ECONOMY.crisisDuration * 1000;
                showToast('üí• –≠–ö–û–ù–û–ú–ò–ß–ï–°–ö–ò–ô –ö–†–ò–ó–ò–°! –ó–∞–∫–∞–∑—ã –¥–∞—é—Ç -30%!', 5000);
                updateWeatherIndicator();
            }
        }
        
        // === –ê–ß–ò–í–ö–ò ===
        function checkAchievements() {
            let newUnlocked = false;
            
            ACHIEVEMENTS.forEach(ach => {
                if (!economyState.unlockedAchievements.includes(ach.id) && ach.check()) {
                    economyState.unlockedAchievements.push(ach.id);
                    state.balance += ach.reward;
                    showToast(`üèÜ –ê—á–∏–≤–∫–∞: ${ach.name}! +${ach.reward}‚ÇΩ`, 4000);
                    newUnlocked = true;
                }
            });
            
            if (newUnlocked) {
                saveEconomy();
                updateUI();
            }
        }
        
        // === –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–ï–ù–Æ ===
        function hideMenu() {
            // –°–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Ö–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –∏ –∫–∞–∑–∏–Ω–æ
            const topActions = document.querySelector('.top-actions');
            const casinoFab = document.querySelector('.casino-fab');
            
            if (topActions) topActions.style.display = 'none';
            if (casinoFab) casinoFab.style.display = 'none';
        }
        
        function hideAllMenu() {
            // –°–∫—Ä—ã–≤–∞–µ–º –í–°–Å (–¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏)
            const mainMenu = document.querySelector('.main-menu');
            const topActions = document.querySelector('.top-actions');
            const casinoFab = document.querySelector('.casino-fab');
            
            if (mainMenu) mainMenu.style.display = 'none';
            if (topActions) topActions.style.display = 'none';
            if (casinoFab) casinoFab.style.display = 'none';
        }
        
        function showMenu() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å—ë –æ–±—Ä–∞—Ç–Ω–æ
            const mainMenu = document.querySelector('.main-menu');
            const topActions = document.querySelector('.top-actions');
            const casinoFab = document.querySelector('.casino-fab');
            
            if (mainMenu) mainMenu.style.display = 'flex';
            if (topActions) topActions.style.display = 'flex';
            if (casinoFab) casinoFab.style.display = 'flex';
        }
        
        function openAchievements() {
            hideMenu();
            const container = document.getElementById('achievements-content');
            container.innerHTML = '';
            
            let unlockedCount = 0;
            
            ACHIEVEMENTS.forEach(ach => {
                const isUnlocked = economyState.unlockedAchievements.includes(ach.id);
                if (isUnlocked) unlockedCount++;
                
                const div = document.createElement('div');
                div.className = 'achievement ' + (isUnlocked ? 'unlocked' : 'locked');
                div.innerHTML = `
                    <div class="achievement-icon">${ach.icon}</div>
                    <div class="achievement-info">
                        <div class="achievement-name">${ach.name}</div>
                        <div class="achievement-desc">${ach.desc}</div>
                        ${isUnlocked ? `<div class="achievement-reward">‚úì –ü–æ–ª—É—á–µ–Ω–æ +${ach.reward}‚ÇΩ</div>` : ''}
                    </div>
                `;
                container.appendChild(div);
            });
            
            const progress = document.createElement('div');
            progress.style.cssText = 'text-align: center; margin-top: 15px; font-size: 13px; color: #888;';
            progress.innerHTML = `–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: <b style="color: #ffd700;">${unlockedCount}/${ACHIEVEMENTS.length}</b>`;
            container.appendChild(progress);
            
            document.getElementById('achievements-overlay').classList.add('active');
        }
        
        function closeAchievements() {
            document.getElementById('achievements-overlay').classList.remove('active');
            showMenu();
        }
        
        // === –≠–ö–û–ù–û–ú–ò–ö–ê –ü–ê–ù–ï–õ–¨ ===
        function openEconomy() {
            hideMenu();
            const container = document.getElementById('economy-content');
            const inflationPercent = Math.round((economyState.inflationMultiplier - 1) * 100);
            
            let inflationClass = 'low';
            if (inflationPercent > 30) inflationClass = 'medium';
            if (inflationPercent > 70) inflationClass = 'high';
            
            container.innerHTML = `
                <div class="economy-stat">
                    <span class="economy-label">üìà –ò–Ω—Ñ–ª—è—Ü–∏—è</span>
                    <span class="economy-value ${inflationClass === 'high' ? 'bad' : inflationClass === 'medium' ? 'warning' : 'good'}">+${inflationPercent}%</span>
                </div>
                <div class="inflation-bar">
                    <div class="inflation-fill ${inflationClass}" style="width: ${Math.min(100, inflationPercent / 2)}%"></div>
                </div>
                
                <div class="economy-stat">
                    <span class="economy-label">üåßÔ∏è –î–æ–∂–¥—å</span>
                    <span class="economy-value ${economyState.isRain ? 'good' : ''}">${economyState.isRain ? '–î–ê (+25%)' : '–ù–µ—Ç'}</span>
                </div>
                
                <div class="economy-stat">
                    <span class="economy-label">üåô –ù–æ—á–Ω–æ–π –±–æ–Ω—É—Å</span>
                    <span class="economy-value ${economyState.isNight ? 'good' : ''}">${economyState.isNight ? '–î–ê (+50%)' : '–ù–µ—Ç'}</span>
                </div>
                
                <div class="economy-stat">
                    <span class="economy-label">üí• –ö—Ä–∏–∑–∏—Å</span>
                    <span class="economy-value ${economyState.isCrisis ? 'bad' : 'good'}">${economyState.isCrisis ? '–ê–ö–¢–ò–í–ï–ù (-30%)' : '–ù–µ—Ç'}</span>
                </div>
                
                <div class="economy-stat">
                    <span class="economy-label">üì¶ –î–æ—Å—Ç–∞–≤–æ–∫ —Å–¥–µ–ª–∞–Ω–æ</span>
                    <span class="economy-value">${economyState.deliveriesCount}</span>
                </div>
                
                <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 10px; font-size: 11px; color: #888; line-height: 1.5;">
                    üí° <b>–°–æ–≤–µ—Ç:</b> –î–æ–∂–¥—å –∏ –Ω–æ—á—å –¥–∞—é—Ç –±–æ–Ω—É—Å—ã –∫ –∑–∞–∫–∞–∑–∞–º, –Ω–æ –∏–Ω—Ñ–ª—è—Ü–∏—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Ä–∞—Å—Ç—ë—Ç —Å –∫–∞–∂–¥–æ–π –¥–æ—Å—Ç–∞–≤–∫–æ–π!
                </div>
            `;
            
            document.getElementById('economy-overlay').classList.add('active');
        }
        
        function closeEconomy() {
            document.getElementById('economy-overlay').classList.remove('active');
            showMenu();
        }

        function saveGame() {
            localStorage.setItem('warsaw_courier_save', JSON.stringify({
                balance: state.balance, energy: state.energy, water: state.water, mood: state.mood,
                stats: state.stats, level: state.level, experience: state.experience,
                inventory: state.inventory, activeItems: state.activeItems
            }));
        }
        
        function loadGame() {
            const saved = localStorage.getItem('warsaw_courier_save');
            if (saved) {
                const data = JSON.parse(saved);
                state.balance = data.balance ?? 50;
                state.energy = data.energy ?? 100;
                state.water = data.water ?? 100;
                state.mood = data.mood ?? 100;
                state.stats = data.stats ?? { totalDeliveries: 0, totalEarned: 0, accidents: 0, bestTip: 0, casinoWins: 0, rainDeliveries: 0 };
                state.level = data.level ?? 1;
                state.experience = data.experience ?? 0;
                state.inventory = data.inventory ?? [];
                state.activeItems = data.activeItems ?? { raincoat: false, thermos: false, powerbank: false, gps: false };
                
                // –ù–æ–≤—ã–µ –ø–æ–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                if (state.stats) {
                    state.stats.casinoWins = state.stats.casinoWins || 0;
                    state.stats.rainDeliveries = state.stats.rainDeliveries || 0;
                }
            }
        }

        function init() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView(WARSAW_CENTER, 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
            
            const courierIcon = L.divIcon({ html: '<div class="marker-courier"></div>', className: 'custom-marker', iconSize: [20, 20] });
            courierMarker = L.marker(WARSAW_CENTER, { icon: courierIcon }).addTo(map);
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–æ–∂–¥—å
            createRain();
            
            // –°–ø–∞–≤–Ω–∏–º —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–≤
            spawnRivals();
            
            loadGame();
            loadBank();
            loadEconomy();
            updateUI();
            updateLevelUI();
            updateInventoryUI();
            updateEconomy();
            checkAchievements();
            
            setInterval(gameTick, 1000);
            setInterval(saveGame, 5000);
            setInterval(bankInterestTick, 60000); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
            setInterval(moveRivals, 3000); // –î–≤–∏–≥–∞–µ–º —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–≤ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫
            setInterval(updateEconomy, 30000); // –û–±–Ω–æ–≤–ª—è–µ–º —ç–∫–æ–Ω–æ–º–∏–∫—É –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
            window.addEventListener('beforeunload', () => { saveGame(); saveBank(); saveEconomy(); });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–ª–≥ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            if (bankState.loan >= BANK_CONFIG.collectorThreshold) {
                setTimeout(() => showToast('‚ö†Ô∏è –£ –≤–∞—Å –±–æ–ª—å—à–æ–π –¥–æ–ª–≥! –ö–æ–ª–ª–µ–∫—Ç–æ—Ä—ã –∞–∫—Ç–∏–≤–Ω—ã!', 4000), 2000);
            }
            
            showToast('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ! –ù–∞–∂–º–∏ –ó–ê–ö–ê–ó', 3000);
        }
        
        // === –î–û–ñ–î–¨ ===
        function createRain() {
            const rainContainer = document.getElementById('rain');
            for (let i = 0; i < 80; i++) {
                const drop = document.createElement('div');
                drop.className = 'rain-drop';
                drop.style.left = Math.random() * 100 + '%';
                drop.style.animationDuration = (0.5 + Math.random() * 0.5) + 's';
                drop.style.animationDelay = Math.random() * 2 + 's';
                drop.style.opacity = 0.3 + Math.random() * 0.4;
                rainContainer.appendChild(drop);
            }
        }
        
        // === –°–û–ü–ï–†–ù–ò–ö–ò ===
        function spawnRivals() {
            for (let i = 0; i < 3; i++) {
                const rival = {
                    name: rivalNames[i],
                    color: rivalColors[i],
                    earnings: Math.floor(Math.random() * 200) + 50,
                    lat: WARSAW_CENTER[0] + (Math.random() - 0.5) * 0.04,
                    lng: WARSAW_CENTER[1] + (Math.random() - 0.5) * 0.06,
                    marker: null
                };
                
                const icon = L.divIcon({
                    html: `<div class="rival-marker ${rival.color}"></div>`,
                    className: 'custom-marker',
                    iconSize: [18, 18]
                });
                
                rival.marker = L.marker([rival.lat, rival.lng], { icon: icon }).addTo(map);
                rival.marker.bindPopup(`
                    <div class="rival-popup" style="border-color: ${rival.color === 'red' ? '#ff3d00' : rival.color === 'blue' ? '#2979ff' : '#9c27b0'}">
                        <b>üèçÔ∏è ${rival.name}</b><br>
                        üí∞ –ó–∞—Ä–∞–±–æ—Ç–∞–ª: ${rival.earnings}‚ÇΩ
                    </div>
                `);
                
                rivals.push(rival);
            }
        }
        
        function moveRivals() {
            rivals.forEach(rival => {
                // –°–æ–ø–µ—Ä–Ω–∏–∫–∏ —Å–ª—É—á–∞–π–Ω–æ –¥–≤–∏–≥–∞—é—Ç—Å—è
                rival.lat += (Math.random() - 0.5) * 0.002;
                rival.lng += (Math.random() - 0.5) * 0.003;
                rival.marker.setLatLng([rival.lat, rival.lng]);
                
                // –ò–Ω–æ–≥–¥–∞ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç
                if (Math.random() < 0.3) {
                    rival.earnings += Math.floor(Math.random() * 15) + 5;
                    rival.marker.setPopupContent(`
                        <div class="rival-popup" style="border-color: ${rival.color === 'red' ? '#ff3d00' : rival.color === 'blue' ? '#2979ff' : '#9c27b0'}">
                            <b>üèçÔ∏è ${rival.name}</b><br>
                            üí∞ –ó–∞—Ä–∞–±–æ—Ç–∞–ª: ${rival.earnings}‚ÇΩ
                        </div>
                    `);
                }
            });
        }
        
        // === –ö–ê–ó–ò–ù–û ===
        let slotReels = [];
        
        function openCasino() {
            if (state.isDelivering) {
                showToast('‚ùå –ù–µ–ª—å–∑—è –≤–æ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏!', 2000);
                return;
            }
            hideMenu();
            document.getElementById('casino-balance').textContent = Math.floor(state.balance) + ' ‚ÇΩ';
            document.getElementById('casino-overlay').classList.add('active');
        }
        
        function closeCasino() {
            document.getElementById('casino-overlay').classList.remove('active');
            showMenu();
        }
        
        // === –ú–ï–ù–Æ ===
        function toggleFoodMenu() {
            const menu = document.getElementById('food-menu');
            const shopMenu = document.getElementById('shop-menu');
            
            shopMenu.style.display = 'none';
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }
        
        function toggleShopMenu() {
            const menu = document.getElementById('shop-menu');
            const foodMenu = document.getElementById('food-menu');
            
            foodMenu.style.display = 'none';
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.side-btn') && !e.target.closest('#food-menu') && !e.target.closest('#shop-menu')) {
                document.getElementById('food-menu').style.display = 'none';
                document.getElementById('shop-menu').style.display = 'none';
            }
        });
        
        function setBet(amount) {
            currentBet = amount;
            document.querySelectorAll('.bet-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.bet) === amount);
            });
        }
        
        function getRandomSymbol() {
            const totalWeight = slotWeights.reduce((a, b) => a + b, 0);
            let random = Math.random() * totalWeight;
            for (let i = 0; i < slotSymbols.length; i++) {
                random -= slotWeights[i];
                if (random <= 0) return slotSymbols[i];
            }
            return slotSymbols[0];
        }
        
        function spinSlots() {
            if (isSpinning) return;
            if (state.balance < currentBet) {
                showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!', 2000);
                return;
            }
            
            isSpinning = true;
            state.balance -= currentBet;
            updateUI();
            document.getElementById('casino-balance').textContent = Math.floor(state.balance) + ' ‚ÇΩ';
            document.getElementById('casino-result').textContent = '';
            
            const btn = document.getElementById('spin-btn');
            btn.disabled = true;
            btn.textContent = '–ö—Ä—É—Ç–∏–º...';
            
            slotReels = [
                document.getElementById('slot1'),
                document.getElementById('slot2'),
                document.getElementById('slot3')
            ];
            
            slotReels.forEach(r => r.classList.remove('win'));
            slotReels.forEach(r => r.classList.add('spinning'));
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞—Ä–∞–±–∞–Ω—ã —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
            const results = [];
            slotReels.forEach((reel, i) => {
                setTimeout(() => {
                    reel.classList.remove('spinning');
                    const symbol = getRandomSymbol();
                    reel.textContent = symbol;
                    results.push(symbol);
                    
                    if (i === 2) {
                        checkWin(results);
                        isSpinning = false;
                        btn.disabled = false;
                        btn.textContent = 'üé∞ –ö–†–£–¢–ò–¢–¨!';
                    }
                }, 500 + i * 300);
            });
        }
        
        function checkWin(results) {
            const resultDiv = document.getElementById('casino-result');
            const [s1, s2, s3] = results;
            let win = 0;
            let message = '';
            
            // –í—Å–µ —Ç—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ
            if (s1 === s2 && s2 === s3) {
                const multipliers = { 'üçí': 10, 'üçã': 5, 'üçá': 3, 'üíé': 15, '7Ô∏è‚É£': 20, 'üé∞': 50 };
                win = currentBet * (multipliers[s1] || 3);
                message = `üéâ –î–ñ–ï–ö–ü–û–¢! ${s1}${s1}${s1} = +${win}‚ÇΩ!`;
                slotReels.forEach(r => r.classList.add('win'));
                setTimeout(() => slotReels.forEach(r => r.classList.remove('win')), 1000);
            }
            // –î–≤–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ
            else if (s1 === s2 || s2 === s3 || s1 === s3) {
                win = currentBet * 2;
                message = `‚úÖ –î–≤–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ! +${win}‚ÇΩ`;
            }
            else {
                message = '‚ùå –ù–µ –ø–æ–≤–µ–∑–ª–æ...';
            }
            
            if (win > 0) {
                state.balance += win;
                state.stats.casinoWins = (state.stats.casinoWins || 0) + win;
                resultDiv.className = 'casino-result win';
                showToast(`üé∞ ${message}`, 3000);
                checkAchievements(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—á–∏–≤–∫–∏
            } else {
                resultDiv.className = 'casino-result lose';
            }
            
            resultDiv.textContent = message;
            updateUI();
            document.getElementById('casino-balance').textContent = Math.floor(state.balance) + ' ‚ÇΩ';
            saveGame();
        }
        
        // === –£–†–û–í–ù–ò –ò –û–ü–´–¢ ===
        function addXP(amount) {
            const multiplier = state.level >= 6 ? 2 : 1;
            state.experience += amount * multiplier;
            checkLevelUp();
            updateLevelUI();
        }
        
        function checkLevelUp() {
            const nextLevel = state.level + 1;
            if (LEVELS[nextLevel] && state.experience >= LEVELS[nextLevel].xpNeed) {
                state.level = nextLevel;
                showToast(`üéâ –£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω! –¢–µ–ø–µ—Ä—å —Ç—ã ${LEVELS[nextLevel].title}!`, 4000);
            }
        }
        
        function updateLevelUI() {
            const currentLevel = LEVELS[state.level];
            const nextLevel = LEVELS[state.level + 1];
            document.getElementById('level-badge').textContent = `Lv.${state.level} ${currentLevel.title}`;
            
            if (nextLevel) {
                const xpInLevel = state.experience - currentLevel.xpNeed;
                const xpNeeded = nextLevel.xpNeed - currentLevel.xpNeed;
                const percent = Math.min(100, (xpInLevel / xpNeeded) * 100);
                document.getElementById('xp-fill').style.width = percent + '%';
            } else {
                document.getElementById('xp-fill').style.width = '100%';
            }
        }
        
        function getDiscount() {
            if (state.level >= 6) return 0.25;
            if (state.level >= 5) return 0.20;
            if (state.level >= 4) return 0.15;
            if (state.level >= 3) return 0.10;
            if (state.level >= 2) return 0.05;
            return 0;
        }
        
        // === –ò–ù–í–ï–ù–¢–ê–†–¨ ===
        function openGearShop() {
            if (state.isDelivering) { showToast('‚ùå –í–æ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–µ–ª—å–∑—è!', 2000); return; }
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ –º–µ–Ω—é
            document.getElementById('food-menu').style.display = 'none';
            document.getElementById('shop-menu').style.display = 'none';
            hideMenu();
            
            const container = document.getElementById('gear-content');
            container.innerHTML = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã
            const activeItems = Object.entries(state.activeItems).filter(([_, v]) => v);
            if (activeItems.length > 0) {
                container.innerHTML += '<div style="font-size:12px;color:#888;margin-bottom:10px;">‚ú® –ê–∫—Ç–∏–≤–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã:</div>';
                activeItems.forEach(([id, _]) => {
                    const item = SHOP_GEAR.find(g => g.id === id);
                    if (item) {
                        container.innerHTML += `
                            <div class="shop-item" style="border-color:#00e676;">
                                <span>${item.icon} ${item.name} ‚Äî –∞–∫—Ç–∏–≤–Ω–æ</span>
                            </div>
                        `;
                    }
                });
                container.innerHTML += '<div style="margin:15px 0;border-top:1px solid rgba(255,255,255,0.1);"></div>';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –ø–æ–∫—É–ø–∫–∏
            container.innerHTML += '<div style="font-size:12px;color:#888;margin-bottom:10px;">üõí –î–æ—Å—Ç—É–ø–Ω–æ–µ:</div>';
            
            SHOP_GEAR.forEach(item => {
                const discount = getDiscount();
                const inflatedBase = getCurrentPrice(item.cost);
                const price = Math.floor(inflatedBase * (1 - discount));
                const owned = state.inventory.includes(item.id);
                
                const div = document.createElement('div');
                div.className = 'shop-item';
                div.style.opacity = owned ? '0.5' : '1';
                div.innerHTML = `
                    <div>
                        <div>${item.icon} ${item.name}</div>
                        <div style="font-size:11px;color:#888;">${item.desc}</div>
                    </div>
                    <span class="shop-item-price">${owned ? '‚úì' : price + '‚ÇΩ'}</span>
                `;
                if (!owned) {
                    div.onclick = () => buyGear({...item, cost: price});
                }
                container.appendChild(div);
            });
            
            if (state.level >= 2) {
                container.innerHTML += `
                    <div style="margin-top:10px;font-size:11px;color:#00e676;text-align:center;">
                        üíé –°–∫–∏–¥–∫–∞ ${(getDiscount() * 100).toFixed(0)}% –∑–∞ —É—Ä–æ–≤–µ–Ω—å ${state.level}
                    </div>
                `;
            }
            
            document.getElementById('gear-overlay').classList.add('active');
        }
        
        function buyGear(item) {
            // –¶–µ–Ω–∞ —É–∂–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ —Å —É—á—ë—Ç–æ–º –∏–Ω—Ñ–ª—è—Ü–∏–∏ –∏ —Å–∫–∏–¥–∫–∏
            const price = item.cost;
            
            if (state.balance < price) {
                showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!', 2000);
                return;
            }
            if (state.inventory.length >= 3) {
                showToast('‚ùå –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø–æ–ª–æ–Ω! (–º–∞–∫—Å 3 –ø—Ä–µ–¥–º–µ—Ç–∞)', 2000);
                return;
            }
            
            state.balance -= price;
            state.inventory.push(item.id);
            state.activeItems[item.id] = true;
            
            // –¢–∞–π–º–µ—Ä –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤
            if (item.duration > 0) {
                setTimeout(() => {
                    state.inventory = state.inventory.filter(id => id !== item.id);
                    state.activeItems[item.id] = false;
                    showToast(`‚è∞ ${item.name} –∑–∞–∫–æ–Ω—á–∏–ª—Å—è!`, 2000);
                    updateInventoryUI();
                }, item.duration * 1000);
            }
            
            updateUI();
            saveGame();
            openGearShop();
            showToast(`${item.icon} ${item.name} –∫—É–ø–ª–µ–Ω!`, 2000);
        }
        
        function updateInventoryUI() {
            for (let i = 0; i < 3; i++) {
                const slot = document.getElementById('inv-' + i);
                const itemId = state.inventory[i];
                if (itemId) {
                    const item = SHOP_GEAR.find(g => g.id === itemId);
                    slot.textContent = item ? item.icon : '';
                    slot.classList.toggle('active', state.activeItems[itemId]);
                } else {
                    slot.textContent = '';
                    slot.classList.remove('active');
                }
            }
        }
        
        function closeGearShop() {
            document.getElementById('gear-overlay').classList.remove('active');
            showMenu();
        }
        
        function updateUI() {
            document.getElementById('balance').textContent = Math.floor(state.balance) + ' ‚ÇΩ';
            ['energy', 'water', 'mood'].forEach(stat => {
                const val = Math.floor(state[stat]);
                document.getElementById(stat + '-val').textContent = val;
                document.getElementById(stat + '-bar').style.width = val + '%';
            });
        }
        
        function gameTick() {
            if (state.isDelivering && !state.gameActive) {
                // –≠—Ñ—Ñ–µ–∫—Ç—ã –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
                if (!state.activeItems.powerbank) state.energy -= 0.2;
                if (!state.activeItems.thermos) state.water -= 0.15;
                if (!state.activeItems.raincoat) state.mood -= 0.1;
                
                if (state.energy <= 0 || state.water <= 0) failDelivery('–†–µ—Å—É—Ä—Å—ã –∫–æ–Ω—á–∏–ª–∏—Å—å!');
                updateUI();
            }
        }
        
        function showToast(msg, duration = 2500) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), duration);
        }

        function openShopType(type) {
            if (state.isDelivering) { showToast('‚ùå –í–æ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–µ–ª—å–∑—è!', 2000); return; }
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ –º–µ–Ω—é –∏ –≤–µ—Ä—Ö–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
            document.getElementById('food-menu').style.display = 'none';
            document.getElementById('shop-menu').style.display = 'none';
            hideMenu();
            document.getElementById('shop-title').textContent = type === 'water' ? 'üíß –ù–∞–ø–∏—Ç–∫–∏' : '‚òï –≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∏';
            const container = document.getElementById('shop-items');
            container.innerHTML = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–ª—è—Ü–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
            if (economyState.inflationMultiplier > 1.1) {
                const inflationWarning = document.createElement('div');
                inflationWarning.style.cssText = 'font-size:11px;color:#ff3d00;margin-bottom:10px;text-align:center;';
                inflationWarning.innerHTML = `üìà –ò–Ω—Ñ–ª—è—Ü–∏—è: —Ü–µ–Ω—ã +${Math.round((economyState.inflationMultiplier - 1) * 100)}%`;
                container.appendChild(inflationWarning);
            }
            
            SHOP_ITEMS[type].forEach(item => {
                const div = document.createElement('div');
                div.className = 'shop-item';
                const inflatedCost = getCurrentPrice(item.cost);
                div.onclick = () => buyItem({...item, cost: inflatedCost});
                const effects = [];
                if (item.energy !== 0) effects.push(`‚ö°${item.energy > 0 ? '+' : ''}${item.energy}`);
                if (item.water !== 0) effects.push(`üíß${item.water > 0 ? '+' : ''}${item.water}`);
                if (item.mood !== 0) effects.push(`üòé${item.mood > 0 ? '+' : ''}${item.mood}`);
                div.innerHTML = `
                    <div>
                        <div>${item.icon} ${item.name}</div>
                        <div style="font-size:11px;color:#888;margin-top:2px;">${effects.join(' ')}</div>
                    </div>
                    <span class="shop-item-price">${inflatedCost}‚ÇΩ</span>
                `;
                container.appendChild(div);
            });
            document.getElementById('shop-overlay').classList.add('active');
        }
        
        function openShop() {
            if (state.isDelivering) { showToast('‚ùå –í–æ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–µ–ª—å–∑—è!', 2000); return; }
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ –º–µ–Ω—é
            document.getElementById('food-menu').style.display = 'none';
            document.getElementById('shop-menu').style.display = 'none';
            hideMenu();
            document.getElementById('shop-title').textContent = 'üõí –ú–∞–≥–∞–∑–∏–Ω';
            const container = document.getElementById('shop-items');
            container.innerHTML = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–ª—è—Ü–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
            if (economyState.inflationMultiplier > 1.1) {
                const inflationWarning = document.createElement('div');
                inflationWarning.style.cssText = 'font-size:11px;color:#ff3d00;margin-bottom:10px;text-align:center;';
                inflationWarning.innerHTML = `üìà –ò–Ω—Ñ–ª—è—Ü–∏—è: —Ü–µ–Ω—ã +${Math.round((economyState.inflationMultiplier - 1) * 100)}%`;
                container.appendChild(inflationWarning);
            }
            
            SHOP_ITEMS.all.forEach(item => {
                const div = document.createElement('div');
                div.className = 'shop-item';
                const inflatedCost = getCurrentPrice(item.cost);
                div.onclick = () => buyItem({...item, cost: inflatedCost});
                const effects = [];
                if (item.energy !== 0) effects.push(`‚ö°${item.energy > 0 ? '+' : ''}${item.energy}`);
                if (item.water !== 0) effects.push(`üíß${item.water > 0 ? '+' : ''}${item.water}`);
                if (item.mood !== 0) effects.push(`üòé${item.mood > 0 ? '+' : ''}${item.mood}`);
                div.innerHTML = `
                    <div>
                        <div>${item.icon} ${item.name}</div>
                        <div style="font-size:11px;color:#888;margin-top:2px;">${effects.join(' ')}</div>
                    </div>
                    <span class="shop-item-price">${inflatedCost}‚ÇΩ</span>
                `;
                container.appendChild(div);
            });
            document.getElementById('shop-overlay').classList.add('active');
        }
        
        function buyItem(item) {
            if (state.balance < item.cost) { showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!', 2000); return; }
            state.balance -= item.cost;
            state.energy = Math.min(100, Math.max(0, state.energy + item.energy));
            state.water = Math.min(100, Math.max(0, state.water + item.water));
            state.mood = Math.min(100, Math.max(0, state.mood + item.mood));
            updateUI(); saveGame(); closeShop();
            showToast(`${item.icon} –ì–æ—Ç–æ–≤–æ!`, 2000);
        }
        
        function closeShop() { 
            document.getElementById('shop-overlay').classList.remove('active'); 
            showMenu();
        }

        function showStats() {
            hideMenu();
            const container = document.getElementById('stats-content');
            container.innerHTML = `
                <div class="shop-item"><span>üì¶ –î–æ—Å—Ç–∞–≤–æ–∫</span><span class="shop-item-price">${state.stats.totalDeliveries}</span></div>
                <div class="shop-item"><span>üí∞ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</span><span class="shop-item-price">${state.stats.totalEarned}‚ÇΩ</span></div>
                <div class="shop-item"><span>üí• –ê–≤–∞—Ä–∏–π</span><span class="shop-item-price">${state.stats.accidents}</span></div>
                <div class="shop-item"><span>üéÅ –õ—É—á—à–∏–µ —á–∞–µ–≤—ã–µ</span><span class="shop-item-price">${state.stats.bestTip}‚ÇΩ</span></div>
                <div class="shop-item"><span>üé∞ –í—ã–∏–≥—Ä–∞–Ω–æ –≤ –∫–∞–∑–∏–Ω–æ</span><span class="shop-item-price">${state.stats.casinoWins || 0}‚ÇΩ</span></div>
                <div class="shop-item"><span>üåßÔ∏è –î–æ—Å—Ç–∞–≤–æ–∫ –≤ –¥–æ–∂–¥—å</span><span class="shop-item-price">${state.stats.rainDeliveries || 0}</span></div>
            `;
            document.getElementById('stats-overlay').classList.add('active');
        }
        
        function closeStats() { 
            document.getElementById('stats-overlay').classList.remove('active'); 
            showMenu();
        }

        function findOrder() {
            if (state.energy < 20 || state.water < 20) { showToast('‚ö†Ô∏è –ú–∞–ª–æ —Ä–µ—Å—É—Ä—Å–æ–≤!', 3000); return; }
            
            const rest = RESTAURANTS[Math.floor(Math.random() * RESTAURANTS.length)];
            const dist = (1.5 + Math.random() * 4).toFixed(1);
            const rawBasePrice = Math.floor(15 + parseFloat(dist) * 8);
            
            // –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ê–Ø –¶–ï–ù–ê: —É—á–∏—Ç—ã–≤–∞–µ–º –∏–Ω—Ñ–ª—è—Ü–∏—é, –ø–æ–≥–æ–¥—É, –≤—Ä–µ–º—è
            const basePrice = getCurrentPrice(rawBasePrice);
            
            // GPS —ç—Ñ—Ñ–µ–∫—Ç: –º–∞—Ä—à—Ä—É—Ç—ã –Ω–∞ 20% –∫–æ—Ä–æ—á–µ
            const gpsMultiplier = state.activeItems.gps ? 0.8 : 1;
            
            // –ù–æ—á–Ω–æ–π —à—Ç—Ä–∞—Ñ –∫ —ç–Ω–µ—Ä–≥–∏–∏
            const nightEnergyPenalty = economyState.isNight ? ECONOMY.nightPenalty : 0;
            
            const routes = [
                { id: 'fast', name: 'üèéÔ∏è –ö–æ—Ä–æ—Ç–∫–∏–π', tag: 'tag-fast', tagText: '–ë—ã—Å—Ç—Ä–æ', time: Math.floor(dist * 2 * gpsMultiplier), risk: 40, energyCost: Math.floor(20 * (1 + nightEnergyPenalty)), waterCost: 15, price: basePrice + 5, pitstops: 0, desc: `${dist} –∫–º ‚Ä¢ –†–∏—Å–∫: –≤—ã—Å–æ–∫–∏–π` },
                { id: 'safe', name: 'üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π', tag: 'tag-safe', tagText: '–ù–∞–¥—ë–∂–Ω–æ', time: Math.floor(dist * 4 * gpsMultiplier), risk: 10, energyCost: Math.floor(12 * (1 + nightEnergyPenalty)), waterCost: 10, price: basePrice, pitstops: 1, desc: `${dist} –∫–º ‚Ä¢ 1 –ø–∏—Ç-—Å—Ç–æ–ø` },
                { id: 'profit', name: 'üí∞ –ü—Ä–∏–±—ã–ª—å–Ω—ã–π', tag: 'tag-profit', tagText: '–î–æ—Ö–æ–¥', time: Math.floor(dist * 5 * gpsMultiplier), risk: 25, energyCost: Math.floor(30 * (1 + nightEnergyPenalty)), waterCost: 20, price: Math.floor(basePrice * 1.4), pitstops: 2, desc: `${dist} –∫–º ‚Ä¢ 2 –ø–∏—Ç-—Å—Ç–æ–ø–∞` }
            ];
            
            state.currentOrder = { restaurant: rest, distance: parseFloat(dist), basePrice: basePrice, routes: routes, destLat: WARSAW_CENTER[0] + (Math.random() - 0.5) * 0.06, destLng: WARSAW_CENTER[1] + (Math.random() - 0.5) * 0.08 };
            
            const container = document.getElementById('route-options');
            container.innerHTML = '';
            routes.forEach((route, idx) => {
                const div = document.createElement('div');
                div.className = 'route-option';
                div.onclick = () => selectRoute(idx);
                div.innerHTML = `
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">${route.name}<span class="route-tag ${route.tag}">${route.tagText}</span></div>
                    <div style="font-size:12px;color:#888;display:flex;gap:12px;flex-wrap:wrap;">
                        <span>‚è±Ô∏è ${route.time} –º–∏–Ω</span><span>‚ö° -${route.energyCost}</span><span>üíß -${route.waterCost}</span><span class="route-price">${route.price}‚ÇΩ</span>
                    </div>
                    <div style="margin-top:6px;font-size:11px;color:#666;">${route.desc}</div>
                `;
                container.appendChild(div);
            });
            
            document.getElementById('route-panel').classList.add('active');
        }
        
        function selectRoute(idx) {
            state.currentRoute = state.currentOrder.routes[idx];
            const types = Object.keys(PITSTOPS);
            state.currentRoute.pitstopData = [];
            for (let i = 0; i < state.currentRoute.pitstops; i++) {
                const type = types[Math.floor(Math.random() * types.length)];
                state.currentRoute.pitstopData.push({ type: type, ...PITSTOPS[type], progress: Math.floor(((i + 1) / (state.currentRoute.pitstops + 1)) * 100) });
            }
            document.getElementById('route-panel').classList.remove('active');
            startDelivery();
        }
        
        function startDelivery() {
            state.isDelivering = true; state.progress = 0; state.currentStop = 0; state.gameHits = 0;
            state.energy -= state.currentRoute.energyCost * 0.3;
            state.water -= state.currentRoute.waterCost * 0.3;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –¥–æ—Å—Ç–∞–≤–∫–µ
            hideAllMenu();
            
            const dest = [state.currentOrder.destLat, state.currentOrder.destLng];
            
            destMarker = L.marker(dest, { icon: L.divIcon({ html: '<div class="marker-dest"></div>', className: 'custom-marker', iconSize: [26, 26] }) }).addTo(map);
            
            state.currentRoute.pitstopData.forEach((stop, idx) => {
                const lat = WARSAW_CENTER[0] + (dest[0] - WARSAW_CENTER[0]) * (stop.progress / 100);
                const lng = WARSAW_CENTER[1] + (dest[1] - WARSAW_CENTER[1]) * (stop.progress / 100);
                const marker = L.marker([lat, lng], { icon: L.divIcon({ html: `<div class="marker-pitstop">${stop.icon}</div>`, className: 'custom-marker', iconSize: [24, 24] }) }).addTo(map);
                pitstopMarkers.push(marker);
            });
            
            routeLine = L.polyline([WARSAW_CENTER, dest], { color: '#00e676', weight: 4, opacity: 0.6, dashArray: '8, 8' }).addTo(map);
            map.fitBounds([WARSAW_CENTER, dest], { padding: [60, 60] });
            
            document.getElementById('delivery-title').innerHTML = `${state.currentOrder.restaurant.icon} –î–æ—Å—Ç–∞–≤–∫–∞`;
            document.getElementById('delivery-panel').classList.add('active');
            document.getElementById('drive-btn').style.display = 'block';
            updateProgress(); updateUI();
            showToast('–ù–∞–∂–º–∏ –ï–•–ê–¢–¨ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!', 3000);
        }
        
        function updateProgress() { document.getElementById('progress-fill').style.width = state.progress + '%'; }

        function startDriving() {
            document.getElementById('drive-btn').style.display = 'none';
            document.getElementById('delivery-status').textContent = '–ï–¥–µ–º...';
            autoDrive();
        }
        
        function autoDrive() {
            const nextStop = state.currentRoute.pitstopData[state.currentStop];
            if (nextStop && state.progress >= nextStop.progress) { showPitstop(nextStop); return; }
            if (state.progress >= 100) { finishDelivery(); return; }
            
            const rand = Math.random();
            if (rand < 0.3) { startMiniGame(); }
            else if (rand < 0.3 + (state.currentRoute.risk / 100)) { triggerEvent(); }
            else {
                state.progress += 15; state.energy -= 3; state.water -= 2;
                updateProgress(); updateUI();
                setTimeout(autoDrive, 1000);
            }
        }
        
        function startMiniGame() {
            state.gameActive = true; state.bikeLane = 1; state.gameHits = 0;
            document.getElementById('game-overlay').classList.add('active');
            document.getElementById('delivery-status').textContent = '–û–ø–∞—Å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫!';
            updateBikePosition();
            
            let spawnCount = 0;
            obstacleInterval = setInterval(() => {
                spawnObstacle();
                spawnCount++;
                if (spawnCount >= 5) { clearInterval(obstacleInterval); setTimeout(endMiniGame, 2500); }
            }, 800);
        }
        
        function updateBikePosition() { document.getElementById('player').style.top = (state.bikeLane * 33.33 + 16.66) + '%'; }
        
        function moveBike(dir) {
            if (!state.gameActive) return;
            state.bikeLane += dir;
            if (state.bikeLane < 0) state.bikeLane = 0;
            if (state.bikeLane > 2) state.bikeLane = 2;
            updateBikePosition();
        }
        
        function spawnObstacle() {
            const road = document.getElementById('game-road');
            const obstacle = document.createElement('div');
            obstacle.className = 'obstacle';
            obstacle.textContent = ['üöó', 'üöß', 'üï≥Ô∏è', 'üêï'][Math.floor(Math.random() * 4)];
            const lane = Math.floor(Math.random() * 3);
            obstacle.style.top = (lane * 33.33 + 8) + '%';
            obstacle.dataset.lane = lane;
            road.appendChild(obstacle);
            
            setTimeout(() => {
                if (!state.gameActive) return;
                const bike = document.getElementById('player');
                const bikeRect = bike.getBoundingClientRect();
                const obsRect = obstacle.getBoundingClientRect();
                if (parseInt(obstacle.dataset.lane) === state.bikeLane && Math.abs(bikeRect.left - obsRect.left) < 60) {
                    state.gameHits++; showToast('üí• –£–¥–∞—Ä!', 1000);
                }
                setTimeout(() => obstacle.remove(), 2000);
            }, 1800);
        }
        
        function endMiniGame() {
            state.gameActive = false;
            document.getElementById('game-overlay').classList.remove('active');
            document.querySelectorAll('.obstacle').forEach(o => o.remove());
            
            if (state.gameHits === 0) { showToast('üåü –ò–¥–µ–∞–ª—å–Ω–æ! –ë–æ–Ω—É—Å: +5‚ÇΩ', 2000); state.currentOrder.bonus = (state.currentOrder.bonus || 0) + 5; state.progress += 10; }
            else if (state.gameHits === 1) { showToast('‚úÖ –ù–µ–ø–ª–æ—Ö–æ', 1500); state.progress += 5; }
            else { showToast(`üí• ${state.gameHits} –∞–≤–∞—Ä–∏–π! -10 —ç–Ω–µ—Ä–≥–∏–∏`, 2000); state.energy -= 10; state.mood -= 10; state.accidents++; }
            
            updateProgress(); updateUI();
            setTimeout(autoDrive, 2000);
        }
        
        function showPitstop(stop) {
            document.getElementById('pitstop-title').innerHTML = `${stop.icon} ${stop.name}`;
            const container = document.getElementById('pitstop-items');
            container.innerHTML = '';
            stop.items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'pitstop-item';
                div.onclick = () => buyPitstopItem(item);
                div.innerHTML = `<div class="pitstop-item-header"><span>${item.icon}</span><span>${item.name}</span><span class="pitstop-item-price">${item.cost}‚ÇΩ</span></div>`;
                container.appendChild(div);
            });
            document.getElementById('pitstop-overlay').classList.add('active');
        }
        
        function buyPitstopItem(item) {
            if (state.balance < item.cost) { showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!', 2000); return; }
            state.balance -= item.cost;
            state.energy = Math.min(100, Math.max(0, state.energy + item.energy));
            state.water = Math.min(100, Math.max(0, state.water + item.water));
            state.mood = Math.min(100, Math.max(0, state.mood + item.mood));
            updateUI(); saveGame(); skipPitstop();
            showToast(`${item.icon} –ö—É–ø–ª–µ–Ω–æ!`, 2000);
        }
        
        function skipPitstop() { document.getElementById('pitstop-overlay').classList.remove('active'); state.currentStop++; setTimeout(autoDrive, 1000); }

        function triggerEvent() {
            const event = ROAD_EVENTS[Math.floor(Math.random() * ROAD_EVENTS.length)];
            document.getElementById('event-icon').textContent = event.icon;
            document.getElementById('event-title').textContent = event.title;
            document.getElementById('event-text').textContent = event.text;
            
            const container = document.getElementById('event-choices');
            container.innerHTML = '';
            event.choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-primary';
                btn.textContent = choice.text;
                btn.onclick = () => handleEventChoice(choice.effect);
                container.appendChild(btn);
            });
            document.getElementById('event-overlay').classList.add('active');
        }
        
        function handleEventChoice(effect) {
            document.getElementById('event-overlay').classList.remove('active');
            if (effect.money) { state.balance += effect.money; showToast(effect.money > 0 ? `+${effect.money}‚ÇΩ` : `${effect.money}‚ÇΩ`, 2000); }
            if (effect.mood) state.mood = Math.max(0, state.mood + effect.mood);
            updateUI(); saveGame();
            setTimeout(autoDrive, 1500);
        }

        function finishDelivery() {
            state.isDelivering = false;
            const bonus = state.currentOrder.bonus || 0;
            let total = state.currentRoute.price + bonus;
            
            // –•–ò–¢–†–ê–Ø –°–ò–°–¢–ï–ú–ê: –ö–æ–ª–ª–µ–∫—Ç–æ—Ä—ã –∑–∞–±–∏—Ä–∞—é—Ç –ø—Ä–æ—Ü–µ–Ω—Ç –µ—Å–ª–∏ –¥–æ–ª–≥ –±–æ–ª—å—à–æ–π
            loadBank();
            const originalTotal = total;
            total = applyCollectorFee(total);
            
            state.balance += total;
            state.stats.totalDeliveries++;
            state.stats.totalEarned += total;
            if (bonus > state.stats.bestTip) state.stats.bestTip = bonus;
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –∞—á–∏–≤–æ–∫
            if (economyState.isRain) {
                state.stats.rainDeliveries = (state.stats.rainDeliveries || 0) + 1;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º XP (10 –±–∞–∑–æ–≤—ã–π + 1 –∑–∞ –∫–∞–∂–¥—ã–µ 10‚ÇΩ)
            const xpGain = 10 + Math.floor(total / 10);
            addXP(xpGain);
            
            // –ò–ù–§–õ–Ø–¶–ò–Ø: —Ü–µ–Ω—ã —Ä–∞—Å—Ç—É—Ç —Å –∫–∞–∂–¥–æ–π –¥–æ—Å—Ç–∞–≤–∫–æ–π
            applyInflation();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—á–∏–≤–∫–∏
            checkAchievements();
            
            // –®–∞–Ω—Å –∫—Ä–∏–∑–∏—Å–∞
            triggerCrisis();
            
            document.getElementById('delivery-panel').classList.remove('active');
            if (destMarker) map.removeLayer(destMarker);
            pitstopMarkers.forEach(m => map.removeLayer(m));
            pitstopMarkers = [];
            if (routeLine) map.removeLayer(routeLine);
            map.setView(WARSAW_CENTER, 13);
            
            updateUI(); saveGame(); saveEconomy();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –æ–±—Ä–∞—Ç–Ω–æ
            showMenu();
            
            if (originalTotal !== total) {
                showToast(`‚úÖ –î–æ—Å—Ç–∞–≤–∫–∞: +${total}‚ÇΩ (–±—ã–ª–æ ${originalTotal}‚ÇΩ)`, 3000);
            } else {
                showToast(`‚úÖ –î–æ—Å—Ç–∞–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! +${total}‚ÇΩ`, 3000);
            }
        }
        
        function failDelivery(reason) {
            state.isDelivering = false;
            document.getElementById('delivery-panel').classList.remove('active');
            if (destMarker) map.removeLayer(destMarker);
            pitstopMarkers.forEach(m => map.removeLayer(m));
            pitstopMarkers = [];
            if (routeLine) map.removeLayer(routeLine);
            map.setView(WARSAW_CENTER, 13);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –æ–±—Ä–∞—Ç–Ω–æ
            showMenu();
            
            showToast('‚ùå ' + reason, 3000);
        }
        
        function cancelDelivery() {
            state.isDelivering = false;
            document.getElementById('delivery-panel').classList.remove('active');
            if (destMarker) map.removeLayer(destMarker);
            pitstopMarkers.forEach(m => map.removeLayer(m));
            pitstopMarkers = [];
            if (routeLine) map.removeLayer(routeLine);
            map.setView(WARSAW_CENTER, 13);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –æ–±—Ä–∞—Ç–Ω–æ
            showMenu();
            
            showToast('–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω—ë–Ω', 2000);
        }

        // ==================== –ë–ê–ù–ö ====================
        const BANK_CONFIG = {
            depositRate: 0.05,      // 5% –≤ —á–∞—Å –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç
            loanRates: {
                small: 0.10,        // 10% –Ω–∞ –º–∞–ª—ã–π –∫—Ä–µ–¥–∏—Ç
                medium: 0.15,       // 15% –Ω–∞ —Å—Ä–µ–¥–Ω–∏–π
                large: 0.25         // 25% –Ω–∞ –±–æ–ª—å—à–æ–π (–æ–ø–∞—Å–Ω—ã–π!)
            },
            collectorThreshold: 50,  // –ü–æ—Å–ª–µ 50‚ÇΩ –¥–æ–ª–≥–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç –∫–æ–ª–ª–µ–∫—Ç–æ—Ä—ã
            collectorCut: 0.30       // 30% –æ—Ç –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞ –∑–∞–±–∏—Ä–∞—é—Ç –∫–æ–ª–ª–µ–∫—Ç–æ—Ä—ã
        };
        
        let bankState = {
            deposit: 0,              // –î–µ–Ω—å–≥–∏ –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç–µ
            loan: 0,                 // –¢–µ–∫—É—â–∏–π –¥–æ–ª–≥
            loanRate: 0,             // –ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ –∫—Ä–µ–¥–∏—Ç—É
            creditRating: 100,       // –ö—Ä–µ–¥–∏—Ç–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ (0-100)
            totalPaid: 0,            // –í—Å–µ–≥–æ –≤—ã–ø–ª–∞—á–µ–Ω–æ
            missedPayments: 0,       // –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
            lastInterestTime: Date.now()
        };
        
        function loadBank() {
            const saved = localStorage.getItem('warsaw_courier_bank');
            if (saved) {
                const data = JSON.parse(saved);
                bankState = { ...bankState, ...data };
            }
        }
        
        function saveBank() {
            localStorage.setItem('warsaw_courier_bank', JSON.stringify(bankState));
        }
        
        function bankInterestTick() {
            const now = Date.now();
            const hoursPassed = (now - bankState.lastInterestTime) / (1000 * 60 * 60);
            
            if (hoursPassed >= 1) {
                // –ù–∞—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç
                if (bankState.deposit > 0) {
                    const interest = Math.floor(bankState.deposit * BANK_CONFIG.depositRate * hoursPassed);
                    bankState.deposit += interest;
                }
                
                // –ù–∞—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã –ø–æ –∫—Ä–µ–¥–∏—Ç—É
                if (bankState.loan > 0) {
                    const interest = Math.floor(bankState.loan * bankState.loanRate * hoursPassed);
                    bankState.loan += interest;
                    
                    // –ü–æ–Ω–∏–∂–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –∑–∞ –¥–æ–ª–≥
                    if (bankState.loan > 20) {
                        bankState.creditRating = Math.max(0, bankState.creditRating - 1);
                    }
                }
                
                bankState.lastInterestTime = now;
                saveBank();
            }
        }
        
        function openBank() {
            hideMenu();
            loadBank();
            bankInterestTick();
            renderBank();
            document.getElementById('bank-overlay').classList.add('active');
        }
        
        function closeBank() {
            document.getElementById('bank-overlay').classList.remove('active');
            showMenu();
        }
        
        function renderBank() {
            const container = document.getElementById('bank-content');
            const hasDebt = bankState.loan > 0;
            const hasCollectors = bankState.loan >= BANK_CONFIG.collectorThreshold;
            
            let ratingClass = 'good';
            if (bankState.creditRating < 60) ratingClass = 'medium';
            if (bankState.creditRating < 30) ratingClass = 'bad';
            
            container.innerHTML = `
                <div class="credit-warning ${hasCollectors ? 'active' : ''}">
                    ‚ö†Ô∏è <b>–í–ù–ò–ú–ê–ù–ò–ï!</b> –ö–æ–ª–ª–µ–∫—Ç–æ—Ä—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã!<br>
                    ${BANK_CONFIG.collectorCut * 100}% –æ—Ç –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞ —É—Ö–æ–¥–∏—Ç –Ω–∞ –ø–æ–≥–∞—à–µ–Ω–∏–µ –¥–æ–ª–≥–∞!
                </div>
                
                <div class="bank-section">
                    <div class="bank-section-title">üí∞ –í–∞—à —Å—á—ë—Ç</div>
                    <div class="bank-balance-box">
                        <div class="bank-balance-label">–î–µ–ø–æ–∑–∏—Ç</div>
                        <div class="bank-balance-amount">${Math.floor(bankState.deposit)} ‚ÇΩ</div>
                    </div>
                    <div class="bank-input-group">
                        <input type="number" class="bank-input" id="deposit-amount" placeholder="–°—É–º–º–∞" min="1">
                        <button class="bank-btn gold" onclick="deposit()">–ü–æ–ª–æ–∂–∏—Ç—å</button>
                    </div>
                    <div class="bank-input-group">
                        <input type="number" class="bank-input" id="withdraw-amount" placeholder="–°—É–º–º–∞" min="1">
                        <button class="bank-btn" style="background:rgba(255,255,255,0.1);color:#fff;" onclick="withdraw()">–°–Ω—è—Ç—å</button>
                    </div>
                    <div style="font-size:11px;color:#888;margin-top:6px;">
                        üí° –î–µ–ø–æ–∑–∏—Ç: +${BANK_CONFIG.depositRate * 100}% –≤ —á–∞—Å
                    </div>
                </div>
                
                ${hasDebt ? `
                <div class="bank-section">
                    <div class="bank-section-title">üìã –ö—Ä–µ–¥–∏—Ç</div>
                    <div class="credit-info">
                        <div class="credit-info-row">
                            <span>–î–æ–ª–≥:</span>
                            <span style="color:#ff3d00;font-weight:700;">${Math.floor(bankState.loan)} ‚ÇΩ</span>
                        </div>
                        <div class="credit-info-row">
                            <span>–°—Ç–∞–≤–∫–∞:</span>
                            <span>${(bankState.loanRate * 100).toFixed(0)}%</span>
                        </div>
                        <div class="credit-info-row">
                            <span>–†–µ–π—Ç–∏–Ω–≥:</span>
                            <span class="${bankState.creditRating < 50 ? 'credit-status-bad' : 'credit-status-good'}">${bankState.creditRating}/100</span>
                        </div>
                        <div class="rating-bar">
                            <div class="rating-fill ${ratingClass}" style="width:${bankState.creditRating}%"></div>
                        </div>
                    </div>
                    <div class="bank-input-group" style="margin-top:10px;">
                        <input type="number" class="bank-input" id="repay-amount" placeholder="–°—É–º–º–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è" min="1">
                        <button class="bank-btn red" onclick="repayLoan()">–ü–æ–≥–∞—Å–∏—Ç—å</button>
                    </div>
                </div>
                ` : ''}
                
                <div class="bank-section">
                    <div class="bank-section-title">üìú –í–∑—è—Ç—å –∫—Ä–µ–¥–∏—Ç</div>
                    ${bankState.loan > 0 ? '<div style="font-size:12px;color:#ff3d00;margin-bottom:10px;">‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–≥–∞—Å–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –¥–æ–ª–≥!</div>' : ''}
                    
                    <div class="loan-option" onclick="takeLoan(50, 'small')" style="${bankState.loan > 0 || bankState.creditRating < 30 ? 'opacity:0.5;pointer-events:none;' : ''}">
                        <div class="loan-option-header">
                            <span class="loan-amount">50 ‚ÇΩ</span>
                            <span class="loan-rate">${BANK_CONFIG.loanRates.small * 100}% / —á–∞—Å</span>
                        </div>
                        <div class="loan-payment">–õ—ë–≥–∫–∏–π —Å—Ç–∞—Ä—Ç –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤</div>
                    </div>
                    
                    <div class="loan-option" onclick="takeLoan(150, 'medium')" style="${bankState.loan > 0 || bankState.creditRating < 50 ? 'opacity:0.5;pointer-events:none;' : ''}">
                        <div class="loan-option-header">
                            <span class="loan-amount">150 ‚ÇΩ</span>
                            <span class="loan-rate">${BANK_CONFIG.loanRates.medium * 100}% / —á–∞—Å</span>
                        </div>
                        <div class="loan-payment">–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–π—Ç–∏–Ω–≥ 50+</div>
                    </div>
                    
                    <div class="loan-option" onclick="takeLoan(300, 'large')" style="${bankState.loan > 0 || bankState.creditRating < 70 ? 'opacity:0.5;pointer-events:none;' : ''}">
                        <div class="loan-option-header">
                            <span class="loan-amount">300 ‚ÇΩ</span>
                            <span class="loan-rate" style="color:#ff3d00;">${BANK_CONFIG.loanRates.large * 100}% / —á–∞—Å ‚ö†Ô∏è</span>
                        </div>
                        <div class="loan-payment">–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–π—Ç–∏–Ω–≥ 70+. –û–ø–∞—Å–Ω–æ!</div>
                    </div>
                </div>
                
                <div style="font-size:11px;color:#666;margin-top:10px;text-align:center;">
                    üíÄ –ü—Ä–∏ –¥–æ–ª–≥–µ ${BANK_CONFIG.collectorThreshold}‚ÇΩ+ –∫–æ–ª–ª–µ–∫—Ç–æ—Ä—ã –∑–∞–±–∏—Ä–∞—é—Ç ${BANK_CONFIG.collectorCut * 100}% —Å –∑–∞–∫–∞–∑–æ–≤
                </div>
            `;
        }
        
        function deposit() {
            const amount = parseInt(document.getElementById('deposit-amount').value);
            if (!amount || amount <= 0) { showToast('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É!', 2000); return; }
            if (state.balance < amount) { showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!', 2000); return; }
            
            state.balance -= amount;
            bankState.deposit += amount;
            saveBank();
            updateUI();
            renderBank();
            showToast(`üí∞ –ü–æ–ª–æ–∂–µ–Ω–æ ${amount}‚ÇΩ –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç!`, 2000);
        }
        
        function withdraw() {
            const amount = parseInt(document.getElementById('withdraw-amount').value);
            if (!amount || amount <= 0) { showToast('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É!', 2000); return; }
            if (bankState.deposit < amount) { showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç–µ!', 2000); return; }
            
            bankState.deposit -= amount;
            state.balance += amount;
            saveBank();
            updateUI();
            renderBank();
            showToast(`üíµ –°–Ω—è—Ç–æ ${amount}‚ÇΩ!`, 2000);
        }
        
        function takeLoan(amount, type) {
            if (bankState.loan > 0) { showToast('‚ùå –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∫—Ä–µ–¥–∏—Ç!', 2000); return; }
            
            const minRating = type === 'small' ? 30 : type === 'medium' ? 50 : 70;
            if (bankState.creditRating < minRating) { showToast('‚ùå –ù–∏–∑–∫–∏–π –∫—Ä–µ–¥–∏—Ç–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥!', 2000); return; }
            
            bankState.loan = amount;
            bankState.loanRate = BANK_CONFIG.loanRates[type];
            state.balance += amount;
            bankState.lastInterestTime = Date.now();
            
            saveBank();
            updateUI();
            renderBank();
            showToast(`üè¶ –ö—Ä–µ–¥–∏—Ç ${amount}‚ÇΩ –ø–æ–ª—É—á–µ–Ω! –°—Ç–∞–≤–∫–∞: ${(bankState.loanRate * 100).toFixed(0)}%`, 3000);
        }
        
        function repayLoan() {
            const amount = parseInt(document.getElementById('repay-amount').value);
            if (!amount || amount <= 0) { showToast('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É!', 2000); return; }
            if (state.balance < amount) { showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!', 2000); return; }
            
            const actualRepay = Math.min(amount, bankState.loan);
            state.balance -= actualRepay;
            bankState.loan -= actualRepay;
            bankState.totalPaid += actualRepay;
            
            // –ü–æ–≤—ã—à–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –∑–∞ –ø–æ–≥–∞—à–µ–Ω–∏–µ
            if (actualRepay >= bankState.loan * 0.5) {
                bankState.creditRating = Math.min(100, bankState.creditRating + 5);
            }
            
            if (bankState.loan <= 0) {
                bankState.loan = 0;
                bankState.loanRate = 0;
                bankState.missedPayments = 0;
                showToast('üéâ –ö—Ä–µ–¥–∏—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≥–∞—à–µ–Ω! –†–µ–π—Ç–∏–Ω–≥ +5', 3000);
            } else {
                showToast(`‚úÖ –ü–æ–≥–∞—à–µ–Ω–æ ${actualRepay}‚ÇΩ`, 2000);
            }
            
            saveBank();
            updateUI();
            renderBank();
        }
        
        // –•–∏—Ç—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞: –∫–æ–ª–ª–µ–∫—Ç–æ—Ä—ã –æ—Ç–Ω–∏–º–∞—é—Ç % –æ—Ç –∑–∞–∫–∞–∑–æ–≤
        function applyCollectorFee(amount) {
            if (bankState.loan >= BANK_CONFIG.collectorThreshold) {
                const fee = Math.floor(amount * BANK_CONFIG.collectorCut);
                bankState.loan -= fee;
                bankState.totalPaid += fee;
                
                if (bankState.loan <= 0) {
                    bankState.loan = 0;
                    bankState.loanRate = 0;
                    showToast('üéâ –ö–æ–ª–ª–µ–∫—Ç–æ—Ä—ã –ø–æ–≥–∞—Å–∏–ª–∏ –≤–∞—à –¥–æ–ª–≥!', 3000);
                } else {
                    showToast(`üíÄ –ö–æ–ª–ª–µ–∫—Ç–æ—Ä—ã –∑–∞–±—Ä–∞–ª–∏ ${fee}‚ÇΩ (${BANK_CONFIG.collectorCut * 100}%)`, 2500);
                }
                saveBank();
                return amount - fee;
            }
            return amount;
        }

        window.onload = init;
    </script>
</body>
</html>
