<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Warszawa Courier</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Styles -->
  <link rel="stylesheet" href="css/main.css" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>
  <!-- MAP -->
  <div id="map"></div>

  <!-- HUD -->
  <div class="hud">
    <div class="balance">
      <span>–ë–∞–ª–∞–Ω—Å</span>
      <b><span id="money">0</span> PLN</b>
    </div>
  </div>

  <!-- ORDER SLIDE PANEL -->
  <div class="order-panel" id="orderPanel">
    <div class="grabber"></div>

    <div class="order-info">
      <div>üì¶ –î–æ—Å—Ç–∞–≤–∫–∞</div>
      <div class="price">+ <span id="orderPrice">18</span> PLN</div>
    </div>

    <button id="acceptOrder" class="accept-btn">
      –ü—Ä–∏–Ω—è—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É
    </button>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    import { state } from "./state.js";
    import { saveState, loadState } from "./save.js";

    /* ---------- MAP ---------- */
    const map = L.map("map", { zoomControl: false }).setView(
      [52.2297, 21.0122],
      14
    );

    L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
      { attribution: "&copy; OpenStreetMap" }
    ).addTo(map);

    let courierPos = [52.2297, 21.0122];

    const courier = L.circleMarker(courierPos, {
      radius: 8,
      color: "#2a7cff",
      fillColor: "#2a7cff",
      fillOpacity: 1,
    }).addTo(map);

    function moveTo(targetPos) {
      const timer = setInterval(() => {
        courierPos[0] += (targetPos[0] - courierPos[0]) * 0.08;
        courierPos[1] += (targetPos[1] - courierPos[1]) * 0.08;
        courier.setLatLng(courierPos);

        if (
          Math.hypot(
            targetPos[0] - courierPos[0],
            targetPos[1] - courierPos[1]
          ) < 0.0003
        ) {
          clearInterval(timer);
        }
      }, 50);
    }

    /* ---------- HUD ---------- */
    const moneyEl = document.getElementById("money");

    function render() {
      moneyEl.textContent = state.money;
    }

    /* ---------- ORDER PANEL ---------- */
    const orderPanel = document.getElementById("orderPanel");
    const acceptOrder = document.getElementById("acceptOrder");
    const orderPriceEl = document.getElementById("orderPrice");

    let currentOrderPrice = 0;

    function spawnOrder() {
      currentOrderPrice = Math.floor(12 + Math.random() * 20);
      orderPriceEl.textContent = currentOrderPrice;
      orderPanel.classList.add("show");

      const dx = (Math.random() - 0.5) * 0.02;
      const dy = (Math.random() - 0.5) * 0.02;
      return [courierPos[0] + dx, courierPos[1] + dy];
    }

    acceptOrder.onclick = () => {
      orderPanel.classList.remove("show");

      state.money += currentOrderPrice;
      state.energy -= 10;
      state.stress += 5;

      saveState(state);
      render();

      const target = spawnOrder();
      moveTo(target);
    };

    /* ---------- INIT ---------- */
    await loadState(state);
    render();

    // –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    spawnOrder();
  </script>
</body>
</html>
