<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warszawa Admin Center üöÅ</title>
    <style>
        :root { --bg: #0f0f13; --card: #1e1e24; --accent: #007aff; --green: #34c759; --danger: #ff3b30; --text: #eee; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, monospace; margin: 0; padding: 20px; }
        
        .stats-bar { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #333; flex: 1; text-align: center; }
        .stat-val { font-size: 24px; font-weight: bold; display: block; margin-bottom: 5px; }
        .stat-label { color: #888; font-size: 12px; text-transform: uppercase; }
        .online-dot { height: 10px; width: 10px; background: var(--green); border-radius: 50%; display: inline-block; box-shadow: 0 0 10px var(--green); }

        .table-container { overflow-x: auto; background: var(--card); border-radius: 12px; border: 1px solid #333; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #333; }
        th { background: rgba(0,0,0,0.3); color: #aaa; font-size: 12px; text-transform: uppercase; }
        tr:hover { background: rgba(255,255,255,0.02); }
        
        .user-name { font-weight: bold; color: #fff; }
        .user-nick { color: #aaa; font-size: 11px; }
        .status-badge { padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: bold; }
        .status-on { background: rgba(52, 199, 89, 0.2); color: var(--green); border: 1px solid var(--green); }
        .status-off { background: rgba(255, 255, 255, 0.1); color: #777; }
        .btn-edit { background: var(--accent); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .btn-edit:hover { opacity: 0.8; }

        #editor-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 100; align-items: center; justify-content: center; }
        .editor-content { background: #222; padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; border: 1px solid #444; position: relative; }
        input { background: #111; border: 1px solid #444; color: white; padding: 10px; width: 100%; margin: 5px 0 15px 0; border-radius: 6px; box-sizing: border-box; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #777; }
        
        .danger-zone { margin-top: 25px; padding-top: 20px; border-top: 1px solid #444; text-align: center; }
        .btn-reset { background: rgba(255, 59, 48, 0.15); color: var(--danger); border: 1px solid var(--danger); width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-reset:hover { background: var(--danger); color: white; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

    <h2 style="margin-top:0">üõ∞Ô∏è Warszawa Control Center</h2>

    <div class="stats-bar">
        <div class="stat-card">
            <span class="stat-val" style="color:var(--green)" id="online-count">0</span>
            <span class="stat-label"><span class="online-dot"></span> –ò–≥—Ä–æ–∫–æ–≤ –û–Ω–ª–∞–π–Ω</span>
        </div>
        <div class="stat-card">
            <span class="stat-val" id="total-count">0</span>
            <span class="stat-label">–í—Å–µ–≥–æ –≤ –±–∞–∑–µ</span>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>–ò–≥—Ä–æ–∫</th>
                    <th>–ë–∞–ª–∞–Ω—Å</th>
                    <th>LVL</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th>
                </tr>
            </thead>
            <tbody id="players-list">
                <tr><td colspan="5" style="text-align:center; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö... üì°</td></tr>
            </tbody>
        </table>
    </div>

    <div id="editor-modal">
        <div class="editor-content">
            <span class="close-btn" onclick="closeEditor()">√ó</span>
            <h3 style="margin-top:0">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
            <div style="margin-bottom:15px; color:#aaa; font-size:12px;">
                ID: <span id="edit-id" style="color:#00f2ff">---</span><br>
                –ò–≥—Ä–æ–∫: <span id="edit-name" style="color:white">---</span>
            </div>

            <label>üí∞ –î–µ–Ω—å–≥–∏ (PLN)</label>
            <input type="number" id="input-money">

            <label>‚≠ê –£—Ä–æ–≤–µ–Ω—å (LVL)</label>
            <input type="number" id="input-lvl">

            <button class="btn-edit" style="width:100%; background:#34c759; padding:12px; font-size:16px;" onclick="saveUserChanges()">–°–û–•–†–ê–ù–ò–¢–¨ –ò–ó–ú–ï–ù–ï–ù–ò–Ø</button>

            <div class="danger-zone">
                <h4 style="margin:0 0 10px 0; color:var(--danger)">üíÄ –û–ü–ê–°–ù–ê–Ø –ó–û–ù–ê</h4>
                <button class="btn-reset" onclick="resetUserFull()">‚ôªÔ∏è –ü–û–õ–ù–û–ï –û–ë–ù–£–õ–ï–ù–ò–ï</button>
                <small style="display:block; margin-top:5px; color:#666;">–£–¥–∞–ª–∏—Ç –≤—Å—ë: –≤–µ—â–∏, —Ä–∞–π–æ–Ω, –¥–µ–Ω—å–≥–∏.</small>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
          authDomain: "warszawa-courier.firebaseapp.com",
          databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "warszawa-courier",
          storageBucket: "warszawa-courier.firebasestorage.app",
          messagingSenderId: "295860613508",
          appId: "1:295860613508:web:86fe8364377d6875612dd1",
          measurementId: "G-TGSCHBVLX2"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let allUsersData = {};

        db.ref('users').on('value', (snapshot) => {
            const users = snapshot.val();
            if (!users) { document.getElementById('players-list').innerHTML = "<tr><td colspan='5' style='text-align:center'>–ë–∞–∑–∞ –ø—É—Å—Ç–∞ üåë</td></tr>"; return; }
            allUsersData = users;
            renderTable(users);
        });

        function renderTable(users) {
            const tbody = document.getElementById('players-list');
            tbody.innerHTML = '';
            let onlineCounter = 0;
            let totalCounter = 0;
            const now = Date.now();
            const usersArray = Object.entries(users).map(([id, data]) => ({ id, ...data }));
            usersArray.sort((a, b) => (b.lastActive || 0) - (a.lastActive || 0));

            usersArray.forEach(user => {
                totalCounter++;
                const lastSeen = user.lastActive || 0;
                const isOnline = (now - lastSeen) < (3 * 60 * 1000); 
                if (isOnline) onlineCounter++;
                let timeString = lastSeen === 0 ? "–î–∞–≤–Ω–æ" : new Date(lastSeen).toLocaleTimeString();
                if(isOnline) timeString = "üî• –°–µ–π—á–∞—Å";

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="user-name">${user.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'}</div>
                        <div class="user-nick">${user.user || user.id}</div>
                    </td>
                    <td style="color:var(--green)">${(user.money || 0).toFixed(2)} PLN</td>
                    <td style="color:#ffcc00">${(user.lvl || 1).toFixed(2)}</td>
                    <td><span class="status-badge ${isOnline ? 'status-on' : 'status-off'}">${isOnline ? 'üü¢ ON' : '‚ö´ OFF'}</span><div style="font-size:10px; color:#666; margin-top:3px;">${timeString}</div></td>
                    <td><button class="btn-edit" onclick="openEditor('${user.id}')">‚úèÔ∏è Edit</button></td>
                `;
                tbody.appendChild(row);
            });
            document.getElementById('online-count').innerText = onlineCounter;
            document.getElementById('total-count').innerText = totalCounter;
        }

        function openEditor(userId) {
            const user = allUsersData[userId];
            if (!user) return;
            document.getElementById('edit-id').innerText = userId;
            document.getElementById('edit-name').innerText = user.name || "---";
            document.getElementById('input-money').value = user.money;
            document.getElementById('input-lvl').value = user.lvl;
            document.getElementById('editor-modal').style.display = 'flex';
        }

        function closeEditor() { document.getElementById('editor-modal').style.display = 'none'; }

        // --- –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø ---
        function saveUserChanges() {
            const userId = document.getElementById('edit-id').innerText;
            const newMoney = parseFloat(document.getElementById('input-money').value);
            const newLvl = parseFloat(document.getElementById('input-lvl').value);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏ lastAdminUpdate, —á—Ç–æ–±—ã –∏–≥—Ä–∞ –ø–æ–Ω—è–ª–∞, —á—Ç–æ —ç—Ç–æ –ü–†–ò–ö–ê–ó
            db.ref('users/' + userId).update({ 
                money: newMoney, 
                lvl: newLvl,
                lastAdminUpdate: Date.now() // <--- –í–ê–ñ–ù–û
            }).then(() => closeEditor());
        }

        function resetUserFull() {
            const userId = document.getElementById('edit-id').innerText;
            const userName = document.getElementById('edit-name').innerText;
            if(!confirm(`‚ö†Ô∏è –¢–´ –£–í–ï–†–ï–ù?\n\n–ò–≥—Ä–æ–∫ ${userName} –ø–æ—Ç–µ—Ä—è–µ—Ç –í–°–Å (–∏–Ω–≤–µ–Ω—Ç–∞—Ä—å, —Ä–∞–π–æ–Ω, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è).`)) return;

            const currentUser = allUsersData[userId] || {};
            const freshStart = {
                name: currentUser.name || "Reset Player",
                user: currentUser.user || "@unknown",
                lastActive: Date.now(),
                money: 10,
                lvl: 1.0,
                en: 2000,
                maxEn: 2000,
                debt: 0,
                tax: 300,
                rent: 300,
                waterStock: 0,
                totalOrders: 0,
                totalClicks: 0,
                totalBottles: 0,
                autoTime: 0,
                scooter: false,
                bag: false,
                phone: false,
                district: 0,
                bikeRentTime: 0,
                buffTime: 0,
                history: [],
                usedPromos: [],
                activeMilestones: [
                    { id: 1, name: "üì¶ –ü–µ—Ä–≤—ã–µ —à–∞–≥–∏", goal: 10, type: 'orders', reward: 30 }, 
                    { id: 2, name: "üß¥ –≠–∫–æ-–∞–∫—Ç–∏–≤–∏—Å—Ç", goal: 50, type: 'bottles', reward: 20 }, 
                    { id: 3, name: "‚ö° –≠–Ω–µ—Ä–¥–∂–∞–π–∑–µ—Ä", goal: 1000, type: 'clicks', reward: 40 }
                ],
                forceReset: true,
                lastAdminUpdate: Date.now() // –¢–æ–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É
            };

            db.ref('users/' + userId).set(freshStart).then(() => {
                alert(`–ò–≥—Ä–æ–∫ ${userName} –æ–±–Ω—É–ª–µ–Ω!`);
                closeEditor();
            });
        }

        window.onclick = function(event) { if (event.target == document.getElementById('editor-modal')) closeEditor(); }
    </script>
</body>
</html>
