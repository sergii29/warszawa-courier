<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>WARSZAWA GOD MODE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg: #0b0f19; --card: #1f2937; --input: #374151; --text: #f3f4f6; --accent: #3b82f6; --gold: #f59e0b; --danger: #ef4444; --success: #10b981; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-box { background: var(--card); padding: 30px; border-radius: 20px; text-align: center; border: 1px solid var(--accent); width: 80%; max-width: 300px; }
        .header-bar { background: #111827; padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .tabs-container { background: #111827; overflow-x: auto; white-space: nowrap; display: flex; padding: 0 5px; -webkit-overflow-scrolling: touch; }
        .tab-btn { padding: 12px 15px; color: #9ca3af; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
        main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; }
        .card { background: var(--card); border-radius: 12px; border: 1px solid #374151; padding: 15px; margin-bottom: 15px; }
        .card h3 { color: var(--accent); margin-top: 0; font-size: 14px; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: flex; justify-content: space-between; font-size: 11px; color: #aaa; margin-bottom: 4px; text-transform: uppercase; }
        .form-group input { width: 100%; background: var(--input); border: 1px solid #4b5563; color: white; padding: 12px; border-radius: 8px; box-sizing: border-box; }
        .btn { padding: 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; width: 100%; color: white; margin-top: 5px; }
        .btn-primary { background: var(--accent); }
        .btn-success { background: var(--success); color: #000; }
        .btn-danger { background: var(--danger); }
        .fab-save { position: fixed; bottom: 20px; right: 20px; left: 20px; padding: 15px; font-size: 16px; z-index: 100; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .user-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 8px; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); padding: 20px; }
        .modal { background: #1f2937; width: 100%; max-width: 400px; max-height: 85vh; overflow-y: auto; border-radius: 16px; border: 1px solid var(--accent); padding: 20px; display: flex; flex-direction: column; }
        .tab-content { display: none; } .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <h2>GOD MODE</h2>
            <input type="password" id="admin-pass" placeholder="Password" style="margin-bottom: 15px;">
            <button class="btn btn-primary" onclick="auth()">LOGIN</button>
        </div>
    </div>

    <div style="display: flex; flex-direction: column; height: 100%;" id="app-ui" hidden>
        <div class="header-bar">
            <div style="font-weight:900; color:white;">WARSZAWA <span style="color:var(--gold)">ADMIN</span></div>
            <button class="btn btn-danger" style="width: auto; padding: 6px 12px; font-size: 10px;" onclick="location.reload()">EXIT</button>
        </div>
        <div class="tabs-container">
            <div class="tab-btn active" onclick="switchTab('players', this)">–ò–≥—Ä–æ–∫–∏</div>
            <div class="tab-btn" onclick="switchTab('economy', this)">–≠–∫–æ–Ω–æ–º</div>
            <div class="tab-btn" onclick="switchTab('items', this)">–ú–∞–≥–∞–∑–∏–Ω</div>
            <div class="tab-btn" onclick="switchTab('map', this)">–ö–∞—Ä—Ç–∞</div>
            <div class="tab-btn" onclick="switchTab('business', this)">–ë–∏–∑–Ω–µ—Å</div>
        </div>
        <main>
            <div id="tab-players" class="tab-content active">
                <input type="text" id="user-search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderUsers()" style="width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: white; border-radius: 8px; margin-bottom: 15px;">
                <div id="users-list">Loading...</div>
            </div>
            
            <div id="tab-economy" class="tab-content">
                <div class="card">
                    <h3>üí∞ –ì–ª–æ–±–∞–ª</h3>
                    <div class="form-group"><label>–ù–∞–ª–æ–≥ (%)</label><input type="number" data-path="economy.tax_rate" data-type="percent"></div>
                    <div class="form-group"><label>–ü–æ—Ä–æ–≥ –Ω–∞–ª–æ–≥–∞</label><input type="number" data-path="economy.tax_threshold"></div>
                    <div class="form-group"><label>–ò–Ω—Ñ–ª—è—Ü–∏—è (%)</label><input type="number" data-path="economy.inflation_rate" data-type="percent"></div>
                    <div class="form-group"><label>–¶–µ–Ω–∞ –ö–ª–∏–∫–∞ (–ë–∞–∑–∞)</label><input type="number" step="0.01" data-path="economy.click_base"></div>
                </div>
            </div>
            
            <div id="tab-items" class="tab-content">
                <div class="card">
                    <h3>ü•§ –¶–µ–Ω—ã</h3>
                    <div class="form-group"><label>–í–æ–¥–∞</label><input type="number" step="0.1" data-path="prices.water"></div>
                    <div class="form-group"><label>–ö–æ—Ñ–µ</label><input type="number" step="0.1" data-path="prices.coffee"></div>
                    <div class="form-group"><label>–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫</label><input type="number" step="0.1" data-path="prices.energy"></div>
                </div>
            </div>
            
            <div id="tab-map" class="tab-content">
                <div id="districts-container"></div>
            </div>
            
            <div id="tab-business" class="tab-content">
                <div class="card">
                    <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                    <div class="form-group"><label>–ù–∞–ª–æ–≥ –Ω–∞ –±–∏–∑–Ω–µ—Å (%)</label><input type="number" data-path="economy.business_tax" data-type="percent"></div>
                </div>
                <div id="business-container"></div>
            </div>
            
            <button class="btn btn-success fab-save" onclick="saveAllSettings()">–°–û–•–†–ê–ù–ò–¢–¨ –ú–ò–†</button>
        </main>
    </div>

    <div id="user-modal" class="modal-overlay">
        <div class="modal">
            <h3 id="m-username" style="color:white; margin-top:0;">Player</h3>
            <div class="form-group"><label>–ë–∞–ª–∞–Ω—Å</label><input type="number" id="m-money"></div>
            <div class="form-group"><label>LVL</label><input type="number" step="0.01" id="m-lvl"></div>
            <div class="form-group"><label>–í–æ–¥–∞</label><input type="number" id="m-water"></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
                <button class="btn btn-primary" onclick="adminAction('give_water')">üíß +1.5–ª</button>
                <button class="btn btn-primary" onclick="adminAction('repair_all')">üõ†Ô∏è –ü–æ—á–∏–Ω–∏—Ç—å</button>
            </div>
            <button class="btn btn-success" style="margin-top:15px;" onclick="saveUserChanges()">–°–û–•–†–ê–ù–ò–¢–¨</button>
            <button class="btn" style="background:#444; margin-top:10px;" onclick="document.getElementById('user-modal').style.display='none'">–ó–ê–ö–†–´–¢–¨</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
            authDomain: "warszawa-courier.firebaseapp.com",
            databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "warszawa-courier",
            storageBucket: "warszawa-courier.firebasestorage.app",
            messagingSenderId: "295860613508",
            appId: "1:295860613508:web:86fe8364377d6875612dd1",
            measurementId: "G-TGSCHBVLX2"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let settings = {}, users = {}, currentUserId = null;

        function auth() {
            if(document.getElementById('admin-pass').value === 'admin') {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-ui').hidden = false;
                init();
            } else alert("Error");
        }

        function switchTab(id, el) {
            document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
        }

        function init() {
            db.ref('game_settings').on('value', snap => { settings = snap.val() || {}; renderSettings(); });
            db.ref('users').on('value', snap => { users = snap.val() || {}; renderUsers(); });
        }

        function renderSettings() {
            // Basic inputs
            document.querySelectorAll('[data-path]').forEach(el => {
                const path = el.dataset.path.split('.');
                let val = settings;
                for (let p of path) { val = val ? val[p] : undefined; }
                if (val !== undefined) {
                    if (el.dataset.type === 'percent') val = (val * 100).toFixed(2);
                    el.value = val;
                }
            });

            // Districts
            const distDiv = document.getElementById('districts-container');
            if(settings.districts_data) {
                distDiv.innerHTML = settings.districts_data.map((d, i) => `
                    <div class="card">
                        <h3>–†–∞–π–æ–Ω ${i}</h3>
                        <div class="form-group"><label>–¶–µ–Ω–∞ –î–æ–º–∞</label><input type="number" id="dist-${i}-price" value="${d.housePrice}"></div>
                        <div class="form-group"><label>–ú–∏–Ω. LVL</label><input type="number" id="dist-${i}-lvl" value="${d.minLvl}"></div>
                        <div class="form-group"><label>–ú–Ω–æ–∂–∏—Ç–µ–ª—å (x)</label><input type="number" id="dist-${i}-mult" value="${d.mult}"></div>
                    </div>
                `).join('');
            }

            // Business
            const bizDiv = document.getElementById('business-container');
            if(settings.business_data) {
                bizDiv.innerHTML = settings.business_data.map((b, i) => `
                    <div class="card">
                        <h3>–ë–∏–∑–Ω–µ—Å ${i}</h3>
                        <div class="form-group"><label>–¶–µ–Ω–∞</label><input type="number" id="biz-${i}-price" value="${b.basePrice}"></div>
                        <div class="form-group"><label>–¶–µ–Ω–∞ –¢–æ–≤–∞—Ä–∞</label><input type="number" id="biz-${i}-stock" value="${b.stockPrice}"></div>
                        <div class="form-group"><label>–¶–µ–Ω–∞ –ü—Ä–æ–¥–∞–∂–∏</label><input type="number" id="biz-${i}-sell" value="${b.sellPrice}"></div>
                    </div>
                `).join('');
            }
        }

        function saveAllSettings() {
            let update = JSON.parse(JSON.stringify(settings));
            if(!update.economy) update.economy = {};
            if(!update.prices) update.prices = {};
            if(!update.jobs) update.jobs = {};
            
            // Save basic
            document.querySelectorAll('[data-path]').forEach(el => {
                const path = el.dataset.path.split('.');
                let val = parseFloat(el.value);
                if (el.dataset.type === 'percent') val = val / 100;
                let obj = update;
                for (let i = 0; i < path.length - 1; i++) {
                    if (!obj[path[i]]) obj[path[i]] = {};
                    obj = obj[path[i]];
                }
                obj[path[path.length - 1]] = val;
            });

            // Save Arrays
            if(update.districts_data) {
                update.districts_data.forEach((d, i) => {
                    d.housePrice = parseFloat(document.getElementById(`dist-${i}-price`).value);
                    d.minLvl = parseFloat(document.getElementById(`dist-${i}-lvl`).value);
                    d.mult = parseFloat(document.getElementById(`dist-${i}-mult`).value);
                });
            }
            if(update.business_data) {
                update.business_data.forEach((b, i) => {
                    b.basePrice = parseFloat(document.getElementById(`biz-${i}-price`).value);
                    b.stockPrice = parseFloat(document.getElementById(`biz-${i}-stock`).value);
                    b.sellPrice = parseFloat(document.getElementById(`biz-${i}-sell`).value);
                });
            }

            db.ref('game_settings').set(update).then(() => alert('‚úÖ SAVED'));
        }

        function renderUsers() {
            const list = document.getElementById('users-list');
            const term = document.getElementById('user-search').value.toLowerCase();
            let html = '';
            Object.keys(users).forEach(uid => {
                const u = users[uid];
                const name = u.name || 'Unknown';
                if (term && !name.toLowerCase().includes(term)) return;
                html += `<div class="user-row" onclick="openUser('${uid}')">
                    <div><b>${name}</b> <small>${uid.substr(0,5)}</small></div>
                    <div style="color:${u.money<0?'red':'#10b981'}">${Math.floor(u.money||0)} PLN</div>
                </div>`;
            });
            list.innerHTML = html;
        }

        function openUser(uid) {
            currentUserId = uid;
            const u = users[uid];
            document.getElementById('user-modal').style.display = 'flex';
            document.getElementById('m-username').innerText = u.name;
            document.getElementById('m-money').value = u.money || 0;
            document.getElementById('m-lvl').value = u.lvl || 1;
            document.getElementById('m-water').value = u.waterStock || 0;
        }

        function saveUserChanges() {
            if(!currentUserId) return;
            db.ref('users/' + currentUserId).update({
                money: parseFloat(document.getElementById('m-money').value),
                lvl: parseFloat(document.getElementById('m-lvl').value),
                waterStock: parseFloat(document.getElementById('m-water').value),
                lastAdminUpdate: Date.now(),
                adminMessage: "Admin update"
            }).then(() => document.getElementById('user-modal').style.display = 'none');
        }

        function adminAction(action) {
            if(!currentUserId) return;
            let updates = { lastAdminUpdate: Date.now() };
            if (action === 'give_water') updates.waterStock = (users[currentUserId].waterStock || 0) + 1500;
            if (action === 'repair_all') {
                updates['shoes/dur'] = 100;
                ['bag', 'phone', 'scooter'].forEach(k => updates[`${k}/dur`] = 100);
            }
            db.ref('users/' + currentUserId).update(updates).then(() => alert("Done"));
        }
    </script>
</body>
</html>
