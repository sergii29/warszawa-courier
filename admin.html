<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warszawa GOD MODE ‚ö°</title>
    <style>
        :root { --bg: #0f0f13; --card: #1e1e24; --accent: #007aff; --green: #34c759; --danger: #ff3b30; --text: #eee; --gold: #ffd700; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .stats-bar { display: flex; gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #333; flex: 1; text-align: center; }
        .stat-val { font-size: 24px; font-weight: bold; display: block; margin-bottom: 5px; }
        .stat-label { color: #888; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
        .online-dot { height: 10px; width: 10px; background: var(--green); border-radius: 50%; display: inline-block; box-shadow: 0 0 10px var(--green); margin-right: 5px;}

        /* –¢–∞–±–ª–∏—Ü–∞ */
        .table-wrapper { background: var(--card); border-radius: 12px; border: 1px solid #333; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { background: rgba(0,0,0,0.3); color: #888; font-size: 11px; text-transform: uppercase; padding: 15px; text-align: left; }
        td { padding: 12px 15px; border-top: 1px solid #333; vertical-align: middle; }
        tr:hover { background: rgba(255,255,255,0.02); }
        
        .user-avatar { width: 35px; height: 35px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; margin-right: 10px; }
        .user-row-flex { display: flex; align-items: center; }
        .badge { padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .badge-admin { background: rgba(255, 215, 0, 0.15); color: var(--gold); border: 1px solid var(--gold); }
        .badge-banned { background: rgba(255, 59, 48, 0.2); color: var(--danger); }

        .btn { border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: 0.2s; }
        .btn-edit { background: rgba(0, 122, 255, 0.15); color: var(--accent); }
        .btn-edit:hover { background: var(--accent); color: white; }

        /* –ú–æ–¥–∞–ª–∫–∞ */
        #editor-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        #editor-modal.show { opacity: 1; }
        
        .editor-content { background: #1a1a20; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto; border-radius: 16px; border: 1px solid #444; box-shadow: 0 20px 50px rgba(0,0,0,0.5); padding: 0; display: flex; flex-direction: column; }
        
        .modal-header { padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #222; }
        .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .form-group { margin-bottom: 5px; }
        .form-label { display: block; color: #888; font-size: 11px; margin-bottom: 5px; text-transform: uppercase; }
        .form-input { background: #111; border: 1px solid #444; color: white; padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box; font-family: monospace; }
        
        .section-title { color: var(--accent); font-size: 12px; font-weight: bold; text-transform: uppercase; margin: 15px 0 5px 0; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        .check-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .check-item { background: #252530; padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 10px; cursor: pointer; border: 1px solid #333; }
        .check-item:hover { border-color: #555; }
        .check-item input { accent-color: var(--accent); transform: scale(1.2); }

        .danger-zone { background: rgba(255, 59, 48, 0.05); border: 1px solid rgba(255, 59, 48, 0.2); padding: 15px; border-radius: 8px; margin-top: 20px; }
        
        .btn-save { background: var(--green); color: black; width: 100%; padding: 15px; font-size: 16px; margin-top: 20px; }
        .btn-ban { background: #333; color: #aaa; width: 100%; border: 1px solid #444; margin-top: 10px; }
        .btn-ban.banned { background: var(--danger); color: white; border-color: var(--danger); }
        .btn-reset { background: transparent; border: 1px solid var(--danger); color: var(--danger); width: 100%; margin-top: 10px; }
        .btn-reset:hover { background: var(--danger); color: white; }

        .close-btn { font-size: 24px; cursor: pointer; color: #777; }
        .close-btn:hover { color: white; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

    <div class="header">
        <h2 style="margin:0">üöÅ Warszawa Control <span style="color:var(--accent)">PRO</span></h2>
        <div style="font-size:12px; color:#666;">Admin Panel v2.0</div>
    </div>

    <div class="stats-bar">
        <div class="stat-card">
            <span class="stat-val" style="color:var(--green)" id="online-count">0</span>
            <span class="stat-label"><span class="online-dot"></span> Online</span>
        </div>
        <div class="stat-card">
            <span class="stat-val" id="total-count">0</span>
            <span class="stat-label">–í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤</span>
        </div>
        <div class="stat-card">
            <span class="stat-val" style="color:var(--gold)" id="rich-count">0</span>
            <span class="stat-label">–ë–æ–≥–∞—á–µ–π (>1000 PLN)</span>
        </div>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>–ò–≥—Ä–æ–∫</th>
                    <th>–ë–∞–ª–∞–Ω—Å / LVL</th>
                    <th>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                </tr>
            </thead>
            <tbody id="players-list">
                <tr><td colspan="5" style="text-align:center; padding: 30px; color:#666;">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–ø—É—Ç–Ω–∏–∫—É... üì°</td></tr>
            </tbody>
        </table>
    </div>

    <div id="editor-modal">
        <div class="editor-content">
            <div class="modal-header">
                <div>
                    <h3 style="margin:0" id="edit-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                    <small style="color:#666" id="edit-id">ID: ...</small>
                </div>
                <span class="close-btn" onclick="closeEditor()">√ó</span>
            </div>
            
            <div class="modal-body">
                <div class="section-title">üí∞ –§–∏–Ω–∞–Ω—Å—ã –∏ –°—Ç–∞—Ç—É—Å</div>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <label class="form-label">–ë–∞–ª–∞–Ω—Å (PLN)</label>
                        <input type="number" id="inp-money" class="form-input">
                    </div>
                    <div style="flex:1">
                        <label class="form-label">–£—Ä–æ–≤–µ–Ω—å (LVL)</label>
                        <input type="number" id="inp-lvl" class="form-input">
                    </div>
                </div>

                <div class="section-title">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å (–í—ã–¥–∞—Ç—å/–ó–∞–±—Ä–∞—Ç—å)</div>
                <div class="check-grid">
                    <label class="check-item"><input type="checkbox" id="chk-bag"> üéí –¢–µ—Ä–º–æ—Å—É–º–∫–∞</label>
                    <label class="check-item"><input type="checkbox" id="chk-phone"> üì± –°–º–∞—Ä—Ç—Ñ–æ–Ω</label>
                    <label class="check-item"><input type="checkbox" id="chk-scooter"> üõ¥ –°–∞–º–æ–∫–∞—Ç</label>
                    <label class="check-item"><input type="checkbox" id="chk-helmet"> üß¢ –®–ª–µ–º</label>
                    <label class="check-item"><input type="checkbox" id="chk-raincoat"> üß• –î–æ–∂–¥–µ–≤–∏–∫</label>
                    <label class="check-item"><input type="checkbox" id="chk-powerbank"> üîã Powerbank</label>
                </div>

                <div class="section-title">üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ –∏–≥—Ä–æ–∫—É</div>
                <input type="text" id="inp-msg" class="form-input" placeholder="–ù–∞–ø–∏—à–∏ —á—Ç–æ-—Ç–æ, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å...">

                <div class="danger-zone">
                    <label class="form-label" style="color:var(--danger)">–£–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ê–ö–ê–ó–ê–ù–ò–Ø–ú–ò</label>
                    <button class="btn btn-ban" id="btn-ban" onclick="toggleBan()">‚õî –ó–ê–ë–ê–ù–ò–¢–¨ –ò–ì–†–û–ö–ê</button>
                    <button class="btn btn-reset" onclick="resetUserFull()">‚ôªÔ∏è –ü–û–õ–ù–´–ô –°–ë–†–û–° (WIPE)</button>
                </div>

                <button class="btn btn-save" onclick="saveUserChanges()">üíæ –°–û–•–†–ê–ù–ò–¢–¨ –í–°–Å</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyChrQMyO2soPgoEHq_f3aYs5Cs19q3sWEk",
          authDomain: "warszawa-courier.firebaseapp.com",
          databaseURL: "https://warszawa-courier-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "warszawa-courier",
          storageBucket: "warszawa-courier.firebasestorage.app",
          messagingSenderId: "295860613508",
          appId: "1:295860613508:web:86fe8364377d6875612dd1",
          measurementId: "G-TGSCHBVLX2"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let allUsers = {};
        let currentEditId = null;
        let isCurrentBanned = false;

        // LOAD DATA
        db.ref('users').on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return;
            allUsers = data;
            renderTable();
        });

        function renderTable() {
            const tbody = document.getElementById('players-list');
            tbody.innerHTML = '';
            
            let online = 0, rich = 0, total = 0;
            const now = Date.now();
            
            Object.entries(allUsers)
                .sort((a,b) => (b[1].lastActive || 0) - (a[1].lastActive || 0))
                .forEach(([id, user]) => {
                    total++;
                    if (user.money > 1000) rich++;
                    
                    const isOnline = (now - (user.lastActive || 0)) < 180000; // 3 min
                    if (isOnline) online++;

                    let inventoryIcons = "";
                    if(user.bag || (user.bag && user.bag.active)) inventoryIcons += "üéí";
                    if(user.scooter || (user.scooter && user.scooter.active)) inventoryIcons += "üõ¥";
                    if(user.shoes && user.shoes.name !== "Tapki") inventoryIcons += "üëü";
                    if(user.isBanned) inventoryIcons = "‚õî BANNED";

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <div class="user-row-flex">
                                <div class="user-avatar">${user.icon || 'üë§'}</div>
                                <div>
                                    <div style="font-weight:bold; color:white;">${user.name || 'Unknown'}</div>
                                    <div style="font-size:10px; color:#777;">${user.user || id}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div style="color:${user.money < 0 ? 'var(--danger)' : 'var(--green)'}; font-weight:bold;">${(user.money||0).toFixed(2)} PLN</div>
                            <div style="font-size:10px; color:var(--gold);">LVL ${(user.lvl||1).toFixed(2)}</div>
                        </td>
                        <td>${inventoryIcons}</td>
                        <td>
                            ${isOnline ? '<span class="badge" style="background:#34c75933; color:#34c759">ON</span>' : '<span class="badge" style="background:#333; color:#777">OFF</span>'}
                            ${user.isBanned ? '<span class="badge badge-banned">BAN</span>' : ''}
                        </td>
                        <td>
                            <button class="btn btn-edit" onclick="openEditor('${id}')">‚öôÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

            document.getElementById('online-count').innerText = online;
            document.getElementById('total-count').innerText = total;
            document.getElementById('rich-count').innerText = rich;
        }

        function openEditor(id) {
            currentEditId = id;
            const user = allUsers[id];
            
            document.getElementById('editor-modal').style.display = 'flex';
            setTimeout(() => document.getElementById('editor-modal').classList.add('show'), 10);
            
            document.getElementById('edit-title').innerText = user.name || "–ò–≥—Ä–æ–∫";
            document.getElementById('edit-id').innerText = id;
            
            document.getElementById('inp-money').value = user.money;
            document.getElementById('inp-lvl').value = user.lvl;
            document.getElementById('inp-msg').value = "";

            // Checkboxes (support old boolean and new object structure)
            const check = (key) => {
                let val = user[key];
                // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞) –∏ active=true, –∏–ª–∏ –µ—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ true (—Å—Ç–∞—Ä–∞—è)
                return (val === true) || (val && val.active === true);
            };

            document.getElementById('chk-bag').checked = check('bag');
            document.getElementById('chk-phone').checked = check('phone');
            document.getElementById('chk-scooter').checked = check('scooter');
            document.getElementById('chk-helmet').checked = check('helmet');
            document.getElementById('chk-raincoat').checked = check('raincoat');
            document.getElementById('chk-powerbank').checked = check('powerbank');

            // Ban Status
            isCurrentBanned = !!user.isBanned;
            updateBanBtn();
        }

        function toggleBan() {
            isCurrentBanned = !isCurrentBanned;
            updateBanBtn();
        }

        function updateBanBtn() {
            const btn = document.getElementById('btn-ban');
            if (isCurrentBanned) {
                btn.innerText = "‚úÖ –†–ê–ó–ë–ê–ù–ò–¢–¨ –ò–ì–†–û–ö–ê";
                btn.classList.add('banned');
            } else {
                btn.innerText = "‚õî –ó–ê–ë–ê–ù–ò–¢–¨ –ò–ì–†–û–ö–ê";
                btn.classList.remove('banned');
            }
        }

        function saveUserChanges() {
            if(!currentEditId) return;

            const updates = {
                money: parseFloat(document.getElementById('inp-money').value),
                lvl: parseFloat(document.getElementById('inp-lvl').value),
                isBanned: isCurrentBanned,
                lastAdminUpdate: Date.now()
            };

            // –°–æ–æ–±—â–µ–Ω–∏–µ
            const msg = document.getElementById('inp-msg').value.trim();
            if(msg) updates.adminMessage = msg;

            // –ü—Ä–µ–¥–º–µ—Ç—ã. –í –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ –ø—Ä–µ–¥–º–µ—Ç—ã - —ç—Ç–æ –æ–±—ä–µ–∫—Ç—ã.
            // –ï—Å–ª–∏ –≥–∞–ª–æ—á–∫–∞ —Å—Ç–æ–∏—Ç - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ü–µ–ª—ã–π –ø—Ä–µ–¥–º–µ—Ç (–∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)
            // –ï—Å–ª–∏ –≥–∞–ª–æ—á–∫–∞ —Å–Ω—è—Ç–∞ - —Å—Ç–∞–≤–∏–º null
            
            const setItem = (key) => {
                const isChecked = document.getElementById('chk-'+key).checked;
                if(isChecked) {
                    // –ï—Å–ª–∏ —É —é–∑–µ—Ä–∞ —É–∂–µ –±—ã–ª –ø—Ä–µ–¥–º–µ—Ç, –æ—Å—Ç–∞–≤–ª—è–µ–º, –∏–Ω–∞—á–µ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ñ—É–ª–æ–≤—ã–π
                    if(allUsers[currentEditId][key]) return allUsers[currentEditId][key]; 
                    return { active: true, dur: 100 };
                } else {
                    return null;
                }
            };

            updates.bag = setItem('bag');
            updates.phone = setItem('phone');
            updates.scooter = setItem('scooter');
            updates.helmet = setItem('helmet');
            updates.raincoat = setItem('raincoat');
            updates.powerbank = setItem('powerbank');

            db.ref('users/' + currentEditId).update(updates).then(() => {
                closeEditor();
            });
        }

        function resetUserFull() {
            if(!currentEditId) return;
            if(!confirm("–£–í–ï–†–ï–ù? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–ï–°–¨ –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–≥—Ä–æ–∫–∞ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.")) return;

            const user = allUsers[currentEditId];
            
            const wipeData = {
                name: user.name,
                user: user.user,
                lastActive: Date.now(),
                lastAdminUpdate: Date.now(),
                
                // –†–ï–°–£–†–°–´
                money: 10.00,
                lvl: 1.0,
                en: 2000,
                waterStock: 0,
                
                // –°–¢–ê–¢–ò–°–¢–ò–ö–ê
                totalOrders: 0,
                totalClicks: 0,
                totalBottles: 0,
                totalEarned: 0,
                
                // –ò–ù–í–ï–ù–¢–ê–†–¨ (–û–ë–ù–£–õ–ï–ù–ò–ï)
                shoes: { name: "Tapki", maxDur: 100, dur: 100, bonus: 0 },
                bag: null,
                phone: null,
                scooter: null,
                helmet: null,
                raincoat: null,
                powerbank: null,
                starter_bag: null,   // –í–ê–ñ–ù–û: —É–±—Ä–∞—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ
                starter_phone: null, // –í–ê–ñ–ù–û: —É–±—Ä–∞—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ
                
                // –°–û–°–¢–û–Ø–ù–ò–Ø
                district: 0,
                autoTime: 0,
                bikeRentTime: 0,
                buffTime: 0,
                isNewPlayer: true,   // –ß—Ç–æ–±—ã –≤—ã–ª–µ–∑–ª–æ –æ–∫–Ω–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
                
                // –°–ü–ò–°–ö–ò
                history: [],
                usedPromos: [],
                activeMilestones: [ // –°–±—Ä–æ—Å –∞—á–∏–≤–æ–∫
                    { id: 1, name: "üì¶ –ü–µ—Ä–≤—ã–µ —à–∞–≥–∏", goal: 10, type: 'orders', reward: 30 }, 
                    { id: 2, name: "üß¥ –≠–∫–æ-–∞–∫—Ç–∏–≤–∏—Å—Ç", goal: 50, type: 'bottles', reward: 20 }, 
                    { id: 3, name: "‚ö° –≠–Ω–µ—Ä–¥–∂–∞–π–∑–µ—Ä", goal: 1000, type: 'clicks', reward: 40 }
                ]
            };

            db.ref('users/' + currentEditId).set(wipeData).then(() => {
                alert("–ò–≥—Ä–æ–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω—É–ª–µ–Ω.");
                closeEditor();
            });
        }

        function closeEditor() {
            document.getElementById('editor-modal').classList.remove('show');
            setTimeout(() => document.getElementById('editor-modal').style.display = 'none', 300);
            currentEditId = null;
        }
        
        // Close on click outside
        window.onclick = function(e) {
            if(e.target == document.getElementById('editor-modal')) closeEditor();
        }
    </script>
</body>
</html>
